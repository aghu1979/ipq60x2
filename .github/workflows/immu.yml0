# ==============================================================================
# ImmortalWrt å›ºä»¶ç¼–è¯‘å·¥ä½œæµ
#
# åŠŸèƒ½:
#   è‡ªåŠ¨åŒ–ç¼–è¯‘ ImmortalWrt å›ºä»¶
#   æ”¯æŒå¤šç§é…ç½®é€‰é¡¹å’ŒPasswallæ›´æ–°æ–¹å¼
#   é›†æˆç£ç›˜ç©ºé—´æ‰©å±•å’Œç¼“å­˜ç®¡ç†
#
# ä½¿ç”¨æ–¹æ³•:
#   é€šè¿‡ GitHub Actions æ‰‹åŠ¨è§¦å‘æˆ–è‡ªåŠ¨è§¦å‘
#
# ä½œè€…: Mary
# æ—¥æœŸï¼š20251114
# ç‰ˆæœ¬: 4.0 - è„šæœ¬æ•´åˆä¼˜åŒ–ç‰ˆ
# ==============================================================================

name: ImmortalWrt å›ºä»¶ç¼–è¯‘å·¥ä½œæµ

on:
  workflow_dispatch:
    inputs:
      firmware_tag:
        description: 'å›ºä»¶æ ‡ç­¾'
        required: false
        default: 'ImmortalWrt'
        type: string
      upload_bin_dir:
        description: 'ä¸Šä¼ å®Œæ•´binç›®å½•'
        required: false
        default: false
        type: boolean
      firmware_release:
        description: 'å‘å¸ƒå›ºä»¶åˆ°Release'
        required: false
        default: true
        type: boolean
      use_passwall_method:
        description: 'Passwallæ›´æ–°æ–¹æ³• (1=feeds.conf, 2=æ‰‹åŠ¨å…‹éš†)'
        required: false
        default: '1'
        type: choice
        options:
        - '1'
        - '2'
  workflow_call:

env:
  # å·¥ä½œæµç‰ˆæœ¬
  WORKFLOW_VERSION: "4.0"
  # æºç ä»“åº“é…ç½®
  REPO_URL: https://github.com/laipeng668/immortalwrt.git
  REPO_BRANCH: master
  REPO_NAME: immwrt
  
  # é…ç½®æ–‡ä»¶è·¯å¾„
  CONFIG_FILE: configs/immu.config
  BUILD_SCRIPT: scripts/build.sh
  
  # ç¼–è¯‘é…ç½®
  TZ: Asia/Shanghai

jobs:
  Build:
    runs-on: ubuntu-24.04

    steps:
    - name: æ£€æŸ¥æœåŠ¡å™¨æ€§èƒ½
      run: |
        echo "========æœåŠ¡å™¨æ€§èƒ½ä¿¡æ¯========"
        echo "CPUä¿¡æ¯:"
        lscpu | grep "Model name" | cut -d':' -f2- | xargs
        echo "CPUæ ¸å¿ƒæ•°: $(nproc)"
        echo "å†…å­˜ä¿¡æ¯:"
        free -h
        echo "ç£ç›˜ä¿¡æ¯:"
        df -hT
        echo "================================"

    - name: åˆå§‹åŒ–ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        echo "========åˆå§‹åŒ–ç¯å¢ƒ========"
        sudo -E apt-get -y update
        sudo -E apt-get -y install $(curl -fsSL ophub.org/ubuntu2404-make-openwrt-depends)
        sudo -E systemctl daemon-reload
        sudo timedatectl set-timezone "$TZ"
        echo "ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
        echo "========================"

    - name: æ‰©å±•ç£ç›˜ç©ºé—´
      run: |
        echo "========æ‰©å±•ç£ç›˜ç©ºé—´========"
        
        # æ˜¾ç¤ºå½“å‰ç£ç›˜ä½¿ç”¨æƒ…å†µ
        echo "å½“å‰ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
        df -hT
        
        # å°è¯•æ‰©å±•ç£ç›˜ç©ºé—´
        EXTENDED=false
        
        # æ£€æŸ¥å¯ç”¨ç£ç›˜è®¾å¤‡
        if [ -b /dev/sda ]; then
          DEVICE="sda"
        elif [ -b /dev/sdb ]; then
          DEVICE="sdb"
        else
          echo "æœªæ‰¾åˆ°å¯ç”¨çš„ç£ç›˜è®¾å¤‡"
          exit 1
        fi
        
        echo "ä½¿ç”¨ç£ç›˜è®¾å¤‡: /dev/$DEVICE"
        
        # æ£€æŸ¥ç£ç›˜åˆ†åŒº
        sudo fdisk -l /dev/$DEVICE
        
        # å°è¯•æ‰©å±•åˆ†åŒº
        if sudo growpart /dev/$DEVICE 1 2>/dev/null; then
          echo "åˆ†åŒºæ‰©å±•æˆåŠŸ"
          # æ‰©å±•æ–‡ä»¶ç³»ç»Ÿ
          if sudo resize2fs /dev/${DEVICE}1 2>/dev/null; then
            echo "ext4æ–‡ä»¶ç³»ç»Ÿæ‰©å±•æˆåŠŸ"
            EXTENDED=true
          elif sudo xfs_growfs / 2>/dev/null; then
            echo "XFSæ–‡ä»¶ç³»ç»Ÿæ‰©å±•æˆåŠŸ"
            EXTENDED=true
          else
            echo "æ–‡ä»¶ç³»ç»Ÿæ‰©å±•å¤±è´¥"
          fi
        else
          echo "åˆ†åŒºæ‰©å±•å¤±è´¥ï¼Œå¯èƒ½å·²ç»æ˜¯æœ€å¤§åˆ†åŒº"
        fi
        
        # å¦‚æœæ‰©å±•å¤±è´¥ï¼Œä½¿ç”¨è½¯é“¾æ¥æ–¹å¼æ‰©å±•ç©ºé—´
        if [ "$EXTENDED" = "false" ]; then
          echo "ä½¿ç”¨è½¯é“¾æ¥æ–¹å¼æ‰©å±•ç©ºé—´..."
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•åœ¨æ›´å¤§çš„åˆ†åŒºä¸Š
          if [ -d /mnt ] && df /mnt | awk 'NR==2 {print $4}' | grep -q 'G'; then
            TEMP_DIR="/mnt/openwrt-temp"
          elif [ -d /tmp ] && df /tmp | awk 'NR==2 {print $4}' | grep -q 'G'; then
            TEMP_DIR="/tmp/openwrt-temp"
          else
            echo "æœªæ‰¾åˆ°åˆé€‚çš„åˆ†åŒºç”¨äºåˆ›å»ºè½¯é“¾æ¥"
            exit 1
          fi
          
          echo "åˆ›å»ºä¸´æ—¶ç›®å½•: $TEMP_DIR"
          sudo mkdir -p "$TEMP_DIR"
          sudo chown $(id -u):$(id -g) "$TEMP_DIR"
          
          # ç§»åŠ¨ç°æœ‰å†…å®¹åˆ°ä¸´æ—¶ç›®å½•
          if [ -d "$GITHUB_WORKSPACE" ]; then
            echo "ç§»åŠ¨å·¥ä½œç©ºé—´å†…å®¹åˆ°ä¸´æ—¶ç›®å½•..."
            mv "$GITHUB_WORKSPACE"/* "$TEMP_DIR/" 2>/dev/null || true
          fi
          
          # åˆ›å»ºè½¯é“¾æ¥
          echo "åˆ›å»ºè½¯é“¾æ¥: $TEMP_DIR -> $GITHUB_WORKSPACE"
          sudo ln -sf "$TEMP_DIR" "$GITHUB_WORKSPACE"
          
          # é‡æ–°è®¾ç½®æƒé™
          sudo chown -R $(id -u):$(id -g) "$TEMP_DIR"
        fi
        
        # æ˜¾ç¤ºæ‰©å±•åçš„ç£ç›˜ç©ºé—´
        echo "æ‰©å±•åçš„ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
        df -hT
        echo "========================"

    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: å…‹éš†æºä»£ç 
      run: |
        echo "========å…‹éš†æºä»£ç ========"
        df -hT $GITHUB_WORKSPACE
        
        # åˆ›å»ºå·¥ä½œç›®å½•
        sudo mkdir -p /mnt/openwrt
        sudo chown -R $(id -u):$(id -g) /mnt/openwrt
        
        # å…‹éš†æºç 
        git clone --depth 1 -b $REPO_BRANCH --single-branch $REPO_URL /mnt/openwrt
        cd /mnt/openwrt
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV
        
        # è·å–ç‰ˆæœ¬ä¿¡æ¯
        VERSION_INFO=$(git show -s --date=short --format="ä½œè€…: %an<br/>æ—¶é—´: %cd<br/>å†…å®¹: %s<br/>hash: %H")
        echo "VERSION_INFO=$VERSION_INFO" >> $GITHUB_ENV
        
        # è·å–å†…æ ¸ç‰ˆæœ¬
        VERSION_KERNEL=$(grep -oP 'LINUX_KERNEL_HASH-\K[0-9]+\.[0-9]+\.[0-9]+' target/linux/generic/kernel-6.12 2>/dev/null || echo "æœªçŸ¥")
        echo "VERSION_KERNEL=$VERSION_KERNEL" >> $GITHUB_ENV
        
        # è·å–æºç å“ˆå¸Œ
        echo "HASH=$(git log -1 --pretty=format:'%h')" >> $GITHUB_ENV
        echo "CACHE_DATE=$(date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_ENV
        
        echo "æºç å…‹éš†å®Œæˆ"
        echo "========================"

    - name: ç¼“å­˜å·¥å…·é“¾
      uses: actions/cache@v4
      with:
        key: ${{ env.REPO_NAME }}-${{ env.REPO_BRANCH }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-${{ env.HASH }}-${{ env.CACHE_DATE }}
        restore-keys: ${{ env.REPO_NAME }}-${{ env.REPO_BRANCH }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-
        path: |
          ${{ env.OPENWRT_PATH }}/.ccache
          ${{ env.OPENWRT_PATH }}/staging_dir

    - name: æ‰§è¡Œç¼–è¯‘æµç¨‹
      id: compile
      env:
        PASSWALL_METHOD: ${{ github.event.inputs.use_passwall_method || '1' }}
        REPO_NAME: ${{ env.REPO_NAME }}
        REPO_BRANCH: ${{ env.REPO_BRANCH }}
      run: |
        echo "========æ‰§è¡Œç¼–è¯‘æµç¨‹========"
        
        # è®¾ç½®è„šæœ¬æƒé™
        chmod +x $GITHUB_WORKSPACE/$BUILD_SCRIPT
        
        # æ‰§è¡Œç¼–è¯‘è„šæœ¬
        $GITHUB_WORKSPACE/$BUILD_SCRIPT
        
        # è®¾ç½®ç¼–è¯‘çŠ¶æ€
        echo "status=success" >> $GITHUB_OUTPUT
        echo "DATE=$(date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_ENV
        
        echo "ç¼–è¯‘æµç¨‹æ‰§è¡Œå®Œæˆ"
        echo "========================"

    - name: ä¸Šä¼ LUCIæŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.REPO_NAME }}-luci-report-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-${{ env.FILE_DATE }}
        path: reports/

    - name: ä¸Šä¼ Binç›®å½•
      if: steps.compile.outputs.status == 'success' && github.event.inputs.upload_bin_dir == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.REPO_NAME }}-bin-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-${{ env.FILE_DATE }}
        path: ${{ env.OPENWRT_PATH }}/bin

    - name: ä¸Šä¼ å›ºä»¶åˆ°Artifact
      if: steps.compile.outputs.status == 'success' && github.event.inputs.firmware_release == 'false'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.REPO_NAME }}-firmware-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE_PATH }}

    - name: å‘å¸ƒå›ºä»¶åˆ°Release
      if: steps.compile.outputs.status == 'success' && github.event.inputs.firmware_release == 'true'
      uses: ncipollo/release-action@v1
      with:
        name: ${{ env.DATE }} for ${{ env.FIRMWARE_TAG || 'ImmortalWrt' }}
        allowUpdates: true
        tag: ${{ env.FIRMWARE_TAG || 'ImmortalWrt' }}
        token: ${{ secrets.GITHUB_TOKEN }}
        artifacts: ${{ env.FIRMWARE_PATH }}/*
        body: "**è¿™æ˜¯ ${{ env.FIRMWARE_TAG || 'ImmortalWrt' }} å¹³å°ä½¿ç”¨çš„ ImmortalWrt å›ºä»¶**\n\n### ğŸ“’ å›ºä»¶ä¿¡æ¯\n- è¿™æ˜¯å¼€å¯å…¨åŠŸèƒ½NSSçš„6.12å†…æ ¸å›ºä»¶ï¼Œé»˜è®¤ä¸»é¢˜ä¸ºArgonï¼›è¯¥å›ºä»¶åœ¨ImmortalWrtçš„åŸºç¡€ä¸Šï¼Œæ·»åŠ äº†è‹¥å¹²å·¥å…·ï¼Œå…·ä½“è¯¦è§å¯¹åº”æœºå‹çš„configã€‚\n- ğŸ’» è¿™æ˜¯ ${{ env.FIRMWARE_TAG || 'ImmortalWrt' }} å¹³å°ä½¿ç”¨çš„ ImmortalWrt å›ºä»¶\n- âš½ å›ºä»¶æºç : ${{ env.REPO_URL }}\n- ğŸ’ æºç åˆ†æ”¯: ${{ env.REPO_BRANCH }}\n- ğŸŒ é»˜è®¤åœ°å€: **192.168.111.1**\n- ğŸ”‘ é»˜è®¤å¯†ç : none\n\n### ğŸ§Š å›ºä»¶ç‰ˆæœ¬\n- å›ºä»¶å†…æ ¸ç‰ˆæœ¬ï¼š**${{ env.VERSION_KERNEL }}**\n- å›ºä»¶ç¼–è¯‘å‰æœ€åä¸€æ¬¡â¦[ä¸»æºç ](${{ env.REPO_URL }})æ›´æ–°è®°å½•\n- ${{ env.VERSION_INFO }}\n- å·¥ä½œæµç‰ˆæœ¬: ${{ env.WORKFLOW_VERSION }}\n- Passwallæ›´æ–°æ–¹æ³•: æ–¹æ³•${{ github.event.inputs.use_passwall_method || '1' }}"
