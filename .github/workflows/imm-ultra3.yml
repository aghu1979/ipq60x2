# .github/workflows/imm-ultra3.yml
name: Build ImmortalWrt Ultra for IPQ60xx

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'
  push:
    branches:
      - main
    paths:
      - 'configs/**'
      - 'scripts/**'
      - '.github/workflows/build.yml'

env:
  # --- å…¨å±€å˜é‡ (å°½é‡ä¸ä½¿ç”¨ç¡¬ç¼–ç ) ---
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: openwrt-23.05
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: ".config"
  DIY_P1_SH: scripts/diy.sh
  DIY_P2_SH: scripts/repo.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_COWTRANSFER: false
  UPLOAD_WETRANSFER: false
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialization environment
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-2204)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir
          
      - name: Clone source code
        working-directory: /workdir
        run: |
          df -hT $PWD
          git clone $REPO_URL -b $REPO_BRANCH openwrt
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

      - name: Load custom scripts
        run: |
          chmod +x scripts/*.sh
          # å¯¼å‡ºæ—¥å¿—å‡½æ•°ä¸ºç¯å¢ƒå˜é‡ï¼Œä¾›å­è¿›ç¨‹ä½¿ç”¨
          export -f log_info log_success log_warn log_error
          
      - name: Merge Configuration Files
        run: |
          [ -f openwrt/.config ] && rm -f openwrt/.config
          cat configs/base_ipq60xx.config configs/base_immwrt.config configs/Ultra.config > openwrt/.config
          log_success "é…ç½®æ–‡ä»¶åˆå¹¶å®Œæˆ: base_ipq60xx.config + base_immwrt.config + Ultra.config"

      - name: Extract Target and Device Info
        id: target_info
        run: |
          cd openwrt
          # æå–ç›®æ ‡å¹³å°å’Œå­å¹³å°
          TARGET=$(grep '^CONFIG_TARGET_BOARD=.*$' .config | sed 's/.*=//')
          SUBTARGET=$(grep '^CONFIG_TARGET_SUBTARGET=.*$' .config | sed 's/.*=//')
          echo "TARGET=$TARGET" >> $GITHUB_ENV
          echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
          echo "target_platform=$TARGET/$SUBTARGET" >> $GITHUB_OUTPUT
          
          # æå–æ‰€æœ‰å¯ç”¨çš„è®¾å¤‡å
          DEVICE_NAMES=$(grep '^CONFIG_TARGET_DEVICE_.*=y$' .config | sed 's/.*DEVICE_\(.*\)=y/\1/' | tr '\n' ' ')
          if [ -z "$DEVICE_NAMES" ]; then
            log_error "æœªåœ¨ .config ä¸­æ‰¾åˆ°ä»»ä½•å¯ç”¨çš„è®¾å¤‡ã€‚"
            exit 1
          fi
          echo "DEVICE_NAMES=$DEVICE_NAMES" >> $GITHUB_ENV
          log_success "æå–åˆ°ç›®æ ‡å¹³å°: $TARGET/$SUBTARGET"
          log_success "æå–åˆ°è®¾å¤‡åˆ—è¡¨: $DEVICE_NAMES"

      - name: Cache Toolchain
        uses: actions/cache@v4
        with:
          path: openwrt/staging_dir/toolchain-*
          key: ${{ env.REPO_BRANCH }}-${{ env.TARGET }}-${{ env.SUBTARGET }}-toolchain-${{ hashFiles('configs/base_*.config', 'configs/Ultra.config') }}
          restore-keys: |
            ${{ env.REPO_BRANCH }}-${{ env.TARGET }}-${{ env.SUBTARGET }}-toolchain-

      - name: Cache Downloads
        uses: actions/cache@v4
        with:
          path: openwrt/dl
          key: ${{ env.REPO_BRANCH }}-dl-${{ hashFiles('configs/Ultra.config') }}
          restore-keys: |
            ${{ env.REPO_BRANCH }}-dl-

      - name: Run DIY-Part 1 (Initial Settings)
        run: |
          cd openwrt
          $GITHUB_WORKSPACE/$DIY_P1_SH .

      - name: Update Feeds
        run: cd openwrt && ./scripts/feeds update -a

      - name: Install Feeds
        run: cd openwrt && ./scripts/feeds install -a

      - name: Run DIY-Part 2 (Third-party Sources)
        id: repo
        run: |
          cd openwrt
          $GITHUB_WORKSPACE/$DIY_P2_SH
          
      - name: Generate LUCI Report
        id: report
        run: |
          cd openwrt
          $GITHUB_WORKSPACE/scripts/luci_report.sh before
          make defconfig
          $GITHUB_WORKSPACE/scripts/luci_report.sh after
          echo "report_path=$(pwd)/luci_report.md" >> $GITHUB_OUTPUT

      - name: Download package
        id: package
        run: |
          cd openwrt
          make defconfig
          make download -j8
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: Build the firmware
        id: compile
        run: |
          cd openwrt
          echo -e "$(nproc) thread compile"
          make -j$(nproc) || make -j1 || make
          echo "status=success" >> $GITHUB_OUTPUT
          echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_OUTPUT

      - name: Check space usage
        if: (!cancelled())
        run: df -hT

      - name: Upload LUCI Report
        uses: actions/upload-artifact@v4
        with:
          name: LUCI_report_${{ steps.target_info.outputs.target_platform }}_${{ steps.compile.outputs.FILE_DATE }}
          path: ${{ steps.report.outputs.report_path }}

      - name: Upload firmware directory
        uses: actions/upload-artifact@v4
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
        with:
          name: OpenWrt_bin_${{ steps.target_info.outputs.target_platform }}_${{ steps.compile.outputs.FILE_DATE }}
          path: openwrt/bin

      - name: Upload firmware
        uses: actions/upload-artifact@v4
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true'
        with:
          name: OpenWrt_firmware_${{ steps.target_info.outputs.target_platform }}_${{ steps.compile.outputs.FILE_DATE }}
          path: |
            openwrt/bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/*combined*
            openwrt/bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/*sysupgrade*
            ${{ steps.report.outputs.report_path }}

      - name: Upload firmware to release
        uses: softprops/action-gh-release@v2
        if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ImmortalWrt-${{ env.TARGET }}-${{ env.SUBTARGET }}-${{ steps.compile.outputs.FILE_DATE }}
          body: |
            ## ğŸ“¦ å›ºä»¶ä¿¡æ¯
            - **æºç åˆ†æ”¯**: ${{ env.REPO_BRANCH }}
            - **ç›®æ ‡å¹³å°**: ${{ env.TARGET }}/${{ env.SUBTARGET }}
            - **æ„å»ºè®¾å¤‡**: ${{ env.DEVICE_NAMES }}
            
            ## ğŸ“‹ LUCI è½¯ä»¶åŒ…å˜æ›´æŠ¥å‘Š
            è¯·æŸ¥çœ‹ä¸‹æ–¹ `luci_report.md` æ–‡ä»¶é™„ä»¶ï¼Œäº†è§£æœ¬æ¬¡æ„å»ºæ–°å¢ã€åˆ é™¤åŠæ›´æ–°çš„æ‰€æœ‰ LUCI åº”ç”¨ã€‚
          files: |
            openwrt/bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/*combined*
            openwrt/bin/targets/${{ env.TARGET }}/${{ env.SUBTARGET }}/*sysupgrade*
            ${{ steps.report.outputs.report_path }}

      - name: Delete workflow runs
        uses: GitRML/delete-workflow-runs@main
        with:
          retain_days: 1
          keep_minimum_runs: 3

      - name: Remove old Releases
        uses: dev-drprasad/delete-older-releases@v0.1.0
        if: env.UPLOAD_RELEASE == 'true'
        with:
          keep_latest: 3
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
