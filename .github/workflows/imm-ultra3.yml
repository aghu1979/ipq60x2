# å·¥ä½œæµåç§°
name: Build ImmortalWrt for Ultra3

# è§¦å‘æ¡ä»¶
on:
  # å…è®¸åœ¨ GitHub Actions é¡µé¢æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # å½“æ¨é€åˆ° main åˆ†æ”¯ï¼Œå¹¶ä¸”ä»¥ä¸‹æ–‡ä»¶æœ‰å˜æ›´æ—¶è§¦å‘
  push:
    branches:
      - main
    paths:
      - '.config' # è‡ªå®šä¹‰é…ç½®æ–‡ä»¶å˜æ›´
      - 'scripts/**' # è„šæœ¬ç›®å½•ä¸‹çš„ä»»ä½•æ–‡ä»¶å˜æ›´
      - '.github/workflows/imm-ultra3.yml' # å·¥ä½œæµæ–‡ä»¶è‡ªèº«å˜æ›´

# ç¯å¢ƒå˜é‡
env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt # ImmortalWrt æºç ä»“åº“åœ°å€
  REPO_BRANCH: openwrt-23.05 # è¦ä½¿ç”¨çš„åˆ†æ”¯
  FEEDS_CONF: feeds.conf.default # è‡ªå®šä¹‰ feeds é…ç½®æ–‡ä»¶
  CONFIG_FILE: .config # è‡ªå®šä¹‰å›ºä»¶é…ç½®æ–‡ä»¶
  DIY_P1_SH: scripts/diy-part1.sh # è‡ªå®šä¹‰è„šæœ¬1 (åœ¨æ›´æ–°æºå‰æ‰§è¡Œ)
  DIY_P2_SH: scripts/diy-part2.sh # è‡ªå®šä¹‰è„šæœ¬2 (åœ¨æ›´æ–°æºåæ‰§è¡Œ)
  UPLOAD_BIN_DIR: false # æ˜¯å¦ä¸Šä¼ æ•´ä¸ª bin ç›®å½•
  UPLOAD_FIRMWARE: true # æ˜¯å¦ä¸Šä¼ æœ€ç»ˆå›ºä»¶æ–‡ä»¶
  UPLOAD_COWTRANSFER: false # æ˜¯å¦ä¸Šä¼ åˆ° Cowtransfer
  UPLOAD_WETRANSFER: false # æ˜¯å¦ä¸Šä¼ åˆ° WeTransfer
  UPLOAD_RELEASE: true # æ˜¯å¦åˆ›å»º GitHub Release
  TZ: Asia/Shanghai # è®¾ç½®æ—¶åŒº

# ä½œä¸šå®šä¹‰
jobs:
  # ä½œä¸šåç§°: æ„å»º
  build:
    # è¿è¡Œç¯å¢ƒ: Ubuntu 22.04
    runs-on: ubuntu-22.04

    # ä½œä¸šæ­¥éª¤
    steps:
    # æ­¥éª¤ 1: æ£€å‡ºå½“å‰ä»“åº“çš„ä»£ç 
    - name: Checkout
      uses: actions/checkout@v4

    # æ­¥éª¤ 2: åˆå§‹åŒ–æ„å»ºç¯å¢ƒ
    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        # æ¸…ç†ç³»ç»Ÿï¼Œé‡Šæ”¾ç©ºé—´
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        # æ›´æ–°åŒ…åˆ—è¡¨å¹¶å®‰è£…æ„å»ºä¾èµ–
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-2204)
        # æ¸…ç†ä¸éœ€è¦çš„åŒ…
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        # è®¾ç½®æ—¶åŒº
        sudo timedatectl set-timezone "$TZ"
        # åˆ›å»ºå¹¶è®¾ç½®å·¥ä½œç›®å½•æƒé™
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir
        # æ˜¾ç¤ºç£ç›˜ç©ºé—´
        df -hT

    # æ­¥éª¤ 3: å…‹éš† ImmortalWrt æºç 
    - name: Clone source code
      working-directory: /workdir
      run: |
        df -hT $GITHUB_WORKSPACE
        # å…‹éš†æŒ‡å®šåˆ†æ”¯çš„æºç 
        git clone $REPO_URL -b $REPO_BRANCH immortalwrt
        # åˆ›å»ºè½¯é“¾æ¥ï¼Œæ–¹ä¾¿åç»­æ­¥éª¤è®¿é—®
        ln -sf /workdir/immortalwrt $GITHUB_WORKSPACE/immortalwrt

    # æ­¥éª¤ 4: åŠ è½½è‡ªå®šä¹‰ feeds é…ç½®
    - name: Load custom feeds
      run: |
        # å¦‚æœå­˜åœ¨è‡ªå®šä¹‰ feeds é…ç½®ï¼Œåˆ™å¤åˆ¶åˆ°æºç ç›®å½•
        [ -e $FEEDS_CONF ] && cp $FEEDS_CONF immortalwrt/feeds.conf.default
        # å¦‚æœå­˜åœ¨è‡ªå®šä¹‰è„šæœ¬1ï¼Œåˆ™åœ¨æºç ç›®å½•æ‰§è¡Œ
        [ -e $DIY_P1_SH ] && cd immortalwrt && bash $GITHUB_WORKSPACE/$DIY_P1_SH

    # æ­¥éª¤ 5: å‡†å¤‡è‡ªå®šä¹‰è½¯ä»¶æºå’Œè½¯ä»¶åŒ… (æ ¸å¿ƒä¿®æ­£æ­¥éª¤)
    - name: Prepare custom feeds and packages
      id: customfeeds
      run: |
        cd immortalwrt
        # æ‰§è¡Œ repo.sh è„šæœ¬ã€‚
        # æ­¤è„šæœ¬ç°åœ¨è´Ÿè´£ï¼š
        # 1. æ·»åŠ è‡ªå®šä¹‰è½¯ä»¶æºã€‚
        # 2. è¿è¡Œ 'feeds update -a' å’Œ 'feeds install -a'ã€‚
        # 3. å°†é€‰å®šçš„è½¯ä»¶åŒ…æ·»åŠ åˆ° .config æ–‡ä»¶ã€‚
        # 4. ç”Ÿæˆä¸€ä¸ªå˜æ›´æŠ¥å‘Šã€‚
        # æ³¨æ„ï¼šåŸå·¥ä½œæµä¸­çš„ "Update & Install Feeds" æ­¥éª¤å·²è¢«æ•´åˆåˆ°æ­¤è„šæœ¬ä¸­ã€‚
        bash $GITHUB_WORKSPACE/scripts/repo.sh

    # æ­¥éª¤ 6: åŠ è½½è‡ªå®šä¹‰å›ºä»¶é…ç½®
    - name: Load custom configuration
      run: |
        # å¦‚æœå­˜åœ¨ files ç›®å½•ï¼Œåˆ™ç§»åŠ¨åˆ°æºç ç›®å½•ï¼Œç”¨äºè¦†ç›–å›ºä»¶æ–‡ä»¶
        [ -e files ] && mv files immortalwrt/files
        # å¦‚æœå­˜åœ¨è‡ªå®šä¹‰å›ºä»¶é…ç½®ï¼Œåˆ™å¤åˆ¶åˆ°æºç ç›®å½•
        [ -e $CONFIG_FILE ] && cp $CONFIG_FILE immortalwrt/.config
        # å¦‚æœå­˜åœ¨è‡ªå®šä¹‰è„šæœ¬2ï¼Œåˆ™åœ¨æºç ç›®å½•æ‰§è¡Œ
        [ -e $DIY_P2_SH ] && cd immortalwrt && bash $GITHUB_WORKSPACE/$DIY_P2_SH

    # æ­¥éª¤ 7: å‡†å¤‡å†…æ ¸é…ç½®
    - name: Prepare kernel config
      run: |
        cd immortalwrt
        # å¤åˆ¶è‡ªå®šä¹‰çš„å†…æ ¸é…ç½®æ–‡ä»¶
        cp $GITHUB_WORKSPACE/kernel/ipq60xx.config target/linux/ipq60xx/config-6.1
        # è¿è¡Œ make defconfigã€‚
        # ä¸Šä¸€æ­¥ (repo.sh) å·²ç»ä¿®æ”¹äº† .configï¼Œæ­¤æ­¥éª¤ä¼šåŸºäºä¿®æ”¹åçš„ .config
        # è¿›è¡Œæœ€ç»ˆç¡®è®¤ï¼Œå¹¶è¡¥å…¨ç¼ºå¤±çš„ä¾èµ–é¡¹ï¼Œç”Ÿæˆæœ€ç»ˆçš„ã€å®Œæ•´çš„é…ç½®æ–‡ä»¶ã€‚
        make defconfig

    # æ­¥éª¤ 8: ä¸‹è½½æ‰€æœ‰è½¯ä»¶åŒ…æºç 
    - name: Download package
      id: package
      run: |
        cd immortalwrt
        make defconfig
        # ä¸‹è½½æ‰€æœ‰éœ€è¦çš„è½¯ä»¶åŒ…æºç 
        make download -j8
        # æŸ¥æ‰¾å¹¶åˆ é™¤ä¸‹è½½å¤±è´¥çš„å°æ–‡ä»¶ï¼Œé¿å…ç¼–è¯‘é”™è¯¯
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    # æ­¥éª¤ 9: ç¼–è¯‘å›ºä»¶
    - name: Compile the firmware
      id: compile
      run: |
        cd immortalwrt
        echo -e "$(nproc) thread compile"
        # ä½¿ç”¨æ‰€æœ‰CPUæ ¸å¿ƒè¿›è¡Œç¼–è¯‘ï¼Œå¦‚æœå¤±è´¥åˆ™å°è¯•å•æ ¸ç¼–è¯‘å¹¶è¾“å‡ºè¯¦ç»†æ—¥å¿—
        make -j$(nproc) || make -j1 || make -j1 V=s
        echo "status=success" >> $GITHUB_OUTPUT
        # ä» .config ä¸­æå–è®¾å¤‡åç§°ï¼Œç”¨äºåç»­æ–‡ä»¶å‘½å
        grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
        [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
        # ç”Ÿæˆæ—¶é—´æˆ³ï¼Œç”¨äºæ–‡ä»¶å‘½å
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    # æ­¥éª¤ 10: æ£€æŸ¥ç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ
    - name: Check space usage
      if: (!cancelled())
      run: df -hT

    # æ­¥éª¤ 11: ä¸Šä¼  bin ç›®å½• (ä½œä¸ºæ„å»ºäº§ç‰©)
    - name: Upload bin directory
      uses: actions/upload-artifact@v4
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
      with:
        name: ImmortalWrt_bin${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: immortalwrt/bin/

    # æ­¥éª¤ 12: æ•´ç†æœ€ç»ˆå›ºä»¶æ–‡ä»¶
    - name: Organize files
      id: organize
      if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        cd immortalwrt/bin/targets/*/*
        # åˆ é™¤ packages ç›®å½•ï¼Œåªä¿ç•™å›ºä»¶æœ¬èº«
        rm -rf packages
        # å°†å›ºä»¶æ‰€åœ¨è·¯å¾„è®¾ç½®ä¸ºç¯å¢ƒå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    # æ­¥éª¤ 13: ä¸Šä¼ æ•´ç†åçš„å›ºä»¶ç›®å½• (ä½œä¸ºæ„å»ºäº§ç‰©)
    - name: Upload firmware directory
      uses: actions/upload-artifact@v4
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: ImmortalWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}

    # æ­¥éª¤ 14: ä¸Šä¼ å›ºä»¶åˆ° Cowtransfer
    - name: Upload firmware to cowtransfer
      id: cowtransfer
      if: steps.organize.outputs.status == 'success' && env.UPLOAD_COWTRANSFER == 'true' && !cancelled()
      run: |
        curl -L https://cowtransfer.com/static/cowtransfer.sh -s | sudo bash -s upload -s -p ${{ env.FIRMWARE }} 2>&1 | tee cowtransfer.log
        echo "::warning file=cowtransfer.com::$(cat cowtransfer.log | grep https)"
        echo "url=$(cat cowtransfer.log | grep https | cut -f3 -d" ")" >> $GITHUB_OUTPUT

    # æ­¥éª¤ 15: ä¸Šä¼ å›ºä»¶åˆ° WeTransfer
    - name: Upload firmware to WeTransfer
      id: wetransfer
      if: steps.organize.outputs.status == 'success' && env.UPLOAD_WETRANSFER == 'true' && !cancelled()
      run: |
        curl -fsSL git.io/wetransfer.sh | bash -s ${{ env.FIRMWARE }} 2>&1 | tee wetransfer.log
        echo "::warning file=wetransfer.com::$(cat wetransfer.log | grep https)"
        echo "url=$(cat wetransfer.log | grep https | cut -f3 -d" ")" >> $GITHUB_OUTPUT

    # æ­¥éª¤ 16: ç”Ÿæˆ Release æ ‡ç­¾
    - name: Generate release tag
      id: tag
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        # ç”ŸæˆåŸºäºæ—¶é—´çš„æ ‡ç­¾
        echo "release_tag=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
        touch release.txt
        # å°†å…¶ä»–åˆ†äº«é“¾æ¥å†™å…¥ Release æ­£æ–‡
        [ ${{ steps.cowtransfer.outputs.url }} ] && echo "ğŸ”— [Cowtransfer](${{ steps.cowtransfer.outputs.url }})" >> release.txt
        [ ${{ steps.wetransfer.outputs.url }} ] && echo "ğŸ”— [WeTransfer](${{ steps.wetransfer.outputs.url }})" >> release.txt
        echo "status=success" >> $GITHUB_OUTPUT

    # æ­¥éª¤ 17: ä¸Šä¼ å›ºä»¶åˆ° GitHub Release
    - name: Upload firmware to release
      uses: softprops/action-gh-release@v2
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}${{ env.DEVICE_NAME }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*

    # æ­¥éª¤ 18: åˆ é™¤æ—§çš„ workflow è¿è¡Œè®°å½•
    - name: Delete workflow runs
      uses: GitRML/delete-workflow-runs@main
      with:
        retain_days: 1
        keep_minimum_runs: 3

    # æ­¥éª¤ 19: åˆ é™¤æ—§çš„ Release
    - name: Remove old Releases
      uses: dev-drprasad/delete-older-releases@v0.1.0
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
