name: IPQ60XX-Triple-Stage-Build

on:
  workflow_dispatch:
    inputs:
      repo_config:
        description: 'é€‰æ‹©è¦æž„å»ºçš„ä»“åº“ (ç•™ç©ºåˆ™æž„å»ºæ‰€æœ‰)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - openwrt
          - immwrt
          - libwrt
  workflow_call:

env:
  TZ: Asia/Shanghai
  OPENWRT_PATH: /mnt/openwrt
  CONFIG_BASE_DIR: configs
  DIY_SCRIPT_DIR: scripts
  CACHE_VERSION: v3
  LOG_LEVEL: INFO
  LOG_FILE: build.log
  REPORT_FILE: build_report.json

jobs:
  # ==================== é˜¶æ®µä¸€ï¼šå¹¶è¡Œæž„å»ºåŸºç¡€çŽ¯å¢ƒ ====================
  Build-Bases:
    if: github.event.inputs.repo_config == 'all' || github.event.inputs.repo_config == ''
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        repo_config: ['openwrt', 'immwrt', 'libwrt']
    
    outputs:
      repo_short_openwrt: ${{ steps.generate_vars.outputs.repo_short_openwrt }}
      repo_short_immwrt: ${{ steps.generate_vars.outputs.repo_short_immwrt }}
      repo_short_libwrt: ${{ steps.generate_vars.outputs.repo_short_libwrt }}

    steps:
    - name: åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ
      run: |
        cat > /tmp/logger.sh << 'EOF'
        #!/bin/bash
        declare -A LOG_LEVELS=([DEBUG]=0 [INFO]=1 [WARN]=2 [ERROR]=3)
        CURRENT_LEVEL=${LOG_LEVELS[$LOG_LEVEL]}
        LOG_FILE="$GITHUB_WORKSPACE/$LOG_FILE"
        REPORT_FILE="$GITHUB_WORKSPACE/$REPORT_FILE"
        echo "=== Build Log Started at $(date) ===" > "$LOG_FILE"
        echo '{"build_id":"base-'${{ matrix.repo_config }}'-$(date +%s)","start_time":"'$(date -Iseconds)'","steps":[],"errors":[],"warnings":[]}' > "$REPORT_FILE"
        log() { local level="$1" message="$2" step="${3:-$(caller | awk '{print $2}')}"; local timestamp=$(date '+%Y-%m-%d %H:%M:%S'); if [ ${LOG_LEVELS[$level]} -ge $CURRENT_LEVEL ]; then case $level in DEBUG) echo -e "\033[0;37m[$timestamp] [DEBUG] $message\033[0m" ;; INFO) echo -e "\033[0;34m[$timestamp] [INFO] $message\033[0m" ;; WARN) echo -e "\033[0;33m[$timestamp] [WARN] $message\033[0m" ;; ERROR) echo -e "\033[1;41;37m[$timestamp] [ERROR] $message\033[0m" ;; esac; echo "[$timestamp] [$level] [Step: $step] $message" >> "$LOG_FILE"; fi; }
        step_start() { local step_name="$1" description="$2"; log "INFO" "â–¶ å¼€å§‹æ‰§è¡Œ: $description" "$step_name"; }
        step_complete() { local step_name="$1" status="$2"; if [ "$status" = "success" ]; then log "INFO" "âœ… æ­¥éª¤å®Œæˆ: $step_name" "$step_name"; elif [ "$status" = "failed" ]; then log "ERROR" "âŒ æ­¥éª¤å¤±è´¥: $step_name" "$step_name"; fi; }
        export -f log step_start step_complete
        EOF
        chmod +x /tmp/logger.sh
        echo "LOGGER_SCRIPT=/tmp/logger.sh" >> $GITHUB_ENV
        source /tmp/logger.sh
        step_start "INIT" "åˆå§‹åŒ–åŸºç¡€çŽ¯å¢ƒæž„å»ºæ—¥å¿—"

    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è¯»å–ä»“åº“é…ç½®
      id: read_repo_config
      run: |
        source "$LOGGER_SCRIPT"
        step_start "READ_CONFIG" "è¯»å–ä»“åº“é…ç½® (${{ matrix.repo_config }})"
        REPO_CONFIG_FILE="${GITHUB_WORKSPACE}/${CONFIG_BASE_DIR}/repos.json"
        REPO_INFO=$(jq -r --arg repo "${{ matrix.repo_config }}" '.[$repo]' "$REPO_CONFIG_FILE")
        if [ "$REPO_INFO" = "null" ]; then log "ERROR" "æœªæ‰¾åˆ°ä»“åº“é…ç½®: ${{ matrix.repo_config }}"; exit 1; fi
        echo "REPO_URL=$(echo "$REPO_INFO" | jq -r '.url')" >> $GITHUB_ENV
        echo "REPO_BRANCH=$(echo "$REPO_INFO" | jq -r '.branch')" >> $GITHUB_ENV
        echo "REPO_SHORT=$(echo "$REPO_INFO" | jq -r '.short')" >> $GITHUB_ENV
        log "INFO" "ä»“åº“: ${{ matrix.repo_config }} ($REPO_URL)"
        step_complete "READ_CONFIG" "success"

    - name: å…‹éš†æºä»£ç 
      run: |
        source "$LOGGER_SCRIPT"
        step_start "CLONE" "å…‹éš†æºä»£ç "
        sudo mkdir -p "$OPENWRT_PATH" && sudo chown -R $(id -u):$(id -g) "$OPENWRT_PATH"
        git clone --depth 1 -b "$REPO_BRANCH" --single-branch "$REPO_URL" "$OPENWRT_PATH"
        step_complete "CLONE" "success"

    - name: ç”Ÿæˆå˜é‡å¹¶æ£€æŸ¥é…ç½®
      id: generate_vars
      run: |
        source "$LOGGER_SCRIPT"
        step_start "GEN_VARS" "ç”Ÿæˆæž„å»ºå˜é‡å¹¶æ£€æŸ¥é…ç½®"
        
        # å°è£…é…ç½®æ£€æŸ¥å‡½æ•°
        check_luci_packages() {
          local config_file="$1"
          local step_name="$2"
          
          # ç›´æŽ¥è¾“å‡ºåˆ°æŽ§åˆ¶å°ï¼Œä¸ä½¿ç”¨æŠ˜å 
          echo ""
          echo "=================================================================================="
          echo -e "\033[1;44;37m ðŸ” æ£€æŸ¥ $step_name é…ç½®ä¸­çš„ Luci è½¯ä»¶åŒ… \033[0m"
          echo "=================================================================================="
          echo -e "\033[1;36mé…ç½®æ–‡ä»¶: $config_file\033[0m"
          echo ""
          
          # è¯»å–é…ç½®æ–‡ä»¶ä¸­çš„luciè½¯ä»¶åŒ… (ä¿®å¤äº†æ­£åˆ™è¡¨è¾¾å¼)
          local luci_packages=$(grep -E "^CONFIG_PACKAGE_luci-.+=y" "$config_file" | sort || true)
          
          if [ -n "$luci_packages" ]; then
            echo -e "\033[1;32må‘çŽ°ä»¥ä¸‹ Luci è½¯ä»¶åŒ…:\033[0m"
            echo "$luci_packages" | sed 's/^CONFIG_PACKAGE_//' | sed 's/=y//' | while read pkg; do
              echo -e "  \033[0;32mâœ“ $pkg\033[0m"
              log "INFO" "  - $pkg"
            done
          else
            echo -e "\033[1;33m(æ—  Luci è½¯ä»¶åŒ…)\033[0m"
            log "INFO" "  (æ—  Luci è½¯ä»¶åŒ…)"
          fi
          echo "=================================================================================="
          echo ""
          
          # è¿”å›žluciè½¯ä»¶åŒ…åˆ—è¡¨
          echo "$luci_packages"
        }
        
        # å°è£…defconfigåŽæ£€æŸ¥å‡½æ•°
        check_defconfig_packages() {
          local before_packages="$1"
          local step_name="$2"
          
          echo ""
          echo "=================================================================================="
          echo -e "\033[1;44;37m ðŸ”§ è¿è¡Œ defconfig å¹¶æ£€æŸ¥ $step_name \033[0m"
          echo "=================================================================================="
          log "INFO" "è¿è¡Œ defconfig..."
          make defconfig > /dev/null 2>&1
          echo -e "\033[1;36mDefconfig å®Œæˆï¼Œæ­£åœ¨åˆ†æžè½¯ä»¶åŒ…å˜åŒ–...\033[0m"
          echo ""
          
          # è¯»å–defconfigåŽçš„luciè½¯ä»¶åŒ… (ä¿®å¤äº†æ­£åˆ™è¡¨è¾¾å¼)
          local after_packages=$(grep -E "^CONFIG_PACKAGE_luci-.+=y" .config | sort || true)
          
          echo -e "\033[1;32mDefconfigåŽçš„æœ€ç»ˆ Luci è½¯ä»¶åŒ…åˆ—è¡¨:\033[0m"
          if [ -n "$after_packages" ]; then
            echo "$after_packages" | sed 's/^CONFIG_PACKAGE_//' | sed 's/=y//' | while read pkg; do
              echo -e "  \033[0;32mâœ“ $pkg\033[0m"
              log "INFO" "  - $pkg"
            done
          else
            echo -e "\033[1;33m(æ—  Luci è½¯ä»¶åŒ…)\033[0m"
            log "INFO" "  (æ—  Luci è½¯ä»¶åŒ…)"
          fi
          
          # ç”Ÿæˆå¯¹æ¯”æŠ¥å‘Š - ä½¿ç”¨æ›´å¥å£®çš„grepå¾ªçŽ¯æ›¿ä»£comm
          echo ""
          echo -e "\033[1;34m------------------- è½¯ä»¶åŒ…å˜åŒ–åˆ†æž -------------------\033[0m"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°å¢žçš„è½¯ä»¶åŒ…
          local found_new=false
          echo "$after_packages" | sed 's/^CONFIG_PACKAGE_//' | sed 's/=y//' | while read pkg; do
            # ä¿®å¤ï¼šä½¿ç”¨å›ºå®šå­—ç¬¦ä¸²åŒ¹é…ï¼Œé¿å…æ­£åˆ™è¡¨è¾¾å¼é”™è¯¯
            if ! echo "$before_packages" | grep -Fq "CONFIG_PACKAGE_${pkg}=y"; then
              if [ "$found_new" = false ]; then
                echo -e "\033[1;32mðŸ” å‘çŽ°æ–°å¢žçš„ Luci è½¯ä»¶åŒ…:\033[0m"
                found_new=true
              fi
              echo -e "  \033[0;32mâœ… $pkg\033[0m"
              log "INFO" "  âœ… $pkg"
            fi
          done
          
          if [ "$found_new" = false ]; then
            echo -e "\033[1;37mâ„¹ï¸  æ— æ–°å¢žçš„ Luci è½¯ä»¶åŒ…\033[0m"
            log "INFO" "â„¹ï¸  æ— æ–°å¢žçš„Luciè½¯ä»¶åŒ…"
          fi
          
          echo ""
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ç¼ºå¤±çš„è½¯ä»¶åŒ…
          local found_missing=false
          echo "$before_packages" | while read pkg_line; do
            local pkg=$(echo "$pkg_line" | sed 's/^CONFIG_PACKAGE_//' | sed 's/=y//')
            # ä¿®å¤ï¼šä½¿ç”¨å›ºå®šå­—ç¬¦ä¸²åŒ¹é…ï¼Œé¿å…æ­£åˆ™è¡¨è¾¾å¼é”™è¯¯
            if ! echo "$after_packages" | grep -Fq "CONFIG_PACKAGE_${pkg}=y"; then
              if [ "$found_missing" = false ]; then
                echo -e "\033[1;31mâš ï¸  å‘çŽ°ç¼ºå¤±çš„ Luci è½¯ä»¶åŒ…:\033[0m"
                found_missing=true
              fi
              echo -e "  \033[0;31mâŒ $pkg\033[0m"
              log "WARN" "  âŒ $pkg"
            fi
          done
          
          if [ "$found_missing" = false ]; then
            echo -e "\033[1;37mâ„¹ï¸  æ— ç¼ºå¤±çš„ Luci è½¯ä»¶åŒ…\033[0m"
            log "INFO" "â„¹ï¸  æ— ç¼ºå¤±çš„Luciè½¯ä»¶åŒ…"
          else
            echo -e "\n\033[1;31mæ³¨æ„ï¼šç¼ºå¤±çš„è½¯ä»¶åŒ…å¯èƒ½æ˜¯å› ä¸ºä¾èµ–ä¸æ»¡è¶³æˆ–å·²è¢«ç§»é™¤\033[0m"
          fi
          
          echo "=================================================================================="
          echo ""
          
          # è¿”å›ždefconfigåŽçš„è½¯ä»¶åŒ…åˆ—è¡¨
          echo "$after_packages"
        }
        
        # å¯¼å‡ºå‡½æ•°ä¾›åŽç»­ä½¿ç”¨
        export -f check_luci_packages check_defconfig_packages
        
        find_config_file() { local base_name="$1"; local config_dir="${GITHUB_WORKSPACE}/${CONFIG_BASE_DIR}"; for ext in ".config" ".config.txt"; do if [ -f "${config_dir}/${base_name}${ext}" ]; then echo "${config_dir}/${base_name}${ext}"; return 0; fi; done; return 1; }
        
        # æŸ¥æ‰¾é…ç½®æ–‡ä»¶
        CONFIG_BASE=$(find_config_file "base_ipq60xx")
        CONFIG_BRANCH=$(find_config_file "base_${REPO_SHORT}")
        
        # æ£€æŸ¥åŸºç¡€é…ç½®
        BASE_LUCI=$(check_luci_packages "$CONFIG_BASE" "åŸºç¡€é…ç½®")
        
        # æ£€æŸ¥åˆ†æ”¯é…ç½®
        BRANCH_LUCI=$(check_luci_packages "$CONFIG_BRANCH" "åˆ†æ”¯é…ç½®")
        
        # åˆå¹¶é…ç½®æ–‡ä»¶
        log "INFO" "åˆå¹¶åŸºç¡€é…ç½®å’Œåˆ†æ”¯é…ç½®..."
        cat "$CONFIG_BASE" "$CONFIG_BRANCH" > .config
        
        # æ£€æŸ¥åˆå¹¶åŽçš„é…ç½®
        MERGED_LUCI=$(check_luci_packages ".config" "åˆå¹¶åŽé…ç½®")
        
        # è¿è¡Œdefconfigå¹¶æ£€æŸ¥
        FINAL_LUCI=$(check_defconfig_packages "$MERGED_LUCI" "åŸºç¡€çŽ¯å¢ƒ")
        
        # ä¸ºæ¯ä¸ªä»“åº“è®¾ç½®è¾“å‡ºå˜é‡
        if [ "${{ matrix.repo_config }}" = "openwrt" ]; then
          echo "repo_short_openwrt=${REPO_SHORT}" >> $GITHUB_OUTPUT
        elif [ "${{ matrix.repo_config }}" = "immwrt" ]; then
          echo "repo_short_immwrt=${REPO_SHORT}" >> $GITHUB_OUTPUT
        elif [ "${{ matrix.repo_config }}" = "libwrt" ]; then
          echo "repo_short_libwrt=${REPO_SHORT}" >> $GITHUB_OUTPUT
        fi
        
        # æå–è®¾å¤‡ä¿¡æ¯ï¼Œå¢žåŠ å¥å£®æ€§
        DEVICE_INFO=$(cat .config | grep "^CONFIG_TARGET_BOARD=" | awk -F '"' '{print $2}' || echo "æœªçŸ¥")
        if [ "$DEVICE_INFO" = "æœªçŸ¥" ]; then
          DEVICE_INFO=$(cat .config | grep "^CONFIG_TARGET_ARCH_PACKAGES=" | awk -F '"' '{print $2}' || echo "æœªçŸ¥")
        fi
        log "INFO" "è®¾å¤‡ä¿¡æ¯: $DEVICE_INFO"
        step_complete "GEN_VARS" "success"

    - name: ç¼“å­˜å·¥å…·é“¾å’ŒFeeds
      uses: actions/cache@v4
      with:
        key: ${{ env.CACHE_VERSION }}-base-${{ matrix.repo_config }}-${{ env.REPO_BRANCH }}-${{ hashFiles('**/feeds.conf.default') }}
        restore-keys: |
          ${{ env.CACHE_VERSION }}-base-${{ matrix.repo_config }}-${{ env.REPO_BRANCH }}-
          ${{ env.CACHE_VERSION }}-base-${{ matrix.repo_config }}-
        path: |
          ${{ env.OPENWRT_PATH }}/staging_dir
          ${{ env.OPENWRT_PATH }}/dl
          ${{ env.OPENWRT_PATH }}/feeds
          ${{ env.OPENWRT_PATH }}/build_dir

    - name: å‡†å¤‡æž„å»ºçŽ¯å¢ƒ
      run: |
        source "$LOGGER_SCRIPT"
        step_start "PREP_ENV" "å‡†å¤‡æž„å»ºçŽ¯å¢ƒ"
        cd "$OPENWRT_PATH"
        
        # æ›´æ–°feeds
        log "INFO" "æ›´æ–°feeds..."
        ./scripts/feeds update -a
        
        # å®‰è£…feeds
        log "INFO" "å®‰è£…feeds..."
        ./scripts/feeds install -a
        
        # æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬
        if [ -f "${{ env.DIY_SCRIPT_DIR }}/diy.sh" ]; then 
          log "INFO" "æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬..."
          chmod +x "${{ env.DIY_SCRIPT_DIR }}/diy.sh" && "${{ env.DIY_SCRIPT_DIR }}/diy.sh"
        fi
        
        # å†æ¬¡è¿è¡Œdefconfigç¡®ä¿æ‰€æœ‰ä¾èµ–æ­£ç¡®è§£æž
        log "INFO" "è¿è¡Œdefconfigè§£æžä¾èµ–..."
        make defconfig
        
        step_complete "PREP_ENV" "success"

    - name: ç¼–è¯‘åŸºç¡€çŽ¯å¢ƒï¼ˆå¹¶è¡Œæ¨¡å¼ï¼‰
      id: compile_base_parallel
      continue-on-error: true
      run: |
        source "$LOGGER_SCRIPT"
        step_start "COMPILE_BASE_PARALLEL" "ç¼–è¯‘åŸºç¡€çŽ¯å¢ƒï¼ˆå¹¶è¡Œæ¨¡å¼ï¼‰"
        cd "$OPENWRT_PATH"
        
        # è®¾ç½®ç¼–è¯‘æ—¥å¿—æ–‡ä»¶
        BUILD_LOG="$GITHUB_WORKSPACE/build_parallel.log"
        
        # å°è¯•å¹¶è¡Œç¼–è¯‘
        log "INFO" "å¼€å§‹å¹¶è¡Œç¼–è¯‘åŸºç¡€çŽ¯å¢ƒ..."
        if make -j$(nproc) > "$BUILD_LOG" 2>&1; then
          log "INFO" "å¹¶è¡Œç¼–è¯‘æˆåŠŸ"
          echo "status=success" >> $GITHUB_OUTPUT
          step_complete "COMPILE_BASE_PARALLEL" "success"
        else
          log "ERROR" "å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œå°†å°è¯•å•çº¿ç¨‹ç¼–è¯‘"
          echo "status=failed" >> $GITHUB_OUTPUT
          step_complete "COMPILE_BASE_PARALLEL" "failed"
          exit 1
        fi

    - name: ç¼–è¯‘åŸºç¡€çŽ¯å¢ƒï¼ˆå•çº¿ç¨‹æ¨¡å¼ï¼‰
      id: compile_base_serial
      if: steps.compile_base_parallel.outcome == 'failure'
      run: |
        source "$LOGGER_SCRIPT"
        step_start "COMPILE_BASE_SERIAL" "ç¼–è¯‘åŸºç¡€çŽ¯å¢ƒï¼ˆå•çº¿ç¨‹è¯¦ç»†æ¨¡å¼ï¼‰"
        cd "$OPENWRT_PATH"
        
        # è®¾ç½®ç¼–è¯‘æ—¥å¿—æ–‡ä»¶
        BUILD_LOG="$GITHUB_WORKSPACE/build_serial.log"
        
        # å°è¯•å•çº¿ç¨‹è¯¦ç»†ç¼–è¯‘
        log "INFO" "å¼€å§‹å•çº¿ç¨‹è¯¦ç»†ç¼–è¯‘åŸºç¡€çŽ¯å¢ƒ..."
        if make -j1 V=s > "$BUILD_LOG" 2>&1; then
          log "INFO" "å•çº¿ç¨‹ç¼–è¯‘æˆåŠŸ"
          echo "status=success" >> $GITHUB_OUTPUT
          step_complete "COMPILE_BASE_SERIAL" "success"
        else
          log "ERROR" "å•çº¿ç¨‹ç¼–è¯‘ä¹Ÿå¤±è´¥äº†"
          
          # æå–æœ€åŽå‡ è¡Œé”™è¯¯ä¿¡æ¯
          log "ERROR" "ç¼–è¯‘é”™è¯¯è¯¦æƒ…ï¼ˆæœ€åŽ20è¡Œï¼‰ï¼š"
          tail -20 "$BUILD_LOG" | while read line; do
            log "ERROR" "$line"
          done
          
          echo "status=failed" >> $GITHUB_OUTPUT
          step_complete "COMPILE_BASE_SERIAL" "failed"
          exit 1
        fi

    - name: ä¸Šä¼ æž„å»ºæ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ matrix.repo_config }}
        path: |
          ${{ github.workspace }}/build_parallel.log
          ${{ github.workspace }}/build_serial.log
        retention-days: 7

    - name: ä¸Šä¼ åŸºç¡€çŽ¯å¢ƒ
      if: steps.compile_base_parallel.outcome == 'success' || steps.compile_base_serial.outcome == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: base-env-${{ matrix.repo_config }}
        path: ${{ env.OPENWRT_PATH }}
        retention-days: 7

  # ==================== é˜¶æ®µäºŒï¼šé›†ä¸­é¢„ç¼–è¯‘é€šç”¨è½¯ä»¶åŒ… ====================
  Prebuild-Packages:
    needs: Build-Bases
    runs-on: ubuntu-22.04
    steps:
    - name: åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ
      run: |
        cat > /tmp/logger.sh << 'EOF'
        #!/bin/bash
        declare -A LOG_LEVELS=([DEBUG]=0 [INFO]=1 [WARN]=2 [ERROR]=3)
        CURRENT_LEVEL=${LOG_LEVELS[$LOG_LEVEL]}
        LOG_FILE="$GITHUB_WORKSPACE/$LOG_FILE"
        REPORT_FILE="$GITHUB_WORKSPACE/$REPORT_FILE"
        echo "=== Prebuild Log Started at $(date) ===" > "$LOG_FILE"
        echo '{"build_id":"prebuild-$(date +%s)","start_time":"'$(date -Iseconds)'","steps":[],"errors":[],"warnings":[]}' > "$REPORT_FILE"
        log() { local level="$1" message="$2" step="${3:-$(caller | awk '{print $2}')}"; local timestamp=$(date '+%Y-%m-%d %H:%M:%S'); if [ ${LOG_LEVELS[$level]} -ge $CURRENT_LEVEL ]; then case $level in DEBUG) echo -e "\033[0;37m[$timestamp] [DEBUG] $message\033[0m" ;; INFO) echo -e "\033[0;34m[$timestamp] [INFO] $message\033[0m" ;; WARN) echo -e "\033[0;33m[$timestamp] [WARN] $message\033[0m" ;; ERROR) echo -e "\033[1;41;37m[$timestamp] [ERROR] $message\033[0m" ;; esac; echo "[$timestamp] [$level] [Step: $step] $message" >> "$LOG_FILE"; fi; }
        step_start() { local step_name="$1" description="$2"; log "INFO" "â–¶ å¼€å§‹æ‰§è¡Œ: $description" "$step_name"; }
        step_complete() { local step_name="$1" status="$2"; if [ "$status" = "success" ]; then log "INFO" "âœ… æ­¥éª¤å®Œæˆ: $step_name" "$step_name"; elif [ "$status" = "failed" ]; then log "ERROR" "âŒ æ­¥éª¤å¤±è´¥: $step_name" "$step_name"; fi; }
        export -f log step_start step_complete
        EOF
        chmod +x /tmp/logger.sh
        echo "LOGGER_SCRIPT=/tmp/logger.sh" >> $GITHUB_ENV
        source /tmp/logger.sh
        step_start "INIT" "åˆå§‹åŒ–é¢„ç¼–è¯‘æž„å»ºæ—¥å¿—"

    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ä¸‹è½½åŸºç¡€çŽ¯å¢ƒ
      uses: actions/download-artifact@v4
      with:
        name: base-env-openwrt
        path: ${{ env.OPENWRT_PATH }}

    - name: ç”Ÿæˆ"è¶…çº§é…ç½®"å¹¶æ£€æŸ¥
      id: generate_super_config
      run: |
        source "$LOGGER_SCRIPT"
        step_start "GEN_SUPER_CONFIG" "ç”ŸæˆåŒ…å«æ‰€æœ‰å˜ä½“è½¯ä»¶åŒ…çš„è¶…çº§é…ç½®"
        cd "$OPENWRT_PATH"
        
        # å°è£…é…ç½®æ£€æŸ¥å‡½æ•° (ä¸Žé˜¶æ®µä¸€ç›¸åŒ)
        check_luci_packages() {
          local config_file="$1"
          local step_name="$2"
          echo ""
          echo "=================================================================================="
          echo -e "\033[1;44;37m ðŸ” æ£€æŸ¥ $step_name é…ç½®ä¸­çš„ Luci è½¯ä»¶åŒ… \033[0m"
          echo "=================================================================================="
          echo -e "\033[1;36mé…ç½®æ–‡ä»¶: $config_file\033[0m"
          echo ""
          local luci_packages=$(grep -E "^CONFIG_PACKAGE_luci-.+=y" "$config_file" | sort || true)
          if [ -n "$luci_packages" ]; then
            echo -e "\033[1;32må‘çŽ°ä»¥ä¸‹ Luci è½¯ä»¶åŒ…:\033[0m"
            echo "$luci_packages" | sed 's/^CONFIG_PACKAGE_//' | sed 's/=y//' | while read pkg; do
              echo -e "  \033[0;32mâœ“ $pkg\033[0m"
              log "INFO" "  - $pkg"
            done
          else
            echo -e "\033[1;33m(æ—  Luci è½¯ä»¶åŒ…)\033[0m"
            log "INFO" "  (æ—  Luci è½¯ä»¶åŒ…)"
          fi
          echo "=================================================================================="
          echo ""
          echo "$luci_packages"
        }
        
        check_defconfig_packages() {
          local before_packages="$1"
          local step_name="$2"
          echo ""
          echo "=================================================================================="
          echo -e "\033[1;44;37m ðŸ”§ è¿è¡Œ defconfig å¹¶æ£€æŸ¥ $step_name \033[0m"
          echo "=================================================================================="
          log "INFO" "è¿è¡Œ defconfig..."
          make defconfig > /dev/null 2>&1
          echo -e "\033[1;36mDefconfig å®Œæˆï¼Œæ­£åœ¨åˆ†æžè½¯ä»¶åŒ…å˜åŒ–...\033[0m"
          echo ""
          local after_packages=$(grep -E "^CONFIG_PACKAGE_luci-.+=y" .config | sort || true)
          echo -e "\033[1;32mDefconfigåŽçš„æœ€ç»ˆ Luci è½¯ä»¶åŒ…åˆ—è¡¨:\033[0m"
          if [ -n "$after_packages" ]; then
            echo "$after_packages" | sed 's/^CONFIG_PACKAGE_//' | sed 's/=y//' | while read pkg; do
              echo -e "  \033[0;32mâœ“ $pkg\033[0m"
              log "INFO" "  - $pkg"
            done
          else
            echo -e "\033[1;33m(æ—  Luci è½¯ä»¶åŒ…)\033[0m"
            log "INFO" "  (æ—  Luci è½¯ä»¶åŒ…)"
          fi
          echo ""
          echo -e "\033[1;34m------------------- è½¯ä»¶åŒ…å˜åŒ–åˆ†æž -------------------\033[0m"
          local found_new=false
          echo "$after_packages" | sed 's/^CONFIG_PACKAGE_//' | sed 's/=y//' | while read pkg; do
            if ! echo "$before_packages" | grep -Fq "CONFIG_PACKAGE_${pkg}=y"; then
              if [ "$found_new" = false ]; then
                echo -e "\033[1;32mðŸ” å‘çŽ°æ–°å¢žçš„ Luci è½¯ä»¶åŒ…:\033[0m"
                found_new=true
              fi
              echo -e "  \033[0;32mâœ… $pkg\033[0m"
              log "INFO" "  âœ… $pkg"
            fi
          done
          if [ "$found_new" = false ]; then
            echo -e "\033[1;37mâ„¹ï¸  æ— æ–°å¢žçš„ Luci è½¯ä»¶åŒ…\033[0m"
            log "INFO" "â„¹ï¸  æ— æ–°å¢žçš„Luciè½¯ä»¶åŒ…"
          fi
          echo ""
          local found_missing=false
          echo "$before_packages" | while read pkg_line; do
            local pkg=$(echo "$pkg_line" | sed 's/^CONFIG_PACKAGE_//' | sed 's/=y//')
            if ! echo "$after_packages" | grep -Fq "CONFIG_PACKAGE_${pkg}=y"; then
              if [ "$found_missing" = false ]; then
                echo -e "\033[1;31mâš ï¸  å‘çŽ°ç¼ºå¤±çš„ Luci è½¯ä»¶åŒ…:\033[0m"
                found_missing=true
              fi
              echo -e "  \033[0;31mâŒ $pkg\033[0m"
              log "WARN" "  âŒ $pkg"
            fi
          done
          if [ "$found_missing" = false ]; then
            echo -e "\033[1;37mâ„¹ï¸  æ— ç¼ºå¤±çš„ Luci è½¯ä»¶åŒ…\033[0m"
            log "INFO" "â„¹ï¸  æ— ç¼ºå¤±çš„Luciè½¯ä»¶åŒ…"
          else
            echo -e "\n\033[1;31mæ³¨æ„ï¼šç¼ºå¤±çš„è½¯ä»¶åŒ…å¯èƒ½æ˜¯å› ä¸ºä¾èµ–ä¸æ»¡è¶³æˆ–å·²è¢«ç§»é™¤\033[0m"
          fi
          echo "=================================================================================="
          echo ""
          echo "$after_packages"
        }
        
        export -f check_luci_packages check_defconfig_packages
        
        # åˆ›å»ºåŸºç¡€é…ç½®
        echo "CONFIG_TARGET_ipq60xx=y" > .config
        echo "CONFIG_TARGET_ipq60xx_DEVICE_generic=y" >> .config
        echo "CONFIG_TARGET_DEVICE_ipq60xx_generic=y" >> .config
        
        # æ£€æŸ¥åŸºç¡€é…ç½®
        BASE_LUCI=$(check_luci_packages ".config" "åŸºç¡€é…ç½®")
        
        # åˆå¹¶æ‰€æœ‰å˜ä½“é…ç½®
        for variant in Pro Max Ultra; do
          log "INFO" "åˆå¹¶ $variant é…ç½®"
          if [ -f "${{ env.CONFIG_BASE_DIR }}/${variant}.config" ]; then
            # æ£€æŸ¥å˜ä½“é…ç½®
            VARIANT_LUCI=$(check_luci_packages "${{ env.CONFIG_BASE_DIR }}/${variant}.config" "$variant é…ç½®")
            # åˆå¹¶é…ç½®æ–‡ä»¶
            cat "${{ env.CONFIG_BASE_DIR }}/${variant}.config" >> .config
          else
            log "WARN" "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: ${{ env.CONFIG_BASE_DIR }}/${variant}.config"
          fi
        done
        
        # æ£€æŸ¥åˆå¹¶åŽçš„é…ç½®
        MERGED_LUCI=$(check_luci_packages ".config" "è¶…çº§é…ç½®åˆå¹¶åŽ")
        
        # è¿è¡Œdefconfigå¹¶æ£€æŸ¥
        FINAL_LUCI=$(check_defconfig_packages "$MERGED_LUCI" "è¶…çº§é…ç½®")
        
        log "INFO" "è¶…çº§é…ç½®ç”Ÿæˆå®Œæˆ"
        step_complete "GEN_SUPER_CONFIG" "success"

    - name: ç¼“å­˜é¢„ç¼–è¯‘è½¯ä»¶åŒ…
      uses: actions/cache@v4
      with:
        key: ${{ env.CACHE_VERSION }}-prebuilt-packages-ipq60xx-${{ hashFiles('configs/Pro.config', 'configs/Max.config', 'configs/Ultra.config') }}
        path: |
          ${{ env.OPENWRT_PATH }}/staging_dir
          ${{ env.OPENWRT_PATH }}/build_dir
          ${{ env.OPENWRT_PATH }}/dl

    - name: é¢„ç¼–è¯‘æ‰€æœ‰ç¬¬ä¸‰æ–¹è½¯ä»¶åŒ…ï¼ˆå¹¶è¡Œæ¨¡å¼ï¼‰
      id: prebuild_parallel
      continue-on-error: true
      run: |
        source "$LOGGER_SCRIPT"
        step_start "PREBUILD_PKGS_PARALLEL" "é¢„ç¼–è¯‘æ‰€æœ‰ç¬¬ä¸‰æ–¹è½¯ä»¶åŒ…ï¼ˆå¹¶è¡Œæ¨¡å¼ï¼‰"
        cd "$OPENWRT_PATH"
        
        # è®¾ç½®ç¼–è¯‘æ—¥å¿—æ–‡ä»¶
        BUILD_LOG="$GITHUB_WORKSPACE/prebuild_parallel.log"
        
        # æå–æ‰€æœ‰ luci-å¼€å¤´çš„åŒ…
        PACKAGES=$(grep -E "^CONFIG_PACKAGE_luci-.+=y" .config | sed 's/CONFIG_PACKAGE_//' | sed 's/=y//' | tr '\n' ' ')
        if [ -z "$PACKAGES" ]; then
          log "WARN" "æœªæ‰¾åˆ°éœ€è¦é¢„ç¼–è¯‘çš„ Luci è½¯ä»¶åŒ…ï¼Œè·³è¿‡ç¼–è¯‘ã€‚"
          echo "status=success" >> $GITHUB_OUTPUT
          step_complete "PREBUILD_PKGS_PARALLEL" "success"
        else
          log "INFO" "å³å°†é¢„ç¼–è¯‘çš„è½¯ä»¶åŒ…: $PACKAGES"
          if make -j$(nproc) $PACKAGES > "$BUILD_LOG" 2>&1; then
            log "INFO" "å¹¶è¡Œé¢„ç¼–è¯‘æˆåŠŸ"
            echo "status=success" >> $GITHUB_OUTPUT
            step_complete "PREBUILD_PKGS_PARALLEL" "success"
          else
            log "ERROR" "å¹¶è¡Œé¢„ç¼–è¯‘å¤±è´¥ï¼Œå°†å°è¯•å•çº¿ç¨‹ç¼–è¯‘"
            echo "status=failed" >> $GITHUB_OUTPUT
            step_complete "PREBUILD_PKGS_PARALLEL" "failed"
            exit 1
          fi
        fi

    - name: é¢„ç¼–è¯‘æ‰€æœ‰ç¬¬ä¸‰æ–¹è½¯ä»¶åŒ…ï¼ˆå•çº¿ç¨‹æ¨¡å¼ï¼‰
      id: prebuild_serial
      if: steps.prebuild_parallel.outcome == 'failure'
      run: |
        source "$LOGGER_SCRIPT"
        step_start "PREBUILD_PKGS_SERIAL" "é¢„ç¼–è¯‘æ‰€æœ‰ç¬¬ä¸‰æ–¹è½¯ä»¶åŒ…ï¼ˆå•çº¿ç¨‹è¯¦ç»†æ¨¡å¼ï¼‰"
        cd "$OPENWRT_PATH"
        
        # è®¾ç½®ç¼–è¯‘æ—¥å¿—æ–‡ä»¶
        BUILD_LOG="$GITHUB_WORKSPACE/prebuild_serial.log"
        
        # æå–æ‰€æœ‰ luci-å¼€å¤´çš„åŒ…
        PACKAGES=$(grep -E "^CONFIG_PACKAGE_luci-.+=y" .config | sed 's/CONFIG_PACKAGE_//' | sed 's/=y//' | tr '\n' ' ')
        
        log "INFO" "å¼€å§‹å•çº¿ç¨‹è¯¦ç»†é¢„ç¼–è¯‘è½¯ä»¶åŒ…: $PACKAGES"
        if make -j1 V=s $PACKAGES > "$BUILD_LOG" 2>&1; then
          log "INFO" "å•çº¿ç¨‹é¢„ç¼–è¯‘æˆåŠŸ"
          echo "status=success" >> $GITHUB_OUTPUT
          step_complete "PREBUILD_PKGS_SERIAL" "success"
        else
          log "ERROR" "å•çº¿ç¨‹é¢„ç¼–è¯‘ä¹Ÿå¤±è´¥äº†"
          
          # æå–æœ€åŽå‡ è¡Œé”™è¯¯ä¿¡æ¯
          log "ERROR" "é¢„ç¼–è¯‘é”™è¯¯è¯¦æƒ…ï¼ˆæœ€åŽ20è¡Œï¼‰ï¼š"
          tail -20 "$BUILD_LOG" | while read line; do
            log "ERROR" "$line"
          done
          
          echo "status=failed" >> $GITHUB_OUTPUT
          step_complete "PREBUILD_PKGS_SERIAL" "failed"
          exit 1
        fi

    - name: ä¸Šä¼ é¢„ç¼–è¯‘æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: prebuild-logs
        path: |
          ${{ github.workspace }}/prebuild_parallel.log
          ${{ github.workspace }}/prebuild_serial.log
        retention-days: 7

    - name: ä¸Šä¼ é¢„ç¼–è¯‘è½¯ä»¶åŒ…
      if: steps.prebuild_parallel.outcome == 'success' || steps.prebuild_serial.outcome == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: prebuilt-packages-ipq60xx
        path: ${{ env.OPENWRT_PATH }}/staging_dir
        retention-days: 7

  # ==================== é˜¶æ®µä¸‰ï¼šå¹¶è¡Œç»„è£…å˜ä½“å›ºä»¶ ====================
  Assemble-Variants:
    needs: [Build-Bases, Prebuild-Packages]
    if: success() && needs.Prebuild-Packages.result == 'success'
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        repo: ['openwrt', 'immwrt', 'libwrt']
        variant: ['Pro', 'Max', 'Ultra']
    
    steps:
    - name: åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ
      run: |
        cat > /tmp/logger.sh << 'EOF'
        #!/bin/bash
        declare -A LOG_LEVELS=([DEBUG]=0 [INFO]=1 [WARN]=2 [ERROR]=3)
        CURRENT_LEVEL=${LOG_LEVELS[$LOG_LEVEL]}
        LOG_FILE="$GITHUB_WORKSPACE/$LOG_FILE"
        REPORT_FILE="$GITHUB_WORKSPACE/$REPORT_FILE"
        echo "=== Variant Log Started at $(date) ===" > "$LOG_FILE"
        echo '{"build_id":"variant-${{ matrix.repo }}-${{ matrix.variant }}-$(date +%s)","start_time":"'$(date -Iseconds)'","steps":[],"errors":[],"warnings":[]}' > "$REPORT_FILE"
        log() { local level="$1" message="$2" step="${3:-$(caller | awk '{print $2}')}"; local timestamp=$(date '+%Y-%m-%d %H:%M:%S'); if [ ${LOG_LEVELS[$level]} -ge $CURRENT_LEVEL ]; then case $level in DEBUG) echo -e "\033[0;37m[$timestamp] [DEBUG] $message\033[0m" ;; INFO) echo -e "\033[0;34m[$timestamp] [INFO] $message\033[0m" ;; WARN) echo -e "\033[0;33m[$timestamp] [WARN] $message\033[0m" ;; ERROR) echo -e "\033[1;41;37m[$timestamp] [ERROR] $message\033[0m" ;; esac; echo "[$timestamp] [$level] [Step: $step] $message" >> "$LOG_FILE"; fi; }
        step_start() { local step_name="$1" description="$2"; log "INFO" "â–¶ å¼€å§‹æ‰§è¡Œ: $description" "$step_name"; }
        step_complete() { local step_name="$1" status="$2"; if [ "$status" = "success" ]; then log "INFO" "âœ… æ­¥éª¤å®Œæˆ: $step_name" "$step_name"; elif [ "$status" = "failed" ]; then log "ERROR" "âŒ æ­¥éª¤å¤±è´¥: $step_name" "$step_name"; fi; }
        export -f log step_start step_complete
        EOF
        chmod +x /tmp/logger.sh
        echo "LOGGER_SCRIPT=/tmp/logger.sh" >> $GITHUB_ENV
        source /tmp/logger.sh
        step_start "INIT" "åˆå§‹åŒ–å˜ä½“ç»„è£…æ—¥å¿— (${{ matrix.repo }}-${{ matrix.variant }})"

    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ä¸‹è½½åŸºç¡€çŽ¯å¢ƒ
      uses: actions/download-artifact@v4
      with:
        name: base-env-${{ matrix.repo }}
        path: ${{ env.OPENWRT_PATH }}

    - name: ä¸‹è½½é¢„ç¼–è¯‘è½¯ä»¶åŒ…
      uses: actions/download-artifact@v4
      with:
        name: prebuilt-packages-ipq60xx
        path: ${{ env.OPENWRT_PATH }}/staging_dir # è¦†ç›–staging_dir

    - name: å‡†å¤‡å˜ä½“é…ç½®å¹¶æ£€æŸ¥
      run: |
        source "$LOGGER_SCRIPT"
        step_start "PREP_VARIANT" "å‡†å¤‡å˜ä½“é…ç½® (${{ matrix.variant }})"
        cd "$OPENWRT_PATH"
        
        # å°è£…é…ç½®æ£€æŸ¥å‡½æ•° (ä¸Žé˜¶æ®µä¸€ç›¸åŒ)
        check_luci_packages() {
          local config_file="$1"
          local step_name="$2"
          echo ""
          echo "=================================================================================="
          echo -e "\033[1;44;37m ðŸ” æ£€æŸ¥ $step_name é…ç½®ä¸­çš„ Luci è½¯ä»¶åŒ… \033[0m"
          echo "=================================================================================="
          echo -e "\033[1;36mé…ç½®æ–‡ä»¶: $config_file\033[0m"
          echo ""
          local luci_packages=$(grep -E "^CONFIG_PACKAGE_luci-.+=y" "$config_file" | sort || true)
          if [ -n "$luci_packages" ]; then
            echo -e "\033[1;32må‘çŽ°ä»¥ä¸‹ Luci è½¯ä»¶åŒ…:\033[0m"
            echo "$luci_packages" | sed 's/^CONFIG_PACKAGE_//' | sed 's/=y//' | while read pkg; do
              echo -e "  \033[0;32mâœ“ $pkg\033[0m"
              log "INFO" "  - $pkg"
            done
          else
            echo -e "\033[1;33m(æ—  Luci è½¯ä»¶åŒ…)\033[0m"
            log "INFO" "  (æ—  Luci è½¯ä»¶åŒ…)"
          fi
          echo "=================================================================================="
          echo ""
          echo "$luci_packages"
        }
        
        check_defconfig_packages() {
          local before_packages="$1"
          local step_name="$2"
          echo ""
          echo "=================================================================================="
          echo -e "\033[1;44;37m ðŸ”§ è¿è¡Œ defconfig å¹¶æ£€æŸ¥ $step_name \033[0m"
          echo "=================================================================================="
          log "INFO" "è¿è¡Œ defconfig..."
          make defconfig > /dev/null 2>&1
          echo -e "\033[1;36mDefconfig å®Œæˆï¼Œæ­£åœ¨åˆ†æžè½¯ä»¶åŒ…å˜åŒ–...\033[0m"
          echo ""
          local after_packages=$(grep -E "^CONFIG_PACKAGE_luci-.+=y" .config | sort || true)
          echo -e "\033[1;32mDefconfigåŽçš„æœ€ç»ˆ Luci è½¯ä»¶åŒ…åˆ—è¡¨:\033[0m"
          if [ -n "$after_packages" ]; then
            echo "$after_packages" | sed 's/^CONFIG_PACKAGE_//' | sed 's/=y//' | while read pkg; do
              echo -e "  \033[0;32mâœ“ $pkg\033[0m"
              log "INFO" "  - $pkg"
            done
          else
            echo -e "\033[1;33m(æ—  Luci è½¯ä»¶åŒ…)\033[0m"
            log "INFO" "  (æ—  Luci è½¯ä»¶åŒ…)"
          fi
          echo ""
          echo -e "\033[1;34m------------------- è½¯ä»¶åŒ…å˜åŒ–åˆ†æž -------------------\033[0m"
          local found_new=false
          echo "$after_packages" | sed 's/^CONFIG_PACKAGE_//' | sed 's/=y//' | while read pkg; do
            if ! echo "$before_packages" | grep -Fq "CONFIG_PACKAGE_${pkg}=y"; then
              if [ "$found_new" = false ]; then
                echo -e "\033[1;32mðŸ” å‘çŽ°æ–°å¢žçš„ Luci è½¯ä»¶åŒ…:\033[0m"
                found_new=true
              fi
              echo -e "  \033[0;32mâœ… $pkg\033[0m"
              log "INFO" "  âœ… $pkg"
            fi
          done
          if [ "$found_new" = false ]; then
            echo -e "\033[1;37mâ„¹ï¸  æ— æ–°å¢žçš„ Luci è½¯ä»¶åŒ…\033[0m"
            log "INFO" "â„¹ï¸  æ— æ–°å¢žçš„Luciè½¯ä»¶åŒ…"
          fi
          echo ""
          local found_missing=false
          echo "$before_packages" | while read pkg_line; do
            local pkg=$(echo "$pkg_line" | sed 's/^CONFIG_PACKAGE_//' | sed 's/=y//')
            if ! echo "$after_packages" | grep -Fq "CONFIG_PACKAGE_${pkg}=y"; then
              if [ "$found_missing" = false ]; then
                echo -e "\033[1;31mâš ï¸  å‘çŽ°ç¼ºå¤±çš„ Luci è½¯ä»¶åŒ…:\033[0m"
                found_missing=true
              fi
              echo -e "  \033[0;31mâŒ $pkg\033[0m"
              log "WARN" "  âŒ $pkg"
            fi
          done
          if [ "$found_missing" = false ]; then
            echo -e "\033[1;37mâ„¹ï¸  æ— ç¼ºå¤±çš„ Luci è½¯ä»¶åŒ…\033[0m"
            log "INFO" "â„¹ï¸  æ— ç¼ºå¤±çš„Luciè½¯ä»¶åŒ…"
          else
            echo -e "\n\033[1;31mæ³¨æ„ï¼šç¼ºå¤±çš„è½¯ä»¶åŒ…å¯èƒ½æ˜¯å› ä¸ºä¾èµ–ä¸æ»¡è¶³æˆ–å·²è¢«ç§»é™¤\033[0m"
          fi
          echo "=================================================================================="
          echo ""
          echo "$after_packages"
        }
        
        export -f check_luci_packages check_defconfig_packages
        
        find_config_file() { local base_name="$1"; local config_dir="${GITHUB_WORKSPACE}/${CONFIG_BASE_DIR}"; for ext in ".config" ".config.txt"; do if [ -f "${config_dir}/${base_name}${ext}" ]; then echo "${config_dir}/${base_name}${ext}"; return 0; fi; done; return 1; }
        
        # æŸ¥æ‰¾é…ç½®æ–‡ä»¶
        CONFIG_BASE=$(find_config_file "base_ipq60xx")
        CONFIG_VARIANT=$(find_config_file "${{ matrix.variant }}")
        
        # æ£€æŸ¥åŸºç¡€é…ç½®
        BASE_LUCI=$(check_luci_packages "$CONFIG_BASE" "åŸºç¡€é…ç½®")
        
        # æ£€æŸ¥å˜ä½“é…ç½®
        VARIANT_LUCI=$(check_luci_packages "$CONFIG_VARIANT" "${{ matrix.variant }} é…ç½®")
        
        # åˆå¹¶é…ç½®æ–‡ä»¶
        cat "$CONFIG_BASE" "$CONFIG_VARIANT" > .config.tmp && mv .config.tmp .config
        
        # æ£€æŸ¥åˆå¹¶åŽçš„é…ç½®
        MERGED_LUCI=$(check_luci_packages ".config" "å˜ä½“åˆå¹¶åŽé…ç½®")
        
        # è¿è¡Œdefconfigå¹¶æ£€æŸ¥
        FINAL_LUCI=$(check_defconfig_packages "$MERGED_LUCI" "å˜ä½“ ${{ matrix.variant }}")
        
        step_complete "PREP_VARIANT" "success"

    - name: ç»„è£…å›ºä»¶ï¼ˆå¹¶è¡Œæ¨¡å¼ï¼‰
      id: assemble_parallel
      continue-on-error: true
      run: |
        source "$LOGGER_SCRIPT"
        step_start "ASSEMBLE_FIRMWARE_PARALLEL" "ç»„è£…æœ€ç»ˆå›ºä»¶ï¼ˆå¹¶è¡Œæ¨¡å¼ï¼‰"
        cd "$OPENWRT_PATH"
        
        # è®¾ç½®ç¼–è¯‘æ—¥å¿—æ–‡ä»¶
        BUILD_LOG="$GITHUB_WORKSPACE/assemble_parallel.log"
        
        if make -j$(nproc) > "$BUILD_LOG" 2>&1; then
          log "INFO" "å¹¶è¡Œç»„è£…å›ºä»¶æˆåŠŸ"
          echo "status=success" >> $GITHUB_OUTPUT
          step_complete "ASSEMBLE_FIRMWARE_PARALLEL" "success"
        else
          log "ERROR" "å¹¶è¡Œç»„è£…å›ºä»¶å¤±è´¥ï¼Œå°†å°è¯•å•çº¿ç¨‹ç»„è£…"
          echo "status=failed" >> $GITHUB_OUTPUT
          step_complete "ASSEMBLE_FIRMWARE_PARALLEL" "failed"
          exit 1
        fi

    - name: ç»„è£…å›ºä»¶ï¼ˆå•çº¿ç¨‹æ¨¡å¼ï¼‰
      id: assemble_serial
      if: steps.assemble_parallel.outcome == 'failure'
      run: |
        source "$LOGGER_SCRIPT"
        step_start "ASSEMBLE_FIRMWARE_SERIAL" "ç»„è£…æœ€ç»ˆå›ºä»¶ï¼ˆå•çº¿ç¨‹è¯¦ç»†æ¨¡å¼ï¼‰"
        cd "$OPENWRT_PATH"
        
        # è®¾ç½®ç¼–è¯‘æ—¥å¿—æ–‡ä»¶
        BUILD_LOG="$GITHUB_WORKSPACE/assemble_serial.log"
        
        if make -j1 V=s > "$BUILD_LOG" 2>&1; then
          log "INFO" "å•çº¿ç¨‹ç»„è£…å›ºä»¶æˆåŠŸ"
          echo "status=success" >> $GITHUB_OUTPUT
          step_complete "ASSEMBLE_FIRMWARE_SERIAL" "success"
        else
          log "ERROR" "å•çº¿ç¨‹ç»„è£…å›ºä»¶ä¹Ÿå¤±è´¥äº†"
          
          # æå–æœ€åŽå‡ è¡Œé”™è¯¯ä¿¡æ¯
          log "ERROR" "ç»„è£…å›ºä»¶é”™è¯¯è¯¦æƒ…ï¼ˆæœ€åŽ20è¡Œï¼‰ï¼š"
          tail -20 "$BUILD_LOG" | while read line; do
            log "ERROR" "$line"
          done
          
          echo "status=failed" >> $GITHUB_OUTPUT
          step_complete "ASSEMBLE_FIRMWARE_SERIAL" "failed"
          exit 1
        fi

    - name: ä¸Šä¼ å›ºä»¶äº§ç‰©
      if: steps.assemble_parallel.outcome == 'success' || steps.assemble_serial.outcome == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ matrix.repo }}-${{ matrix.variant }}-${{ env.FILE_DATE }}
        path: ${{ env.OPENWRT_PATH }}/bin/targets/
        retention-days: 30

    - name: ä¸Šä¼ æž„å»ºæ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: logs-${{ matrix.repo }}-${{ matrix.variant }}-${{ env.FILE_DATE }}
        path: |
          ${{ github.workspace }}/$LOG_FILE
          ${{ github.workspace }}/$REPORT_FILE
          ${{ github.workspace }}/assemble_parallel.log
          ${{ github.workspace }}/assemble_serial.log
        retention-days: 7
