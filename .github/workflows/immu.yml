name: ImmortalWrt IPQ60xx Build

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

env:
  REPO_NAME: immortalwrt
  REPO_OWNER: laipeng668
  REPO_BRANCH: master
  REPO_PATH: ${{ github.workspace }}/immortalwrt
  CONFIG_FILE: configs/immu.config
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
      packages: write

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®æ—¶åŒº
        run: sudo timedatectl set-timezone $TZ

      - name: æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
        run: |
          echo "ğŸ–¥ï¸ ç³»ç»Ÿä¿¡æ¯:"
          uname -a
          echo "ğŸ’¾ ç£ç›˜ç©ºé—´:"
          df -h
          echo "ğŸ”§ å¯ç”¨å†…å­˜:"
          free -h
          echo "ğŸ“‹ ç£ç›˜åˆ—è¡¨:"
          lsblk

      - name: æ‰©å±•ç£ç›˜ç©ºé—´
        run: |
          echo "ğŸ”§ æ‰©å±•ç£ç›˜ç©ºé—´..."
          echo "æ‰©å±•ç£ç›˜ç©ºé—´å‰:"
          df -h
          lsblk
          
          AVAILABLE_SPACE=$(df / | awk 'NR==2 {print $4}')
          echo "å½“å‰æ ¹åˆ†åŒºå¯ç”¨ç©ºé—´: ${AVAILABLE_SPACE}KB"
          
          if [ "$AVAILABLE_SPACE" -gt 52428800 ]; then
            echo "âœ… ç£ç›˜ç©ºé—´å……è¶³ï¼Œè·³è¿‡æ‰©å±•"
            exit 0
          fi
          
          if [ -e /dev/sdb1 ] && mountpoint -q /mnt; then
            echo "ğŸ“‹ å‘ç° /dev/sdb1 æŒ‚è½½åœ¨ /mntï¼Œå‡†å¤‡ä½¿ç”¨å…¶ç©ºé—´"
            sudo mkdir -p /mnt/workdir
            sudo chown $USER:$GROUPS /mnt/workdir
            sudo rm -rf /workdir
            sudo ln -sf /mnt/workdir /workdir
            echo "REPO_PATH=/workdir/immortalwrt" >> $GITHUB_ENV
            echo "âœ… ç£ç›˜ç©ºé—´é‡å®šå‘å®Œæˆ"
            df -h
            lsblk
          elif [ -e /dev/sda1 ] && mountpoint -q /mnt; then
            echo "ğŸ“‹ å‘ç° /dev/sda1 æŒ‚è½½åœ¨ /mntï¼Œå‡†å¤‡ä½¿ç”¨å…¶ç©ºé—´"
            sudo mkdir -p /mnt/workdir
            sudo chown $USER:$GROUPS /mnt/workdir
            sudo rm -rf /workdir
            sudo ln -sf /mnt/workdir /workdir
            echo "REPO_PATH=/workdir/immortalwrt" >> $GITHUB_ENV
            echo "âœ… ç£ç›˜ç©ºé—´é‡å®šå‘å®Œæˆ"
            df -h
            lsblk
          else
            echo "âš ï¸ æœªå‘ç°å¯ç”¨çš„ç£ç›˜ç©ºé—´ï¼Œå°è¯•å…¶ä»–æ–¹æ³•"
            EXTRA_DISK=""
            for disk in sda sdb sdc sdd; do
              if [ -b "/dev/$disk" ]; then
                if ! mount | grep -q "/dev/$disk"; then
                  if [ -b "/dev/${disk}1" ]; then
                    EXTRA_DISK="/dev/${disk}1"
                  else
                    EXTRA_DISK="/dev/$disk"
                  fi
                  break
                else
                  echo "âš ï¸ /dev/$disk å·²æŒ‚è½½ï¼Œè·³è¿‡"
                fi
              fi
            done
            
            if [ -n "$EXTRA_DISK" ]; then
              echo "ğŸ“‹ æ‰¾åˆ°é¢å¤–ç£ç›˜: $EXTRA_DISK"
              if ! blkid $EXTRA_DISK; then
                echo "ğŸ”§ æ ¼å¼åŒ–ç£ç›˜ $EXTRA_DISK..."
                sudo mkfs.ext4 -F $EXTRA_DISK
              fi
              sudo mkdir -p /mnt/extra-space
              if mountpoint -q /mnt/extra-space; then
                echo "ğŸ”§ å¸è½½å·²å­˜åœ¨çš„æŒ‚è½½..."
                sudo umount /mnt/extra-space
              fi
              sudo mount $EXTRA_DISK /mnt/extra-space
              sudo chown -R $USER:$USER /mnt/extra-space
              mkdir -p /mnt/extra-space/immortalwrt
              echo "REPO_PATH=/mnt/extra-space/immortalwrt" >> $GITHUB_ENV
              echo "âœ… ç£ç›˜æ‰©å±•å®Œæˆ"
            else
              echo "âš ï¸ æœªæ‰¾åˆ°ä»»ä½•å¯ç”¨ç£ç›˜ï¼Œæ¸…ç†ç³»ç»Ÿç¼“å­˜"
              sudo apt-get clean
              sudo docker system prune -af --volumes || true
              echo "âœ… å·²æ¸…ç†ç³»ç»Ÿç¼“å­˜"
            fi
          fi
          
          echo "æœ€ç»ˆç£ç›˜çŠ¶æ€:"
          df -h
          lsblk

      - name: è®¾ç½®ç¼“å­˜å˜é‡
        id: cache
        run: |
          CONFIG_HASH=$(sha256sum $CONFIG_FILE | cut -d' ' -f1)
          REPO_HASH=$(sha256sum scripts/repo.sh | cut -d' ' -f1)
          echo "cache-key-immwrt-${CONFIG_HASH}-${REPO_HASH}" >> $GITHUB_OUTPUT
          echo "cache-key-feeds-${CONFIG_HASH}-${REPO_HASH}" >> $GITHUB_OUTPUT

      - name: ç¼“å­˜ ImmortalWrt æºç 
        uses: actions/cache@v4
        id: cache-repo
        with:
          path: ${{ env.REPO_PATH }}
          key: ${{ steps.cache.outputs.cache-key-immwrt }}
          restore-keys: |
            cache-key-immwrt-
            cache-key-immwrt

      - name: ç¼“å­˜ Feeds
        uses: actions/cache@v4
        id: cache-feeds
        with:
          path: ${{ env.REPO_PATH }}/feeds
          key: ${{ steps.cache.outputs.cache-key-feeds }}
          restore-keys: |
            cache-key-feeds

      - name: å…‹éš† ImmortalWrt æºç 
        if: steps.cache-repo.outputs.cache-hit != 'true'
        run: |
          echo "ğŸ“¥ å…‹éš† ImmortalWrt æºç ..."
          git clone https://github.com/${{ env.REPO_OWNER }}/${{ env.REPO_NAME }}.git ${{ env.REPO_PATH }}
          cd ${{ env.REPO_PATH }}
          git checkout ${{ env.REPO_BRANCH }}
          echo "âœ… æºç å…‹éš†å®Œæˆ"

      - name: æ›´æ–°æºç 
        if: steps.cache-repo.outputs.cache-hit == 'true'
        run: |
          echo "ğŸ”„ æ›´æ–°æºç ..."
          cd ${{ env.REPO_PATH }}
          git fetch origin
          git checkout ${{ env.REPO_BRANCH }}
          git pull origin ${{ env.REPO_BRANCH }}
          echo "âœ… æºç æ›´æ–°å®Œæˆ"

      - name: å®‰è£…ä¾èµ–
        run: |
          echo "ğŸ“¦ å®‰è£…æ„å»ºä¾èµ–..."
          sudo apt-get update
          sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk gettext java-runtime-common javascript libelf-dev libncurses5-dev libncursesw5-dev libssl-dev python3 python3-debian python3-distutils python3-lib2to3 python3-pyelftools python3-setuptools python3-unittest rsync subversion swig unzip wget python3-pip python3-pyelftools zlib1g-dev qemu-utils upx-ucl llvm clang flex bison curl
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: å¤åˆ¶é…ç½®æ–‡ä»¶
        run: |
          echo "ğŸ“‹ å¤åˆ¶é…ç½®æ–‡ä»¶..."
          cp ${{ env.CONFIG_FILE }} ${{ env.REPO_PATH }}/.config
          echo "âœ… é…ç½®æ–‡ä»¶å¤åˆ¶å®Œæˆ"

      - name: æ˜¾ç¤ºç£ç›˜ä½¿ç”¨æƒ…å†µ
        run: |
          echo "ğŸ’¾ é…ç½®åç£ç›˜ä½¿ç”¨æƒ…å†µ:"
          df -h

      - name: æ›´æ–°ç¬¬ä¸‰æ–¹æº
        run: |
          echo "ğŸ”„ æ›´æ–°ç¬¬ä¸‰æ–¹æº..."
          cd ${{ env.REPO_PATH }}
          bash ../scripts/repo.sh
          echo "âœ… ç¬¬ä¸‰æ–¹æºæ›´æ–°å®Œæˆ"

      - name: ç”Ÿæˆ LUCI åŸºå‡†æŠ¥å‘Š
        run: |
          echo "ğŸ“„ ç”Ÿæˆ LUCI åŸºå‡†æŠ¥å‘Š..."
          cd ${{ env.REPO_PATH }}
          bash ../scripts/luci_report.sh
          echo "âœ… åŸºå‡†æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

      - name: æ›´æ–° Feeds
        run: |
          echo "ğŸ”„ æ›´æ–° Feeds..."
          cd ${{ env.REPO_PATH }}
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          echo "âœ… Feeds æ›´æ–°å®Œæˆ"

      - name: æ‰§è¡Œ defconfig
        run: |
          echo "âš™ï¸ æ‰§è¡Œ defconfig..."
          cd ${{ env.REPO_PATH }}
          make defconfig
          echo "âœ… defconfig å®Œæˆ"

      - name: ç”Ÿæˆ LUCI è½¯ä»¶åŒ…å˜æ›´æŠ¥å‘Š
        run: |
          echo "ğŸ“„ ç”Ÿæˆ LUCI è½¯ä»¶åŒ…å˜æ›´æŠ¥å‘Š..."
          cd ${{ env.REPO_PATH }}
          bash ../scripts/luci_report.sh
          echo "âœ… æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

      - name: ä¸Šä¼  LUCI æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: luci-report-${{ github.run_number }}
          path: ${{ env.REPO_PATH }}/.luci_report.txt
          retention-days: 30

      - name: æå–è®¾å¤‡é…ç½®
        id: devices
        run: |
          echo "ğŸ” æå–è®¾å¤‡é…ç½®..."
          cd ${{ env.REPO_PATH }}
          DEVICES=$(grep "^CONFIG_TARGET_DEVICE_.*=y$" .config | sed -r 's/^CONFIG_TARGET_DEVICE_.*_DEVICE_(.*)=y$/\1/' | sort -u | tr '\n' ' ')
          echo "devices=$DEVICES" >> $GITHUB_OUTPUT
          echo "âœ… è®¾å¤‡é…ç½®æå–å®Œæˆ: $DEVICES"

      - name: æ˜¾ç¤ºç£ç›˜ä½¿ç”¨æƒ…å†µ
        run: |
          echo "ğŸ’¾ å½“å‰ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
          df -h

      - name: é…ç½®ç¼–è¯‘ç¯å¢ƒ
        run: |
          echo "âš™ï¸ é…ç½®ç¼–è¯‘ç¯å¢ƒ..."
          cd ${{ env.REPO_PATH }}
          THREADS=$(nproc)
          echo "THREADS=$THREADS" >> $GITHUB_ENV
          echo "ğŸ”§ ä½¿ç”¨ $THREADS çº¿ç¨‹ç¼–è¯‘"
          echo "CONFIG_CCACHE=y" >> .config
          bash ../scripts/diy.sh
          echo "âœ… ç¼–è¯‘ç¯å¢ƒé…ç½®å®Œæˆ"

      - name: ç¼–è¯‘å›ºä»¶
        id: compile
        run: |
          echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘å›ºä»¶..."
          cd ${{ env.REPO_PATH }}
          echo "compile_completed=false" >> $GITHUB_OUTPUT
          if make -j${{ env.THREADS }}; then
            echo "compile_completed=true" >> $GITHUB_OUTPUT
            echo "âœ… å›ºä»¶ç¼–è¯‘æˆåŠŸ"
          else
            echo "âŒ å›ºä»¶ç¼–è¯‘å¤±è´¥"
            exit 1
          fi

      - name: æ˜¾ç¤ºç£ç›˜ä½¿ç”¨æƒ…å†µ
        if: always()
        run: |
          echo "ğŸ’¾ ç¼–è¯‘åç£ç›˜ä½¿ç”¨æƒ…å†µ:"
          df -h

      - name: æ•´ç†å›ºä»¶æ–‡ä»¶
        if: steps.compile.outputs.compile_completed == 'true'
        run: |
          echo "ğŸ“¦ æ•´ç†å›ºä»¶æ–‡ä»¶..."
          cd ${{ env.REPO_PATH }}
          mkdir -p firmware
          find bin/targets -name "*.bin" -o -name "*.img" -o -name "manifest" | xargs -I {} cp {} firmware/
          echo "âœ… å›ºä»¶æ–‡ä»¶æ•´ç†å®Œæˆ"

      - name: ç”Ÿæˆå›ºä»¶README
        if: steps.compile.outputs.compile_completed == 'true'
        run: |
          echo "ğŸ“ ç”Ÿæˆå›ºä»¶README..."
          cd ${{ env.REPO_PATH }}/firmware
          printf '%s\n' '# ImmortalWrt å›ºä»¶' '' '## æ„å»ºä¿¡æ¯' "- æ„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" "- æºç åˆ†æ”¯: ${{ env.REPO_BRANCH }}" "- æäº¤å“ˆå¸Œ: $(git rev-parse --short HEAD)" '' '## è®¾å¤‡åˆ—è¡¨' "${{ steps.devices.outputs.devices }}" '' '## æ–‡ä»¶è¯´æ˜' '- *.bin: å›ºä»¶æ–‡ä»¶' '- *.img: é•œåƒæ–‡ä»¶' '- manifest: åŒ…æ¸…å•' > README.md
          echo "âœ… READMEç”Ÿæˆå®Œæˆ"

      - name: ä¸Šä¼ å›ºä»¶åˆ°Artifacts
        uses: actions/upload-artifact@v4
        if: steps.compile.outputs.compile_completed == 'true'
        with:
          name: immortalwrt-${{ github.run_number }}
          path: ${{ env.REPO_PATH }}/firmware/
          retention-days: 30

      - name: å‘å¸ƒåˆ°GitHub Release
        uses: softprops/action-gh-release@v2
        if: steps.compile.outputs.compile_completed == 'true' && github.event_name == 'push'
        with:
          tag_name: build-${{ github.run_number }}
          name: ImmortalWrt Build ${{ github.run_number }}
          body_path: ${{ env.REPO_PATH }}/firmware/README.md
          files: ${{ env.REPO_PATH }}/firmware/*.*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ç¼“å­˜æ¸…ç†
        if: always()
        run: |
          echo "ğŸ§¹ æ¸…ç†è¿‡æœŸç¼“å­˜..."
          gh cache list --repo ${{ github.repository }} --limit 20 | grep "immwrt-" | tail -n +6 | awk '{print $1}' | xargs -I {} gh cache delete --repo ${{ github.repository }} {} || true
        env:
          GH_TOKEN: ${{ github.token }}

      - name: æ¸…ç†å·¥ä½œç›®å½•
        if: always()
        run: |
          echo "ğŸ§¹ æ¸…ç†å·¥ä½œç›®å½•..."
          sudo rm -rf $REPO_PATH
          echo "ğŸ“Š æœ€ç»ˆç£ç›˜ç©ºé—´:"
          df -h
