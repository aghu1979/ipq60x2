# ==============================================================================
# OpenWrt/ImmortalWrt è‡ªåŠ¨ç¼–è¯‘å·¥ä½œæµ
#
# åŠŸèƒ½:
#   è‡ªåŠ¨ç¼–è¯‘OpenWrt/ImmortalWrtå›ºä»¶
#   æ”¯æŒå¤šè®¾å¤‡åŒæ—¶ç¼–è¯‘
#   è‡ªåŠ¨ç”Ÿæˆå›ºä»¶å·®å¼‚æŠ¥å‘Š
#
# ä½œè€…: Mary
# æ—¥æœŸï¼š2025-11-17
# ç‰ˆæœ¬: 3.0 - ä¼ä¸šçº§ä¼˜åŒ–ç‰ˆ
# ==============================================================================

name: OpenWrt/ImmortalWrt è‡ªåŠ¨ç¼–è¯‘

on:
  push:
    branches: [ main, master ]
    paths:
      - 'configs/**'
      - 'scripts/**'
      - '.github/workflows/immu.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'configs/**'
      - 'scripts/**'
      - '.github/workflows/immu.yml'
  workflow_dispatch:
    inputs:
      upload_release:
        description: 'æ˜¯å¦å‘å¸ƒåˆ°Release'
        required: true
        default: 'false'
        type: boolean

env:
  REPO_URL: https://github.com/laipeng668/immortalwrt.git
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: configs/immu.config
  DIY_P1_SH: scripts/diy.sh
  DIY_P2_SH: scripts/repo.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_COWTRANSFER: false
  UPLOAD_WETRANSFER: false
  UPLOAD_RELEASE: ${{ github.event.inputs.upload_release || 'false' }}
  TZ: Asia/Shanghai
  DEVICE_NAMES: "" # å°†ä»é…ç½®æ–‡ä»¶ä¸­æå–

jobs:
  build:
    runs-on: ubuntu-24.04
    
    steps:
    - name: æ£€æŸ¥ç£ç›˜ç©ºé—´
      id: check-disk
      run: |
        echo "::group::æ£€æŸ¥ç£ç›˜ç©ºé—´"
        echo "åˆå§‹ç£ç›˜ç©ºé—´:"
        df -h
        echo "::endgroup::"
        
    - name: æ‰©å±•ç£ç›˜ç©ºé—´
      id: extend-disk
      run: |
        echo "::group::æ‰©å±•ç£ç›˜ç©ºé—´"
        # æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨çš„ç£ç›˜è®¾å¤‡
        DISK=$(lsblk -d -n -o NAME,SIZE | grep -E 'sd[a-z]' | head -n 1 | awk '{print $1}')
        
        if [ -n "$DISK" ]; then
          echo "æ‰¾åˆ°ç£ç›˜è®¾å¤‡: /dev/$DISK"
          
          # æ£€æŸ¥ç£ç›˜æ˜¯å¦å·²åˆ†åŒº
          if ! lsblk /dev/$DISK | grep -q "part"; then
            echo "ç£ç›˜æœªåˆ†åŒºï¼Œæ­£åœ¨åˆ†åŒº..."
            echo -e "o\nn\np\n1\n\n\nw" | sudo fdisk /dev/$DISK
            sudo partprobe /dev/$DISK
          fi
          
          # æ£€æŸ¥åˆ†åŒºæ˜¯å¦å·²æ ¼å¼åŒ–
          PARTITION="/dev/${DISK}1"
          if ! sudo blkid $PARTITION | grep -q "TYPE"; then
            echo "åˆ†åŒºæœªæ ¼å¼åŒ–ï¼Œæ­£åœ¨æ ¼å¼åŒ–ä¸ºext4..."
            sudo mkfs.ext4 -F $PARTITION
          fi
          
          # åˆ›å»ºæŒ‚è½½ç‚¹å¹¶æŒ‚è½½
          sudo mkdir -p /mnt/extra-space
          sudo mount $PARTITION /mnt/extra-space
          
          # åˆ›å»ºå·¥ä½œç›®å½•å¹¶è®¾ç½®è½¯é“¾æ¥
          sudo mkdir -p /mnt/extra-space/openwrt
          sudo ln -sf /mnt/extra-space/openwrt $GITHUB_WORKSPACE/openwrt
          
          echo "æ‰©å±•ç£ç›˜ç©ºé—´å®Œæˆ"
          df -h
        else
          echo "æœªæ‰¾åˆ°å¯ç”¨çš„ç£ç›˜è®¾å¤‡ï¼Œè·³è¿‡æ‰©å±•ç£ç›˜ç©ºé—´"
        fi
        echo "::endgroup::"
        
    - name: å…‹éš†æºä»£ç 
      uses: actions/checkout@v4
      
    - name: åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
      id: init-env
      run: |
        echo "::group::åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ"
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-2404)
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir
        echo "::endgroup::"
        
    - name: å…‹éš†ImmortalWrtæºç 
      id: clone-repo
      run: |
        echo "::group::å…‹éš†ImmortalWrtæºç "
        df -h
        cd /workdir
        
        # ä½¿ç”¨æµ…å…‹éš†ä»¥èŠ‚çœæ—¶é—´å’Œç©ºé—´
        git clone $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
        cd openwrt
        
        echo "æºç å…‹éš†å®Œæˆ"
        df -h
        echo "::endgroup::"
        
    - name: åŠ è½½è‡ªå®šä¹‰é…ç½®
      id: load-config
      run: |
        echo "::group::åŠ è½½è‡ªå®šä¹‰é…ç½®"
        [ -e files ] && mv files openwrt/files
        [ -e $CONFIG_FILE ] && cp $CONFIG_FILE openwrt/.config
        chmod +x $DIY_P1_SH
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P1_SH
        echo "::endgroup::"
        
    - name: æ›´æ–°è½¯ä»¶æº
      id: update-feeds
      run: |
        echo "::group::æ›´æ–°è½¯ä»¶æº"
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "::endgroup::"
        
    - name: åŠ è½½ç¬¬ä¸‰æ–¹æº
      id: load-repo
      run: |
        echo "::group::åŠ è½½ç¬¬ä¸‰æ–¹æº"
        cd openwrt
        chmod +x $GITHUB_WORKSPACE/$DIY_P2_SH
        $GITHUB_WORKSPACE/$DIY_P2_SH
        
        # æ›´æ–°è½¯ä»¶æº
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # è¿è¡Œdefconfig
        make defconfig
        echo "::endgroup::"
        
    - name: ç”ŸæˆLuciè½¯ä»¶åŒ…å·®å¼‚æŠ¥å‘Š
      id: luci-report
      run: |
        echo "::group::ç”ŸæˆLuciè½¯ä»¶åŒ…å·®å¼‚æŠ¥å‘Š"
        cd openwrt
        
        # åˆ›å»ºæŠ¥å‘Šè„šæœ¬
        cat > luci_report.sh << 'EOF'
        #!/bin/bash
        # ==============================================================================
        # Luciè½¯ä»¶åŒ…å·®å¼‚æŠ¥å‘Šç”Ÿæˆè„šæœ¬
        #
        # åŠŸèƒ½:
        #   ç”ŸæˆLuciè½¯ä»¶åŒ…å·®å¼‚æŠ¥å‘Š
        #   å¯¹æ¯”é…ç½®æ–‡ä»¶ä¸­çš„Luciè½¯ä»¶åŒ…ä¸å®é™…å®‰è£…çš„è½¯ä»¶åŒ…
        #
        # ä½œè€…: Mary
        # æ—¥æœŸï¼š2025-11-17
        # ç‰ˆæœ¬: 1.0
        # ==============================================================================
        
        echo "========================================"
        echo "Luciè½¯ä»¶åŒ…å·®å¼‚æŠ¥å‘Š"
        echo "========================================"
        echo "ç”Ÿæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        echo ""
        
        # ä»é…ç½®æ–‡ä»¶ä¸­æå–Luciè½¯ä»¶åŒ…
        CONFIG_LUCI_PACKAGES=$(grep "^CONFIG_PACKAGE_luci-.*=y" .config | sed 's/^CONFIG_PACKAGE_\(.*\)=y/\1/' | sort)
        
        # è·å–å®é™…å®‰è£…çš„Luciè½¯ä»¶åŒ…
        INSTALLED_LUCI_PACKAGES=$(find ./feeds/luci/collections -name "*.mk" -exec grep -l "Package:" {} \; | xargs -I {} grep "Package:" {} | sed 's/.*Package:[[:space:]]*\(luci-.*\)/\1/' | sort -u)
        
        # è·å–å·²å®‰è£…çš„Luciè½¯ä»¶åŒ…
        INSTALLED_PACKAGES=$(find ./feeds/luci/applications -name "Makefile" -exec grep -l "Package:" {} \; | xargs -I {} grep "Package:" {} | sed 's/.*Package:[[:space:]]*\(luci-.*\)/\1/' | sort -u)
        
        # åˆå¹¶å·²å®‰è£…çš„è½¯ä»¶åŒ…
        ALL_INSTALLED_PACKAGES=$(echo -e "$INSTALLED_LUCI_PACKAGES\n$INSTALLED_PACKAGES" | sort -u)
        
        # è®¡ç®—å·®å¼‚
        MISSING_PACKAGES=$(comm -23 <(echo "$CONFIG_LUCI_PACKAGES") <(echo "$ALL_INSTALLED_PACKAGES"))
        EXTRA_PACKAGES=$(comm -13 <(echo "$CONFIG_LUCI_PACKAGES") <(echo "$ALL_INSTALLED_PACKAGES"))
        
        # è¾“å‡ºæŠ¥å‘Š
        echo "é…ç½®æ–‡ä»¶ä¸­çš„Luciè½¯ä»¶åŒ…æ•°é‡: $(echo "$CONFIG_LUCI_PACKAGES" | wc -l)"
        echo "å®é™…å®‰è£…çš„Luciè½¯ä»¶åŒ…æ•°é‡: $(echo "$ALL_INSTALLED_PACKAGES" | wc -l)"
        echo ""
        
        if [ -n "$MISSING_PACKAGES" ]; then
          echo "ç¼ºå¤±çš„Luciè½¯ä»¶åŒ…:"
          echo "$MISSING_PACKAGES"
          echo ""
        else
          echo "æ²¡æœ‰ç¼ºå¤±çš„Luciè½¯ä»¶åŒ…"
          echo ""
        fi
        
        if [ -n "$EXTRA_PACKAGES" ]; then
          echo "é¢å¤–çš„Luciè½¯ä»¶åŒ…:"
          echo "$EXTRA_PACKAGES"
          echo ""
        else
          echo "æ²¡æœ‰é¢å¤–çš„Luciè½¯ä»¶åŒ…"
          echo ""
        fi
        
        echo "========================================"
        EOF
        
        chmod +x luci_report.sh
        ./luci_report.sh > ../luci_report.txt
        echo "::endgroup::"
        
    - name: æå–è®¾å¤‡åç§°
      id: extract-devices
      run: |
        echo "::group::æå–è®¾å¤‡åç§°"
        cd openwrt
        
        # ä»é…ç½®æ–‡ä»¶ä¸­æå–è®¾å¤‡åç§°
        DEVICE_NAMES=$(grep "^CONFIG_TARGET_DEVICE_.*_DEVICE_.*=y" .config | sed 's/^CONFIG_TARGET_DEVICE_.*_DEVICE_\(.*\)=y/\1/' | sort -u | tr '\n' ' ')
        echo "æå–åˆ°çš„è®¾å¤‡åç§°: $DEVICE_NAMES"
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        echo "DEVICE_NAMES=$DEVICE_NAMES" >> $GITHUB_ENV
        
        # è¾“å‡ºåˆ°æ—¥å¿—
        echo "è®¾å¤‡åç§°å·²è®¾ç½®ä¸ºç¯å¢ƒå˜é‡"
        echo "::endgroup::"
        
    - name: ä¸‹è½½è½¯ä»¶åŒ…
      id: download-packages
      run: |
        echo "::group::ä¸‹è½½è½¯ä»¶åŒ…"
        cd openwrt
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;
        echo "::endgroup::"
        
    - name: ç¼–è¯‘å›ºä»¶
      id: build-firmware
      run: |
        echo "::group::ç¼–è¯‘å›ºä»¶"
        cd openwrt
        echo -e "$(nproc) thread build"
        make -j$(nproc) || make -j1 || make -j1 V=s
        echo "ç¼–è¯‘å®Œæˆ"
        echo "::endgroup::"
        
    - name: æ£€æŸ¥ç£ç›˜ç©ºé—´
      id: check-disk-after
      run: |
        echo "::group::æ£€æŸ¥ç£ç›˜ç©ºé—´"
        echo "ç¼–è¯‘åç£ç›˜ç©ºé—´:"
        df -h
        echo "::endgroup::"
        
    - name: æ•´ç†æ–‡ä»¶
      id: organize-files
      run: |
        echo "::group::æ•´ç†æ–‡ä»¶"
        cd openwrt
        rm -rf ./tmp
        mkdir -p ../firmware
        
        # å¤åˆ¶æ‰€æœ‰å›ºä»¶æ–‡ä»¶
        find bin/targets -name "*.bin" -o -name "*.img" -o -name "*.elf" -o -name "*.vmdk" | xargs -I {} cp {} ../firmware/
        
        # å¤åˆ¶manifestæ–‡ä»¶
        find bin/targets -name "manifest" | xargs -I {} cp {} ../firmware/
        
        # å¤åˆ¶sha256sumsæ–‡ä»¶
        find bin/targets -name "sha256sums" | xargs -I {} cp {} ../firmware/
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        cp .config ../firmware/config.txt
        
        # å¤åˆ¶LuciæŠ¥å‘Š
        cp ../luci_report.txt ../firmware/
        
        # é‡å‘½åå›ºä»¶æ–‡ä»¶ä»¥åŒ…å«è®¾å¤‡åç§°
        cd ../firmware
        for device in $DEVICE_NAMES; do
          for file in *$device*; do
            if [ -f "$file" ]; then
              new_name="${file}-${device}"
              mv "$file" "$new_name"
            fi
          done
        done
        
        echo "æ–‡ä»¶æ•´ç†å®Œæˆ"
        ls -lh
        echo "::endgroup::"
        
    - name: ä¸Šä¼ å›ºä»¶åˆ°Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt_firmware_${{ github.run_number }}
        path: ./firmware/
        
    - name: åˆ›å»ºå‘å¸ƒ
      id: create-release
      if: steps.extract-devices.outputs.device-names != '' && env.UPLOAD_RELEASE == 'true'
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.run_number }}
        body: |
          ## ğŸ‰ OpenWrt/ImmortalWrt å›ºä»¶å‘å¸ƒ
          
          ### ğŸ“‹ ç¼–è¯‘ä¿¡æ¯
          - **ç¼–è¯‘æ—¶é—´**: ${{ steps.build-firmware.outputs.build-time }}
          - **æºç ä»“åº“**: ${{ env.REPO_URL }}
          - **æºç åˆ†æ”¯**: ${{ env.REPO_BRANCH }}
          - **è®¾å¤‡åç§°**: ${{ env.DEVICE_NAMES }}
          
          ### ğŸ“¦ å›ºä»¶æ–‡ä»¶
          - å›ºä»¶æ–‡ä»¶å·²åŒ…å«è®¾å¤‡åç§°åç¼€
          - è¯·æ ¹æ®æ‚¨çš„è®¾å¤‡å‹å·é€‰æ‹©å¯¹åº”çš„å›ºä»¶æ–‡ä»¶
          
          ### ğŸ“„ Luciè½¯ä»¶åŒ…å·®å¼‚æŠ¥å‘Š
          - è¯·æŸ¥çœ‹ luci_report.txt æ–‡ä»¶äº†è§£è½¯ä»¶åŒ…å·®å¼‚
          
          ### âš ï¸ æ³¨æ„äº‹é¡¹
          - åˆ·æœºå‰è¯·å¤‡ä»½åŸå›ºä»¶é…ç½®
          - åˆ·æœºåè¯·æ¢å¤å‡ºå‚è®¾ç½®
          - é¦–æ¬¡å¯åŠ¨å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´
        files: ./firmware/*
