# ==============================================================================
# ImmortalWrt è‡ªåŠ¨ç¼–è¯‘å·¥ä½œæµ
# 
# åŠŸèƒ½:
#   è‡ªåŠ¨åŒ–ç¼–è¯‘ ImmortalWrt å›ºä»¶
#   æ”¯æŒå¤šè®¾å¤‡é…ç½®
#   è‡ªåŠ¨ç”Ÿæˆ LUCI è½¯ä»¶åŒ…æŠ¥å‘Š
#   ä¼ä¸šçº§ç¼“å­˜ç®¡ç†å’Œé”™è¯¯æ§åˆ¶
#
# ä½œè€…: Mary
# æ—¥æœŸ: 20251107
# ç‰ˆæœ¬: 3.3 - è·¯å¾„å½»åº•ä¿®å¤ç‰ˆ
# ==============================================================================

name: ImmortalWrt Auto Build

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ master, main ]
    paths:
      - 'configs/**'
      - 'scripts/**'
      - '.github/workflows/immu.yml'
  pull_request:
    branches: [ master, main ]
    paths:
      - 'configs/**'
      - 'scripts/**'
      - '.github/workflows/immu.yml'
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'å¼ºåˆ¶é‡æ–°æ„å»ºï¼ˆå¿½ç•¥ç¼“å­˜ï¼‰'
        required: false
        default: 'false'
        type: boolean
      upload_release:
        description: 'ä¸Šä¼ åˆ° Release'
        required: false
        default: 'true'
        type: boolean

# å…¨å±€ç¯å¢ƒå˜é‡
env:
  # === ç‰ˆæœ¬æ§åˆ¶ ===
  WORKFLOW_VERSION: "3.3"
  BUILD_DATE: "${{ github.run_number }}-${{ github.sha }}"
  
  # === ä»“åº“é…ç½® ===
  REPO_URL: "https://github.com/laipeng668/immortalwrt.git"
  REPO_BRANCH: "master"
  REPO_NAME: "immortalwrt"
  
  # === æ–‡ä»¶è·¯å¾„ ===
  CONFIG_FILE: "configs/immu.config"
  DIY_SCRIPT: "scripts/diy.sh"
  REPO_SCRIPT: "scripts/repo.sh"
  LUCI_REPORT_SCRIPT: "scripts/luci_report.sh"
  
  # === ç¼–è¯‘é…ç½® ===
  FEEDS_CONF: "feeds.conf.default"
  PARALLEL_JOBS: "8"
  
  # === ç£ç›˜é…ç½® ===
  EXPAND_DISK: "true"
  DISK_DEVICE: "/dev/sda1"
  DISK_SIZE: "80G"
  WORKSPACE_DIR: "/workspace"
  
  # === ä¸Šä¼ é…ç½® ===
  UPLOAD_FIRMWARE: "true"
  RETAIN_DAYS: "7"
  KEEP_RELEASES: "5"
  
  # === ç³»ç»Ÿé…ç½® ===
  TZ: "Asia/Shanghai"
  DEBIAN_FRONTEND: "noninteractive"
  
  # === ç¼“å­˜é…ç½® ===
  CACHE_VERSION: "v3"

# ä»»åŠ¡å®šä¹‰
jobs:
  # ==============================================================================
  # ä¸»ç¼–è¯‘ä»»åŠ¡
  # ==============================================================================
  build:
    # è¿è¡Œç¯å¢ƒï¼šæ”¯æŒ Ubuntu 22.04 å’Œ 24.04
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id
    
    # è®¾ç½® GitHub Token ç¯å¢ƒå˜é‡
    env:
      GH_TOKEN: ${{ github.token }}
    
    # è¾“å‡ºå˜é‡
    outputs:
      status: ${{ steps.build_status.outputs.status }}
      device_list: ${{ steps.device_info.outputs.devices }}
      firmware_path: ${{ steps.organize.outputs.firmware_path }}
      release_tag: ${{ steps.release.outputs.tag }}
    
    # æ­¥éª¤å®šä¹‰
    steps:
    # -------------------------------------------------------------------------
    # 1. æ£€å‡ºä»£ç 
    # -------------------------------------------------------------------------
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        path: source-code

    # -------------------------------------------------------------------------
    # 2. åˆå§‹åŒ–å’Œç¯å¢ƒå‡†å¤‡
    # -------------------------------------------------------------------------
    - name: ğŸš€ åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
      id: init
      run: |
        echo "=================================================================="
        echo "ğŸ”§ ImmortalWrt è‡ªåŠ¨ç¼–è¯‘å·¥ä½œæµ ${{ env.WORKFLOW_VERSION }}"
        echo "=================================================================="
        echo "ğŸ“… ç¼–è¯‘æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸ”— ä»“åº“åœ°å€: ${{ env.REPO_URL }}"
        echo "ğŸŒ¿ åˆ†æ”¯: ${{ env.REPO_BRANCH }}"
        echo "ğŸ’» è¿è¡Œç¯å¢ƒ: ${{ runner.os }}"
        echo "ğŸ—ï¸  ç¼–è¯‘ID: ${{ github.run_number }}"
        echo "ğŸ“ æäº¤å“ˆå¸Œ: ${{ github.sha }}"
        echo "ğŸ“ å½“å‰å·¥ä½œç›®å½•: $(pwd)"
        echo "ğŸ“ GitHub å·¥ä½œç©ºé—´: ${{ github.workspace }}"
        echo "ğŸ“ æºç æ£€å‡ºç›®å½•: ${{ github.workspace }}/source-code"
        echo "=================================================================="
        
        # è®¾ç½®æºç ç›®å½•ç¯å¢ƒå˜é‡
        echo "SOURCE_CODE_DIR=${{ github.workspace }}/source-code" >> $GITHUB_ENV
        
        # åˆ›å»ºå·¥ä½œç›®å½•
        sudo mkdir -p ${{ env.WORKSPACE_DIR }}
        sudo chown $USER:$GROUPS ${{ env.WORKSPACE_DIR }}
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        echo "WORKSPACE_PATH=${{ env.WORKSPACE_DIR }}" >> $GITHUB_ENV
        echo "SOURCE_PATH=${{ env.WORKSPACE_DIR }}/${{ env.REPO_NAME }}" >> $GITHUB_ENV
        echo "BUILD_START_TIME=$(date +%s)" >> $GITHUB_ENV
        echo "BUILD_ID=${{ github.run_number }}-${{ github.sha }}" >> $GITHUB_ENV
        echo "CACHE_KEY_PREFIX=immortalwrt-${{ env.CACHE_VERSION }}" >> $GITHUB_ENV
        
        # æ£€æŸ¥è„šæœ¬æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        echo "ğŸ” æ£€æŸ¥è„šæœ¬æ–‡ä»¶..."
        echo "ğŸ“ æºç ç›®å½•ç»“æ„:"
        ls -la "${{ env.SOURCE_CODE_DIR }}/"
        echo "ğŸ“ è„šæœ¬ç›®å½•: ${{ env.SOURCE_CODE_DIR }}/scripts"
        if [ -d "${{ env.SOURCE_CODE_DIR }}/scripts" ]; then
          ls -la "${{ env.SOURCE_CODE_DIR }}/scripts/"
        else
          echo "âš ï¸ è„šæœ¬ç›®å½•ä¸å­˜åœ¨"
        fi
        
        # æ£€æŸ¥ç£ç›˜ç©ºé—´
        echo "ğŸ“Š åˆå§‹ç£ç›˜ç©ºé—´:"
        df -hT
        
        echo "âœ… ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

    # -------------------------------------------------------------------------
    # 3. ç³»ç»Ÿä¾èµ–å®‰è£…
    # -------------------------------------------------------------------------
    - name: ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
      id: deps
      run: |
        echo "=================================================================="
        echo "ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–åŒ…"
        echo "=================================================================="
        
        # æ¸…ç†ä¸å¿…è¦çš„åŒ…
        sudo rm -rf /etc/apt/sources.list.d/* \
                      /usr/share/dotnet \
                      /usr/local/lib/android \
                      /opt/ghc \
                      /usr/share/swift
        
        # æ›´æ–°åŒ…åˆ—è¡¨
        echo "ğŸ”„ æ›´æ–°åŒ…åˆ—è¡¨..."
        sudo -E apt-get -qq update
        
        # å®‰è£…ä¾èµ–
        echo "ğŸ“¥ å®‰è£…ç¼–è¯‘ä¾èµ–..."
        sudo -E apt-get -qq install \
          build-essential \
          ccache \
          ecj \
          fastjar \
          file \
          g++ \
          gawk \
          gettext \
          java-propose-classpath \
          libelf-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libssl-dev \
          python3-debian \
          python3-pyelftools \
          python3-setuptools \
          python3-serial \
          rsync \
          unzip \
          wget \
          python3-distutils \
          python3-lib2to3 \
          python3-pip \
          subversion \
          swig \
          time \
          xsltproc \
          zlib1g-dev \
          curl \
          git \
          python3 \
          python3-pip \
          python3-pyelftools \
          python3-setuptools \
          python3-distutils \
          python3-lib2to3 \
          gh
        
        # æ¸…ç†
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        
        # è®¾ç½®æ—¶åŒº
        sudo timedatectl set-timezone "${{ env.TZ }}"
        
        echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"

    # -------------------------------------------------------------------------
    # 4. ç¼“å­˜ç®¡ç†
    # -------------------------------------------------------------------------
    - name: ğŸ’¾ æ¢å¤ç¼“å­˜
      id: cache_restore
      uses: actions/cache@v4
      with:
        path: |
          ${{ env.WORKSPACE_DIR }}/${{ env.REPO_NAME }}
          ${{ env.WORKSPACE_DIR }}/ccache
          ${{ env.WORKSPACE_DIR }}/dl
        key: "immortalwrt-${{ env.CACHE_VERSION }}-${{ github.run_number }}-${{ github.sha }}"
        restore-keys: |
          immortalwrt-${{ env.CACHE_VERSION }}-
          immortalwrt-${{ env.CACHE_VERSION }}-${{ env.REPO_BRANCH }}-

    # -------------------------------------------------------------------------
    # 5. ç£ç›˜ç©ºé—´æ‰©å±•ï¼ˆä½¿ç”¨è½¯é“¾æ¥ï¼‰
    # -------------------------------------------------------------------------
    - name: ğŸ’¿ æ‰©å±•ç£ç›˜ç©ºé—´
      id: expand_disk
      if: env.EXPAND_DISK == 'true'
      run: |
        echo "=================================================================="
        echo "ğŸ’¿ æ‰©å±•ç£ç›˜ç©ºé—´ï¼ˆè½¯é“¾æ¥æ–¹å¼ï¼‰"
        echo "=================================================================="
        
        # æ£€æŸ¥è®¾å¤‡æ˜¯å¦å­˜åœ¨
        if [ ! -b "${{ env.DISK_DEVICE }}" ]; then
          echo "âš ï¸ è®¾å¤‡ ${{ env.DISK_DEVICE }} ä¸å­˜åœ¨ï¼Œè·³è¿‡ç£ç›˜æ‰©å±•"
          exit 0
        fi
        
        # æ£€æŸ¥æ˜¯å¦å·²æŒ‚è½½
        if ! mount | grep -q "${{ env.DISK_DEVICE }}"; then
          echo "âš ï¸ è®¾å¤‡ ${{ env.DISK_DEVICE }} æœªæŒ‚è½½ï¼Œè·³è¿‡ç£ç›˜æ‰©å±•"
          exit 0
        fi
        
        # è·å–æŒ‚è½½ç‚¹
        MOUNT_POINT=$(mount | grep "${{ env.DISK_DEVICE }}" | awk '{print $3}')
        echo "ğŸ“ è®¾å¤‡æŒ‚è½½ç‚¹: $MOUNT_POINT"
        
        # æ£€æŸ¥æ˜¯å¦æ˜¯æ ¹åˆ†åŒº
        if [ "$MOUNT_POINT" = "/" ]; then
          echo "âš ï¸ è®¾å¤‡ ${{ env.DISK_DEVICE }} æ˜¯æ ¹åˆ†åŒºï¼Œä½¿ç”¨è½¯é“¾æ¥æ–¹å¼æ‰©å±•"
        fi
        
        # åˆ›å»ºæ‰©å±•å·¥ä½œç›®å½•
        EXTEND_DIR="$MOUNT_POINT/immortalwrt-build"
        echo "ğŸ“ åˆ›å»ºæ‰©å±•ç›®å½•: $EXTEND_DIR"
        sudo mkdir -p "$EXTEND_DIR"
        sudo chown $USER:$GROUPS "$EXTEND_DIR"
        
        # åˆ›å»ºè½¯é“¾æ¥
        if [ ! -L "${{ env.WORKSPACE_DIR }}" ]; then
          echo "ğŸ”— åˆ›å»ºè½¯é“¾æ¥: $EXTEND_DIR -> ${{ env.WORKSPACE_DIR }}"
          sudo mv "${{ env.WORKSPACE_DIR }}" "${{ env.WORKSPACE_DIR }}.bak"
          sudo ln -sf "$EXTEND_DIR" "${{ env.WORKSPACE_DIR }}"
        fi
        
        # éªŒè¯è½¯é“¾æ¥
        echo "âœ… è½¯é“¾æ¥åˆ›å»ºå®Œæˆ"
        ls -la "${{ env.WORKSPACE_DIR }}"
        
        # æ˜¾ç¤ºç£ç›˜ç©ºé—´
        echo "ğŸ“Š æ‰©å±•åç£ç›˜ç©ºé—´:"
        df -hT

    # -------------------------------------------------------------------------
    # 6. æºç è·å–
    # -------------------------------------------------------------------------
    - name: ğŸ“¥ è·å–æºç 
      id: source
      run: |
        echo "=================================================================="
        echo "ğŸ“¥ è·å– ImmortalWrt æºç "
        echo "=================================================================="
        
        cd "${{ env.WORKSPACE_DIR }}"
        
        # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        if [ -d "${{ env.REPO_NAME }}" ] && [ "${{ github.event.inputs.force_rebuild }}" != "true" ]; then
          echo "ğŸ“‚ æºç å·²å­˜åœ¨ï¼Œæ›´æ–°ä»£ç ..."
          cd "${{ env.REPO_NAME }}"
          git fetch origin
          git checkout ${{ env.REPO_BRANCH }}
          git pull origin ${{ env.REPO_BRANCH }}
        else
          echo "ğŸ“¥ å…‹éš†æºç ..."
          git clone ${{ env.REPO_URL }} -b ${{ env.REPO_BRANCH }} ${{ env.REPO_NAME }}
        fi
        
        # è¿›å…¥æºç ç›®å½•
        cd "${{ env.SOURCE_PATH }}"
        
        # è·å–ç‰ˆæœ¬ä¿¡æ¯
        REPO_COMMIT=$(git rev-parse HEAD)
        REPO_VERSION=$(git describe --tags --always)
        REPO_DATE=$(git log -1 --format=%cd --date=format:%Y%m%d)
        
        echo "ğŸ”— ä»“åº“åœ°å€: $(git config --get remote.origin.url)"
        echo "ğŸŒ¿ å½“å‰åˆ†æ”¯: $(git rev-parse --abbrev-ref HEAD)"
        echo "ğŸ“ æäº¤å“ˆå¸Œ: $REPO_COMMIT"
        echo "ğŸ·ï¸  ç‰ˆæœ¬æ ‡ç­¾: $REPO_VERSION"
        echo "ğŸ“… æäº¤æ—¥æœŸ: $REPO_DATE"
        
        # è®¾ç½®è¾“å‡ºå˜é‡
        echo "repo_commit=$REPO_COMMIT" >> $GITHUB_OUTPUT
        echo "repo_version=$REPO_VERSION" >> $GITHUB_OUTPUT
        echo "repo_date=$REPO_DATE" >> $GITHUB_OUTPUT
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        echo "REPO_COMMIT=$REPO_COMMIT" >> $GITHUB_ENV
        echo "REPO_VERSION=$REPO_VERSION" >> $GITHUB_ENV
        echo "REPO_DATE=$REPO_DATE" >> $GITHUB_ENV
        
        echo "âœ… æºç è·å–å®Œæˆ"

    # -------------------------------------------------------------------------
    # 7. åŠ è½½è‡ªå®šä¹‰è½¯ä»¶æº
    # -------------------------------------------------------------------------
    - name: ğŸ”§ åŠ è½½è‡ªå®šä¹‰è½¯ä»¶æº
      id: custom_feeds
      run: |
        echo "=================================================================="
        echo "ğŸ”§ åŠ è½½è‡ªå®šä¹‰è½¯ä»¶æº"
        echo "=================================================================="
        
        # ç¡®ä¿åœ¨æ­£ç¡®çš„ç›®å½•
        cd "${{ env.SOURCE_PATH }}"
        
        # å¤åˆ¶ feeds é…ç½®
        if [ -f "${{ env.SOURCE_CODE_DIR }}/${{ env.FEEDS_CONF }}" ]; then
          echo "ğŸ“‹ å¤åˆ¶ feeds é…ç½®æ–‡ä»¶"
          cp "${{ env.SOURCE_CODE_DIR }}/${{ env.FEEDS_CONF }}" "./feeds.conf.default"
        else
          echo "âš ï¸ feeds é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: ${{ env.SOURCE_CODE_DIR }}/${{ env.FEEDS_CONF }}"
        fi
        
        # æ£€æŸ¥è„šæœ¬æ–‡ä»¶
        echo "ğŸ” æ£€æŸ¥è„šæœ¬æ–‡ä»¶..."
        echo "ğŸ“ å½“å‰ç›®å½•: $(pwd)"
        echo "ğŸ“ æºç æ£€å‡ºç›®å½•: ${{ env.SOURCE_CODE_DIR }}"
        echo "ğŸ“ è„šæœ¬è·¯å¾„: ${{ env.SOURCE_CODE_DIR }}/${{ env.REPO_SCRIPT }}"
        
        # æ£€æŸ¥è„šæœ¬æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "${{ env.SOURCE_CODE_DIR }}/${{ env.REPO_SCRIPT }}" ]; then
          echo "âŒ è„šæœ¬æ–‡ä»¶ä¸å­˜åœ¨: ${{ env.SOURCE_CODE_DIR }}/${{ env.REPO_SCRIPT }}"
          echo "ğŸ” æœç´¢æ‰€æœ‰å¯èƒ½çš„ repo.sh æ–‡ä»¶:"
          find ${{ env.SOURCE_CODE_DIR }} -name "repo.sh" 2>/dev/null || true
          exit 1
        fi
        
        # æ‰§è¡Œè½¯ä»¶æºè„šæœ¬
        echo "ğŸ”§ æ‰§è¡Œè½¯ä»¶æºé›†æˆè„šæœ¬..."
        chmod +x "${{ env.SOURCE_CODE_DIR }}/${{ env.REPO_SCRIPT }}"
        "${{ env.SOURCE_CODE_DIR }}/${{ env.REPO_SCRIPT }}"
        
        echo "âœ… è‡ªå®šä¹‰è½¯ä»¶æºåŠ è½½å®Œæˆ"

    # -------------------------------------------------------------------------
    # 8. ç”Ÿæˆ defconfig å‰çš„ LUCI æŠ¥å‘Š
    # -------------------------------------------------------------------------
    - name: ğŸ“Š ç”Ÿæˆ defconfig å‰çš„ LUCI æŠ¥å‘Š
      id: luci_report_before
      run: |
        echo "=================================================================="
        echo "ğŸ“Š ç”Ÿæˆ defconfig å‰çš„ LUCI è½¯ä»¶åŒ…æŠ¥å‘Š"
        echo "=================================================================="
        
        cd "${{ env.SOURCE_PATH }}"
        
        # åˆ›å»ºæŠ¥å‘Šç›®å½•
        mkdir -p reports
        
        # ç”Ÿæˆ defconfig å‰çš„è½¯ä»¶åŒ…åˆ—è¡¨
        echo "ğŸ“‹ ç”Ÿæˆ defconfig å‰çš„è½¯ä»¶åŒ…åˆ—è¡¨..."
        find package feeds -name "luci-app-*" -type d 2>/dev/null | sed 's/.*\///' | sort -u > reports/luci_packages_before.txt
        
        # ç»Ÿè®¡æ•°é‡
        BEFORE_COUNT=$(wc -l < reports/luci_packages_before.txt 2>/dev/null || echo "0")
        echo "ğŸ“Š defconfig å‰ LUCI è½¯ä»¶åŒ…æ•°é‡: $BEFORE_COUNT"
        
        # è®¾ç½®è¾“å‡ºå˜é‡
        echo "before_count=$BEFORE_COUNT" >> $GITHUB_OUTPUT
        echo "before_list=reports/luci_packages_before.txt" >> $GITHUB_OUTPUT
        
        echo "âœ… defconfig å‰ LUCI æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

    # -------------------------------------------------------------------------
    # 9. æ›´æ–°å’Œå®‰è£… feeds
    # -------------------------------------------------------------------------
    - name: ğŸ”„ æ›´æ–° feeds
      id: update_feeds
      run: |
        echo "=================================================================="
        echo "ğŸ”„ æ›´æ–° feeds"
        echo "=================================================================="
        
        cd "${{ env.SOURCE_PATH }}"
        
        echo "ğŸ“¥ æ›´æ–° feeds..."
        ./scripts/feeds update -a
        
        echo "âœ… feeds æ›´æ–°å®Œæˆ"

    - name: ğŸ“¦ å®‰è£… feeds
      id: install_feeds
      run: |
        echo "=================================================================="
        echo "ğŸ“¦ å®‰è£… feeds"
        echo "=================================================================="
        
        cd "${{ env.SOURCE_PATH }}"
        
        echo "ğŸ“¦ å®‰è£… feeds..."
        ./scripts/feeds install -a
        
        echo "âœ… feeds å®‰è£…å®Œæˆ"

    # -------------------------------------------------------------------------
    # 10. åŠ è½½è‡ªå®šä¹‰é…ç½®
    # -------------------------------------------------------------------------
    - name: âš™ï¸ åŠ è½½è‡ªå®šä¹‰é…ç½®
      id: custom_config
      run: |
        echo "=================================================================="
        echo "âš™ï¸ åŠ è½½è‡ªå®šä¹‰é…ç½®"
        echo "=================================================================="
        
        cd "${{ env.SOURCE_PATH }}"
        
        # å¤åˆ¶æ–‡ä»¶
        if [ -d "${{ env.SOURCE_CODE_DIR }}/files" ]; then
          echo "ğŸ“ å¤åˆ¶è‡ªå®šä¹‰æ–‡ä»¶"
          cp -r "${{ env.SOURCE_CODE_DIR }}/files" ./
        fi
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        if [ -f "${{ env.SOURCE_CODE_DIR }}/${{ env.CONFIG_FILE }}" ]; then
          echo "ğŸ“‹ å¤åˆ¶é…ç½®æ–‡ä»¶"
          cp "${{ env.SOURCE_CODE_DIR }}/${{ env.CONFIG_FILE }}" ./.config
        fi
        
        # æ£€æŸ¥è‡ªå®šä¹‰è„šæœ¬
        echo "ğŸ” æ£€æŸ¥è‡ªå®šä¹‰è„šæœ¬..."
        echo "ğŸ“ è„šæœ¬è·¯å¾„: ${{ env.SOURCE_CODE_DIR }}/${{ env.DIY_SCRIPT }}"
        
        if [ ! -f "${{ env.SOURCE_CODE_DIR }}/${{ env.DIY_SCRIPT }}" ]; then
          echo "âŒ è‡ªå®šä¹‰è„šæœ¬ä¸å­˜åœ¨: ${{ env.SOURCE_CODE_DIR }}/${{ env.DIY_SCRIPT }}"
          exit 1
        fi
        
        # æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬
        echo "ğŸ”§ æ‰§è¡Œè‡ªå®šä¹‰é…ç½®è„šæœ¬..."
        chmod +x "${{ env.SOURCE_CODE_DIR }}/${{ env.DIY_SCRIPT }}"
        "${{ env.SOURCE_CODE_DIR }}/${{ env.DIY_SCRIPT }}"
        
        echo "âœ… è‡ªå®šä¹‰é…ç½®åŠ è½½å®Œæˆ"

    # -------------------------------------------------------------------------
    # 11. ç”Ÿæˆ defconfig å¹¶ç”Ÿæˆå¯¹æ¯”æŠ¥å‘Š
    # -------------------------------------------------------------------------
    - name: ğŸ“Š ç”Ÿæˆ defconfig å’Œå¯¹æ¯”æŠ¥å‘Š
      id: defconfig_report
      run: |
        echo "=================================================================="
        echo "ğŸ“Š ç”Ÿæˆ defconfig å’Œ LUCI å¯¹æ¯”æŠ¥å‘Š"
        echo "=================================================================="
        
        cd "${{ env.SOURCE_PATH }}"
        
        # ç”Ÿæˆ defconfig
        echo "ğŸ”§ ç”Ÿæˆ defconfig..."
        make defconfig
        
        # ç”Ÿæˆ defconfig åçš„è½¯ä»¶åŒ…åˆ—è¡¨
        echo "ğŸ“‹ ç”Ÿæˆ defconfig åçš„è½¯ä»¶åŒ…åˆ—è¡¨..."
        find package feeds -name "luci-app-*" -type d 2>/dev/null | sed 's/.*\///' | sort -u > reports/luci_packages_after.txt
        
        # ç»Ÿè®¡æ•°é‡
        AFTER_COUNT=$(wc -l < reports/luci_packages_after.txt 2>/dev/null || echo "0")
        echo "ğŸ“Š defconfig å LUCI è½¯ä»¶åŒ…æ•°é‡: $AFTER_COUNT"
        
        # ç”Ÿæˆå¯¹æ¯”æŠ¥å‘Š
        echo "ğŸ“Š ç”Ÿæˆ LUCI è½¯ä»¶åŒ…å¯¹æ¯”æŠ¥å‘Š..."
        {
          echo "=================================================================="
          echo "LUCI è½¯ä»¶åŒ…å˜æ›´æŠ¥å‘Š"
          echo "=================================================================="
          echo "ç”Ÿæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "é…ç½®æ–‡ä»¶: ${{ env.CONFIG_FILE }}"
          echo "ä»“åº“ç‰ˆæœ¬: ${{ env.REPO_VERSION }}"
          echo "æäº¤å“ˆå¸Œ: ${{ env.REPO_COMMIT }}"
          echo ""
          
          echo "ğŸ“Š ç»Ÿè®¡ä¿¡æ¯:"
          echo "----------------------------------------"
          echo "defconfig å‰è½¯ä»¶åŒ…æ•°é‡: ${{ steps.luci_report_before.outputs.before_count }}"
          echo "defconfig åè½¯ä»¶åŒ…æ•°é‡: $AFTER_COUNT"
          echo "å˜æ›´æ•°é‡: $(($AFTER_COUNT - ${{ steps.luci_report_before.outputs.before_count }}))"
          echo ""
          
          echo "ğŸ†• æ–°å¢çš„è½¯ä»¶åŒ… (defconfig åæ–°å¢):"
          echo "----------------------------------------"
          if [ -f reports/luci_packages_before.txt ] && [ -f reports/luci_packages_after.txt ]; then
            comm -13 reports/luci_packages_before.txt reports/luci_packages_after.txt || echo "æ— æ–°å¢è½¯ä»¶åŒ…"
          else
            echo "æ— æ³•ç”Ÿæˆå¯¹æ¯”ï¼ˆæ–‡ä»¶ä¸å­˜åœ¨ï¼‰"
          fi
          echo ""
          
          echo "ğŸ—‘ï¸  ç§»é™¤çš„è½¯ä»¶åŒ… (defconfig åç§»é™¤):"
          echo "----------------------------------------"
          if [ -f reports/luci_packages_before.txt ] && [ -f reports/luci_packages_after.txt ]; then
            comm -23 reports/luci_packages_before.txt reports/luci_packages_after.txt || echo "æ— ç§»é™¤è½¯ä»¶åŒ…"
          else
            echo "æ— æ³•ç”Ÿæˆå¯¹æ¯”ï¼ˆæ–‡ä»¶ä¸å­˜åœ¨ï¼‰"
          fi
          echo ""
          
          echo "âœ… ä¿æŒä¸å˜çš„è½¯ä»¶åŒ…:"
          echo "----------------------------------------"
          if [ -f reports/luci_packages_before.txt ] && [ -f reports/luci_packages_after.txt ]; then
            comm -12 reports/luci_packages_before.txt reports/luci_packages_after.txt || echo "æ— ä¿æŒä¸å˜çš„è½¯ä»¶åŒ…"
          else
            echo "æ— æ³•ç”Ÿæˆå¯¹æ¯”ï¼ˆæ–‡ä»¶ä¸å­˜åœ¨ï¼‰"
          fi
          echo ""
          
          echo "=================================================================="
        } > reports/luci_packages_diff.txt
        
        # è®¾ç½®è¾“å‡ºå˜é‡
        echo "after_count=$AFTER_COUNT" >> $GITHUB_OUTPUT
        echo "diff_report=reports/luci_packages_diff.txt" >> $GITHUB_OUTPUT
        
        # æ˜¾ç¤ºæŠ¥å‘Š
        echo "ğŸ“Š LUCI è½¯ä»¶åŒ…å¯¹æ¯”æŠ¥å‘Š:"
        cat reports/luci_packages_diff.txt
        
        echo "âœ… defconfig å’Œå¯¹æ¯”æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

    # -------------------------------------------------------------------------
    # 12. æå–è®¾å¤‡ä¿¡æ¯
    # -------------------------------------------------------------------------
    - name: ğŸ“± æå–è®¾å¤‡ä¿¡æ¯
      id: device_info
      run: |
        echo "=================================================================="
        echo "ğŸ“± æå–è®¾å¤‡ä¿¡æ¯"
        echo "=================================================================="
        
        cd "${{ env.SOURCE_PATH }}"
        
        # æå–è®¾å¤‡åˆ—è¡¨
        DEVICES=$(grep "^CONFIG_TARGET_DEVICE_.*_DEVICE_.*=y$" .config 2>/dev/null | \
                  sed 's/^CONFIG_TARGET_DEVICE_.*_DEVICE_\(.*\)=y$/\1/' | \
                  sort -u | tr '\n' ' ')
        
        if [ -z "$DEVICES" ]; then
          echo "âš ï¸ æœªæ‰¾åˆ°è®¾å¤‡é…ç½®"
          echo "devices=unknown" >> $GITHUB_OUTPUT
        else
          echo "ğŸ“± ç›®æ ‡è®¾å¤‡: $DEVICES"
          echo "devices=$DEVICES" >> $GITHUB_OUTPUT
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          echo "DEVICE_LIST=$DEVICES" >> $GITHUB_ENV
          
          # ä¸ºæ¯ä¸ªè®¾å¤‡ç”Ÿæˆæ–‡ä»¶ååç¼€
          FIRST_DEVICE=$(echo $DEVICES | awk '{print $1}')
          echo "FIRST_DEVICE=$FIRST_DEVICE" >> $GITHUB_ENV
        fi
        
        echo "âœ… è®¾å¤‡ä¿¡æ¯æå–å®Œæˆ"

    # -------------------------------------------------------------------------
    # 13. ä¸‹è½½è½¯ä»¶åŒ…
    # -------------------------------------------------------------------------
    - name: ğŸ“¥ ä¸‹è½½è½¯ä»¶åŒ…
      id: download
      run: |
        echo "=================================================================="
        echo "ğŸ“¥ ä¸‹è½½è½¯ä»¶åŒ…"
        echo "=================================================================="
        
        cd "${{ env.SOURCE_PATH }}"
        
        echo "ğŸ“¥ å¼€å§‹ä¸‹è½½è½¯ä»¶åŒ…..."
        make download -j${{ env.PARALLEL_JOBS }}
        
        # æ¸…ç†å°æ–‡ä»¶
        echo "ğŸ§¹ æ¸…ç†å°æ–‡ä»¶..."
        find dl -size -1024c -exec ls -l {} \; 2>/dev/null || true
        find dl -size -1024c -exec rm -f {} \; 2>/dev/null || true
        
        echo "âœ… è½¯ä»¶åŒ…ä¸‹è½½å®Œæˆ"

    # -------------------------------------------------------------------------
    # 14. ç¼–è¯‘å›ºä»¶
    # -------------------------------------------------------------------------
    - name: ğŸ”¨ ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        echo "=================================================================="
        echo "ğŸ”¨ ç¼–è¯‘å›ºä»¶"
        echo "=================================================================="
        
        cd "${{ env.SOURCE_PATH }}"
        
        echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘å›ºä»¶..."
        echo "ğŸ”§ ä½¿ç”¨å¹¶è¡Œä»»åŠ¡æ•°: ${{ env.PARALLEL_JOBS }}"
        
        # ç¼–è¯‘
        make -j${{ env.PARALLEL_JOBS }} || make -j1 || make -j1 V=s
        
        # æ£€æŸ¥ç¼–è¯‘ç»“æœ
        if [ $? -eq 0 ]; then
          echo "âœ… å›ºä»¶ç¼–è¯‘æˆåŠŸ"
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "âŒ å›ºä»¶ç¼–è¯‘å¤±è´¥"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        echo "âœ… ç¼–è¯‘å®Œæˆ"

    # -------------------------------------------------------------------------
    # 15. ç¼–è¯‘åæ£€æŸ¥
    # -------------------------------------------------------------------------
    - name: ğŸ” ç¼–è¯‘åæ£€æŸ¥
      id: post_build_check
      run: |
        echo "=================================================================="
        echo "ğŸ” ç¼–è¯‘åæ£€æŸ¥"
        echo "=================================================================="
        
        # æ£€æŸ¥ç£ç›˜ç©ºé—´
        echo "ğŸ“Š ç¼–è¯‘åç£ç›˜ç©ºé—´:"
        df -hT
        
        # æ£€æŸ¥è¾“å‡ºæ–‡ä»¶
        cd "${{ env.SOURCE_PATH }}"
        
        echo "ğŸ“¦ ç¼–è¯‘è¾“å‡ºæ–‡ä»¶:"
        if [ -d "bin/targets" ]; then
          find bin/targets -name "*.bin" -o -name "*.img" -o -name "*.sysupgrade.tar" | head -20
        else
          echo "âš ï¸ æœªæ‰¾åˆ°ç¼–è¯‘è¾“å‡ºæ–‡ä»¶"
        fi
        
        # è®¡ç®—ç¼–è¯‘æ—¶é—´
        BUILD_END_TIME=$(date +%s)
        BUILD_DURATION=$((BUILD_END_TIME - BUILD_START_TIME))
        BUILD_HOURS=$((BUILD_DURATION / 3600))
        BUILD_MINUTES=$(((BUILD_DURATION % 3600) / 60))
        BUILD_SECONDS=$((BUILD_DURATION % 60))
        
        echo "â±ï¸ ç¼–è¯‘è€—æ—¶: ${BUILD_HOURS}å°æ—¶ ${BUILD_MINUTES}åˆ†é’Ÿ ${BUILD_SECONDS}ç§’"
        
        echo "âœ… ç¼–è¯‘åæ£€æŸ¥å®Œæˆ"

    # -------------------------------------------------------------------------
    # 16. ä¿å­˜ç¼“å­˜
    # -------------------------------------------------------------------------
    - name: ğŸ’¾ ä¿å­˜ç¼“å­˜
      id: cache_save
      if: always()
      uses: actions/cache@v4
      with:
        path: |
          ${{ env.WORKSPACE_DIR }}/${{ env.REPO_NAME }}
          ${{ env.WORKSPACE_DIR }}/ccache
          ${{ env.WORKSPACE_DIR }}/dl
        key: "immortalwrt-${{ env.CACHE_VERSION }}-${{ github.run_number }}-${{ github.sha }}"

    # -------------------------------------------------------------------------
    # 17. æ•´ç†å›ºä»¶æ–‡ä»¶
    # -------------------------------------------------------------------------
    - name: ğŸ“¦ æ•´ç†å›ºä»¶æ–‡ä»¶
      id: organize
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true'
      run: |
        echo "=================================================================="
        echo "ğŸ“¦ æ•´ç†å›ºä»¶æ–‡ä»¶"
        echo "=================================================================="
        
        cd "${{ env.SOURCE_PATH }}"
        
        # æŸ¥æ‰¾å›ºä»¶ç›®å½•
        FIRMWARE_DIR=$(find bin/targets -type d -name "*" | head -1)
        if [ -z "$FIRMWARE_DIR" ]; then
          echo "âŒ æœªæ‰¾åˆ°å›ºä»¶ç›®å½•"
          exit 1
        fi
        
        cd "$FIRMWARE_DIR"
        
        # ç§»é™¤ä¸éœ€è¦çš„æ–‡ä»¶
        echo "ğŸ§¹ æ¸…ç†ä¸éœ€è¦çš„æ–‡ä»¶..."
        rm -rf packages
        
        # è·å–å›ºä»¶è·¯å¾„
        FIRMWARE_PATH=$(pwd)
        echo "ğŸ“‚ å›ºä»¶è·¯å¾„: $FIRMWARE_PATH"
        
        # åˆ—å‡ºå›ºä»¶æ–‡ä»¶
        echo "ğŸ“¦ å›ºä»¶æ–‡ä»¶åˆ—è¡¨:"
        ls -la
        
        # è®¾ç½®è¾“å‡ºå˜é‡
        echo "firmware_path=$FIRMWARE_PATH" >> $GITHUB_OUTPUT
        echo "firmware_path=$FIRMWARE_PATH" >> $GITHUB_ENV
        
        echo "âœ… å›ºä»¶æ–‡ä»¶æ•´ç†å®Œæˆ"

    # -------------------------------------------------------------------------
    # 18. ä¸Šä¼ æ„å»ºäº§ç‰©
    # -------------------------------------------------------------------------
    - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
      id: upload_artifact
      if: steps.organize.outputs.firmware_path != ''
      uses: actions/upload-artifact@v4
      with:
        name: "immortalwrt-${{ env.FIRST_DEVICE }}-${{ env.BUILD_ID }}"
        path: ${{ steps.organize.outputs.firmware_path }}
        retention-days: ${{ env.RETAIN_DAYS }}

    # -------------------------------------------------------------------------
    # 19. åˆ›å»º Release
    # -------------------------------------------------------------------------
    - name: ğŸš€ åˆ›å»º Release
      id: release
      if: steps.compile.outputs.status == 'success' && github.event.inputs.upload_release == 'true'
      run: |
        echo "=================================================================="
        echo "ğŸš€ åˆ›å»º Release"
        echo "=================================================================="
        
        # ç”Ÿæˆ Release æ ‡ç­¾
        RELEASE_TAG="v${{ env.REPO_DATE }}-${{ env.FIRST_DEVICE }}-${{ github.run_number }}"
        echo "ğŸ·ï¸ Release æ ‡ç­¾: $RELEASE_TAG"
        
        # ç”Ÿæˆ Release è¯´æ˜
        cat > release_body.txt << EOF
        # ImmortalWrt å›ºä»¶å‘å¸ƒ
        
        ## ğŸ“‹ åŸºæœ¬ä¿¡æ¯
        - **ç‰ˆæœ¬**: ${{ env.REPO_VERSION }}
        - **æäº¤**: ${{ env.REPO_COMMIT }}
        - **è®¾å¤‡**: ${{ env.DEVICE_LIST }}
        - **ç¼–è¯‘æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')
        - **ç¼–è¯‘ID**: ${{ env.BUILD_ID }}
        
        ## ğŸ“Š ç¼–è¯‘ä¿¡æ¯
        - **defconfig å‰è½¯ä»¶åŒ…**: ${{ steps.luci_report_before.outputs.before_count }}"
        - **defconfig åè½¯ä»¶åŒ…**: ${{ steps.defconfig_report.outputs.after_count }}"
        
        ## ğŸ“¦ åŒ…å«æ–‡ä»¶
        $(cd ${{ env.FIRMWARE_PATH }} && ls -la | grep -E '\.(bin|img|tar)$' | awk '{print "- " $9}')
        
        ## ğŸ“¥ ä¸‹è½½è¯´æ˜
        1. é€‰æ‹©é€‚åˆä½ è®¾å¤‡çš„å›ºä»¶æ–‡ä»¶
        2. é€šè¿‡è®¾å¤‡å‡çº§é¡µé¢ä¸Šä¼ å›ºä»¶
        3. ç­‰å¾…å‡çº§å®Œæˆ
        
        ---
        ğŸ¤– è‡ªåŠ¨ç¼–è¯‘äº $(date '+%Y-%m-%d %H:%M:%S')
        EOF
        
        # è®¾ç½®è¾“å‡ºå˜é‡
        echo "tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
        echo "release_body=release_body.txt" >> $GITHUB_OUTPUT
        
        echo "âœ… Release ä¿¡æ¯å‡†å¤‡å®Œæˆ"

    - name: ğŸ“¤ ä¸Šä¼ åˆ° Release
      if: steps.release.outputs.tag != ''
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ github.token }}
      with:
        tag_name: ${{ steps.release.outputs.tag }}
        body_path: ${{ steps.release.outputs.release_body }}
        files: ${{ env.FIRMWARE_PATH }}/*
        draft: false
        prerelease: false

    # -------------------------------------------------------------------------
    # 20. æ¸…ç†å’Œæ€»ç»“
    # -------------------------------------------------------------------------
    - name: ğŸ§¹ æ¸…ç†å’Œæ€»ç»“
      id: cleanup
      if: always()
      run: |
        echo "=================================================================="
        echo "ğŸ§¹ æ¸…ç†å’Œæ€»ç»“"
        echo "=================================================================="
        
        # è®¡ç®—æ€»æ‰§è¡Œæ—¶é—´
        TOTAL_END_TIME=$(date +%s)
        TOTAL_DURATION=$((TOTAL_END_TIME - BUILD_START_TIME))
        TOTAL_HOURS=$((TOTAL_DURATION / 3600))
        TOTAL_MINUTES=$(((TOTAL_DURATION % 3600) / 60))
        TOTAL_SECONDS=$((TOTAL_DURATION % 60))
        
        echo "â±ï¸ æ€»æ‰§è¡Œæ—¶é—´: ${TOTAL_HOURS}å°æ—¶ ${TOTAL_MINUTES}åˆ†é’Ÿ ${TOTAL_SECONDS}ç§’"
        
        # æ˜¾ç¤ºæ‰§è¡Œæ‘˜è¦
        echo ""
        echo "=================================================================="
        echo "ğŸ“Š æ‰§è¡Œæ‘˜è¦"
        echo "=================================================================="
        echo "âœ… ç¼–è¯‘çŠ¶æ€: ${{ steps.compile.outputs.status }}"
        echo "ğŸ“± ç›®æ ‡è®¾å¤‡: ${{ env.DEVICE_LIST }}"
        echo "ğŸ·ï¸ Release æ ‡ç­¾: ${{ steps.release.outputs.tag }}"
        echo "ğŸ“¦ æ„å»ºäº§ç‰©: ${{ steps.upload_artifact.outcome }}"
        echo "ğŸ’¾ ç¼“å­˜çŠ¶æ€: ${{ steps.cache_save.outcome }}"
        echo ""
        
        if [ "${{ steps.compile.outputs.status }}" = "success" ]; then
          echo "ğŸ‰ ç¼–è¯‘æˆåŠŸå®Œæˆï¼"
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
        fi
        
        echo "=================================================================="
        
        # è®¾ç½®æœ€ç»ˆçŠ¶æ€
        if [ "${{ steps.compile.outputs.status }}" = "success" ]; then
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "status=failed" >> $GITHUB_OUTPUT
        fi

    # -------------------------------------------------------------------------
    # 21. æ¸…ç†æ—§èµ„æº
    # -------------------------------------------------------------------------
    - name: ğŸ—‘ï¸ æ¸…ç†æ—§èµ„æº
      if: always()
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "=================================================================="
        echo "ğŸ—‘ï¸ æ¸…ç†æ—§èµ„æº"
        echo "=================================================================="
        
        # æ£€æŸ¥ GitHub CLI æ˜¯å¦å¯ç”¨
        if ! command -v gh &> /dev/null; then
          echo "âš ï¸ GitHub CLI æœªå®‰è£…ï¼Œè·³è¿‡æ¸…ç†"
          exit 0
        fi
        
        # æ¸…ç†æ—§çš„ workflow runs
        echo "ğŸ§¹ æ¸…ç†æ—§çš„ workflow runs..."
        gh run list --repo ${{ github.repository }} --limit 50 \
          --json databaseId \
          --jq '.[10:] | .[].databaseId' 2>/dev/null | \
          xargs -I {} gh run delete --repo ${{ github.repository }} {} 2>/dev/null || true
        
        # æ¸…ç†æ—§çš„ releases
        echo "ğŸ§¹ æ¸…ç†æ—§çš„ releases..."
        gh release list --repo ${{ github.repository }} --limit ${{ env.KEEP_RELEASES }} \
          --json tagName \
          --jq '.[0].tagName' 2>/dev/null > latest_release.txt
        
        if [ -s latest_release.txt ]; then
          LATEST_RELEASE=$(cat latest_release.txt)
          gh release list --repo ${{ github.repository }} \
            --exclude latest \
            --json tagName \
            --jq ".[] | select(.tagName != \"$LATEST_RELEASE\") | .tagName" 2>/dev/null | \
            xargs -I {} gh release delete --repo ${{ github.repository }} {} --yes 2>/dev/null || true
        fi
        
        echo "âœ… æ—§èµ„æºæ¸…ç†å®Œæˆ"

  # ==============================================================================
  # æ„å»ºçŠ¶æ€é€šçŸ¥ä»»åŠ¡
  # ==============================================================================
  status:
    name: æ„å»ºçŠ¶æ€
    if: always()
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“Š æ„å»ºçŠ¶æ€é€šçŸ¥
      run: |
        echo "=================================================================="
        echo "ğŸ“Š æ„å»ºçŠ¶æ€é€šçŸ¥"
        echo "=================================================================="
        echo "ğŸ”— ä»“åº“: ${{ github.repository }}"
        echo "ğŸ·ï¸ åˆ†æ”¯: ${{ github.ref_name }}"
        echo "ğŸ”¨ æ„å»º: ${{ github.run_number }}"
        echo "ğŸ“… æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "âœ… çŠ¶æ€: ${{ needs.build.result }}"
        echo "=================================================================="
        
        if [ "${{ needs.build.result }}" = "success" ]; then
          echo "ğŸ‰ æ„å»ºæˆåŠŸï¼"
        else
          echo "âŒ æ„å»ºå¤±è´¥ï¼"
        fi
