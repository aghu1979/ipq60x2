name: ImmortalWrt IPQ60xx Ultra Build

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:
    inputs:
      variant:
        description: 'æž„å»ºå˜ä½“'
        required: true
        default: 'ultra'
        type: choice
        options:
        - ultra
        - max
      clean_build:
        description: 'å®Œå…¨é‡æ–°æž„å»º'
        required: false
        default: false
        type: boolean

env:
  REPO_NAME: immortalwrt
  REPO_OWNER: laipeng668
  REPO_BRANCH: master
  VARIANT: ${{ github.event.inputs.variant || 'ultra' }}
  REPO_PATH: ${{ github.workspace }}/immortalwrt
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: configs/immu.config
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
      packages: write

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®æ—¶åŒº
        run: sudo timedatectl set-timezone $TZ

      - name: æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
        run: |
          echo "ðŸ–¥ï¸ ç³»ç»Ÿä¿¡æ¯:"
          uname -a
          echo "ðŸ’¾ ç£ç›˜ç©ºé—´:"
          df -h
          echo "ðŸ”§ å¯ç”¨å†…å­˜:"
          free -h

      - name: æ‰©å±•ç£ç›˜ç©ºé—´
        run: |
          echo "ðŸ”§ æ‰©å±•ç£ç›˜ç©ºé—´..."
          # æ£€æŸ¥æ˜¯å¦æœ‰é¢å¤–çš„ç£ç›˜
          if [ -b /dev/sda ]; then
            DISK="/dev/sda"
          elif [ -b /dev/sdb ]; then
            DISK="/dev/sdb"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°é¢å¤–ç£ç›˜ï¼Œè·³è¿‡æ‰©å±•"
            exit 0
          fi
          
          # æ ¼å¼åŒ–ç£ç›˜ï¼ˆå¦‚æžœéœ€è¦ï¼‰
          if ! blkid $DISK; then
            echo "ðŸ”§ æ ¼å¼åŒ–ç£ç›˜ $DISK..."
            sudo mkfs.ext4 -F $DISK
          fi
          
          # åˆ›å»ºæŒ‚è½½ç‚¹å¹¶æŒ‚è½½
          sudo mkdir -p /mnt/extra-space
          sudo mount $DISK /mnt/extra-space
          
          # ç§»åŠ¨å·¥ä½œç›®å½•åˆ°é¢å¤–ç©ºé—´
          sudo mkdir -p /mnt/extra-space/immortalwrt
          sudo chown $USER:$USER /mnt/extra-space/immortalwrt
          
          # æ›´æ–°çŽ¯å¢ƒå˜é‡
          echo "REPO_PATH=/mnt/extra-space/immortalwrt" >> $GITHUB_ENV
          
          echo "âœ… ç£ç›˜æ‰©å±•å®Œæˆ"
          df -h

      - name: è®¾ç½®ç¼“å­˜å˜é‡
        id: cache
        run: |
          # ç”ŸæˆåŸºäºŽé…ç½®æ–‡ä»¶å†…å®¹çš„å“ˆå¸Œå€¼ä½œä¸ºç¼“å­˜é”®
          CONFIG_HASH=$(sha256sum $CONFIG_FILE | cut -d' ' -f1)
          REPO_HASH=$(sha256sum scripts/repo.sh | cut -d' ' -f1)
          echo "cache-key-immwrt-${{ env.VARIANT }}-${CONFIG_HASH}-${REPO_HASH}" >> $GITHUB_OUTPUT
          echo "cache-key-feeds-${CONFIG_HASH}-${REPO_HASH}" >> $GITHUB_OUTPUT

      - name: ç¼“å­˜ ImmortalWrt æºç 
        uses: actions/cache@v4
        id: cache-repo
        with:
          path: ${{ env.REPO_PATH }}
          key: ${{ steps.cache.outputs.cache-key-immwrt }}
          restore-keys: |
            cache-key-immwrt-${{ env.VARIANT }}-
            cache-key-immwrt-

      - name: ç¼“å­˜ Feeds
        uses: actions/cache@v4
        id: cache-feeds
        with:
          path: ${{ env.REPO_PATH }}/feeds
          key: ${{ steps.cache.outputs.cache-key-feeds }}
          restore-keys: |
            cache-key-feeds-

      - name: å…‹éš† ImmortalWrt æºç 
        if: steps.cache-repo.outputs.cache-hit != 'true'
        run: |
          echo "ðŸ“¥ å…‹éš† ImmortalWrt æºç ..."
          git clone https://github.com/${{ env.REPO_OWNER }}/${{ env.REPO_NAME }}.git ${{ env.REPO_PATH }}
          cd ${{ env.REPO_PATH }}
          git checkout ${{ env.REPO_BRANCH }}
          echo "âœ… æºç å…‹éš†å®Œæˆ"

      - name: æ›´æ–°æºç 
        if: steps.cache-repo.outputs.cache-hit == 'true'
        run: |
          echo "ðŸ”„ æ›´æ–°æºç ..."
          cd ${{ env.REPO_PATH }}
          git fetch origin
          git checkout ${{ env.REPO_BRANCH }}
          git pull origin ${{ env.REPO_BRANCH }}
          echo "âœ… æºç æ›´æ–°å®Œæˆ"

      - name: å®‰è£…ä¾èµ–
        run: |
          echo "ðŸ“¦ å®‰è£…æž„å»ºä¾èµ–..."
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            ccache \
            ecj \
            fastjar \
            file \
            g++ \
            gawk \
            gettext \
            java-runtime-common \
            javascript \
            libelf-dev \
            libncurses5-dev \
            libncursesw5-dev \
            libssl-dev \
            python3 \
            python3-debian \
            python3-distutils \
            python3-lib2to3 \
            python3-pyelftools \
            python3-setuptools \
            python3-unittest \
            rsync \
            subversion \
            swig \
            unzip \
            wget \
            python3-pip \
            python3-pyelftools \
            zlib1g-dev \
            qemu-utils \
            upx-ucl \
            llvm \
            clang \
            flex \
            bison \
            curl
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: å¤åˆ¶é…ç½®æ–‡ä»¶
        run: |
          echo "ðŸ“‹ å¤åˆ¶é…ç½®æ–‡ä»¶..."
          cp ${{ env.CONFIG_FILE }} ${{ env.REPO_PATH }}/.config
          echo "âœ… é…ç½®æ–‡ä»¶å¤åˆ¶å®Œæˆ"

      - name: æ˜¾ç¤ºç£ç›˜ä½¿ç”¨æƒ…å†µ
        run: |
          echo "ðŸ’¾ é…ç½®åŽç£ç›˜ä½¿ç”¨æƒ…å†µ:"
          df -h

      - name: æ›´æ–°ç¬¬ä¸‰æ–¹æº
        run: |
          echo "ðŸ”„ æ›´æ–°ç¬¬ä¸‰æ–¹æº..."
          cd ${{ env.REPO_PATH }}
          bash ../scripts/repo.sh
          echo "âœ… ç¬¬ä¸‰æ–¹æºæ›´æ–°å®Œæˆ"

      - name: ç”Ÿæˆ LUCI åŸºå‡†æŠ¥å‘Š
        run: |
          echo "ðŸ“„ ç”Ÿæˆ LUCI åŸºå‡†æŠ¥å‘Š..."
          cd ${{ env.REPO_PATH }}
          bash ../scripts/luci_report.sh
          echo "âœ… åŸºå‡†æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

      - name: æ›´æ–° Feeds
        run: |
          echo "ðŸ”„ æ›´æ–° Feeds..."
          cd ${{ env.REPO_PATH }}
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          echo "âœ… Feeds æ›´æ–°å®Œæˆ"

      - name: æ‰§è¡Œ defconfig
        run: |
          echo "âš™ï¸ æ‰§è¡Œ defconfig..."
          cd ${{ env.REPO_PATH }}
          make defconfig
          echo "âœ… defconfig å®Œæˆ"

      - name: ç”Ÿæˆ LUCI è½¯ä»¶åŒ…å˜æ›´æŠ¥å‘Š
        run: |
          echo "ðŸ“„ ç”Ÿæˆ LUCI è½¯ä»¶åŒ…å˜æ›´æŠ¥å‘Š..."
          cd ${{ env.REPO_PATH }}
          bash ../scripts/luci_report.sh
          echo "âœ… æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

      - name: ä¸Šä¼  LUCI æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: luci-report-${{ env.VARIANT }}-${{ github.run_number }}
          path: ${{ env.REPO_PATH }}/.luci_report.txt
          retention-days: 30

      - name: æå–è®¾å¤‡é…ç½®
        id: devices
        run: |
          echo "ðŸ” æå–è®¾å¤‡é…ç½®..."
          cd ${{ env.REPO_PATH }}
          
          # æå–è®¾å¤‡åˆ—è¡¨
          DEVICES=$(grep "^CONFIG_TARGET_DEVICE_.*=y$" .config | \
            sed -r 's/^CONFIG_TARGET_DEVICE_.*_DEVICE_(.*)=y$/\1/' | \
            sort -u | \
            tr '\n' ' ')
          
          echo "devices=$DEVICES" >> $GITHUB_OUTPUT
          echo "âœ… è®¾å¤‡é…ç½®æå–å®Œæˆ: $DEVICES"

      - name: æ˜¾ç¤ºç£ç›˜ä½¿ç”¨æƒ…å†µ
        run: |
          echo "ðŸ’¾ å½“å‰ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
          df -h

      - name: é…ç½®ç¼–è¯‘çŽ¯å¢ƒ
        run: |
          echo "âš™ï¸ é…ç½®ç¼–è¯‘çŽ¯å¢ƒ..."
          cd ${{ env.REPO_PATH }}
          
          # è®¾ç½®çº¿ç¨‹æ•°
          THREADS=$(nproc)
          echo "THREADS=$THREADS" >> $GITHUB_ENV
          echo "ðŸ”§ ä½¿ç”¨ $THREADS çº¿ç¨‹ç¼–è¯‘"
          
          # å¯ç”¨ ccache
          echo "CONFIG_CCACHE=y" >> .config
          
          # æ‰§è¡Œ DIY è„šæœ¬
          bash ../scripts/diy.sh
          
          echo "âœ… ç¼–è¯‘çŽ¯å¢ƒé…ç½®å®Œæˆ"

      - name: ç¼–è¯‘å›ºä»¶
        id: compile
        run: |
          echo "ðŸ”¨ å¼€å§‹ç¼–è¯‘å›ºä»¶..."
          cd ${{ env.REPO_PATH }}
          
          # è®¾ç½®ç¼–è¯‘å®Œæˆæ ‡å¿—
          echo "compile_completed=false" >> $GITHUB_OUTPUT
          
          # ç¼–è¯‘
          if make -j${{ env.THREADS }}; then
            echo "compile_completed=true" >> $GITHUB_OUTPUT
            echo "âœ… å›ºä»¶ç¼–è¯‘æˆåŠŸ"
          else
            echo "âŒ å›ºä»¶ç¼–è¯‘å¤±è´¥"
            exit 1
          fi

      - name: æ˜¾ç¤ºç£ç›˜ä½¿ç”¨æƒ…å†µ
        if: always()
        run: |
          echo "ðŸ’¾ ç¼–è¯‘åŽç£ç›˜ä½¿ç”¨æƒ…å†µ:"
          df -h

      - name: æ•´ç†å›ºä»¶æ–‡ä»¶
        if: steps.compile.outputs.compile_completed == 'true'
        run: |
          echo "ðŸ“¦ æ•´ç†å›ºä»¶æ–‡ä»¶..."
          cd ${{ env.REPO_PATH }}
          
          # åˆ›å»ºå›ºä»¶ç›®å½•
          mkdir -p firmware
          
          # å¤åˆ¶æ‰€æœ‰å›ºä»¶æ–‡ä»¶
          find bin/targets -name "*.bin" -o -name "*.img" -o -name "manifest" | \
            xargs -I {} cp {} firmware/
          
          # ç”Ÿæˆ README
          cat > firmware/README.md << EOF
# ImmortalWrt ${{ env.VARIANT }} å›ºä»¶

## æž„å»ºä¿¡æ¯
- æž„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
- æž„å»ºå˜ä½“: ${{ env.VARIANT }}
- æºç åˆ†æ”¯: ${{ env.REPO_BRANCH }}
- æäº¤å“ˆå¸Œ: $(git rev-parse --short HEAD)

## è®¾å¤‡åˆ—è¡¨
 ${{ steps.devices.outputs.devices }}

## æ–‡ä»¶è¯´æ˜Ž
- *.bin: å›ºä»¶æ–‡ä»¶
- *.img: é•œåƒæ–‡ä»¶
- manifest: åŒ…æ¸…å•
EOF
          
          echo "âœ… å›ºä»¶æ–‡ä»¶æ•´ç†å®Œæˆ"

      - name: ä¸Šä¼ å›ºä»¶åˆ°Artifacts
        uses: actions/upload-artifact@v4
        if: steps.compile.outputs.compile_completed == 'true'
        with:
          name: immortalwrt-${{ env.VARIANT }}-${{ github.run_number }}
          path: ${{ env.REPO_PATH }}/firmware/
          retention-days: 30

      - name: å‘å¸ƒåˆ°GitHub Release
        uses: softprops/action-gh-release@v2
        if: steps.compile.outputs.compile_completed == 'true' && github.event_name == 'push'
        with:
          tag_name: ${{ env.VARIANT }}-${{ github.run_number }}
          name: ImmortalWrt ${{ env.VARIANT }} Build ${{ github.run_number }}
          body_path: ${{ env.REPO_PATH }}/firmware/README.md
          files: ${{ env.REPO_PATH }}/firmware/*.*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ç¼“å­˜æ¸…ç†
        if: always()
        run: |
          echo "ðŸ§¹ æ¸…ç†è¿‡æœŸç¼“å­˜..."
          # ä¿ç•™æœ€è¿‘5ä¸ªç¼“å­˜
          gh cache list --repo ${{ github.repository }} --limit 20 | \
            grep "immwrt-" | \
            tail -n +6 | \
            awk '{print $1}' | \
            xargs -I {} gh cache delete --repo ${{ github.repository }} {} || true
        env:
          GH_TOKEN: ${{ github.token }}

      - name: æ¸…ç†å·¥ä½œç›®å½•
        if: always()
        run: |
          echo "ðŸ§¹ æ¸…ç†å·¥ä½œç›®å½•..."
          sudo rm -rf $REPO_PATH
          echo "ðŸ“Š æœ€ç»ˆç£ç›˜ç©ºé—´:"
          df -h
