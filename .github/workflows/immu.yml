name: ImmortalWrt å›ºä»¶ç¼–è¯‘å·¥ä½œæµ

on:
  workflow_dispatch:
    inputs:
      firmware_tag:
        description: 'å›ºä»¶æ ‡ç­¾'
        required: false
        default: 'ImmortalWrt'
        type: string
      upload_bin_dir:
        description: 'ä¸Šä¼ å®Œæ•´binç›®å½•'
        required: false
        default: false
        type: boolean
      firmware_release:
        description: 'å‘å¸ƒå›ºä»¶åˆ°Release'
        required: false
        default: true
        type: boolean
  workflow_call:
  # schedule:
  #   - cron: 0 20 * * *

env:
  # æºç ä»“åº“é…ç½®
  REPO_URL: https://github.com/laipeng668/immortalwrt.git
  REPO_BRANCH: master
  REPO_NAME: immwrt
  
  # é…ç½®æ–‡ä»¶è·¯å¾„
  CONFIG_FILE: configs/immu.config
  DIY_SCRIPT: scripts/diy.sh
  REPO_SCRIPT: scripts/repo.sh
  LUCI_REPORT_SCRIPT: scripts/luci_report.sh
  
  # ç¼–è¯‘é…ç½®
  CLASH_KERNEL: amd64
  UPLOAD_BIN_DIR: ${{ github.event.inputs.upload_bin_dir || 'false' }}
  FIRMWARE_RELEASE: ${{ github.event.inputs.firmware_release || 'true' }}
  FIRMWARE_TAG: ${{ github.event.inputs.firmware_tag || 'ImmortalWrt' }}
  TZ: Asia/Shanghai

jobs:
  Build:
    runs-on: ubuntu-24.04

    steps:
    - name: æ£€æŸ¥æœåŠ¡å™¨æ€§èƒ½
      run: |
        echo "========æœåŠ¡å™¨æ€§èƒ½ä¿¡æ¯========"
        echo "CPUä¿¡æ¯:"
        lscpu | grep "Model name" | cut -d':' -f2- | xargs
        echo "CPUæ ¸å¿ƒæ•°: $(nproc)"
        echo "å†…å­˜ä¿¡æ¯:"
        free -h
        echo "ç£ç›˜ä¿¡æ¯:"
        df -hT
        echo "================================"

    - name: åˆå§‹åŒ–ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        echo "========åˆå§‹åŒ–ç¯å¢ƒ========"
        sudo -E apt-get -y update
        sudo -E apt-get -y install $(curl -fsSL ophub.org/ubuntu2404-make-openwrt-depends)
        sudo -E systemctl daemon-reload
        sudo timedatectl set-timezone "$TZ"
        echo "ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
        echo "========================"

    - name: æ‰©å±•ç£ç›˜ç©ºé—´
      run: |
        echo "========æ‰©å±•ç£ç›˜ç©ºé—´========"
        
        # æ£€æŸ¥å¯ç”¨ç£ç›˜
        df -hT
        
        # å°è¯•æ‰©å±•ç£ç›˜ç©ºé—´
        if [ -b /dev/sda ]; then
          DEVICE="sda"
        elif [ -b /dev/sdb ]; then
          DEVICE="sdb"
        else
          echo "æœªæ‰¾åˆ°å¯ç”¨çš„ç£ç›˜è®¾å¤‡"
          exit 1
        fi
        
        echo "ä½¿ç”¨ç£ç›˜è®¾å¤‡: /dev/$DEVICE"
        
        # æ£€æŸ¥ç£ç›˜åˆ†åŒº
        sudo fdisk -l /dev/$DEVICE
        
        # å°è¯•æ‰©å±•åˆ†åŒº
        if sudo growpart /dev/$DEVICE 1; then
          echo "åˆ†åŒºæ‰©å±•æˆåŠŸ"
          # æ‰©å±•æ–‡ä»¶ç³»ç»Ÿ
          if sudo resize2fs /dev/${DEVICE}1; then
            echo "æ–‡ä»¶ç³»ç»Ÿæ‰©å±•æˆåŠŸ"
          else
            echo "æ–‡ä»¶ç³»ç»Ÿæ‰©å±•å¤±è´¥ï¼Œå°è¯•xfsæ–‡ä»¶ç³»ç»Ÿ"
            sudo xfs_growfs /
          fi
        else
          echo "åˆ†åŒºæ‰©å±•å¤±è´¥ï¼Œå¯èƒ½å·²ç»æ˜¯æœ€å¤§åˆ†åŒº"
        fi
        
        # å†æ¬¡æ£€æŸ¥ç£ç›˜ç©ºé—´
        df -hT
        echo "========================"

    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: å…‹éš†æºä»£ç 
      run: |
        echo "========å…‹éš†æºä»£ç ========"
        df -hT $GITHUB_WORKSPACE
        
        # åˆ›å»ºå·¥ä½œç›®å½•
        sudo mkdir -p /mnt/openwrt
        sudo chown -R $(id -u):$(id -g) /mnt/openwrt
        
        # å…‹éš†æºç 
        git clone --depth 1 -b $REPO_BRANCH --single-branch $REPO_URL /mnt/openwrt
        cd /mnt/openwrt
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV
        
        # è·å–ç‰ˆæœ¬ä¿¡æ¯
        VERSION_INFO=$(git show -s --date=short --format="ä½œè€…: %an<br/>æ—¶é—´: %cd<br/>å†…å®¹: %s<br/>hash: %H")
        echo "VERSION_INFO=$VERSION_INFO" >> $GITHUB_ENV
        
        # è·å–å†…æ ¸ç‰ˆæœ¬
        VERSION_KERNEL=$(grep -oP 'LINUX_KERNEL_HASH-\K[0-9]+\.[0-9]+\.[0-9]+' target/linux/generic/kernel-6.12 2>/dev/null || echo "æœªçŸ¥")
        echo "VERSION_KERNEL=$VERSION_KERNEL" >> $GITHUB_ENV
        
        # è·å–æºç å“ˆå¸Œ
        echo "HASH=$(git log -1 --pretty=format:'%h')" >> $GITHUB_ENV
        echo "CACHE_DATE=$(date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_ENV
        
        echo "æºç å…‹éš†å®Œæˆ"
        echo "========================"

    - name: ç”Ÿæˆå˜é‡
      run: |
        echo "========ç”Ÿæˆå˜é‡========"
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        cp $CONFIG_FILE $OPENWRT_PATH/.config
        cd $OPENWRT_PATH
        
        # æ‰§è¡Œdefconfig
        make defconfig > /dev/null 2>&1
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        SOURCE_REPO="$(echo $REPO_URL | awk -F '/' '{print $(NF)}')"
        echo "SOURCE_REPO=$SOURCE_REPO" >> $GITHUB_ENV
        
        DEVICE_TARGET=$(cat .config | grep CONFIG_TARGET_BOARD | awk -F '"' '{print $2}')
        echo "DEVICE_TARGET=$DEVICE_TARGET" >> $GITHUB_ENV
        
        DEVICE_SUBTARGET=$(cat .config | grep CONFIG_TARGET_SUBTARGET | awk -F '"' '{print $2}')
        echo "DEVICE_SUBTARGET=$DEVICE_SUBTARGET" >> $GITHUB_ENV
        
        # ä»é…ç½®æ–‡ä»¶ä¸­æå–è®¾å¤‡åˆ—è¡¨
        DEVICES=$(grep "^CONFIG_TARGET_DEVICE_.*_DEVICE_.*=y$" .config | sed 's/^CONFIG_TARGET_DEVICE_.*_DEVICE_\(.*\)=y$/\1/' | sort -u | tr '\n' ' ')
        echo "DEVICES=$DEVICES" >> $GITHUB_ENV
        
        echo "è®¾å¤‡åˆ—è¡¨: $DEVICES"
        echo "å˜é‡ç”Ÿæˆå®Œæˆ"
        echo "========================"

    - name: ç¼“å­˜å·¥å…·é“¾
      uses: actions/cache@v4
      with:
        key: ${{ env.REPO_NAME }}-${{ env.REPO_BRANCH }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-${{ env.HASH }}-${{ env.CACHE_DATE }}
        restore-keys: ${{ env.REPO_NAME }}-${{ env.REPO_BRANCH }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-
        path: |
          ${{ env.OPENWRT_PATH }}/.ccache
          ${{ env.OPENWRT_PATH }}/staging_dir

    - name: åˆ·æ–°ç¼“å­˜
      run: |
        echo "========åˆ·æ–°ç¼“å­˜========"
        if [ -d "$OPENWRT_PATH/staging_dir" ]; then
          find "$OPENWRT_PATH/staging_dir" -type d -name "stamp" -not -path "*target*" | while read -r dir; do
              find "$dir" -type f -exec touch {} +
          done
          echo "ç¼“å­˜åˆ·æ–°å®Œæˆ"
        else
          echo "ç¼“å­˜ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ·æ–°"
        fi
        echo "========================"

    - name: å®‰è£…Feeds
      run: |
        echo "========å®‰è£…Feeds========"
        cd $OPENWRT_PATH
        echo "æ›´æ–°Feeds..."
        ./scripts/feeds update -a
        echo "å®‰è£…Feeds..."
        ./scripts/feeds install -a
        echo "Feedså®‰è£…å®Œæˆ"
        echo "========================"

    - name: æ˜¾ç¤ºç¼–è¯‘å‰ç£ç›˜ç©ºé—´
      run: |
        echo "========ç¼–è¯‘å‰ç£ç›˜ç©ºé—´========"
        df -hT
        echo "========================"

    - name: æ›´æ–°ç¬¬ä¸‰æ–¹æºå¹¶ç”ŸæˆLUCIæŠ¥å‘Š
      run: |
        echo "========æ›´æ–°ç¬¬ä¸‰æ–¹æºå¹¶ç”ŸæˆLUCIæŠ¥å‘Š========"
        cd $OPENWRT_PATH
        
        # è®¾ç½®è„šæœ¬æƒé™
        chmod +x $GITHUB_WORKSPACE/$REPO_SCRIPT
        chmod +x $GITHUB_WORKSPACE/$LUCI_REPORT_SCRIPT
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        cp $GITHUB_WORKSPACE/$CONFIG_FILE $OPENWRT_PATH/.config
        
        # è¿è¡Œrepo.shæ›´æ–°ç¬¬ä¸‰æ–¹æº
        echo "è¿è¡Œrepo.shæ›´æ–°ç¬¬ä¸‰æ–¹æº..."
        $GITHUB_WORKSPACE/$REPO_SCRIPT
        
        # è¿è¡Œluci_report.shç”Ÿæˆdefconfigå‰çš„æŠ¥å‘Š
        echo "ç”Ÿæˆdefconfigå‰çš„LUCIæŠ¥å‘Š..."
        $GITHUB_WORKSPACE/$LUCI_REPORT_SCRIPT $OPENWRT_PATH/.config
        
        # æ‰§è¡Œdefconfig
        echo "æ‰§è¡Œmake defconfig..."
        make defconfig
        
        # è¿è¡Œluci_report.shç”Ÿæˆdefconfigåçš„æŠ¥å‘Š
        echo "ç”Ÿæˆdefconfigåçš„LUCIæŠ¥å‘Š..."
        $GITHUB_WORKSPACE/$LUCI_REPORT_SCRIPT $OPENWRT_PATH/.config
        
        # ä¸Šä¼ æŠ¥å‘Šæ–‡ä»¶
        mkdir -p $GITHUB_WORKSPACE/reports
        cp -r $OPENWRT_PATH/reports/* $GITHUB_WORKSPACE/reports/ 2>/dev/null || true
        
        echo "ç¬¬ä¸‰æ–¹æºæ›´æ–°å’ŒLUCIæŠ¥å‘Šç”Ÿæˆå®Œæˆ"
        echo "========================"

    - name: ä¸Šä¼ LUCIæŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.REPO_NAME }}-luci-report-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-${{ env.FILE_DATE }}
        path: reports/

    - name: åŠ è½½è‡ªå®šä¹‰é…ç½®
      run: |
        echo "========åŠ è½½è‡ªå®šä¹‰é…ç½®========"
        chmod +x $DIY_SCRIPT
        cd $OPENWRT_PATH
        $GITHUB_WORKSPACE/$DIY_SCRIPT
        echo "è‡ªå®šä¹‰é…ç½®åŠ è½½å®Œæˆ"
        echo "========================"

    - name: ä¸‹è½½DLè½¯ä»¶åŒ…
      run: |
        echo "========ä¸‹è½½DLè½¯ä»¶åŒ…========"
        cd $OPENWRT_PATH
        cat $GITHUB_WORKSPACE/$CONFIG_FILE > .config
        make defconfig
        make download -j$(nproc)
        echo "DLè½¯ä»¶åŒ…ä¸‹è½½å®Œæˆ"
        echo "========================"

    - name: ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        echo "========ç¼–è¯‘å›ºä»¶========"
        cd $OPENWRT_PATH
        echo -e "$(nproc) çº¿ç¨‹ç¼–è¯‘"
        
        # å°è¯•å¤šçº¿ç¨‹ç¼–è¯‘ï¼Œå¤±è´¥åˆ™å°è¯•å•çº¿ç¨‹
        if ! make -j$(nproc); then
          echo "å¤šçº¿ç¨‹ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
          if ! make -j1; then
            echo "å•çº¿ç¨‹ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•è¯¦ç»†æ¨¡å¼ç¼–è¯‘..."
            make -j1 V=s
          fi
        fi
        
        echo "status=success" >> $GITHUB_OUTPUT
        echo "DATE=$(date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_ENV
        echo "FILE_DATE=$(date +"%Y.%m.%d")" >> $GITHUB_ENV
        echo "å›ºä»¶ç¼–è¯‘å®Œæˆ"
        echo "========================"

    - name: æ˜¾ç¤ºç¼–è¯‘åç£ç›˜ç©ºé—´
      if: (!cancelled())
      run: |
        echo "========ç¼–è¯‘åç£ç›˜ç©ºé—´========"
        df -hT
        echo "========================"

    - name: ä¸Šä¼ Binç›®å½•
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.REPO_NAME }}-bin-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-${{ env.FILE_DATE }}
        path: ${{ env.OPENWRT_PATH }}/bin

    - name: æ•´ç†æ–‡ä»¶
      if: steps.compile.outputs.status == 'success'
      run: |
        echo "========æ•´ç†æ–‡ä»¶========"
        cd $OPENWRT_PATH/bin/targets/*/*
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶
        cp $OPENWRT_PATH/.config ImmortalWrt.config
        
        # é‡å‘½åæ–‡ä»¶
        mv config.buildinfo ImmortalWrt.config.buildinfo
        mv immortalwrt-qualcommax-ipq60xx.manifest immortalwrt-qualcommax-ipq60xx-ImmortalWrt.manifest
        
        # å¤„ç†åŒ…æ–‡ä»¶
        if [ -d "$OPENWRT_PATH/bin/packages" ]; then
          mv -f $OPENWRT_PATH/bin/packages/*/*/*.apk packages 2>/dev/null || true
          if [ -d "packages" ]; then
            tar -zcf ImmortalWrt.Packages.tar.gz packages
          fi
        fi
        
        # åˆ é™¤ä¸éœ€è¦çš„æ–‡ä»¶
        rm -rf packages feeds.buildinfo version.buildinfo sha256sums profiles.json
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV
        
        echo "æ–‡ä»¶æ•´ç†å®Œæˆ"
        echo "========================"

    - name: ä¸Šä¼ å›ºä»¶åˆ°Artifact
      if: steps.compile.outputs.status == 'success' && env.FIRMWARE_RELEASE != 'true'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.REPO_NAME }}-firmware-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE_PATH }}

    - name: å‘å¸ƒå›ºä»¶åˆ°Release
      if: steps.compile.outputs.status == 'success' && env.FIRMWARE_RELEASE == 'true'
      uses: ncipollo/release-action@v1
      with:
        name: ${{ env.DATE }} for ${{ env.FIRMWARE_TAG }}
        allowUpdates: true
        tag: ${{ env.FIRMWARE_TAG }}
        token: ${{ secrets.GITHUB_TOKEN }}
        artifacts: ${{ env.FIRMWARE_PATH }}/*
        body: |
          **è¿™æ˜¯ ${{ env.FIRMWARE_TAG }} å¹³å°ä½¿ç”¨çš„ ImmortalWrt å›ºä»¶**
          ### ğŸ“’ å›ºä»¶ä¿¡æ¯
          - è¿™æ˜¯å¼€å¯å…¨åŠŸèƒ½NSSçš„6.12å†…æ ¸å›ºä»¶ï¼Œé»˜è®¤ä¸»é¢˜ä¸ºArgonï¼›è¯¥å›ºä»¶åœ¨ImmortalWrtçš„åŸºç¡€ä¸Šï¼Œæ·»åŠ äº†è‹¥å¹²å·¥å…·ï¼Œå…·ä½“è¯¦è§å¯¹åº”æœºå‹çš„configã€‚
          - ğŸ’» è¿™æ˜¯ ${{ env.FIRMWARE_TAG }} å¹³å°ä½¿ç”¨çš„ ImmortalWrt å›ºä»¶
          - âš½ å›ºä»¶æºç : ${{ env.REPO_URL }}
          - ğŸ’ æºç åˆ†æ”¯: ${{ env.REPO_BRANCH }}
          - ğŸŒ é»˜è®¤åœ°å€: **192.168.111.1**
          - ğŸ”‘ é»˜è®¤å¯†ç : none
          ### ğŸ§Š å›ºä»¶ç‰ˆæœ¬
          - å›ºä»¶å†…æ ¸ç‰ˆæœ¬ï¼š**${{ env.VERSION_KERNEL }}**
          - å›ºä»¶ç¼–è¯‘å‰æœ€åä¸€æ¬¡â¦[ä¸»æºç ](${{ env.REPO_URL }})æ›´æ–°è®°å½•
          - ${{ env.VERSION_INFO }}

    - name: åˆ é™¤æ—§ç¼“å­˜
      run: |
        echo "========åˆ é™¤æ—§ç¼“å­˜========"
        # è·å–ç¼“å­˜åˆ—è¡¨å¹¶åˆ é™¤
        gh cache list --key ${{ env.REPO_NAME }}-${{ env.REPO_BRANCH }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}- --json key --jq '.[] | .key' | while read -r key; do
          gh cache delete "$key"
        done
        # è¾“å‡ºç¼“å­˜çŠ¶æ€
        echo "ccache: $(du -sh $OPENWRT_PATH/.ccache 2>/dev/null | cut -f 1 || echo "0")"
        echo "staging: $(du -sh $OPENWRT_PATH/staging_dir 2>/dev/null | cut -f 1 || echo "0")"
        echo "========================"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
