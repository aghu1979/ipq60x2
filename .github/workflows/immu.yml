name: ImmortalWrt IPQ60xx Auto Build

on:
  workflow_dispatch:
    inputs:
      cache_version:
        description: 'ç¼“å­˜ç‰ˆæœ¬ï¼ˆç”¨äºŽå¼ºåˆ¶æ›´æ–°ç¼“å­˜ï¼‰'
        required: false
        default: 'v1'
        type: string

env:
  REPO_URL: https://github.com/laipeng668/immortalwrt.git
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: configs/immu.config
  DIY_P1_SH: scripts/diy.sh
  DIY_P2_SH: scripts/repo.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_COWTRANSFER: false
  UPLOAD_WETRANSFER: false
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  VARIANT: 'Max'
  DEBUG: false
  CACHE_VERSION: ${{ github.event.inputs.cache_version || 'v1' }}

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
      packages: write
      
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½®ç¼“å­˜å˜é‡
        run: |
          # ç”Ÿæˆé«˜å‘½ä¸­çŽ‡çš„ç¼“å­˜é”®
          SOURCE_HASH=$(echo "${{ env.REPO_URL }}${{ env.REPO_BRANCH }}" | sha256sum | cut -d' ' -f1)
          CONFIG_HASH=$(sha256sum ${{ env.CONFIG_FILE }} | cut -d' ' -f1)
          FEEDS_HASH=$(cat scripts/diy.sh scripts/repo.sh | sha256sum | cut -d' ' -f1)
          
          # ç»„åˆç¼“å­˜é”®ï¼ŒåŒ…å«ç‰ˆæœ¬æŽ§åˆ¶
          CACHE_KEY="immwrt-${{ env.CACHE_VERSION }}-${SOURCE_HASH:0:8}-${CONFIG_HASH:0:8}-${FEEDS_HASH:0:8}"
          
          echo "SOURCE_HASH=$SOURCE_HASH" >> $GITHUB_ENV
          echo "CONFIG_HASH=$CONFIG_HASH" >> $GITHUB_ENV
          echo "FEEDS_HASH=$FEEDS_HASH" >> $GITHUB_ENV
          echo "CACHE_KEY=$CACHE_KEY" >> $GITHUB_ENV
          
          echo "ðŸ”‘ ç¼“å­˜é”®ç”Ÿæˆå®Œæˆ: $CACHE_KEY"

      - name: ç¼“å­˜å·¥å…·é“¾å’Œä¸‹è½½
        uses: actions/cache@v4
        id: cache
        with:
          path: |
            ${{ env.WORKDIR }}/immortalwrt/tmp
            ${{ env.WORKDIR }}/immortalwrt/staging_dir
            ${{ env.WORKDIR }}/immortalwrt/dl
            ${{ env.WORKDIR }}/immortalwrt/build_dir
          key: ${{ env.CACHE_KEY }}
          restore-keys: |
            immwrt-${{ env.CACHE_VERSION }}-
            immwrt-

      - name: åˆå§‹åŒ–ç¼–è¯‘çŽ¯å¢ƒ
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-2204)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: æ‰©å±•ç£ç›˜ç©ºé—´
        run: |
          # æ£€æŸ¥å¯ç”¨ç£ç›˜ç©ºé—´
          echo "ðŸ“Š åˆå§‹ç£ç›˜ç©ºé—´:"
          df -h
          
          # æ‰©å±•ç£ç›˜ç©ºé—´åˆ°æœ€å¤§
          sudo apt-get clean
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo docker system prune -af
          
          # åˆ›å»ºä¸´æ—¶å·¥ä½œç›®å½•
          if [ -d /mnt/sda1 ]; then
            sudo umount /mnt/sda1 2>/dev/null || true
            sudo mkfs.ext4 -F /dev/sda1
            sudo mount /dev/sda1 /mnt/sda1
            sudo chown $USER:$GROUPS /mnt/sda1
            export WORKDIR=/mnt/sda1
          elif [ -d /mnt/sdb1 ]; then
            sudo umount /mnt/sdb1 2>/dev/null || true
            sudo mkfs.ext4 -F /dev/sdb1
            sudo mount /dev/sdb1 /mnt/sdb1
            sudo chown $USER:$GROUPS /mnt/sdb1
            export WORKDIR=/mnt/sdb1
          else
            export WORKDIR=/workdir
          fi
          
          echo "ðŸ”§ ä½¿ç”¨å·¥ä½œç›®å½•: $WORKDIR"
          echo "WORKDIR=$WORKDIR" >> $GITHUB_ENV

      - name: å…‹éš†æºç 
        working-directory: ${{ env.WORKDIR }}
        run: |
          df -h
          echo "ðŸ”„ å¼€å§‹å…‹éš†æºç ..."
          
          # å¦‚æžœç¼“å­˜æœªå‘½ä¸­ï¼Œå®Œæ•´å…‹éš†
          if [ "${{ steps.cache.outputs.cache-hit }}" != "true" ]; then
            echo "ðŸ“¦ ç¼“å­˜æœªå‘½ä¸­ï¼Œæ‰§è¡Œå®Œæ•´å…‹éš†..."
            git clone $REPO_URL -b $REPO_BRANCH immortalwrt
          else
            echo "ðŸ’¾ ç¼“å­˜å‘½ä¸­ï¼Œæ£€æŸ¥æºç ..."
            if [ ! -d "immortalwrt" ]; then
              git clone $REPO_URL -b $REPO_BRANCH immortalwrt
            else
              cd immortalwrt
              git fetch origin
              git reset --hard origin/$REPO_BRANCH
            fi
          fi
          
          cd immortalwrt
          echo "ðŸ“ å½“å‰æäº¤ä¿¡æ¯:"
          git log -1 --oneline
          echo "REPO_PATH=$WORKDIR/immortalwrt" >> $GITHUB_ENV

      - name: ç¼“å­˜çŠ¶æ€æŠ¥å‘Š
        run: |
          echo "ðŸ“Š ç¼“å­˜çŠ¶æ€æŠ¥å‘Š"
          echo "=================="
          echo "ç¼“å­˜é”®: ${{ env.CACHE_KEY }}"
          echo "ç¼“å­˜å‘½ä¸­: ${{ steps.cache.outputs.cache-hit }}"
          echo "æºç å“ˆå¸Œ: ${{ env.SOURCE_HASH }}"
          echo "é…ç½®å“ˆå¸Œ: ${{ env.CONFIG_HASH }}"
          echo "è„šæœ¬å“ˆå¸Œ: ${{ env.FEEDS_HASH }}"
          
          if [ "${{ steps.cache.outputs.cache-hit }}" == "true" ]; then
            echo "âœ… ç¼“å­˜å‘½ä¸­ï¼Œè·³è¿‡ä¸‹è½½æ­¥éª¤"
          else
            echo "â¬‡ï¸ ç¼“å­˜æœªå‘½ä¸­ï¼Œå°†æ‰§è¡Œå®Œæ•´ä¸‹è½½"
          fi

      - name: åŠ è½½é€šç”¨å‡½æ•°åº“
        run: |
          source scripts/common.sh
          echo "âœ… é€šç”¨å‡½æ•°åº“åŠ è½½å®Œæˆ"

      - name: åŠ è½½è‡ªå®šä¹‰é…ç½®
        run: |
          [ -e files ] && mv files $REPO_PATH/files
          [ -e $DIY_P1_SH ] && chmod +x $DIY_P1_SH && cd $REPO_PATH && $GITHUB_WORKSPACE/$DIY_P1_SH
          [ -e $CONFIG_FILE ] && cp $CONFIG_FILE $REPO_PATH/.config

      - name: æ›´æ–°è½¯ä»¶æº
        id: update
        run: |
          cd $REPO_PATH
          echo "ðŸ“¦ æ›´æ–°feeds..."
          ./scripts/feeds update -a
          echo "ðŸ“¦ å®‰è£…feeds..."
          ./scripts/feeds install -a
          echo "feeds_updated=true" >> $GITHUB_OUTPUT

      - name: ç”ŸæˆLuciè½¯ä»¶åŒ…æŠ¥å‘Š
        id: report
        run: |
          cd $REPO_PATH
          echo "ðŸ“Š ç”ŸæˆLuciè½¯ä»¶åŒ…å·®å¼‚æŠ¥å‘Š..."
          chmod +x $GITHUB_WORKSPACE/scripts/luci_report.sh
          $GITHUB_WORKSPACE/scripts/luci_report.sh
          echo "report_generated=true" >> $GITHUB_OUTPUT

      - name: ä¸Šä¼ LuciæŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: steps.report.outputs.report_generated == 'true'
        with:
          name: luci-report-${{ env.VARIANT }}
          path: ${{ env.REPO_PATH }}/luci_report_*.txt
          retention-days: 7

      - name: æå–è®¾å¤‡é…ç½®
        id: devices
        run: |
          source scripts/common.sh
          devices=$(extract_devices_from_config $CONFIG_FILE)
          echo "ðŸ“± æ£€æµ‹åˆ°è®¾å¤‡: $devices"
          echo "devices=$devices" >> $GITHUB_OUTPUT
          
          # ç”Ÿæˆè®¾å¤‡åˆ—è¡¨æ–‡ä»¶
          echo "$devices" | tr ' ' '\n' > $REPO_PATH/device_list.txt
          echo "device_list_path=$REPO_PATH/device_list.txt" >> $GITHUB_OUTPUT

      - name: é…ç½®ç¼–è¯‘é€‰é¡¹
        run: |
          cd $REPO_PATH
          echo "âš™ï¸ åº”ç”¨é…ç½®æ–‡ä»¶..."
          make defconfig
          
          # æ˜¾ç¤ºå…³é”®é…ç½®
          echo "ðŸ“‹ ç¼–è¯‘é…ç½®æ‘˜è¦:"
          grep -E "^CONFIG_TARGET_DEVICE|^CONFIG_ATH11K_MEM_PROFILE|^CONFIG_NSS_FIRMWARE_VERSION" .config || true

      - name: ä¸‹è½½ä¾èµ–åŒ…
        id: download
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd $REPO_PATH
          echo "â¬‡ï¸ ä¸‹è½½ä¾èµ–åŒ…..."
          if [ "$DEBUG" == "true" ]; then
            make download -j8 V=s 2>&1 | tee download.log
          else
            make download -j8
          fi
          echo "download_completed=true" >> $GITHUB_OUTPUT

      - name: ç¼–è¯‘å›ºä»¶
        id: compile
        run: |
          cd $REPO_PATH
          echo "ðŸ”¨ å¼€å§‹ç¼–è¯‘å›ºä»¶..."
          
          # è®¾ç½®ç¼–è¯‘å‚æ•°
          if [ "$DEBUG" == "true" ]; then
            make -j$(nproc) V=s 2>&1 | tee compile.log
          else
            # ä½¿ç”¨ä¼ä¸šçº§é”™è¯¯æŽ§åˆ¶
            make IGNORE_ERRORS=1 -j$(nproc) || {
              echo "âš ï¸ ç¼–è¯‘å‡ºçŽ°é”™è¯¯ï¼Œå°è¯•å•çº¿ç¨‹é‡æ–°ç¼–è¯‘å…³é”®åŒ…..."
              make IGNORE_ERRORS=1 -j1 V=s
            }
          fi
          
          echo "compile_completed=true" >> $GITHUB_OUTPUT

      - name: æ˜¾ç¤ºç£ç›˜ç©ºé—´
        run: |
          echo "ðŸ“Š ç¼–è¯‘åŽç£ç›˜ç©ºé—´:"
          df -h
          echo "ðŸ“¦ å›ºä»¶å¤§å°ç»Ÿè®¡:"
          cd $REPO_PATH
          du -sh bin/targets/*/* 2>/dev/null || true

      - name: æ•´ç†å›ºä»¶æ–‡ä»¶
        run: |
          cd $REPO_PATH
          mkdir -p firmware
          
          # å¤åˆ¶æ‰€æœ‰å›ºä»¶æ–‡ä»¶
          find bin/targets -name "*.bin" -o -name "*.img" -o -name "*.elf" | while read file; do
            cp $file firmware/
          done
          
          # å¤åˆ¶manifestæ–‡ä»¶
          find bin/targets -name "manifest" | while read file; do
            cp $file firmware/
          done
          
          # ç”Ÿæˆå›ºä»¶ä¿¡æ¯ - ä¿®å¤è¯­æ³•é”™è¯¯
          cat > firmware/README.md << EOF
## å›ºä»¶ä¿¡æ¯

- **å˜ä½“**: $VARIANT
- **æºç **: $REPO_URL
- **åˆ†æ”¯**: $REPO_BRANCH
- **æäº¤**: $(git rev-parse HEAD)
- **ç¼–è¯‘æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')
- **è®¾å¤‡**: $(cat device_list.txt | tr '\n' ' ')
- **ç¼“å­˜é”®**: $CACHE_KEY
- **è°ƒè¯•æ¨¡å¼**: $DEBUG

### ç¼–è¯‘çŽ¯å¢ƒ
- **è¿è¡ŒçŽ¯å¢ƒ**: Ubuntu 22.04
- **CPUæ ¸å¿ƒæ•°**: $(nproc)
- **å†…å­˜**: $(free -h | awk 'NR==2{print $2}')
- **ç¼“å­˜å‘½ä¸­**: ${{ steps.cache.outputs.cache-hit }}

### æ–‡ä»¶è¯´æ˜Ž
- *.bin: å›ºä»¶æ–‡ä»¶
- *.img: é•œåƒæ–‡ä»¶
- manifest: åŒ…æ¸…å•
EOF

      - name: ä¸Šä¼ å›ºä»¶åˆ°Artifacts
        uses: actions/upload-artifact@v4
        if: steps.compile.outputs.compile_completed == 'true'
        with:
          name: immortalwrt-${{ env.VARIANT }}-${{ github.run_number }}
          path: ${{ env.REPO_PATH }}/firmware/
          retention-days: 30

      - name: å‘å¸ƒåˆ°GitHub Release
        uses: softprops/action-gh-release@v2
        if: steps.compile.outputs.compile_completed == 'true'
        with:
          tag_name: ${{ env.VARIANT }}-${{ github.run_number }}
          name: ImmortalWrt ${{ env.VARIANT }} Build ${{ github.run_number }}
          body_path: ${{ env.REPO_PATH }}/firmware/README.md
          files: ${{ env.REPO_PATH }}/firmware/*.*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ç¼“å­˜æ¸…ç†
        if: always()
        run: |
          echo "ðŸ§¹ æ¸…ç†è¿‡æœŸç¼“å­˜..."
          # ä¿ç•™æœ€è¿‘5ä¸ªç¼“å­˜
          gh cache list --repo ${{ github.repository }} --limit 20 | \
            grep "immwrt-" | \
            tail -n +6 | \
            awk '{print $1}' | \
            xargs -I {} gh cache delete --repo ${{ github.repository }} {} || true
        env:
          GH_TOKEN: ${{ github.token }}

      - name: æ¸…ç†å·¥ä½œç›®å½•
        if: always()
        run: |
          echo "ðŸ§¹ æ¸…ç†å·¥ä½œç›®å½•..."
          sudo rm -rf $REPO_PATH
          echo "ðŸ“Š æœ€ç»ˆç£ç›˜ç©ºé—´:"
          df -h
