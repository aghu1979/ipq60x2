name: IPQ60XX-Base-Build

on:
  workflow_dispatch:
  workflow_call:

env:
  # åŸºç¡€é…ç½®
  TZ: Asia/Shanghai
  OPENWRT_PATH: /mnt/openwrt
  
  # ä»“åº“é…ç½® - ä½¿ç”¨å˜é‡ä»¥ä¾¿æ‰©å±•
  CONFIG_BASE_DIR: configs
  DIY_SCRIPT_DIR: scripts
  
  # æ„å»ºé…ç½®
  UPLOAD_BIN_DIR: false
  FIRMWARE_RELEASE: false  # æ ¹æ®è¦æ±‚ï¼Œä¸éœ€è¦å‘å¸ƒrelease
  
  # ç¼“å­˜é…ç½® - ç§»é™¤æ—¥æœŸï¼Œæé«˜ç¼“å­˜å‘½ä¸­ç‡
  CACHE_VERSION: v1
  
  # æ—¥å¿—é…ç½®
  LOG_LEVEL: INFO  # DEBUG, INFO, WARN, ERROR
  LOG_FILE: build.log
  REPORT_FILE: build_report.json

jobs:
  Build:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        # å®šä¹‰è¦å¹¶è¡Œæ„å»ºçš„ä»“åº“é…ç½®
        repo_config: 
          - immwrt
          - openwrt
          - libwrt
        # èŠ¯ç‰‡ç³»åˆ— - æš‚æ—¶æ³¨é‡Šæ‰ipq80xxï¼Œåªä¿ç•™ipq60xx
        chip_family:
          - ipq60xx
          # - ipq80xx  # æš‚æ—¶æ³¨é‡Šï¼Œè¿˜æ²¡æœ‰æ‰©å±•è®¡åˆ’
    
    # ä½¿ç”¨ç¯å¢ƒå˜é‡è®¾ç½®èŠ¯ç‰‡ç³»åˆ—å’Œä»“åº“é…ç½®
    env:
      CHIP_FAMILY: ${{ matrix.chip_family }}
      REPO_CONFIG: ${{ matrix.repo_config }}
      BUILD_ID: ${{ github.run_id }}-${{ matrix.repo_config }}-${{ matrix.chip_family }}
      
    steps:

    - name: åˆå§‹åŒ–ä¼ä¸šçº§æ—¥å¿—ç³»ç»Ÿ
      id: init_logging
      run: |
        # åˆ›å»ºä¼ä¸šçº§æ—¥å¿—æ¡†æ¶
        cat > /tmp/logger.sh << 'EOF'
        #!/bin/bash
        
        # æ—¥å¿—çº§åˆ«å®šä¹‰
        declare -A LOG_LEVELS=([DEBUG]=0 [INFO]=1 [WARN]=2 [ERROR]=3)
        CURRENT_LEVEL=${LOG_LEVELS[$LOG_LEVEL]}
        
        # æ—¥å¿—æ–‡ä»¶
        LOG_FILE="$GITHUB_WORKSPACE/$LOG_FILE"
        REPORT_FILE="$GITHUB_WORKSPACE/$REPORT_FILE"
        
        # åˆå§‹åŒ–æ—¥å¿—æ–‡ä»¶
        echo "=== Build Log Started at $(date) ===" > "$LOG_FILE"
        echo '{"build_id":"'$BUILD_ID'","start_time":"'$(date -Iseconds)'","steps":[],"errors":[],"warnings":[],"build_errors":[]}' > "$REPORT_FILE"
        
        # æ—¥å¿—å‡½æ•°
        log() {
            local level="$1"
            local message="$2"
            local step="${3:-$(caller | awk '{print $2}')}"
            local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
            
            # æ£€æŸ¥æ—¥å¿—çº§åˆ«
            if [ ${LOG_LEVELS[$level]} -ge $CURRENT_LEVEL ]; then
                # æ§åˆ¶å°è¾“å‡ºï¼ˆå¸¦é¢œè‰²ï¼‰
                case $level in
                    DEBUG) echo -e "\033[0;37m[$timestamp] [DEBUG] $message\033[0m" ;;
                    INFO)  echo -e "\033[0;34m[$timestamp] [INFO] $message\033[0m" ;;
                    WARN)  echo -e "\033[0;33m[$timestamp] [WARN] $message\033[0m" ;;
                    ERROR) echo -e "\033[1;41;37m[$timestamp] [ERROR] $message\033[0m" ;;
                esac
                
                # æ–‡ä»¶è¾“å‡º
                echo "[$timestamp] [$level] [Step: $step] $message" >> "$LOG_FILE"
                
                # æ›´æ–°æŠ¥å‘Šæ–‡ä»¶
                if [ "$level" = "ERROR" ]; then
                    jq --arg step "$step" --arg message "$message" --arg time "$timestamp" \
                        '.errors += [{"step":$step,"message":$message,"time":$time}]' "$REPORT_FILE" > "$REPORT_FILE.tmp" && \
                        mv "$REPORT_FILE.tmp" "$REPORT_FILE"
                elif [ "$level" = "WARN" ]; then
                    jq --arg step "$step" --arg message "$message" --arg time "$timestamp" \
                        '.warnings += [{"step":$step,"message":$message,"time":$time}]' "$REPORT_FILE" > "$REPORT_FILE.tmp" && \
                        mv "$REPORT_FILE.tmp" "$REPORT_FILE"
                fi
            fi
        }
        
        # æ„å»ºé”™è¯¯è®°å½•å‡½æ•°
        log_build_error() {
            local error_msg="$1"
            local package="$2"
            local timestamp=$(date -Iseconds)
            
            # é«˜äº®æ˜¾ç¤ºæ„å»ºé”™è¯¯
            echo -e "\n\033[1;41;37mğŸ”¥ æ„å»ºé”™è¯¯ ğŸ”¥\033[0m"
            echo -e "\033[1;31mé”™è¯¯ä¿¡æ¯: $error_msg\033[0m"
            echo -e "\033[1;31mç›¸å…³åŒ…: $package\033[0m"
            echo -e "\033[1;41;37m================\033[0m\n"
            
            # è®°å½•åˆ°æ—¥å¿—
            log "ERROR" "æ„å»ºå¤±è´¥: $error_msg (åŒ…: $package)"
            
            # æ›´æ–°æŠ¥å‘Šæ–‡ä»¶
            jq --arg msg "$error_msg" --arg pkg "$package" --arg time "$timestamp" \
                '.build_errors += [{"message":$msg,"package":$pkg,"time":$time}]' "$REPORT_FILE" > "$REPORT_FILE.tmp" && \
                mv "$REPORT_FILE.tmp" "$REPORT_FILE"
            
            # å‘é€GitHubé€šçŸ¥
            echo "::error ::æ„å»ºå¤±è´¥: $error_msg (åŒ…: $package)"
        }
        
        # æ­¥éª¤å¼€å§‹
        step_start() {
            local step_name="$1"
            local description="$2"
            local timestamp=$(date -Iseconds)
            
            log "INFO" "â–¶ å¼€å§‹æ‰§è¡Œ: $description" "$step_name"
            
            # æ›´æ–°æŠ¥å‘Šæ–‡ä»¶
            jq --arg step "$step_name" --arg desc "$description" --arg time "$timestamp" \
                '.steps += [{"name":$step,"description":$desc,"status":"running","start_time":$time}]' "$REPORT_FILE" > "$REPORT_FILE.tmp" && \
                mv "$REPORT_FILE.tmp" "$REPORT_FILE"
        }
        
        # æ­¥éª¤å®Œæˆ
        step_complete() {
            local step_name="$1"
            local status="$2"  # success, failed, warning
            local timestamp=$(date -Iseconds)
            
            if [ "$status" = "success" ]; then
                log "INFO" "âœ… æ­¥éª¤å®Œæˆ: $step_name" "$step_name"
            elif [ "$status" = "failed" ]; then
                log "ERROR" "âŒ æ­¥éª¤å¤±è´¥: $step_name" "$step_name"
            elif [ "$status" = "warning" ]; then
                log "WARN" "âš ï¸ æ­¥éª¤å®Œæˆï¼ˆæœ‰è­¦å‘Šï¼‰: $step_name" "$step_name"
            fi
            
            # æ›´æ–°æŠ¥å‘Šæ–‡ä»¶
            jq --arg step "$step_name" --arg status "$status" --arg time "$timestamp" \
                '(.steps[] | select(.name == $step)) |= . + {"status":$status,"end_time":$time}' "$REPORT_FILE" > "$REPORT_FILE.tmp" && \
                mv "$REPORT_FILE.tmp" "$REPORT_FILE"
        }
        
        # è¿›åº¦æ˜¾ç¤º
        show_progress() {
            local current="$1"
            local total="$2"
            local description="$3"
            local percent=$((current * 100 / total))
            local filled=$((percent / 2))
            local empty=$((50 - filled))
            
            printf "\r\033[0;36m[%3d%%] [" "$percent"
            printf "%*s" $filled | tr ' ' 'â–ˆ'
            printf "%*s" $empty | tr ' ' 'â–‘'
            printf "] %s\033[0m" "$description"
        }
        
        # å¯¼å‡ºå‡½æ•°
        export -f log log_build_error step_start step_complete show_progress
        EOF
        
        chmod +x /tmp/logger.sh
        echo "LOGGER_SCRIPT=/tmp/logger.sh" >> $GITHUB_ENV
        
        # åˆå§‹åŒ–æ—¥å¿—
        source /tmp/logger.sh
        step_start "INIT" "åˆå§‹åŒ–ä¼ä¸šçº§æ—¥å¿—ç³»ç»Ÿ"
        log "INFO" "æ„å»ºID: $BUILD_ID"
        log "INFO" "æ—¥å¿—çº§åˆ«: $LOG_LEVEL"
        log "INFO" "å·¥ä½œç›®å½•: $GITHUB_WORKSPACE"
        step_complete "INIT" "success"

    - name: åˆå§‹åŒ–ç¯å¢ƒ
      id: init_env
      run: |
        source "$LOGGER_SCRIPT"
        step_start "ENV_INIT" "åˆå§‹åŒ–æ„å»ºç¯å¢ƒ"
        
        # è®¾ç½®é”™è¯¯å¤„ç†
        set -euo pipefail
        trap 'log "ERROR" "å‘½ä»¤æ‰§è¡Œå¤±è´¥: $BASH_COMMAND ($LINENO)"' ERR
        
        log "INFO" "æ›´æ–°ç³»ç»ŸåŒ…..."
        if sudo -E apt-get -y update; then
            log "INFO" "ç³»ç»ŸåŒ…æ›´æ–°æˆåŠŸ"
        else
            log "ERROR" "ç³»ç»ŸåŒ…æ›´æ–°å¤±è´¥"
            exit 1
        fi
        
        log "INFO" "å®‰è£…ä¾èµ–..."
        if sudo -E apt-get -y install $(curl -fsSL is.gd/depends_ubuntu_2204); then
            log "INFO" "ä¾èµ–å®‰è£…æˆåŠŸ"
        else
            log "ERROR" "ä¾èµ–å®‰è£…å¤±è´¥"
            exit 1
        fi
        
        log "INFO" "é…ç½®æ—¶åŒº..."
        sudo -E systemctl daemon-reload || log "WARN" "é‡è½½ç³»ç»ŸæœåŠ¡å¤±è´¥"
        if sudo timedatectl set-timezone "$TZ"; then
            log "INFO" "æ—¶åŒºè®¾ç½®æˆåŠŸ: $TZ"
        else
            log "WARN" "æ—¶åŒºè®¾ç½®å¤±è´¥"
        fi
        
        # æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
        log "INFO" "=== ç³»ç»Ÿä¿¡æ¯ ==="
        log "INFO" "CPUæ ¸å¿ƒæ•°: $(nproc)"
        log "INFO" "å†…å­˜æ€»é‡: $(free -h | grep '^Mem:' | awk '{print $2}')"
        log "INFO" "ç£ç›˜ç©ºé—´: $(df -h $GITHUB_WORKSPACE | tail -1 | awk '{print $4}')"
        
        step_complete "ENV_INIT" "success"

    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@main

    - name: è¯»å–ä»“åº“é…ç½®
      id: read_repo_config
      run: |
        source "$LOGGER_SCRIPT"
        step_start "READ_CONFIG" "è¯»å–ä»“åº“é…ç½®"
        
        cd "$GITHUB_WORKSPACE"
        
        # æ£€æŸ¥ä»“åº“é…ç½®æ–‡ä»¶
        REPO_CONFIG_FILE="${GITHUB_WORKSPACE}/${CONFIG_BASE_DIR}/repos.json"
        if [ ! -f "$REPO_CONFIG_FILE" ]; then
            log "ERROR" "ä»“åº“é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $REPO_CONFIG_FILE"
            exit 1
        fi
        
        log "INFO" "è¯»å–ä»“åº“é…ç½®: $REPO_CONFIG"
        REPO_INFO=$(jq -r --arg repo "$REPO_CONFIG" '.[$repo]' "$REPO_CONFIG_FILE")
        
        if [ "$REPO_INFO" = "null" ]; then
            log "ERROR" "æœªæ‰¾åˆ°ä»“åº“é…ç½®: $REPO_CONFIG"
            exit 1
        fi
        
        REPO_URL=$(echo "$REPO_INFO" | jq -r '.url')
        REPO_BRANCH=$(echo "$REPO_INFO" | jq -r '.branch')
        REPO_SHORT=$(echo "$REPO_INFO" | jq -r '.short')
        
        echo "REPO_URL=$REPO_URL" >> $GITHUB_ENV
        echo "REPO_BRANCH=$REPO_BRANCH" >> $GITHUB_ENV
        echo "REPO_SHORT=$REPO_SHORT" >> $GITHUB_ENV
        
        log "INFO" "ä»“åº“URL: $REPO_URL"
        log "INFO" "åˆ†æ”¯: $REPO_BRANCH"
        log "INFO" "ç®€ç§°: $REPO_SHORT"
        
        step_complete "READ_CONFIG" "success"

    - name: å…‹éš†æºä»£ç 
      id: clone_source
      run: |
        source "$LOGGER_SCRIPT"
        step_start "CLONE_SOURCE" "å…‹éš†æºä»£ç "
        
        log "INFO" "æ£€æŸ¥ç£ç›˜ç©ºé—´..."
        df -hT "$GITHUB_WORKSPACE"
        
        log "INFO" "åˆ›å»ºå·¥ä½œç›®å½•: $OPENWRT_PATH"
        if ! sudo mkdir -p "$OPENWRT_PATH"; then
            log "ERROR" "åˆ›å»ºå·¥ä½œç›®å½•å¤±è´¥"
            exit 1
        fi
        
        if ! sudo chown -R $(id -u):$(id -g) "$OPENWRT_PATH"; then
            log "ERROR" "è®¾ç½®å·¥ä½œç›®å½•æƒé™å¤±è´¥"
            exit 1
        fi
        
        log "INFO" "å¼€å§‹å…‹éš†æºä»£ç ..."
        if git clone --depth 1 -b "$REPO_BRANCH" --single-branch "$REPO_URL" "$OPENWRT_PATH"; then
            log "INFO" "æºä»£ç å…‹éš†æˆåŠŸ"
        else
            log "ERROR" "æºä»£ç å…‹éš†å¤±è´¥"
            exit 1
        fi
        
        cd "$OPENWRT_PATH"
        
        # è·å–ç‰ˆæœ¬ä¿¡æ¯
        VERSION_INFO=$(git show -s --date=short --format="ä½œè€…: %an<br/>æ—¶é—´: %cd<br/>å†…å®¹: %s<br/>hash: %H")
        echo "VERSION_INFO=$VERSION_INFO" >> $GITHUB_ENV
        
        VERSION_KERNEL=$(grep -oP 'LINUX_KERNEL_HASH-\K[0-9]+\.[0-9]+\.[0-9]+' target/linux/generic/kernel-6.12 2>/dev/null || echo "æœªçŸ¥")
        echo "VERSION_KERNEL=$VERSION_KERNEL" >> $GITHUB_ENV
        
        SOURCE_HASH=$(git rev-parse HEAD)
        echo "SOURCE_HASH=$SOURCE_HASH" >> $GITHUB_ENV
        
        log "INFO" "æºç å“ˆå¸Œ: $SOURCE_HASH"
        log "INFO" "å†…æ ¸ç‰ˆæœ¬: $VERSION_KERNEL"
        
        step_complete "CLONE_SOURCE" "success"

    - name: ç”Ÿæˆå˜é‡
      id: generate_vars
      run: |
        source "$LOGGER_SCRIPT"
        step_start "GEN_VARS" "ç”Ÿæˆæ„å»ºå˜é‡"
        
        cd "$GITHUB_WORKSPACE"
        
        # æŸ¥æ‰¾é…ç½®æ–‡ä»¶å‡½æ•°
        find_config_file() {
            local base_name="$1"
            local config_dir="${GITHUB_WORKSPACE}/${CONFIG_BASE_DIR}"
            
            # å°è¯•ä¸åŒæ ¼å¼
            for ext in ".config" ".config.txt"; do
                if [ -f "${config_dir}/${base_name}${ext}" ]; then
                    echo "${config_dir}/${base_name}${ext}"
                    return 0
                fi
            done
            
            # ä½¿ç”¨findæŸ¥æ‰¾
            local found_file=$(find "$config_dir" -iname "${base_name}.config*" -type f | head -n 1)
            if [ -n "$found_file" ]; then
                echo "$found_file"
                return 0
            fi
            
            return 1
        }
        
        # æŸ¥æ‰¾é…ç½®æ–‡ä»¶
        log "INFO" "æŸ¥æ‰¾åŸºç¡€é…ç½®æ–‡ä»¶..."
        CONFIG_BASE=$(find_config_file "base_${CHIP_FAMILY}")
        if [ $? -ne 0 ]; then
            log "ERROR" "åŸºç¡€é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: base_${CHIP_FAMILY}"
            exit 1
        fi
        
        log "INFO" "æŸ¥æ‰¾åˆ†æ”¯é…ç½®æ–‡ä»¶..."
        CONFIG_BRANCH=$(find_config_file "base_${REPO_SHORT}")
        if [ $? -ne 0 ]; then
            log "ERROR" "åˆ†æ”¯é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: base_${REPO_SHORT}"
            exit 1
        fi
        
        # è®¾ç½®è„šæœ¬è·¯å¾„
        DIY_SCRIPT="${GITHUB_WORKSPACE}/${DIY_SCRIPT_DIR}/diy.sh"
        REPO_SCRIPT="${GITHUB_WORKSPACE}/${DIY_SCRIPT_DIR}/repo.sh"
        
        log "INFO" "åŸºç¡€é…ç½®æ–‡ä»¶: $CONFIG_BASE"
        log "INFO" "åˆ†æ”¯é…ç½®æ–‡ä»¶: $CONFIG_BRANCH"
        log "INFO" "è‡ªå®šä¹‰è„šæœ¬: $DIY_SCRIPT"
        log "INFO" "è½¯ä»¶æºè„šæœ¬: $REPO_SCRIPT"
        
        echo "CONFIG_BASE=$CONFIG_BASE" >> $GITHUB_ENV
        echo "CONFIG_BRANCH=$CONFIG_BRANCH" >> $GITHUB_ENV
        echo "DIY_SCRIPT=$DIY_SCRIPT" >> $GITHUB_ENV
        echo "REPO_SCRIPT=$REPO_SCRIPT" >> $GITHUB_ENV
        
        # æå–è®¾å¤‡ä¿¡æ¯
        log "INFO" "æå–è®¾å¤‡ä¿¡æ¯..."
        cp "$CONFIG_BASE" "$OPENWRT_PATH/.config" || {
            log "ERROR" "å¤åˆ¶é…ç½®æ–‡ä»¶å¤±è´¥"
            exit 1
        }
        
        cd "$OPENWRT_PATH"
        if ! make defconfig > /dev/null 2>&1; then
            log "ERROR" "è¿è¡Œdefconfigå¤±è´¥"
            exit 1
        fi
        
        SOURCE_REPO="$(echo "$REPO_URL" | awk -F '/' '{print $(NF)}')"
        DEVICE_TARGET=$(cat .config | grep CONFIG_TARGET_BOARD | awk -F '"' '{print $2}')
        DEVICE_SUBTARGET=$(cat .config | grep CONFIG_TARGET_SUBTARGET | awk -F '"' '{print $2}')
        DEVICE_NAMES=$(grep -oP "CONFIG_TARGET_DEVICE_.*_${CHIP_FAMILY}_DEVICE_\K[^=]+" "$CONFIG_BASE" | tr '\n' ' ')
        
        echo "SOURCE_REPO=$SOURCE_REPO" >> $GITHUB_ENV
        echo "DEVICE_TARGET=$DEVICE_TARGET" >> $GITHUB_ENV
        echo "DEVICE_SUBTARGET=$DEVICE_SUBTARGET" >> $GITHUB_ENV
        echo "DEVICE_NAMES=$DEVICE_NAMES" >> $GITHUB_ENV
        
        # ç”Ÿæˆå“ˆå¸Œå€¼
        CONFIG_HASH=$(cat "$CONFIG_BASE" "$CONFIG_BRANCH" | sha256sum | cut -d' ' -f1)
        FEEDS_HASH=$(cat "$OPENWRT_PATH/feeds.conf.default" 2>/dev/null | sha256sum | cut -d' ' -f1 || echo "default")
        
        echo "CONFIG_HASH=$CONFIG_HASH" >> $GITHUB_ENV
        echo "FEEDS_HASH=$FEEDS_HASH" >> $GITHUB_ENV
        
        log "INFO" "è®¾å¤‡ç›®æ ‡: $DEVICE_TARGET"
        log "INFO" "è®¾å¤‡å­ç›®æ ‡: $DEVICE_SUBTARGET"
        log "INFO" "è®¾å¤‡åç§°: $DEVICE_NAMES"
        
        step_complete "GEN_VARS" "success"

    - name: ç¼“å­˜å·¥å…·é“¾
      id: cache_toolchain
      uses: actions/cache@main
      with:
        key: ${{ env.CACHE_VERSION }}-${{ env.SOURCE_REPO }}-${{ env.REPO_BRANCH }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-${{ env.SOURCE_HASH }}-${{ env.CONFIG_HASH }}
        restore-keys: |
          ${{ env.CACHE_VERSION }}-${{ env.SOURCE_REPO }}-${{ env.REPO_BRANCH }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-
          ${{ env.CACHE_VERSION }}-${{ env.SOURCE_REPO }}-${{ env.REPO_BRANCH }}-${{ env.DEVICE_TARGET }}-
          ${{ env.CACHE_VERSION }}-${{ env.SOURCE_REPO }}-${{ env.REPO_BRANCH }}-
        path: |
          ${{ env.OPENWRT_PATH }}/.ccache
          ${{ env.OPENWRT_PATH }}/staging_dir

    - name: ç¼“å­˜Feeds
      id: cache_feeds
      uses: actions/cache@main
      with:
        key: ${{ env.CACHE_VERSION }}-feeds-${{ env.SOURCE_REPO }}-${{ env.REPO_BRANCH }}-${{ env.SOURCE_HASH }}-${{ env.FEEDS_HASH }}
        restore-keys: |
          ${{ env.CACHE_VERSION }}-feeds-${{ env.SOURCE_REPO }}-${{ env.REPO_BRANCH }}-
          ${{ env.CACHE_VERSION }}-feeds-${{ env.SOURCE_REPO }}-
        path: |
          ${{ env.OPENWRT_PATH }}/feeds
          ${{ env.OPENWRT_PATH }}/dl
          ${{ env.OPENWRT_PATH }}/package/feeds

    - name: ç¼“å­˜DLè½¯ä»¶åŒ…
      id: cache_dl
      uses: actions/cache@main
      with:
        key: ${{ env.CACHE_VERSION }}-dl-${{ env.SOURCE_REPO }}-${{ env.REPO_BRANCH }}-${{ env.SOURCE_HASH }}
        restore-keys: |
          ${{ env.CACHE_VERSION }}-dl-${{ env.SOURCE_REPO }}-${{ env.REPO_BRANCH }}-
          ${{ env.CACHE_VERSION }}-dl-${{ env.SOURCE_REPO }}-
        path: |
          ${{ env.OPENWRT_PATH }}/dl

    - name: æ£€æŸ¥ç¼“å­˜çŠ¶æ€
      run: |
        source "$LOGGER_SCRIPT"
        step_start "CACHE_STATUS" "æ£€æŸ¥ç¼“å­˜çŠ¶æ€"
        
        # å·¥å…·é“¾ç¼“å­˜
        if [ "${{ steps.cache_toolchain.outputs.cache-hit }}" == "true" ]; then
            log "INFO" "âœ… å·¥å…·é“¾ç¼“å­˜å‘½ä¸­"
            CACHE_STATUS_TOOLCHAIN="HIT"
        else
            log "INFO" "âŒ å·¥å…·é“¾ç¼“å­˜æœªå‘½ä¸­ï¼Œå°†é‡æ–°æ„å»º"
            CACHE_STATUS_TOOLCHAIN="MISS"
        fi
        
        # Feedsç¼“å­˜
        if [ "${{ steps.cache_feeds.outputs.cache-hit }}" == "true" ]; then
            log "INFO" "âœ… Feedsç¼“å­˜å‘½ä¸­"
            CACHE_STATUS_FEEDS="HIT"
        else
            log "INFO" "âŒ Feedsç¼“å­˜æœªå‘½ä¸­ï¼Œå°†é‡æ–°æ›´æ–°"
            CACHE_STATUS_FEEDS="MISS"
        fi
        
        # DLç¼“å­˜
        if [ "${{ steps.cache_dl.outputs.cache-hit }}" == "true" ]; then
            log "INFO" "âœ… DLè½¯ä»¶åŒ…ç¼“å­˜å‘½ä¸­"
            CACHE_STATUS_DL="HIT"
        else
            log "INFO" "âŒ DLè½¯ä»¶åŒ…ç¼“å­˜æœªå‘½ä¸­ï¼Œå°†é‡æ–°ä¸‹è½½"
            CACHE_STATUS_DL="MISS"
        fi
        
        # æ˜¾ç¤ºç¼“å­˜å¤§å°
        for dir in ".ccache" "staging_dir" "feeds" "dl"; do
            if [ -d "$OPENWRT_PATH/$dir" ]; then
                size=$(du -sh "$OPENWRT_PATH/$dir" | cut -f1)
                log "INFO" "$dir å¤§å°: $size"
            fi
        done
        
        # æ›´æ–°æŠ¥å‘Š
        echo "CACHE_STATUS_TOOLCHAIN=$CACHE_STATUS_TOOLCHAIN" >> $GITHUB_ENV
        echo "CACHE_STATUS_FEEDS=$CACHE_STATUS_FEEDS" >> $GITHUB_ENV
        echo "CACHE_STATUS_DL=$CACHE_STATUS_DL" >> $GITHUB_ENV
        
        step_complete "CACHE_STATUS" "success"

    - name: åˆ·æ–°ç¼“å­˜
      run: |
        source "$LOGGER_SCRIPT"
        step_start "REFRESH_CACHE" "åˆ·æ–°ç¼“å­˜æ—¶é—´æˆ³"
        
        if [ -d "$OPENWRT_PATH/staging_dir" ]; then
            log "INFO" "åˆ·æ–°staging_diræ—¶é—´æˆ³..."
            find "$OPENWRT_PATH/staging_dir" -type d -name "stamp" -not -path "*target*" | while read -r dir; do
                find "$dir" -type f -exec touch {} +
            done
            log "INFO" "ç¼“å­˜åˆ·æ–°å®Œæˆ"
        else
            log "WARN" "æœªæ‰¾åˆ°staging_dirï¼Œè·³è¿‡ç¼“å­˜åˆ·æ–°"
        fi
        
        step_complete "REFRESH_CACHE" "success"

    - name: æ·»åŠ ç¬¬ä¸‰æ–¹è½¯ä»¶æº
      run: |
        source "$LOGGER_SCRIPT"
        step_start "ADD_REPO" "æ·»åŠ ç¬¬ä¸‰æ–¹è½¯ä»¶æº"
        
        if [ -f "$REPO_SCRIPT" ]; then
            log "INFO" "æ‰§è¡Œè½¯ä»¶æºè„šæœ¬: $REPO_SCRIPT"
            chmod +x "$REPO_SCRIPT" || {
                log "ERROR" "è®¾ç½®è„šæœ¬æƒé™å¤±è´¥"
                exit 1
            }
            
            cd "$OPENWRT_PATH"
            if "$REPO_SCRIPT"; then
                log "INFO" "è½¯ä»¶æºè„šæœ¬æ‰§è¡ŒæˆåŠŸ"
            else
                log "ERROR" "è½¯ä»¶æºè„šæœ¬æ‰§è¡Œå¤±è´¥"
                exit 1
            fi
        else
            log "WARN" "è½¯ä»¶æºè„šæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡"
        fi
        
        step_complete "ADD_REPO" "success"

    - name: å®‰è£…Feeds
      run: |
        source "$LOGGER_SCRIPT"
        step_start "INSTALL_FEEDS" "å®‰è£…Feeds"
        
        cd "$OPENWRT_PATH"
        
        # æ›´æ–°feeds
        if [ "${{ steps.cache_feeds.outputs.cache-hit }}" != "true" ]; then
            log "INFO" "æ›´æ–°feeds..."
            show_progress 0 2 "æ›´æ–°feeds"
            if ./scripts/feeds update -a; then
                show_progress 1 2 "æ›´æ–°feeds"
                log "INFO" "Feedsæ›´æ–°æˆåŠŸ"
            else
                log "ERROR" "Feedsæ›´æ–°å¤±è´¥"
                exit 1
            fi
        else
            log "INFO" "ä½¿ç”¨ç¼“å­˜çš„feedsï¼Œè·³è¿‡æ›´æ–°"
            show_progress 1 2 "ä½¿ç”¨ç¼“å­˜"
        fi
        
        # å®‰è£…feeds
        if [ ! -d "$OPENWRT_PATH/package/feeds" ] || [ -z "$(ls -A $OPENWRT_PATH/package/feeds)" ]; then
            log "INFO" "å®‰è£…feeds..."
            show_progress 1 2 "å®‰è£…feeds"
            if ./scripts/feeds install -a; then
                show_progress 2 2 "å®‰è£…å®Œæˆ"
                log "INFO" "Feedså®‰è£…æˆåŠŸ"
            else
                log "ERROR" "Feedså®‰è£…å¤±è´¥"
                exit 1
            fi
        else
            log "INFO" "feedså·²å®‰è£…ï¼Œè·³è¿‡"
            show_progress 2 2 "å·²å®‰è£…"
        fi
        
        echo ""
        step_complete "INSTALL_FEEDS" "success"

    - name: åŠ è½½è‡ªå®šä¹‰é…ç½®
      run: |
        source "$LOGGER_SCRIPT"
        step_start "LOAD_CONFIG" "åŠ è½½è‡ªå®šä¹‰é…ç½®"
        
        if [ -f "$DIY_SCRIPT" ]; then
            log "INFO" "æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬: $DIY_SCRIPT"
            chmod +x "$DIY_SCRIPT" || {
                log "ERROR" "è®¾ç½®è„šæœ¬æƒé™å¤±è´¥"
                exit 1
            }
            
            cd "$OPENWRT_PATH"
            if "$DIY_SCRIPT"; then
                log "INFO" "è‡ªå®šä¹‰è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
            else
                log "ERROR" "è‡ªå®šä¹‰è„šæœ¬æ‰§è¡Œå¤±è´¥"
                exit 1
            fi
        else
            log "WARN" "è‡ªå®šä¹‰è„šæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡"
        fi
        
        step_complete "LOAD_CONFIG" "success"

    - name: åˆå¹¶é…ç½®æ–‡ä»¶å¹¶ç”ŸæˆæŠ¥å‘Š
      id: merge_config
      run: |
        source "$LOGGER_SCRIPT"
        step_start "MERGE_CONFIG" "åˆå¹¶é…ç½®æ–‡ä»¶"
        
        log "INFO" "åˆå¹¶é…ç½®æ–‡ä»¶..."
        
        # è¯»å–åˆå¹¶å‰çš„luciè½¯ä»¶åŒ…
        LUCI_BEFORE=$(grep "^CONFIG_PACKAGE_luci.*=y" "$CONFIG_BASE" | sort || true)
        
        # åˆå¹¶é…ç½®æ–‡ä»¶
        cat "$CONFIG_BASE" "$CONFIG_BRANCH" > "$OPENWRT_PATH/.config" || {
            log "ERROR" "åˆå¹¶é…ç½®æ–‡ä»¶å¤±è´¥"
            exit 1
        }
        
        # è¯»å–åˆå¹¶åçš„luciè½¯ä»¶åŒ…
        LUCI_AFTER=$(grep "^CONFIG_PACKAGE_luci.*=y" "$OPENWRT_PATH/.config" | sort || true)
        
        # æ˜¾ç¤ºåˆå¹¶åçš„luciè½¯ä»¶åŒ…
        log "INFO" "=== åˆå¹¶åçš„Luciè½¯ä»¶åŒ…åˆ—è¡¨ ==="
        if [ -n "$LUCI_AFTER" ]; then
            echo "$LUCI_AFTER" | sed 's/^CONFIG_PACKAGE_//' | sed 's/=y//' | while read pkg; do
                log "INFO" "  - $pkg"
            done
        else
            log "INFO" "  (æ— Luciè½¯ä»¶åŒ…)"
        fi
        
        # è¿è¡Œdefconfig
        log "INFO" "è¿è¡Œdefconfig..."
        cd "$OPENWRT_PATH"
        if make defconfig; then
            log "INFO" "defconfigæˆåŠŸ"
        else
            log "ERROR" "defconfigå¤±è´¥"
            exit 1
        fi
        
        # è¯»å–defconfigåçš„luciè½¯ä»¶åŒ…
        LUCI_DEFCONFIG=$(grep "^CONFIG_PACKAGE_luci.*=y" "$OPENWRT_PATH/.config" | sort || true)
        
        # æ˜¾ç¤ºdefconfigåçš„luciè½¯ä»¶åŒ…
        log "INFO" "=== Defconfigåçš„Luciè½¯ä»¶åŒ…åˆ—è¡¨ ==="
        if [ -n "$LUCI_DEFCONFIG" ]; then
            echo "$LUCI_DEFCONFIG" | sed 's/^CONFIG_PACKAGE_//' | sed 's/=y//' | while read pkg; do
                log "INFO" "  - $pkg"
            done
        else
            log "INFO" "  (æ— Luciè½¯ä»¶åŒ…)"
        fi
        
        # ç”Ÿæˆdefconfigå¯¹æ¯”æŠ¥å‘Šå¹¶è¾“å‡ºåˆ°æ§åˆ¶å°
        log "INFO" "=== Defconfigè½¯ä»¶åŒ…å¯¹æ¯” ==="
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–°å¢çš„è½¯ä»¶åŒ…
        NEW_PACKAGES=$(comm -13 <(echo "$LUCI_AFTER") <(echo "$LUCI_DEFCONFIG") | sed 's/^CONFIG_PACKAGE_//' | sed 's/=y//')
        if [ -n "$NEW_PACKAGES" ]; then
            log "INFO" "ğŸ” å‘ç°æ–°å¢çš„Luciè½¯ä»¶åŒ…:"
            echo "$NEW_PACKAGES" | while read pkg; do
                log "INFO" "  âœ… $pkg"
                echo "  âœ… $pkg"
            done
        else
            log "INFO" "â„¹ï¸  æ— æ–°å¢çš„Luciè½¯ä»¶åŒ…"
            echo "  â„¹ï¸  æ— æ–°å¢çš„Luciè½¯ä»¶åŒ…"
        fi
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ç¼ºå¤±çš„è½¯ä»¶åŒ…
        MISSING_PACKAGES=$(comm -23 <(echo "$LUCI_AFTER") <(echo "$LUCI_DEFCONFIG") | sed 's/^CONFIG_PACKAGE_//' | sed 's/=y//')
        if [ -n "$MISSING_PACKAGES" ]; then
            log "WARN" "âš ï¸  å‘ç°ç¼ºå¤±çš„Luciè½¯ä»¶åŒ…:"
            echo "$MISSING_PACKAGES" | while read pkg; do
                log "WARN" "  âŒ $pkg"
                echo "  âŒ $pkg"
            done
        else
            log "INFO" "â„¹ï¸  æ— ç¼ºå¤±çš„Luciè½¯ä»¶åŒ…"
            echo "  â„¹ï¸  æ— ç¼ºå¤±çš„Luciè½¯ä»¶åŒ…"
        fi
        
        echo ""
        
        # ç”Ÿæˆdefconfigå¯¹æ¯”æŠ¥å‘Šæ–‡ä»¶
        {
            echo "## Defconfigåçš„Luciè½¯ä»¶åŒ…å˜åŒ–"
            echo ""
            echo "### æ–°å¢çš„Luciè½¯ä»¶åŒ…:"
            if [ -n "$NEW_PACKAGES" ]; then
                echo "$NEW_PACKAGES" | while read pkg; do
                    echo "- âœ… $pkg"
                done
            else
                echo "ï¼ˆæ— æ–°å¢è½¯ä»¶åŒ…ï¼‰"
            fi
            echo ""
            echo "### ç¼ºå¤±çš„Luciè½¯ä»¶åŒ…:"
            if [ -n "$MISSING_PACKAGES" ]; then
                echo "$MISSING_PACKAGES" | while read pkg; do
                    echo "- âŒ $pkg"
                done
            else
                echo "ï¼ˆæ— ç¼ºå¤±è½¯ä»¶åŒ…ï¼‰"
            fi
            echo ""
        } > "$GITHUB_WORKSPACE/luci_defconfig_report.md"
        
        # ç”Ÿæˆåˆå¹¶å·®å¼‚æŠ¥å‘Š
        {
            echo "## Luciè½¯ä»¶åŒ…åˆå¹¶æŠ¥å‘Š"
            echo ""
            echo "### æ–°å¢çš„Luciè½¯ä»¶åŒ…:"
            comm -13 <(echo "$LUCI_BEFORE") <(echo "$LUCI_AFTER") | sed 's/^CONFIG_PACKAGE_//' | sed 's/=y//' | while read pkg; do
                echo "- âœ… $pkg"
            done
            echo ""
            echo "### ç¼ºå¤±çš„Luciè½¯ä»¶åŒ…:"
            comm -23 <(echo "$LUCI_BEFORE") <(echo "$LUCI_AFTER") | sed 's/^CONFIG_PACKAGE_//' | sed 's/=y//' | while read pkg; do
                echo "- âŒ $pkg"
            done
            echo ""
        } > "$GITHUB_WORKSPACE/luci_report.md"
        
        step_complete "MERGE_CONFIG" "success"

    - name: ä¸‹è½½DLè½¯ä»¶åŒ…
      run: |
        source "$LOGGER_SCRIPT"
        step_start "DOWNLOAD_PKGS" "ä¸‹è½½è½¯ä»¶åŒ…"
        
        cd "$OPENWRT_PATH"
        log "INFO" "å¼€å§‹ä¸‹è½½è½¯ä»¶åŒ…..."
        
        # åˆ›å»ºé”™è¯¯ç›‘æ§è„šæœ¬
        cat > /tmp/monitor_download_errors.sh << 'EOF'
        #!/bin/bash
        LOG_FILE="$1"
        ERROR_PATTERNS=("failed to download" "Error:" "ERROR:" "error:" "404 Not Found" "Connection refused" "timeout")
        
        tail -f "$LOG_FILE" | while read line; do
            for pattern in "${ERROR_PATTERNS[@]}"; do
                if echo "$line" | grep -qi "$pattern"; then
                    # æå–åŒ…å
                    PACKAGE=$(echo "$line" | grep -o 'package/[^/]*' | head -1 | cut -d'/' -f2)
                    if [ -z "$PACKAGE" ]; then
                        PACKAGE=$(echo "$line" | grep -o '[a-zA-Z0-9_-]*\.tar\.' | head -1 | sed 's/\.tar\.$//')
                    fi
                    if [ -z "$PACKAGE" ]; then
                        PACKAGE="æœªçŸ¥"
                    fi
                    
                    # è°ƒç”¨é”™è¯¯è®°å½•å‡½æ•°
                    log_build_error "$line" "$PACKAGE"
                fi
            done
        done
        EOF
        chmod +x /tmp/monitor_download_errors.sh
        
        # å¯åŠ¨é”™è¯¯ç›‘æ§ï¼ˆåå°ï¼‰
        /tmp/monitor_download_errors.sh /tmp/download.log &
        MONITOR_PID=$!
        
        # ç›‘æ§ä¸‹è½½è¿›åº¦
        if make download -j$(nproc) 2>&1 | tee /tmp/download.log; then
            log "INFO" "è½¯ä»¶åŒ…ä¸‹è½½æˆåŠŸ"
        else
            kill $MONITOR_PID 2>/dev/null || true
            log "ERROR" "è½¯ä»¶åŒ…ä¸‹è½½å¤±è´¥"
            
            # åˆ†æä¸‹è½½é”™è¯¯
            DOWNLOAD_ERRORS=$(grep -E "(failed|Error|ERROR|404|timeout)" /tmp/download.log | tail -5)
            if [ -n "$DOWNLOAD_ERRORS" ]; then
                log_build_error "ä¸‹è½½å¤±è´¥: $DOWNLOAD_ERRORS" "ä¸‹è½½é”™è¯¯"
            fi
            exit 1
        fi
        
        kill $MONITOR_PID 2>/dev/null || true
        step_complete "DOWNLOAD_PKGS" "success"

    - name: æ¸…ç†æ„å»ºç¯å¢ƒ
      run: |
        source "$LOGGER_SCRIPT"
        step_start "CLEAN_ENV" "æ¸…ç†æ„å»ºç¯å¢ƒ"
        
        cd "$OPENWRT_PATH"
        log "INFO" "æ¸…ç†æ„å»ºç¯å¢ƒ..."
        
        if make clean; then
            log "INFO" "æ„å»ºç¯å¢ƒæ¸…ç†æˆåŠŸ"
        else
            log "WARN" "æ„å»ºç¯å¢ƒæ¸…ç†å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ"
        fi
        
        # ç¡®ä¿å·¥å…·é“¾æ­£ç¡®æ„å»º
        log "INFO" "å‡†å¤‡å·¥å…·é“¾..."
        if make toolchain/install -j$(nproc); then
            log "INFO" "å·¥å…·é“¾å‡†å¤‡æˆåŠŸ"
        else
            log "ERROR" "å·¥å…·é“¾å‡†å¤‡å¤±è´¥"
            exit 1
        fi
        
        step_complete "CLEAN_ENV" "success"

    - name: ç¼–è¯‘åŸºç¡€ç¯å¢ƒ
      id: compile
      run: |
        source "$LOGGER_SCRIPT"
        step_start "COMPILE" "ç¼–è¯‘åŸºç¡€ç¯å¢ƒ"
        
        cd "$OPENWRT_PATH"
        log "INFO" "å¼€å§‹ç¼–è¯‘åŸºç¡€ç¯å¢ƒ..."
        log "INFO" "ä½¿ç”¨ $(nproc) ä¸ªçº¿ç¨‹ç¼–è¯‘"
        
        # åˆ›å»ºå¢å¼ºçš„é”™è¯¯ç›‘æ§è„šæœ¬
        cat > /tmp/monitor_errors.sh << 'EOF'
        #!/bin/bash
        LOG_FILE="$1"
        # æ‰©å±•é”™è¯¯æ¨¡å¼ï¼ŒåŒ…å«æ›´å¤šé”™è¯¯ç±»å‹
        ERROR_PATTERNS=(
            "failed to build"
            "failed to install"
            "Error:"
            "ERROR:"
            "error:"
            "make.*\*\*\*.*Error"
            "command terminated with signal"
            "cannot stat"
            "No such file or directory"
            "Permission denied"
            "Segmentation fault"
            "Compilation failed"
            "Build failed"
            "undefined reference"
            "multiple definition"
        )
        
        tail -f "$LOG_FILE" | while read line; do
            for pattern in "${ERROR_PATTERNS[@]}"; do
                if echo "$line" | grep -q "$pattern"; then
                    # æå–åŒ…å - æ”¹è¿›åŒ…åæå–é€»è¾‘
                    PACKAGE=$(echo "$line" | grep -oE 'package/[^/]*|/tmp/[^/]*' | head -1 | cut -d'/' -f2)
                    if [ -z "$PACKAGE" ]; then
                        PACKAGE=$(echo "$line" | grep -oE '[a-zA-Z0-9_-]+\.tar\.[a-z0-9]+' | head -1 | sed 's/\.tar\.[a-z0-9]+$//')
                    fi
                    if [ -z "$PACKAGE" ]; then
                        PACKAGE=$(echo "$line" | grep -oE 'ERROR: package/[^\s]+' | sed 's/ERROR: package\///')
                    fi
                    if [ -z "$PACKAGE" ]; then
                        PACKAGE="æœªçŸ¥"
                    fi
                    
                    # è°ƒç”¨é”™è¯¯è®°å½•å‡½æ•°
                    log_build_error "$line" "$PACKAGE"
                    break  # åªè®°å½•ç¬¬ä¸€ä¸ªåŒ¹é…çš„é”™è¯¯æ¨¡å¼
                fi
            done
        done
        EOF
        chmod +x /tmp/monitor_errors.sh
        
        # å®šä¹‰ç¼–è¯‘é˜¶æ®µï¼ˆé¿å…åœ¨å­shellä¸­ä½¿ç”¨localï¼‰
        stages=("å·¥å…·é“¾å’Œå†…æ ¸" "ç³»ç»ŸåŒ…" "æ‰€æœ‰åŒ…")
        commands=("toolchain/kernel-headers compile" "package/system/opkg/host/compile" "")
        total=3
        current=0
        
        for i in "${!stages[@]}"; do
            current=$((i + 1))
            show_progress $current $total "ç¼–è¯‘${stages[$i]}"
            
            if [ -n "${commands[$i]}" ]; then
                log "INFO" "ç¼–è¯‘${stages[$i]}..."
                
                # å¯åŠ¨é”™è¯¯ç›‘æ§ï¼ˆåå°ï¼‰
                /tmp/monitor_errors.sh /tmp/build.log &
                MONITOR_PID=$!
                
                if make -j$(nproc) ${commands[$i]} 2>&1 | tee /tmp/build.log; then
                    log "INFO" "${stages[$i]}ç¼–è¯‘æˆåŠŸ"
                else
                    kill $MONITOR_PID 2>/dev/null || true
                    log "WARN" "${stages[$i]}å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘"
                    
                    # å•çº¿ç¨‹ç¼–è¯‘æ—¶ä¹Ÿç›‘æ§é”™è¯¯
                    /tmp/monitor_errors.sh /tmp/build.log &
                    MONITOR_PID=$!
                    
                    if make -j1 V=s ${commands[$i]} 2>&1 | tee /tmp/build.log; then
                        log "INFO" "${stages[$i]}å•çº¿ç¨‹ç¼–è¯‘æˆåŠŸ"
                    else
                        kill $MONITOR_PID 2>/dev/null || true
                        log "ERROR" "${stages[$i]}ç¼–è¯‘å½»åº•å¤±è´¥"
                        
                        # åˆ†ææœ€åå‡ è¡Œæ—¥å¿—ï¼Œæå–å…³é”®é”™è¯¯
                        LAST_ERRORS=$(tail -20 /tmp/build.log | grep -E "(failed|Error|ERROR|undefined|multiple)" | tail -3)
                        if [ -n "$LAST_ERRORS" ]; then
                            echo "$LAST_ERRORS" | while read error_line; do
                                log_build_error "$error_line" "ç¼–è¯‘å¤±è´¥"
                            done
                        fi
                        exit 1
                    fi
                fi
                
                kill $MONITOR_PID 2>/dev/null || true
            else
                log "INFO" "ç¼–è¯‘æ‰€æœ‰åŒ…..."
                
                # å¯åŠ¨é”™è¯¯ç›‘æ§ï¼ˆåå°ï¼‰
                /tmp/monitor_errors.sh /tmp/build.log &
                MONITOR_PID=$!
                
                if make -j$(nproc) 2>&1 | tee /tmp/build.log; then
                    log "INFO" "æ‰€æœ‰åŒ…ç¼–è¯‘æˆåŠŸ"
                else
                    kill $MONITOR_PID 2>/dev/null || true
                    log "WARN" "å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘"
                    
                    # å•çº¿ç¨‹ç¼–è¯‘æ—¶ä¹Ÿç›‘æ§é”™è¯¯
                    /tmp/monitor_errors.sh /tmp/build.log &
                    MONITOR_PID=$!
                    
                    if make -j1 V=s 2>&1 | tee /tmp/build.log; then
                        log "INFO" "å•çº¿ç¨‹ç¼–è¯‘æˆåŠŸ"
                    else
                        kill $MONITOR_PID 2>/dev/null || true
                        log "ERROR" "ç¼–è¯‘å½»åº•å¤±è´¥"
                        
                        # åˆ†ææœ€åå‡ è¡Œæ—¥å¿—ï¼Œæå–å…³é”®é”™è¯¯
                        LAST_ERRORS=$(tail -20 /tmp/build.log | grep -E "(failed|Error|ERROR|undefined|multiple)" | tail -3)
                        if [ -n "$LAST_ERRORS" ]; then
                            echo "$LAST_ERRORS" | while read error_line; do
                                log_build_error "$error_line" "ç¼–è¯‘å¤±è´¥"
                            done
                        fi
                        exit 1
                    fi
                fi
                
                kill $MONITOR_PID 2>/dev/null || true
            fi
        done
        
        echo ""
        echo "status=success" >> $GITHUB_OUTPUT
        echo "DATE=$(date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_ENV
        echo "FILE_DATE=$(date +"%Y.%m.%d")" >> $GITHUB_ENV
        
        step_complete "COMPILE" "success"

    - name: ç”Ÿæˆæ„å»ºæŠ¥å‘Š
      if: always()
      run: |
        source "$LOGGER_SCRIPT"
        step_start "GEN_REPORT" "ç”Ÿæˆæ„å»ºæŠ¥å‘Š"
        
        # å®ŒæˆæŠ¥å‘Š
        jq --arg time "$(date -Iseconds)" --arg status "${{ steps.compile.outputs.status }}" \
            '.end_time = $time | .status = $status' "$REPORT_FILE" > "$REPORT_FILE.tmp" && \
            mv "$REPORT_FILE.tmp" "$REPORT_FILE"
        
        # ç”Ÿæˆæ‘˜è¦æŠ¥å‘Š
        {
            echo "=== æ„å»ºæ‘˜è¦ ==="
            echo "æ„å»ºID: $BUILD_ID"
            echo "ä»“åº“: $REPO_URL"
            echo "åˆ†æ”¯: $REPO_BRANCH"
            echo "èŠ¯ç‰‡: $CHIP_FAMILY"
            echo "è®¾å¤‡: $DEVICE_NAMES"
            echo "çŠ¶æ€: ${{ steps.compile.outputs.status }}"
            echo "å¼€å§‹æ—¶é—´: $(jq -r '.start_time' "$REPORT_FILE")"
            echo "ç»“æŸæ—¶é—´: $(date -Iseconds)"
            echo ""
            echo "=== ç¼“å­˜çŠ¶æ€ ==="
            echo "å·¥å…·é“¾ç¼“å­˜: $CACHE_STATUS_TOOLCHAIN"
            echo "Feedsç¼“å­˜: $CACHE_STATUS_FEEDS"
            echo "DLç¼“å­˜: $CACHE_STATUS_DL"
            echo ""
            echo "=== é”™è¯¯ç»Ÿè®¡ ==="
            echo "é”™è¯¯æ•°é‡: $(jq '.errors | length' "$REPORT_FILE")"
            echo "è­¦å‘Šæ•°é‡: $(jq '.warnings | length' "$REPORT_FILE")"
            echo "æ„å»ºé”™è¯¯æ•°é‡: $(jq '.build_errors | length' "$REPORT_FILE")"
            echo ""
            if [ "$(jq '.build_errors | length' "$REPORT_FILE")" -gt 0 ]; then
                echo "=== æ„å»ºé”™è¯¯è¯¦æƒ… ==="
                jq -r '.build_errors[] | "- [\(.time)] \(.package): \(.message)"' "$REPORT_FILE"
                echo ""
            fi
            if [ "$(jq '.errors | length' "$REPORT_FILE")" -gt 0 ]; then
                echo "=== å…¶ä»–é”™è¯¯è¯¦æƒ… ==="
                jq -r '.errors[] | "- [\(.time)] \(.step): \(.message)"' "$REPORT_FILE"
                echo ""
            fi
            if [ "$(jq '.warnings | length' "$REPORT_FILE")" -gt 0 ]; then
                echo "=== è­¦å‘Šè¯¦æƒ… ==="
                jq -r '.warnings[] | "- [\(.time)] \(.step): \(.message)"' "$REPORT_FILE"
                echo ""
            fi
        } > "$GITHUB_WORKSPACE/build_summary.txt"
        
        log "INFO" "æ„å»ºæŠ¥å‘Šå·²ç”Ÿæˆ"
        cat "$GITHUB_WORKSPACE/build_summary.txt"
        
        step_complete "GEN_REPORT" "success"

    - name: æ£€æŸ¥ç©ºé—´ä½¿ç”¨æƒ…å†µ
      if: (!cancelled())
      run: |
        source "$LOGGER_SCRIPT"
        step_start "CHECK_SPACE" "æ£€æŸ¥ç£ç›˜ç©ºé—´"
        
        log "INFO" "=== ç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ ==="
        df -hT
        
        log "INFO" "=== ç›®å½•å¤§å°ç»Ÿè®¡ ==="
        for dir in "bin" "staging_dir" ".ccache" "feeds" "dl"; do
            if [ -d "$OPENWRT_PATH/$dir" ]; then
                size=$(du -sh "$OPENWRT_PATH/$dir" | cut -f1)
                log "INFO" "$dir: $size"
            fi
        done
        
        step_complete "CHECK_SPACE" "success"

    - name: ä¸Šä¼ æ„å»ºæ—¥å¿—å’ŒæŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@main
      with:
        name: ${{ env.SOURCE_REPO }}-logs-${{ env.CHIP_FAMILY }}-${{ env.REPO_SHORT }}-${{ env.FILE_DATE }}
        path: |
          ${{ github.workspace }}/build.log
          ${{ github.workspace }}/build_report.json
          ${{ github.workspace }}/build_summary.txt
          ${{ github.workspace }}/luci_report.md
          ${{ github.workspace }}/luci_defconfig_report.md
        retention-days: 30

    - name: ä¸Šä¼ Binç›®å½•
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
      uses: actions/upload-artifact@main
      with:
        name: ${{ env.SOURCE_REPO }}-bin-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}-${{ env.FILE_DATE }}
        path: ${{ env.OPENWRT_PATH }}/bin

    - name: æ•´ç†æ–‡ä»¶
      if: steps.compile.outputs.status == 'success'
      run: |
        source "$LOGGER_SCRIPT"
        step_start "ORG_FILES" "æ•´ç†æ„å»ºæ–‡ä»¶"
        
        cd "$OPENWRT_PATH/bin/targets/*/*"
        
        # åˆ›å»ºæ„å»ºä¿¡æ¯æ–‡ä»¶
        {
            echo "=== åŸºç¡€ç¯å¢ƒæ„å»ºä¿¡æ¯ ==="
            echo "æ„å»ºID: $BUILD_ID"
            echo "èŠ¯ç‰‡ç³»åˆ—: $CHIP_FAMILY"
            echo "ä»“åº“é…ç½®: $REPO_CONFIG"
            echo "æºç åˆ†æ”¯: $REPO_BRANCH"
            echo "æ„å»ºæ—¶é—´: $DATE"
            echo "å†…æ ¸ç‰ˆæœ¬: $VERSION_KERNEL"
            echo "è®¾å¤‡åç§°: $DEVICE_NAMES"
            echo "å·¥å…·é“¾ç¼“å­˜: $CACHE_STATUS_TOOLCHAIN"
            echo "Feedsç¼“å­˜: $CACHE_STATUS_FEEDS"
            echo "DLç¼“å­˜: $CACHE_STATUS_DL"
            echo "æ„å»ºçŠ¶æ€: ${{ steps.compile.outputs.status }}"
        } > base_build_info.txt
        
        # ä¿å­˜é…ç½®æ–‡ä»¶
        cp "$OPENWRT_PATH/.config" "base_${CHIP_FAMILY}_${REPO_SHORT}.config"
        
        log "INFO" "æ–‡ä»¶æ•´ç†å®Œæˆ"
        step_complete "ORG_FILES" "success"

    - name: ä¸Šä¼ åŸºç¡€ç¯å¢ƒåˆ°Artifact
      if: steps.compile.outputs.status == 'success'
      uses: actions/upload-artifact@main
      with:
        name: ${{ env.SOURCE_REPO }}-base-${{ env.CHIP_FAMILY }}-${{ env.REPO_SHORT }}-${{ env.FILE_DATE }}
        path: |
          ${{ env.OPENWRT_PATH }}/bin
          ${{ env.OPENWRT_PATH }}/.config
          ${{ env.OPENWRT_PATH }}/staging_dir
          ${{ env.OPENWRT_PATH }}/.ccache
          ${{ env.OPENWRT_PATH }}/feeds
          ${{ env.OPENWRT_PATH }}/dl
        retention-days: 30

    - name: æ¸…ç†è¿‡æœŸç¼“å­˜
      if: (!cancelled())
      run: |
        source "$LOGGER_SCRIPT"
        step_start "CLEAN_CACHE" "æ¸…ç†è¿‡æœŸç¼“å­˜"
        
        log "INFO" "æ¸…ç†è¶…è¿‡7å¤©çš„æ—§ç¼“å­˜..."
        CUTOFF_DATE=$(date -d '7 days ago' +%Y-%m-%d)
        
        # æ¸…ç†å·¥å…·é“¾ç¼“å­˜
        gh cache list --key ${{ env.CACHE_VERSION }}-${{ env.SOURCE_REPO }}-${{ env.REPO_BRANCH }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}- --json key,created_at --jq '.[] | select(.created_at < "'$CUTOFF_DATE'") | .key' | while read -r key; do
            log "INFO" "åˆ é™¤è¿‡æœŸå·¥å…·é“¾ç¼“å­˜: $key"
            gh cache delete "$key" || log "WARN" "åˆ é™¤ç¼“å­˜å¤±è´¥: $key"
        done
        
        # æ¸…ç†feedsç¼“å­˜
        gh cache list --key ${{ env.CACHE_VERSION }}-feeds-${{ env.SOURCE_REPO }}-${{ env.REPO_BRANCH }}- --json key,created_at --jq '.[] | select(.created_at < "'$CUTOFF_DATE'") | .key' | while read -r key; do
            log "INFO" "åˆ é™¤è¿‡æœŸfeedsç¼“å­˜: $key"
            gh cache delete "$key" || log "WARN" "åˆ é™¤ç¼“å­˜å¤±è´¥: $key"
        done
        
        # æ¸…ç†DLç¼“å­˜
        gh cache list --key ${{ env.CACHE_VERSION }}-dl-${{ env.SOURCE_REPO }}-${{ env.REPO_BRANCH }}- --json key,created_at --jq '.[] | select(.created_at < "'$CUTOFF_DATE'") | .key' | while read -r key; do
            log "INFO" "åˆ é™¤è¿‡æœŸDLç¼“å­˜: $key"
            gh cache delete "$key" || log "WARN" "åˆ é™¤ç¼“å­˜å¤±è´¥: $key"
        done
        
        step_complete "CLEAN_CACHE" "success"

    - name: å®Œæˆæ„å»º
      if: always()
      run: |
        source "$LOGGER_SCRIPT"
        
        if [ "${{ steps.compile.outputs.status }}" = "success" ]; then
            log "INFO" "ğŸ‰ æ„å»ºæˆåŠŸå®Œæˆï¼"
            echo "::notice::æ„å»ºæˆåŠŸå®Œæˆï¼æ„å»ºID: $BUILD_ID"
        else
            log "ERROR" "ğŸ’¥ æ„å»ºå¤±è´¥ï¼"
            echo "::error::æ„å»ºå¤±è´¥ï¼è¯·æŸ¥çœ‹æ—¥å¿—äº†è§£è¯¦æƒ…ã€‚æ„å»ºID: $BUILD_ID"
        fi
        
        # æœ€ç»ˆæŠ¥å‘Š
        echo "::group::æ„å»ºæ‘˜è¦"
        cat "$GITHUB_WORKSPACE/build_summary.txt"
        echo "::endgroup::"
