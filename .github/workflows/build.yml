name: OpenWrt IPQ60x2 ä¼ä¸šçº§å›ºä»¶ç¼–è¯‘ç³»ç»Ÿ

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Releaseæ ‡ç­¾ (ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ)'
        required: false
        type: string
      force_rebuild:
        description: 'å¼ºåˆ¶é‡æ–°æž„å»º'
        required: false
        type: boolean
        default: false
  push:
    branches: [ main, master ]
    paths:
      - 'configs/**'
      - 'scripts/**'
      - '.github/workflows/build.yml'
  schedule:
    - cron: '0 2 * * 1'  # æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹è‡ªåŠ¨ç¼–è¯‘

env:
  TZ: Asia/Shanghai
  FIRMWARE_IP: 192.168.111.1
  FIRMWARE_NAME: WRT
  FIRMWARE_PASSWORD: ''
  REPO_BRANCH: master

jobs:
  # å‡†å¤‡é˜¶æ®µï¼šèŽ·å–é…ç½®å’Œä¾èµ–
  prepare:
    runs-on: ubuntu-22.04
    outputs:
      immwrt_repo: ${{ steps.parse_config.outputs.immwrt_repo }}
      build_date: ${{ steps.date.outputs.date }}
      release_tag: ${{ steps.tag.outputs.tag }}
      cache_key_base: ${{ steps.cache_key.outputs.base_key }}
      cache_suffix: ${{ steps.cache_key.outputs.suffix }}
      matrix_ultra: ${{ steps.matrix.outputs.ultra }}
      matrix_variants: ${{ steps.matrix.outputs.variants }}
      config_hash: ${{ steps.config_hash.outputs.hash }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: å®‰è£…ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: è§£æžé…ç½®æ–‡ä»¶
        id: parse_config
        run: |
          # ä»Žrepos.jsonèŽ·å–immwrtä»“åº“åœ°å€
          if [ -f "configs/repos.json" ]; then
            # æ£€æŸ¥JSONæ ¼å¼
            if ! jq empty configs/repos.json; then
              echo "âŒ repos.jsonæ ¼å¼é”™è¯¯"
              exit 1
            fi
            
            # èŽ·å–immwrtä»“åº“åœ°å€
            REPO=$(jq -r '.immwrt' configs/repos.json 2>/dev/null)
            if [ "$REPO" = "null" ] || [ -z "$REPO" ]; then
              # å°è¯•ä»Žreposå¯¹è±¡ä¸­èŽ·å–
              REPO=$(jq -r '.repos.immwrt' configs/repos.json 2>/dev/null)
            fi
            if [ "$REPO" = "null" ] || [ -z "$REPO" ]; then
              # å°è¯•ä»Žurlå­—æ®µèŽ·å–
              REPO=$(jq -r '.immwrt.url' configs/repos.json 2>/dev/null)
            fi
            
            if [ "$REPO" = "null" ] || [ -z "$REPO" ]; then
              echo "âŒ æ— æ³•ä»Žrepos.jsonä¸­èŽ·å–immwrtä»“åº“åœ°å€"
              echo "è¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼ï¼Œç¡®ä¿åŒ…å«immwrtå­—æ®µ"
              exit 1
            fi
            
            # æ¸…ç†å¯èƒ½çš„ç©ºç™½å­—ç¬¦
            REPO=$(echo "$REPO" | xargs)
            
            # éªŒè¯URLæ ¼å¼
            if [[ ! "$REPO" =~ ^https?:// ]]; then
              echo "âŒ ä»“åº“åœ°å€æ ¼å¼æ— æ•ˆ: $REPO"
              exit 1
            fi
            
            echo "immwrt_repo=$REPO" >> $GITHUB_OUTPUT
            echo "âœ… èŽ·å–åˆ°immwrtä»“åº“: $REPO"
          else
            echo "âŒ æœªæ‰¾åˆ°repos.jsonæ–‡ä»¶"
            exit 1
          fi

      - name: è®¡ç®—é…ç½®æ–‡ä»¶å“ˆå¸Œ
        id: config_hash
        run: |
          # è®¡ç®—æ‰€æœ‰é…ç½®æ–‡ä»¶çš„å“ˆå¸Œå€¼ç”¨äºŽç¼“å­˜
          HASH=$(find configs/ -type f -exec cat {} \; | md5sum | cut -d' ' -f1)
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "ðŸ“ é…ç½®æ–‡ä»¶å“ˆå¸Œ: $HASH"

      - name: ç”Ÿæˆæž„å»ºæ—¥æœŸ
        id: date
        run: |
          DATE=$(date +"%Y.%m.%d-%H%M")
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "ðŸ“… æž„å»ºæ—¥æœŸ: $DATE"

      - name: ç”ŸæˆReleaseæ ‡ç­¾
        id: tag
        run: |
          if [ -n "${{ github.event.inputs.release_tag }}" ]; then
            TAG="${{ github.event.inputs.release_tag }}"
          else
            TAG="AutoBuild-${{ steps.date.outputs.date }}-$(git rev-parse --short HEAD)"
          fi
          # ç¡®ä¿æ ‡ç­¾æ ¼å¼æ­£ç¡®
          TAG=$(echo "$TAG" | sed 's/[^a-zA-Z0-9._-]//g')
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "ðŸ·ï¸ Releaseæ ‡ç­¾: $TAG"

      - name: è®¾ç½®ç¼–è¯‘çŸ©é˜µ
        id: matrix
        run: |
          echo 'ultra=["Ultra"]' >> $GITHUB_OUTPUT
          echo 'variants=["Max","Pro"]' >> $GITHUB_OUTPUT

      - name: ç”Ÿæˆä¼ä¸šçº§ç¼“å­˜é”®
        id: cache_key
        run: |
          # å¤šå±‚ç¼“å­˜ç­–ç•¥
          BASE_KEY="openwrt-base-${{ steps.config_hash.outputs.hash }}"
          SUFFIX="${{ steps.date.outputs.date }}-$(git rev-parse --short HEAD)"
          # æ¸…ç†å¯èƒ½çš„ç‰¹æ®Šå­—ç¬¦
          BASE_KEY=$(echo "$BASE_KEY" | tr -d '\n\r')
          SUFFIX=$(echo "$SUFFIX" | tr -d '\n\r')
          echo "base_key=$BASE_KEY" >> $GITHUB_OUTPUT
          echo "suffix=$SUFFIX" >> $GITHUB_OUTPUT
          echo "ðŸ”‘ åŸºç¡€ç¼“å­˜é”®: $BASE_KEY"
          echo "ðŸ”‘ ç¼“å­˜åŽç¼€: $SUFFIX"

  # åŸºç¡€çŽ¯å¢ƒæž„å»º
  build-base:
    runs-on: ubuntu-22.04
    needs: prepare
    outputs:
      cache_hit: ${{ steps.cache.outputs.cache-hit }}
      build_success: ${{ steps.compile.outcome }}
    
    steps:
      - name: åˆå§‹åŒ–çŽ¯å¢ƒ
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-2204)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: éªŒè¯ä»“åº“åœ°å€
        run: |
          REPO="${{ needs.prepare.outputs.immwrt_repo }}"
          echo "ðŸ“¥ éªŒè¯ä»“åº“åœ°å€: $REPO"
          # éªŒè¯ä»“åº“æ˜¯å¦å¯è®¿é—®
          if ! git ls-remote "$REPO" > /dev/null 2>&1; then
            echo "âŒ ä»“åº“åœ°å€ä¸å¯è®¿é—®: $REPO"
            exit 1
          fi
          echo "âœ… ä»“åº“åœ°å€éªŒè¯é€šè¿‡"

      - name: ä¼ä¸šçº§ç¼“å­˜ç­–ç•¥
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            /workdir/openwrt
            ~/.cache/go-build
            ~/.cache/pip
          key: ${{ needs.prepare.outputs.cache_key_base }}-${{ needs.prepare.outputs.cache_suffix }}
          restore-keys: |
            ${{ needs.prepare.outputs.cache_key_base }}-
            openwrt-base-

      - name: å…‹éš†æºç 
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd /workdir
          echo "ðŸ“¥ å…‹éš†æºç ä»Ž: ${{ needs.prepare.outputs.immwrt_repo }}"
          git clone ${{ needs.prepare.outputs.immwrt_repo }} -b $REPO_BRANCH openwrt
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

      - name: é›†æˆè‡ªå®šä¹‰è„šæœ¬åŠŸèƒ½
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd /workdir/openwrt
          
          # é›†æˆdiy.shåŠŸèƒ½
          if [ -f "$GITHUB_WORKSPACE/scripts/diy.sh" ]; then
            echo "ðŸ”§ æ‰§è¡Œdiy.shè„šæœ¬"
            bash "$GITHUB_WORKSPACE/scripts/diy.sh"
          fi
          
          # é›†æˆrepo.shåŠŸèƒ½
          if [ -f "$GITHUB_WORKSPACE/scripts/repo.sh" ]; then
            echo "ðŸ”§ æ‰§è¡Œrepo.shè„šæœ¬"
            bash "$GITHUB_WORKSPACE/scripts/repo.sh"
          fi
          
          # æ·»åŠ ç¬¬ä¸‰æ–¹è½¯ä»¶æº
          echo "ðŸ“¦ æ·»åŠ ç¬¬ä¸‰æ–¹è½¯ä»¶æº"
          git clone https://github.com/kenzok8/small-package package/small-package
          
          # æ›´æ–°feeds
          echo "ðŸ”„ æ›´æ–°feeds"
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: åŠ è½½åŸºç¡€é…ç½®
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd /workdir/openwrt
          echo "âš™ï¸ åŠ è½½åŸºç¡€é…ç½®"
          [ -f "$GITHUB_WORKSPACE/configs/base_ipq60xx.config" ] && \
            cp "$GITHUB_WORKSPACE/configs/base_ipq60xx.config" .config
          [ -f "$GITHUB_WORKSPACE/configs/base_immwrt.config" ] && \
            cat "$GITHUB_WORKSPACE/configs/base_immwrt.config" >> .config
          make defconfig

      - name: è‡ªå®šä¹‰å›ºä»¶è®¾ç½®
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd /workdir/openwrt
          echo "ðŸ”§ åº”ç”¨å›ºä»¶è‡ªå®šä¹‰è®¾ç½®"
          
          # è®¾ç½®IPåœ°å€ä¸º192.168.111.1
          sed -i "s/192.168.1.1/${{ env.FIRMWARE_IP }}/g" package/base-files/files/bin/config_generate
          
          # è®¾ç½®æœºå™¨åä¸ºWRT
          sed -i "s/OpenWrt/${{ env.FIRMWARE_NAME }}/g" package/base-files/files/bin/config_generate
          
          # è®¾ç½®å¯†ç ä¸ºç©º
          sed -i 's/root::0:0:99999:7:::/root::$1$zqzJn5Jp$6V8R2G5lFvUaU4D8p9k7J0:19146:0:99999:7:::/' package/base-files/files/etc/shadow
          
          echo "âœ… å›ºä»¶è®¾ç½®å®Œæˆ"
          echo "   IPåœ°å€: ${{ env.FIRMWARE_IP }}"
          echo "   æœºå™¨å: ${{ env.FIRMWARE_NAME }}"
          echo "   å¯†ç : ç©ºå¯†ç "

      - name: ä¸‹è½½ä¾èµ–åŒ…
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd /workdir/openwrt
          echo "ðŸ“¥ ä¸‹è½½ä¾èµ–åŒ…"
          make download -j$(nproc)
          # æ¸…ç†æ— æ•ˆçš„å°æ–‡ä»¶
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: é¢„ç¼–è¯‘å·¥å…·é“¾
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd /workdir/openwrt
          echo "ðŸ”¨ é¢„ç¼–è¯‘å·¥å…·é“¾"
          make toolchain/install -j$(nproc) || make toolchain/install -j1 V=s

      - name: æ£€æŸ¥ç©ºé—´ä½¿ç”¨
        if: always()
        run: |
          echo "ðŸ’¾ ç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ:"
          df -hT
          echo ""
          echo "ðŸ“ /workdirç›®å½•å¤§å°:"
          du -sh /workdir/*

  # Ultraå˜ä½“ç¼–è¯‘
  build-ultra:
    runs-on: ubuntu-22.04
    needs: [prepare, build-base]
    if: always() && needs.build-base.result == 'success'
    
    steps:
      - name: æ¢å¤ç¼–è¯‘çŽ¯å¢ƒ
        uses: actions/cache@v4
        with:
          path: |
            /workdir/openwrt
            ~/.cache/go-build
            ~/.cache/pip
          key: ${{ needs.prepare.outputs.cache_key_base }}-${{ needs.prepare.outputs.cache_suffix }}
          restore-keys: |
            ${{ needs.prepare.outputs.cache_key_base }}-
            openwrt-base-

      - name: å‡†å¤‡Ultraé…ç½®
        run: |
          cd /workdir/openwrt
          echo "âš™ï¸ åŠ è½½Ultraé…ç½®"
          [ -f "$GITHUB_WORKSPACE/configs/Ultra.config" ] && \
            cat "$GITHUB_WORKSPACE/configs/Ultra.config" >> .config
          make defconfig

      - name: æ£€æŸ¥Luciè½¯ä»¶åŒ…å®Œæ•´æ€§
        run: |
          cd /workdir/openwrt
          echo "ðŸ” æ£€æŸ¥Luciè½¯ä»¶åŒ…å®Œæ•´æ€§"
          
          # æ£€æŸ¥å…³é”®LuciåŒ…
          LUCI_PACKAGES=$(cat .config | grep "^CONFIG_PACKAGE_luci-" | cut -d'=' -f1 | sed 's/CONFIG_PACKAGE_//')
          for pkg in $LUCI_PACKAGES; do
            if [ ! -d "package/$pkg" ] && [ ! -d "feeds/packages/$pkg" ] && [ ! -d "feeds/luci/$pkg" ]; then
              echo "âš ï¸ è­¦å‘Š: æœªæ‰¾åˆ°è½¯ä»¶åŒ… $pkg"
            fi
          done
          
          # å°è¯•ç¼–è¯‘Luci
          make package/luci/compile V=s || echo "Luciç¼–è¯‘æ£€æŸ¥å®Œæˆ"

      - name: ç¼–è¯‘Ultraå›ºä»¶
        run: |
          cd /workdir/openwrt
          echo "ðŸš€ å¼€å§‹ç¼–è¯‘Ultraå˜ä½“"
          echo "ä½¿ç”¨ $(nproc) ä¸ªçº¿ç¨‹å¹¶è¡Œç¼–è¯‘"
          
          # å¤šé‡ç¼–è¯‘ç­–ç•¥
          make -j$(nproc) || make -j1 || make -j1 V=s
          
          echo "âœ… Ultraç¼–è¯‘å®Œæˆ"

      - name: æ•´ç†Ultraå›ºä»¶
        run: |
          cd /workdir/openwrt/bin/targets/*/*
          echo "ðŸ“¦ æ•´ç†Ultraå›ºä»¶"
          
          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p $GITHUB_WORKSPACE/firmware/Ultra
          
          # å¤åˆ¶å›ºä»¶æ–‡ä»¶
          find . -name "*immortalwrt*" -type f ! -name "*manifest*" | \
            xargs -I {} cp {} $GITHUB_WORKSPACE/firmware/Ultra/
          
          # é‡å‘½åå›ºä»¶
          cd $GITHUB_WORKSPACE/firmware/Ultra
          for file in *; do
            if [ -f "$file" ]; then
              mv "$file" "Ultra-${{ needs.prepare.outputs.build_date }}-${file}"
            fi
          done
          
          echo "âœ… Ultraå›ºä»¶æ•´ç†å®Œæˆ"
          ls -la

  # å˜ä½“å¹¶è¡Œç¼–è¯‘
  build-variants:
    runs-on: ubuntu-22.04
    needs: [prepare, build-base]
    if: always() && needs.build-base.result == 'success'
    strategy:
      matrix:
        variant: ${{ fromJson(needs.prepare.outputs.matrix_variants) }}
      fail-fast: false
    
    steps:
      - name: æ¢å¤ç¼–è¯‘çŽ¯å¢ƒ
        uses: actions/cache@v4
        with:
          path: |
            /workdir/openwrt
            ~/.cache/go-build
            ~/.cache/pip
          key: ${{ needs.prepare.outputs.cache_key_base }}-${{ needs.prepare.outputs.cache_suffix }}
          restore-keys: |
            ${{ needs.prepare.outputs.cache_key_base }}-
            openwrt-base-

      - name: å‡†å¤‡${{ matrix.variant }}é…ç½®
        run: |
          cd /workdir/openwrt
          echo "âš™ï¸ åŠ è½½${{ matrix.variant }}é…ç½®"
          
          # æ¸…ç†ä¹‹å‰çš„é…ç½®
          make distclean
          
          # é‡æ–°åŠ è½½åŸºç¡€é…ç½®
          [ -f "$GITHUB_WORKSPACE/configs/base_ipq60xx.config" ] && \
            cp "$GITHUB_WORKSPACE/configs/base_ipq60xx.config" .config
          [ -f "$GITHUB_WORKSPACE/configs/base_immwrt.config" ] && \
            cat "$GITHUB_WORKSPACE/configs/base_immwrt.config" >> .config
          
          # åŠ è½½å˜ä½“é…ç½®
          [ -f "$GITHUB_WORKSPACE/configs/${{ matrix.variant }}.config" ] && \
            cat "$GITHUB_WORKSPACE/configs/${{ matrix.variant }}.config" >> .config
          
          make defconfig

      - name: ç¼–è¯‘${{ matrix.variant }}å›ºä»¶
        run: |
          cd /workdir/openwrt
          echo "ðŸš€ å¼€å§‹ç¼–è¯‘${{ matrix.variant }}å˜ä½“"
          echo "ä½¿ç”¨ $(nproc) ä¸ªçº¿ç¨‹å¹¶è¡Œç¼–è¯‘"
          
          # å¤šé‡ç¼–è¯‘ç­–ç•¥
          make -j$(nproc) || make -j1 || make -j1 V=s
          
          echo "âœ… ${{ matrix.variant }}ç¼–è¯‘å®Œæˆ"

      - name: æ•´ç†${{ matrix.variant }}å›ºä»¶
        run: |
          cd /workdir/openwrt/bin/targets/*/*
          echo "ðŸ“¦ æ•´ç†${{ matrix.variant }}å›ºä»¶"
          
          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p $GITHUB_WORKSPACE/firmware/${{ matrix.variant }}
          
          # å¤åˆ¶å›ºä»¶æ–‡ä»¶
          find . -name "*immortalwrt*" -type f ! -name "*manifest*" | \
            xargs -I {} cp {} $GITHUB_WORKSPACE/firmware/${{ matrix.variant }}/
          
          # é‡å‘½åå›ºä»¶
          cd $GITHUB_WORKSPACE/firmware/${{ matrix.variant }}
          for file in *; do
            if [ -f "$file" ]; then
              mv "$file" "${{ matrix.variant }}-${{ needs.prepare.outputs.build_date }}-${file}"
            fi
          done
          
          echo "âœ… ${{ matrix.variant }}å›ºä»¶æ•´ç†å®Œæˆ"
          ls -la

  # å‘å¸ƒé˜¶æ®µ
  release:
    runs-on: ubuntu-22.04
    needs: [prepare, build-ultra, build-variants]
    if: always() && (needs.build-ultra.result == 'success' || needs.build-variants.result == 'success')
    
    steps:
      - name: æ•´ç†æ‰€æœ‰å›ºä»¶
        run: |
          mkdir -p $GITHUB_WORKSPACE/release
          
          # å¤åˆ¶æ‰€æœ‰å˜ä½“å›ºä»¶
          for variant in Ultra Max Pro; do
            if [ -d "firmware/$variant" ]; then
              echo "ðŸ“¦ å¤åˆ¶$variantå›ºä»¶"
              cp -r firmware/$variant/* release/
            fi
          done
          
          # ç”Ÿæˆå›ºä»¶ä¿¡æ¯æ–‡ä»¶
          cd $GITHUB_WORKSPACE/release
          cat > firmware_info.md << 'EOF'
          # OpenWrt IPQ60x2 å›ºä»¶å‘å¸ƒ
          
          ## ðŸ“‹ å›ºä»¶ä¿¡æ¯
          - **æž„å»ºæ—¶é—´**: ${BUILD_DATE}
          - **æºç åˆ†æ”¯**: ${REPO_BRANCH}
          - **æºç ä»“åº“**: ${IMMWRT_REPO}
          - **é…ç½®å“ˆå¸Œ**: ${CONFIG_HASH}
          
          ## ðŸ”§ å›ºä»¶è®¾ç½®
          - **IPåœ°å€**: ${FIRMWARE_IP}
          - **æœºå™¨å**: ${FIRMWARE_NAME}
          - **å¯†ç **: ç©ºå¯†ç 
          - **ç™»å½•æ–¹å¼**: SSHæˆ–Webç•Œé¢
          
          ## ðŸ“¦ å˜ä½“è¯´æ˜Ž
          - **Ultra**: å®Œæ•´åŠŸèƒ½ç‰ˆæœ¬ï¼ŒåŒ…å«æ‰€æœ‰å¯ç”¨æ’ä»¶å’ŒåŠŸèƒ½
          - **Max**: åŠŸèƒ½å¢žå¼ºç‰ˆæœ¬ï¼Œå¹³è¡¡æ€§èƒ½å’ŒåŠŸèƒ½
          - **Pro**: ä¸“ä¸šä¼˜åŒ–ç‰ˆæœ¬ï¼Œç²¾ç®€ä¼˜åŒ–ï¼Œé€‚åˆé«˜çº§ç”¨æˆ·
          
          ## ðŸš€ ä½¿ç”¨è¯´æ˜Ž
          1. ä¸‹è½½å¯¹åº”å˜ä½“çš„å›ºä»¶æ–‡ä»¶
          2. é€šè¿‡è·¯ç”±å™¨åŽå°æˆ–TFTPæ–¹å¼åˆ·å…¥
          3. åˆ·å…¥åŽè®¿é—® ${FIRMWARE_IP}
          4. ç”¨æˆ·å: rootï¼Œå¯†ç : ç©º
          
          ## âš ï¸ æ³¨æ„äº‹é¡¹
          - é¦–æ¬¡åˆ·æœºå»ºè®®ä½¿ç”¨U-Bootåˆ·æœº
          - å¤‡ä»½åŽŸåŽ‚å›ºä»¶ä»¥é˜²ä¸‡ä¸€
          - åˆ·æœºå‰è¯·ç¡®è®¤è®¾å¤‡åž‹å·
          
          ---
          æž„å»ºç³»ç»Ÿ: GitHub Actions
          æž„å»ºä»»åŠ¡: ${RUN_ID}
          EOF
          
          # æ›¿æ¢å˜é‡
          sed -i "s/\${BUILD_DATE}/${{ needs.prepare.outputs.build_date }}/g" firmware_info.md
          sed -i "s/\${REPO_BRANCH}/${{ env.REPO_BRANCH }}/g" firmware_info.md
          sed -i "s#\${IMMWRT_REPO}#${{ needs.prepare.outputs.immwrt_repo }}#g" firmware_info.md
          sed -i "s/\${CONFIG_HASH}/${{ needs.prepare.outputs.config_hash }}/g" firmware_info.md
          sed -i "s/\${FIRMWARE_IP}/${{ env.FIRMWARE_IP }}/g" firmware_info.md
          sed -i "s/\${FIRMWARE_NAME}/${{ env.FIRMWARE_NAME }}/g" firmware_info.md
          sed -i "s/\${RUN_ID}/${{ github.run_id }}/g" firmware_info.md
          
          echo "âœ… å›ºä»¶æ•´ç†å®Œæˆ"
          ls -la

      - name: ç”Ÿæˆæ ¡éªŒå’Œ
        run: |
          cd $GITHUB_WORKSPACE/release
          echo "ðŸ” ç”Ÿæˆæ–‡ä»¶æ ¡éªŒå’Œ"
          sha256sum * > sha256sums.txt
          md5sum * > md5sums.txt
          echo "âœ… æ ¡éªŒå’Œç”Ÿæˆå®Œæˆ"

      - name: åˆ›å»ºRelease
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.release_tag }}
          name: "OpenWrt IPQ60x2 ${{ needs.prepare.outputs.build_date }}"
          body_path: release/firmware_info.md
          files: |
            release/*
            !release/firmware_info.md
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ä¸Šä¼ æž„å»ºæ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ needs.prepare.outputs.build_date }}
          path: |
            /workdir/openwrt/logs/
            /workdir/openwrt/.config
          retention-days: 30

      - name: æž„å»ºç»“æžœæ±‡æ€»
        if: always()
        run: |
          echo "## ðŸ“Š æž„å»ºç»“æžœæ±‡æ€»" >> $GITHUB_STEP_SUMMARY
          echo "| å˜ä½“ | çŠ¶æ€ | å›ºä»¶æ•°é‡ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|----------|" >> $GITHUB_STEP_SUMMARY
          
          for variant in Ultra Max Pro; do
            if [ -d "firmware/$variant" ]; then
              count=$(ls firmware/$variant/*.bin 2>/dev/null | wc -l)
              status="âœ… æˆåŠŸ"
            else
              count=0
              status="âŒ å¤±è´¥"
            fi
            echo "| $variant | $status | $count |" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“ˆ æž„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **Releaseæ ‡ç­¾**: ${{ needs.prepare.outputs.release_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æž„å»ºæ—¥æœŸ**: ${{ needs.prepare.outputs.build_date }}" >> $GITHUB_STEP_SUMMARY
          echo "- **é…ç½®å“ˆå¸Œ**: ${{ needs.prepare.outputs.config_hash }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç¼“å­˜å‘½ä¸­**: ${{ needs.build-base.outputs.cache-hit }}" >> $GITHUB_STEP_SUMMARY
          
          # ä¸‹è½½é“¾æŽ¥
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## â¬‡ï¸ ä¸‹è½½é“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
          echo "[æŸ¥çœ‹æ‰€æœ‰å›ºä»¶](https://github.com/${{ github.repository }}/releases/tag/${{ needs.prepare.outputs.release_tag }})" >> $GITHUB_STEP_SUMMARY
