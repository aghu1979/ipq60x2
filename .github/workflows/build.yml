# .github/workflows/build.yml
# =============================================================================
# ImmortalWrt 自动编译工作流 (优化版)
# 版本: 2.0.1
# 更新日期: 2025-11-19
# =============================================================================

name: ImmortalWrt Auto Build

on:
  workflow_dispatch:
  # schedule:
  #   - cron: '0 8 * * 1'

env:
  REPO_URL: https://github.com/laipeng668/immortalwrt.git
  REPO_BRANCH: master
  TZ: Asia/Shanghai

jobs:
  setup:
    runs-on: ubuntu-24.04
    outputs:
      devices: ${{ steps.extract-devices.outputs.devices }}
      cache-key: ${{ steps.cache-key.outputs.key }}
      release-tag: ${{ steps.vars.outputs.release-tag }}
      build-date: ${{ steps.vars.outputs.build-date }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 初始化编译环境
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-2404)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: 设置变量
        id: vars
        run: |
          build_date=$(date +'%Y.%m.%d')
          echo "build-date=$build_date" >> $GITHUB_OUTPUT
          release_tag="imm-$(date +'%Y%m%d')"
          echo "release-tag=$release_tag" >> $GITHUB_OUTPUT

      - name: 提取设备信息
        id: extract-devices
        run: |
          chmod +x $GITHUB_WORKSPACE/scripts/extract-devices.sh
          devices_json=$(bash $GITHUB_WORKSPACE/scripts/extract-devices.sh $GITHUB_WORKSPACE/configs/base_ipq60xx.config)
          echo "devices=$devices_json" >> $GITHUB_OUTPUT
          echo "$devices_json" > devices.json

      - name: 生成智能缓存键
        id: cache-key
        run: |
          config_hash=$(cat $GITHUB_WORKSPACE/configs/*.config $GITHUB_WORKSPACE/scripts/diy.sh | sha256sum | cut -d' ' -f1)
          key="immwrt-${{ github.sha }}-${config_hash}"
          echo "key=$key" >> $GITHUB_OUTPUT
          echo "生成的智能缓存键: $key"

      - name: 上传设备信息
        uses: actions/upload-artifact@v4
        with:
          name: build-metadata
          path: devices.json

  build-ultra:
    needs: setup
    runs-on: ubuntu-24.04
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 调试 - 列出工作空间内容
        run: |
          echo "当前工作目录: $(pwd)"
          echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
          echo "工作空间内容:"
          ls -la $GITHUB_WORKSPACE

      - name: 扩展磁盘空间
        run: |
          chmod +x $GITHUB_WORKSPACE/scripts/extend-disk.sh
          bash $GITHUB_WORKSPACE/scripts/extend-disk.sh

      - name: 初始化编译环境
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-2404)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: 克隆源码
        working-directory: /workdir
        run: |
          df -hT $PWD
          git clone $REPO_URL -b $REPO_BRANCH immortalwrt
          ln -sf /workdir/immortalwrt $GITHUB_WORKSPACE/immortalwrt

      - name: 加载或回退缓存
        uses: actions/cache@v4
        with:
          path: /workdir/immortalwrt
          key: ${{ needs.setup.outputs.cache-key }}
          restore-keys: |
            immwrt-

      - name: 合并配置文件
        run: |
          chmod +x $GITHUB_WORKSPACE/scripts/merge-configs.sh
          bash $GITHUB_WORKSPACE/scripts/merge-configs.sh $GITHUB_WORKSPACE/configs/base_ipq60xx.config $GITHUB_WORKSPACE/configs/base_immwrt.config $GITHUB_WORKSPACE/configs/Ultra.config /workdir/immortalwrt/.config

      - name: 更新和安装Feeds
        run: |
          cd /workdir/immortalwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: 生成Luci软件包报告
        run: |
          chmod +x $GITHUB_WORKSPACE/scripts/luci-report.sh
          bash $GITHUB_WORKSPACE/scripts/luci-report.sh /workdir/immortalwrt Ultra

      - name: 上传Luci报告
        uses: actions/upload-artifact@v4
        with:
          name: luci-report-ultra
          path: luci_report.txt

      - name: 执行自定义DIY脚本
        run: |
          chmod +x $GITHUB_WORKSPACE/scripts/diy.sh
          cp $GITHUB_WORKSPACE/scripts/diy.sh /workdir/immortalwrt
          cd /workdir/immortalwrt
          ./scripts/diy.sh

      - name: 下载软件包
        run: |
          cd /workdir/immortalwrt
          make defconfig
          make download -j$(nproc)

      - name: 编译固件
        run: |
          cd /workdir/immortalwrt
          echo -e "$(nproc) 线程编译 Ultra 变体"
          make -j$(nproc) || make -j1 || make -j1 V=s

      - name: 上传固件工件
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-firmware-ultra
          path: /workdir/immortalwrt/bin/targets/

  build-others:
    needs: [setup, build-ultra]
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        variant: [Max, Pro]
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 调试 - 列出工作空间内容
        run: |
          echo "当前工作目录: $(pwd)"
          echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
          echo "工作空间内容:"
          ls -la $GITHUB_WORKSPACE

      - name: 扩展磁盘空间
        run: |
          chmod +x $GITHUB_WORKSPACE/scripts/extend-disk.sh
          bash $GITHUB_WORKSPACE/scripts/extend-disk.sh

      - name: 初始化编译环境
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-2404)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: 克隆源码
        working-directory: /workdir
        run: |
          git clone $REPO_URL -b $REPO_BRANCH immortalwrt
          ln -sf /workdir/immortalwrt $GITHUB_WORKSPACE/immortalwrt

      - name: 加载Ultra缓存
        uses: actions/cache@v4
        with:
          path: /workdir/immortalwrt
          key: ${{ needs.setup.outputs.cache-key }}

      - name: 合并配置文件
        run: |
          chmod +x $GITHUB_WORKSPACE/scripts/merge-configs.sh
          bash $GITHUB_WORKSPACE/scripts/merge-configs.sh $GITHUB_WORKSPACE/configs/base_ipq60xx.config $GITHUB_WORKSPACE/configs/base_immwrt.config $GITHUB_WORKSPACE/configs/${{ matrix.variant }}.config /workdir/immortalwrt/.config

      - name: 更新和安装Feeds
        run: |
          cd /workdir/immortalwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: 生成Luci软件包报告
        run: |
          chmod +x $GITHUB_WORKSPACE/scripts/luci-report.sh
          bash $GITHUB_WORKSPACE/scripts/luci-report.sh /workdir/immortalwrt ${{ matrix.variant }}

      - name: 上传Luci报告
        uses: actions/upload-artifact@v4
        with:
          name: luci-report-${{ matrix.variant }}
          path: luci_report.txt

      - name: 执行自定义DIY脚本
        run: |
          chmod +x $GITHUB_WORKSPACE/scripts/diy.sh
          cp $GITHUB_WORKSPACE/scripts/diy.sh /workdir/immortalwrt
          cd /workdir/immortalwrt
          ./scripts/diy.sh

      - name: 下载软件包
        run: |
          cd /workdir/immortalwrt
          make defconfig
          make download -j$(nproc)

      - name: 编译固件
        run: |
          cd /workdir/immortalwrt
          echo -e "$(nproc) 线程编译 ${{ matrix.variant }} 变体 (基于Ultra缓存)"
          make -j$(nproc) || make -j1 || make -j1 V=s

      - name: 上传固件工件
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-firmware-${{ matrix.variant }}
          path: /workdir/immortalwrt/bin/targets/

  release:
    needs: [setup, build-ultra, build-others]
    runs-on: ubuntu-24.04
    if: needs.build-ultra.result == 'success' && needs.build-others.result == 'success'
    steps:
      - name: 下载所有固件工件
        uses: actions/download-artifact@v4
        with:
          pattern: immortalwrt-firmware-*
          merge-multiple: true
          path: artifacts/firmware

      - name: 下载所有Luci报告工件
        uses: actions/download-artifact@v4
        with:
          pattern: luci-report-*
          merge-multiple: true
          path: artifacts/reports

      - name: 下载元数据
        uses: actions/download-artifact@v4
        with:
          name: build-metadata
          path: artifacts/metadata

      - name: 整理发布文件
        run: |
          mkdir -p release
          find artifacts/firmware -name "*.img" -o -name "*.bin" -o -name "*.tar.gz" | xargs -I {} cp {} release/
          ls -la release/

      - name: 生成发布说明
        run: |
          cat > release_notes.md << EOF
          # ImmortalWrt 固件发布
          
          ## 版本信息
          - 构建日期: ${{ needs.setup.outputs.build-date }}
          - 发布标签: ${{ needs.setup.outputs.release-tag }}
          - 源码分支: ${{ env.REPO_BRANCH }}
          
          ## 变体配置
          - **Ultra**: 包含所有功能，适合高级用户
          - **Max**: 包含大部分常用功能
          - **Pro**: 精简版本，只包含基本功能
          
          ## 设备支持
          \`\`\`json
          $(cat artifacts/metadata/devices.json)
          \`\`\`
          
          ## Luci软件包报告
          EOF

          for report_file in artifacts/reports/*.txt; do
            if [ -f "$report_file" ]; then
              variant_name=$(basename "$report_file" .txt | sed 's/luci-report-//')
              echo "" >> release_notes.md
              echo "### $variant_name 变体" >> release_notes.md
              echo '```' >> release_notes.md
              cat "$report_file" >> release_notes.md
              echo '```' >> release_notes.md
            fi
          done
          
          cat >> release_notes.md << EOF
          
          ## 使用说明
          1. 下载对应设备的固件文件。
          2. 通过设备恢复界面或系统升级界面刷入固件。
          3. 刷入后恢复出厂设置。
          
          ## 注意事项
          - 刷机有风险，请谨慎操作。
          - 建议刷机前备份原厂固件。
          - 如遇问题，请到项目主页提交Issue。
          EOF

      - name: 创建GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.setup.outputs.release-tag }}
          body_path: release_notes.md
          files: release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
