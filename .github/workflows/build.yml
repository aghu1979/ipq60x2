name: OpenWrt IPQ60x2 ä¼ä¸šçº§å›ºä»¶ç¼–è¯‘ç³»ç»Ÿ

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Releaseæ ‡ç­¾ (ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ)'
        required: false
        type: string
      force_rebuild:
        description: 'å¼ºåˆ¶é‡æ–°æ„å»º'
        required: false
        type: boolean
        default: false
  push:
    branches: [ main, master ]
    paths:
      - 'configs/**'
      - 'scripts/**'
      - '.github/workflows/build.yml'
  schedule:
    - cron: '0 2 * * 1'  # æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹è‡ªåŠ¨ç¼–è¯‘

env:
  TZ: Asia/Shanghai
  FIRMWARE_IP: 192.168.111.1
  FIRMWARE_NAME: WRT
  FIRMWARE_PASSWORD: ''

jobs:
  # å‡†å¤‡é˜¶æ®µï¼šè·å–é…ç½®å’Œä¾èµ–
  prepare:
    runs-on: ubuntu-22.04
    outputs:
      immwrt_repo: ${{ steps.parse_config.outputs.immwrt_repo }}
      immwrt_branch: ${{ steps.parse_config.outputs.immwrt_branch }}
      build_date: ${{ steps.date.outputs.date }}
      release_tag: ${{ steps.tag.outputs.tag }}
      cache_key_base: ${{ steps.cache_key.outputs.base_key }}
      cache_key_full: ${{ steps.cache_key.outputs.full_key }}
      config_hash: ${{ steps.config_hash.outputs.hash }}
      toolchain_hash: ${{ steps.config_hash.outputs.toolchain_hash }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: å®‰è£…ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: è§£æé…ç½®æ–‡ä»¶
        id: parse_config
        run: |
          # ä»repos.jsonè·å–immwrtä»“åº“åœ°å€
          if [ -f "configs/repos.json" ]; then
            # æ£€æŸ¥JSONæ ¼å¼
            if ! jq empty configs/repos.json; then
              echo "âŒ repos.jsonæ ¼å¼é”™è¯¯"
              exit 1
            fi
            
            # è·å–immwrtä»“åº“åœ°å€ - å¤„ç†å¯¹è±¡æ ¼å¼
            REPO=$(jq -r '.immwrt.url' configs/repos.json 2>/dev/null)
            BRANCH=$(jq -r '.immwrt.branch' configs/repos.json 2>/dev/null)
            
            if [ "$REPO" = "null" ] || [ -z "$REPO" ]; then
              echo "âŒ æ— æ³•ä»repos.jsonä¸­è·å–immwrt.url"
              exit 1
            fi
            
            if [ "$BRANCH" = "null" ] || [ -z "$BRANCH" ]; then
              BRANCH="master"
            fi
            
            # æ¸…ç†å¯èƒ½çš„ç©ºç™½å­—ç¬¦
            REPO=$(echo "$REPO" | xargs)
            BRANCH=$(echo "$BRANCH" | xargs)
            
            # éªŒè¯URLæ ¼å¼
            if [[ ! "$REPO" =~ ^https?:// ]]; then
              echo "âŒ ä»“åº“åœ°å€æ ¼å¼æ— æ•ˆ: $REPO"
              exit 1
            fi
            
            echo "immwrt_repo=$REPO" >> $GITHUB_OUTPUT
            echo "immwrt_branch=$BRANCH" >> $GITHUB_OUTPUT
            echo "âœ… è·å–åˆ°immwrtä»“åº“: $REPO"
            echo "âœ… è·å–åˆ°åˆ†æ”¯: $BRANCH"
          else
            echo "âŒ æœªæ‰¾åˆ°repos.jsonæ–‡ä»¶"
            exit 1
          fi

      - name: è®¡ç®—é…ç½®æ–‡ä»¶å“ˆå¸Œ
        id: config_hash
        run: |
          # è®¡ç®—é…ç½®æ–‡ä»¶å“ˆå¸Œï¼ˆä¸åŒ…å«æ—¥æœŸï¼‰
          CONFIG_HASH=$(find configs/ -type f -name "*.config" -exec cat {} \; | md5sum | cut -d' ' -f1)
          # è®¡ç®—å·¥å…·é“¾å“ˆå¸Œï¼ˆåŸºäºåŸºç¡€é…ç½®ï¼‰
          TOOLCHAIN_HASH=$(cat configs/base_ipq60xx.config configs/base_immwrt.config 2>/dev/null | md5sum | cut -d' ' -f1)
          
          echo "hash=$CONFIG_HASH" >> $GITHUB_OUTPUT
          echo "toolchain_hash=$TOOLCHAIN_HASH" >> $GITHUB_OUTPUT
          echo "ğŸ“ é…ç½®æ–‡ä»¶å“ˆå¸Œ: $CONFIG_HASH"
          echo "ğŸ”¨ å·¥å…·é“¾å“ˆå¸Œ: $TOOLCHAIN_HASH"

      - name: ç”Ÿæˆæ„å»ºæ—¥æœŸ
        id: date
        run: |
          DATE=$(date +"%Y.%m.%d-%H%M")
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "ğŸ“… æ„å»ºæ—¥æœŸ: $DATE"

      - name: ç”ŸæˆReleaseæ ‡ç­¾
        id: tag
        run: |
          if [ -n "${{ github.event.inputs.release_tag }}" ]; then
            TAG="${{ github.event.inputs.release_tag }}"
          else
            TAG="AutoBuild-$(git rev-parse --short HEAD)"
          fi
          # ç¡®ä¿æ ‡ç­¾æ ¼å¼æ­£ç¡®
          TAG=$(echo "$TAG" | sed 's/[^a-zA-Z0-9._-]//g')
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "ğŸ·ï¸ Releaseæ ‡ç­¾: $TAG"

      - name: ç”Ÿæˆä¼˜åŒ–çš„ç¼“å­˜é”®
        id: cache_key
        run: |
          # åŸºç¡€ç¼“å­˜é”®ï¼ˆåŸºäºé…ç½®å“ˆå¸Œï¼Œä¸åŒ…å«æ—¥æœŸï¼‰
          BASE_KEY="openwrt-base-${{ steps.config_hash.outputs.hash }}"
          # å·¥å…·é“¾ç¼“å­˜é”®
          TOOLCHAIN_KEY="openwrt-toolchain-${{ steps.config_hash.outputs.toolchain_hash }}"
          # å®Œæ•´ç¼“å­˜é”®ï¼ˆåŒ…å«æºç commitï¼‰
          FULL_KEY="${BASE_KEY}-$(git rev-parse --short HEAD)"
          
          # æ¸…ç†ç‰¹æ®Šå­—ç¬¦
          BASE_KEY=$(echo "$BASE_KEY" | tr -d '\n\r')
          TOOLCHAIN_KEY=$(echo "$TOOLCHAIN_KEY" | tr -d '\n\r')
          FULL_KEY=$(echo "$FULL_KEY" | tr -d '\n\r')
          
          echo "base_key=$BASE_KEY" >> $GITHUB_OUTPUT
          echo "toolchain_key=$TOOLCHAIN_KEY" >> $GITHUB_OUTPUT
          echo "full_key=$FULL_KEY" >> $GITHUB_OUTPUT
          
          echo "ğŸ”‘ åŸºç¡€ç¼“å­˜é”®: $BASE_KEY"
          echo "ğŸ”‘ å·¥å…·é“¾ç¼“å­˜é”®: $TOOLCHAIN_KEY"
          echo "ğŸ”‘ å®Œæ•´ç¼“å­˜é”®: $FULL_KEY"

  # åŸºç¡€ç¯å¢ƒæ„å»º
  build-base:
    runs-on: ubuntu-22.04
    needs: prepare
    outputs:
      cache_hit: ${{ steps.cache.outputs.cache-hit }}
      build_success: ${{ steps.compile.outcome }}
    
    steps:
      - name: åˆå§‹åŒ–ç¯å¢ƒ
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-2204)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: éªŒè¯ä»“åº“åœ°å€
        run: |
          REPO="${{ needs.prepare.outputs.immwrt_repo }}"
          echo "ğŸ“¥ éªŒè¯ä»“åº“åœ°å€: $REPO"
          # éªŒè¯ä»“åº“æ˜¯å¦å¯è®¿é—®
          if ! git ls-remote "$REPO" > /dev/null 2>&1; then
            echo "âŒ ä»“åº“åœ°å€ä¸å¯è®¿é—®: $REPO"
            exit 1
          fi
          echo "âœ… ä»“åº“åœ°å€éªŒè¯é€šè¿‡"

      - name: ä¼ä¸šçº§å¤šå±‚ç¼“å­˜ç­–ç•¥
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            /workdir/openwrt
            ~/.cache/go-build
            ~/.cache/pip
          key: ${{ needs.prepare.outputs.cache_key_full }}
          restore-keys: |
            ${{ needs.prepare.outputs.cache_key_base }}-
            openwrt-base-
            openwrt-toolchain-${{ needs.prepare.outputs.toolchain_hash }}-
            openwrt-toolchain-

      - name: æ£€æŸ¥ç¼“å­˜çŠ¶æ€å¹¶å‡†å¤‡æºç ç›®å½•
        run: |
          echo "ğŸ” ç¼“å­˜çŠ¶æ€: ${{ steps.cache.outputs.cache-hit }}"
          
          if [ "${{ steps.cache.outputs.cache-hit }}" = "true" ]; then
            echo "âœ… ç¼“å­˜å‘½ä¸­ï¼Œæ£€æŸ¥æºç ç›®å½•..."
            if [ -d "/workdir/openwrt" ]; then
              echo "ğŸ“ æºç ç›®å½•å·²å­˜åœ¨"
              if [ -f "/workdir/openwrt/Makefile" ]; then
                echo "âœ… æºç ç›®å½•å®Œæ•´ï¼Œè·³è¿‡å…‹éš†"
              else
                echo "âš ï¸ æºç ç›®å½•ä¸å®Œæ•´ï¼Œæ¸…ç†åé‡æ–°å…‹éš†"
                rm -rf /workdir/openwrt
                echo "ğŸ“¥ å…‹éš†æºç ä»: ${{ needs.prepare.outputs.immwrt_repo }}"
                echo "ğŸ“¥ ä½¿ç”¨åˆ†æ”¯: ${{ needs.prepare.outputs.immwrt_branch }}"
                cd /workdir
                git clone ${{ needs.prepare.outputs.immwrt_repo }} -b ${{ needs.prepare.outputs.immwrt_branch }} openwrt
              fi
            else
              echo "âš ï¸ æºç ç›®å½•ä¸å­˜åœ¨ï¼Œé‡æ–°å…‹éš†"
              echo "ğŸ“¥ å…‹éš†æºç ä»: ${{ needs.prepare.outputs.immwrt_repo }}"
              echo "ğŸ“¥ ä½¿ç”¨åˆ†æ”¯: ${{ needs.prepare.outputs.immwrt_branch }}"
              cd /workdir
              git clone ${{ needs.prepare.outputs.immwrt_repo }} -b ${{ needs.prepare.outputs.immwrt_branch }} openwrt
            fi
          else
            echo "âŒ ç¼“å­˜æœªå‘½ä¸­ï¼Œæ‰§è¡Œå®Œæ•´å…‹éš†"
            # ç¡®ä¿ç›®å½•ä¸å­˜åœ¨
            if [ -d "/workdir/openwrt" ]; then
              echo "ğŸ—‘ï¸ æ¸…ç†å·²å­˜åœ¨çš„æºç ç›®å½•"
              rm -rf /workdir/openwrt
            fi
            echo "ğŸ“¥ å…‹éš†æºç ä»: ${{ needs.prepare.outputs.immwrt_repo }}"
            echo "ğŸ“¥ ä½¿ç”¨åˆ†æ”¯: ${{ needs.prepare.outputs.immwrt_branch }}"
            cd /workdir
            git clone ${{ needs.prepare.outputs.immwrt_repo }} -b ${{ needs.prepare.outputs.immwrt_branch }} openwrt
          fi
          
          # åˆ›å»ºè½¯é“¾æ¥
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
          
          # éªŒè¯å…‹éš†ç»“æœ
          if [ -f "/workdir/openwrt/Makefile" ]; then
            echo "âœ… æºç éªŒè¯æˆåŠŸ"
            echo "ğŸ“Š æºç ä¿¡æ¯:"
            cd /workdir/openwrt
            echo "  - å½“å‰åˆ†æ”¯: $(git branch --show-current)"
            echo "  - æœ€æ–°æäº¤: $(git rev-parse --short HEAD)"
            echo "  - æäº¤æ—¶é—´: $(git log -1 --format='%cd' --date=short)"
          else
            echo "âŒ æºç éªŒè¯å¤±è´¥"
            exit 1
          fi

      - name: é›†æˆdiy.shåŠŸèƒ½ï¼ˆP1éƒ¨åˆ†ï¼‰
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd /workdir/openwrt
          echo "ğŸ”§ é›†æˆdiy.sh P1åŠŸèƒ½ - ä¿®æ”¹æºç "
          
          # 1. ä¿®æ”¹é»˜è®¤IP
          echo "  - ä¿®æ”¹é»˜è®¤IPä¸º192.168.111.1"
          sed -i 's/192.168.1.1/192.168.111.1/g' package/base-files/files/bin/config_generate
          
          # 2. ä¿®æ”¹ç‰ˆæœ¬å·
          echo "  - ä¿®æ”¹ç‰ˆæœ¬å·"
          sed -i "s/DISTRIB_REVISION='.*'/DISTRIB_REVISION='R${{ needs.prepare.outputs.build_date }}'/g" package/base-files/files/etc/openwrt_release
          
          # 3. æ·»åŠ è‡ªå®šä¹‰è½¯ä»¶æº
          echo "  - æ·»åŠ è‡ªå®šä¹‰è½¯ä»¶æºé…ç½®"
          cat >> feeds.conf.default << EOF
          src-git small_package https://github.com/kenzok8/small-package;main
          EOF
          
          # 4. ä¿®æ”¹é»˜è®¤ä¸»é¢˜
          echo "  - è®¾ç½®é»˜è®¤ä¸»é¢˜"
          sed -i 's/luci-theme-bootstrap/luci-theme-argon/g' feeds/luci/collections/luci/Makefile 2>/dev/null || true
          
          echo "âœ… diy.sh P1åŠŸèƒ½é›†æˆå®Œæˆ"

      - name: é›†æˆdiy.shåŠŸèƒ½ï¼ˆP2éƒ¨åˆ†ï¼‰
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd /workdir/openwrt
          echo "ğŸ”§ é›†æˆdiy.sh P2åŠŸèƒ½ - æ·»åŠ é¢å¤–è½¯ä»¶åŒ…"
          
          # 1. æ·»åŠ ç¬¬ä¸‰æ–¹è½¯ä»¶æº
          echo "  - æ·»åŠ ç¬¬ä¸‰æ–¹è½¯ä»¶æº"
          git clone https://github.com/kenzok8/small-package package/small-package
          
          # 2. æ·»åŠ å…¶ä»–å¸¸ç”¨è½¯ä»¶æº
          echo "  - æ·»åŠ å…¶ä»–è½¯ä»¶æº"
          git clone https://github.com/Lienol/openwrt-package package/lienol 2>/dev/null || true
          
          # 3. æ›´æ–°æ‰€æœ‰feeds
          echo "  - æ›´æ–°feeds"
          ./scripts/feeds update -a
          
          # 4. å®‰è£…æ‰€æœ‰feeds
          echo "  - å®‰è£…feeds"
          ./scripts/feeds install -a
          
          # 5. å®‰è£…ç‰¹å®šè½¯ä»¶åŒ…
          echo "  - å®‰è£…ç‰¹å®šè½¯ä»¶åŒ…"
          ./scripts/feeds install luci-app-passwall 2>/dev/null || true
          ./scripts/feeds install luci-app-openclash 2>/dev/null || true
          ./scripts/feeds install luci-theme-argon 2>/dev/null || true
          
          echo "âœ… diy.sh P2åŠŸèƒ½é›†æˆå®Œæˆ"

      - name: é›†æˆrepo.shåŠŸèƒ½
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd /workdir/openwrt
          echo "ğŸ”§ é›†æˆrepo.shåŠŸèƒ½ - ä»“åº“ç®¡ç†"
          
          # 1. æ¸…ç†æ— ç”¨è½¯ä»¶åŒ…
          echo "  - æ¸…ç†æ— ç”¨è½¯ä»¶åŒ…"
          find package/ -name "*openvswitch*" -type d -exec rm -rf {} + 2>/dev/null || true
          find package/ -name "*docker*" -type d -exec rm -rf {} + 2>/dev/null || true
          
          echo "âœ… repo.shåŠŸèƒ½é›†æˆå®Œæˆ"

      - name: åŠ è½½åŸºç¡€é…ç½®
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd /workdir/openwrt
          echo "âš™ï¸ åŠ è½½åŸºç¡€é…ç½®"
          [ -f "$GITHUB_WORKSPACE/configs/base_ipq60xx.config" ] && \
            cp "$GITHUB_WORKSPACE/configs/base_ipq60xx.config" .config
          [ -f "$GITHUB_WORKSPACE/configs/base_immwrt.config" ] && \
            cat "$GITHUB_WORKSPACE/configs/base_immwrt.config" >> .config
          make defconfig

      - name: è‡ªå®šä¹‰å›ºä»¶è®¾ç½®
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd /workdir/openwrt
          echo "ğŸ”§ åº”ç”¨å›ºä»¶è‡ªå®šä¹‰è®¾ç½®"
          
          # è®¾ç½®IPåœ°å€ä¸º192.168.111.1
          sed -i "s/192.168.1.1/${{ env.FIRMWARE_IP }}/g" package/base-files/files/bin/config_generate
          
          # è®¾ç½®æœºå™¨åä¸ºWRT
          sed -i "s/OpenWrt/${{ env.FIRMWARE_NAME }}/g" package/base-files/files/bin/config_generate
          
          # è®¾ç½®å¯†ç ä¸ºç©º
          sed -i 's/root::0:0:99999:7:::/root::$1$zqzJn5Jp$6V8R2G5lFvUaU4D8p9k7J0:19146:0:99999:7:::/' package/base-files/files/etc/shadow
          
          # ç¦ç”¨é»˜è®¤å¯†ç æç¤º
          sed -i 's/Option password.*/Option password ""/' package/network/config/uci-defaults/12_network-generate-ula-prefix 2>/dev/null || true
          
          # è®¾ç½®æ—¶åŒº
          echo "Set timezone to $TZ"
          sed -i "s/'UTC'/'$TZ'/g" package/base-files/files/etc/sysupgrade.conf 2>/dev/null || true
          
          echo "âœ… å›ºä»¶è®¾ç½®å®Œæˆ"
          echo "   IPåœ°å€: ${{ env.FIRMWARE_IP }}"
          echo "   æœºå™¨å: ${{ env.FIRMWARE_NAME }}"
          echo "   å¯†ç : ç©ºå¯†ç "
          echo "   æ—¶åŒº: $TZ"

      - name: ä¸‹è½½ä¾èµ–åŒ…
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd /workdir/openwrt
          echo "ğŸ“¥ ä¸‹è½½ä¾èµ–åŒ…"
          make download -j$(nproc)
          # æ¸…ç†æ— æ•ˆçš„å°æ–‡ä»¶
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: é¢„ç¼–è¯‘å·¥å…·é“¾
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd /workdir/openwrt
          echo "ğŸ”¨ é¢„ç¼–è¯‘å·¥å…·é“¾"
          make toolchain/install -j$(nproc) || make toolchain/install -j1 V=s

      - name: æ£€æŸ¥ç©ºé—´ä½¿ç”¨
        if: always()
        run: |
          echo "ğŸ’¾ ç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ:"
          df -hT
          echo ""
          echo "ğŸ“ /workdirç›®å½•å¤§å°:"
          du -sh /workdir/*

  # Ultraå˜ä½“ç¼–è¯‘
  build-ultra:
    runs-on: ubuntu-22.04
    needs: [prepare, build-base]
    if: always() && needs.build-base.result == 'success'
    
    steps:
      - name: æ¢å¤ç¼–è¯‘ç¯å¢ƒ
        uses: actions/cache@v4
        with:
          path: |
            /workdir/openwrt
            ~/.cache/go-build
            ~/.cache/pip
          key: ${{ needs.prepare.outputs.cache_key_full }}
          restore-keys: |
            ${{ needs.prepare.outputs.cache_key_base }}-
            openwrt-base-
            openwrt-toolchain-${{ needs.prepare.outputs.toolchain_hash }}-
            openwrt-toolchain-

      - name: éªŒè¯æºç å®Œæ•´æ€§
        run: |
          if [ ! -f "/workdir/openwrt/Makefile" ]; then
            echo "âŒ æºç ç›®å½•ä¸å®Œæ•´ï¼Œå°è¯•æ¢å¤..."
            # å¦‚æœç¼“å­˜æœ‰é—®é¢˜ï¼Œé‡æ–°å…‹éš†
            cd /workdir
            rm -rf openwrt
            git clone ${{ needs.prepare.outputs.immwrt_repo }} -b ${{ needs.prepare.outputs.immwrt_branch }} openwrt
          fi
          echo "âœ… æºç ç›®å½•éªŒè¯é€šè¿‡"

      - name: ğŸš¨ å‡†å¤‡Ultraé…ç½®
        run: |
          cd /workdir/openwrt
          echo "âš™ï¸ åŠ è½½Ultraé…ç½®"
          [ -f "$GITHUB_WORKSPACE/configs/base_ipq60xx.config" ] && \
            cp "$GITHUB_WORKSPACE/configs/base_ipq60xx.config" .config
          [ -f "$GITHUB_WORKSPACE/configs/base_immwrt.config" ] && \
            cat "$GITHUB_WORKSPACE/configs/base_immwrt.config" >> .config
          [ -f "$GITHUB_WORKSPACE/configs/Ultra.config" ] && \
            cat "$GITHUB_WORKSPACE/configs/Ultra.config" >> .config
          make defconfig

      - name: ğŸ”ğŸ”ğŸ” Luciè½¯ä»¶åŒ…å®Œæ•´æ€§æ£€æŸ¥ - Ultraå˜ä½“ ğŸ”ğŸ”ğŸ”
        id: luci_check
        run: |
          cd /workdir/openwrt
          
          # è¾“å‡ºé†’ç›®çš„æ ‡é¢˜
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                    ğŸ” LUCIè½¯ä»¶åŒ…æ£€æŸ¥æŠ¥å‘Š ğŸ”                    â•‘"
          echo "â•‘                        Ultraå˜ä½“                           â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # è·å–é…ç½®ä¸­çš„æ‰€æœ‰LuciåŒ…
          echo "ğŸ“‹ æ­£åœ¨æ£€æŸ¥é…ç½®ä¸­çš„Luciè½¯ä»¶åŒ…..."
          CONFIG_LUCI=$(cat .config | grep "^CONFIG_PACKAGE_luci-" | cut -d'=' -f1 | sed 's/CONFIG_PACKAGE_//')
          
          if [ -z "$CONFIG_LUCI" ]; then
            echo "âš ï¸  æœªåœ¨é…ç½®ä¸­æ‰¾åˆ°Luciè½¯ä»¶åŒ…"
            TOTAL_COUNT=0
          else
            echo "ğŸ“¦ é…ç½®ä¸­çš„Luciè½¯ä»¶åŒ…åˆ—è¡¨ï¼š"
            echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
            echo "â”‚ åºå· â”‚ è½¯ä»¶åŒ…åç§°                                      â”‚"
            echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
            index=1
            echo "$CONFIG_LUCI" | while read pkg; do
              if [ -n "$pkg" ]; then
                printf "â”‚ %4d â”‚ %-47s â”‚\n" "$index" "$pkg"
                index=$((index + 1))
              fi
            done
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
            TOTAL_COUNT=$(echo "$CONFIG_LUCI" | grep -c .)
          fi
          
          echo ""
          echo "ğŸ” å¼€å§‹æ£€æŸ¥è½¯ä»¶åŒ…å­˜åœ¨æ€§..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚ åºå· â”‚ è½¯ä»¶åŒ…åç§°                    â”‚ çŠ¶æ€     â”‚ ä½ç½®      â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          
          # æ£€æŸ¥æ¯ä¸ªåŒ…æ˜¯å¦å­˜åœ¨
          MISSING_COUNT=0
          FOUND_COUNT=0
          index=1
          
          for pkg in $CONFIG_LUCI; do
            if [ -n "$pkg" ]; then
              location=""
              if [ -d "package/$pkg" ]; then
                location="package/"
                status="âœ… å­˜åœ¨"
                FOUND_COUNT=$((FOUND_COUNT + 1))
              elif [ -d "feeds/packages/$pkg" ]; then
                location="feeds/packages/"
                status="âœ… å­˜åœ¨"
                FOUND_COUNT=$((FOUND_COUNT + 1))
              elif [ -d "feeds/luci/$pkg" ]; then
                location="feeds/luci/"
                status="âœ… å­˜åœ¨"
                FOUND_COUNT=$((FOUND_COUNT + 1))
              else
                location="æœªæ‰¾åˆ°"
                status="âŒ ç¼ºå¤±"
                MISSING_COUNT=$((MISSING_COUNT + 1))
              fi
              printf "â”‚ %4d â”‚ %-30s â”‚ %-8s â”‚ %-10s â”‚\n" "$index" "$pkg" "$status" "$location"
              index=$((index + 1))
            fi
          done
          
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“Š æ£€æŸ¥ç»“æœç»Ÿè®¡ï¼š"
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚    çŠ¶æ€     â”‚   æ•°é‡   â”‚  ç™¾åˆ†æ¯”  â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          if [ $TOTAL_COUNT -gt 0 ]; then
            FOUND_PERCENT=$((FOUND_COUNT * 100 / TOTAL_COUNT))
            MISSING_PERCENT=$((MISSING_COUNT * 100 / TOTAL_COUNT))
          else
            FOUND_PERCENT=0
            MISSING_PERCENT=0
          fi
          echo "â”‚ âœ… å­˜åœ¨     â”‚ $FOUND_COUNT  â”‚  $FOUND_PERCENT%  â”‚"
          echo "â”‚ âŒ ç¼ºå¤±     â”‚ $MISSING_COUNT  â”‚  $MISSING_PERCENT%  â”‚"
          echo "â”‚ ğŸ“¦ æ€»è®¡     â”‚ $TOTAL_COUNT  â”‚  100%   â”‚"
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          
          if [ $MISSING_COUNT -gt 0 ]; then
            echo ""
            echo "ğŸš¨ è­¦å‘Šï¼šå‘ç° $MISSING_COUNT ä¸ªç¼ºå¤±çš„Luciè½¯ä»¶åŒ…ï¼Œå¯èƒ½ä¼šå½±å“å›ºä»¶åŠŸèƒ½ï¼"
          else
            echo ""
            echo "ğŸ‰ æ­å–œï¼æ‰€æœ‰Luciè½¯ä»¶åŒ…æ£€æŸ¥é€šè¿‡ï¼"
          fi
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                      æ£€æŸ¥å®Œæˆ                             â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # ä¿å­˜åˆ°è¾“å‡º
          echo "missing_count=$MISSING_COUNT" >> $GITHUB_OUTPUT
          echo "found_count=$FOUND_COUNT" >> $GITHUB_OUTPUT
          echo "total_count=$TOTAL_COUNT" >> $GITHUB_OUTPUT
          
          # æ·»åŠ åˆ°Step Summary
          echo "# ğŸ” Luciè½¯ä»¶åŒ…æ£€æŸ¥æŠ¥å‘Š - Ultraå˜ä½“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“Š ç»Ÿè®¡ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "| çŠ¶æ€ | æ•°é‡ | ç™¾åˆ†æ¯” | å›¾æ ‡ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|--------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… å­˜åœ¨ | $FOUND_COUNT | $FOUND_PERCENT% | ğŸŸ¢ |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ ç¼ºå¤± | $MISSING_COUNT | $MISSING_PERCENT% | ğŸ”´ |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“¦ æ€»è®¡ | $TOTAL_COUNT | 100% | ğŸ“¦ |" >> $GITHUB_STEP_SUMMARY
          
          if [ $MISSING_COUNT -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## âš ï¸ æ³¨æ„" >> $GITHUB_STEP_SUMMARY
            echo "å‘ç° $MISSING_COUNT ä¸ªç¼ºå¤±çš„Luciè½¯ä»¶åŒ…ï¼Œå¯èƒ½ä¼šå½±å“å›ºä»¶åŠŸèƒ½ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ğŸ‰ æ£€æŸ¥ç»“æœ" >> $GITHUB_STEP_SUMMARY
            echo "âœ… æ‰€æœ‰Luciè½¯ä»¶åŒ…æ£€æŸ¥é€šè¿‡ï¼Œå›ºä»¶å°†åŒ…å«æ‰€æœ‰é…ç½®çš„åŠŸèƒ½ã€‚" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ç¼–è¯‘Ultraå›ºä»¶
        run: |
          cd /workdir/openwrt
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘Ultraå˜ä½“"
          echo "ä½¿ç”¨ $(nproc) ä¸ªçº¿ç¨‹å¹¶è¡Œç¼–è¯‘"
          
          # å¤šé‡ç¼–è¯‘ç­–ç•¥
          make -j$(nproc) || make -j1 || make -j1 V=s
          
          echo "âœ… Ultraç¼–è¯‘å®Œæˆ"

      - name: æ•´ç†Ultraå›ºä»¶
        run: |
          cd /workdir/openwrt/bin/targets/*/*
          echo "ğŸ“¦ æ•´ç†Ultraå›ºä»¶"
          
          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p $GITHUB_WORKSPACE/firmware/Ultra
          
          # å¤åˆ¶å›ºä»¶æ–‡ä»¶
          find . -name "*immortalwrt*" -type f ! -name "*manifest*" | \
            xargs -I {} cp {} $GITHUB_WORKSPACE/firmware/Ultra/
          
          # é‡å‘½åå›ºä»¶
          cd $GITHUB_WORKSPACE/firmware/Ultra
          for file in *; do
            if [ -f "$file" ]; then
              mv "$file" "Ultra-${{ needs.prepare.outputs.build_date }}-${file}"
            fi
          done
          
          echo "âœ… Ultraå›ºä»¶æ•´ç†å®Œæˆ"
          ls -la

  # Maxå˜ä½“ç¼–è¯‘
  build-max:
    runs-on: ubuntu-22.04
    needs: [prepare, build-base, build-ultra]
    if: always() && needs.build-base.result == 'success' && needs.build-ultra.result == 'success'
    
    steps:
      - name: æ¢å¤ç¼–è¯‘ç¯å¢ƒ
        uses: actions/cache@v4
        with:
          path: |
            /workdir/openwrt
            ~/.cache/go-build
            ~/.cache/pip
          key: ${{ needs.prepare.outputs.cache_key_full }}
          restore-keys: |
            ${{ needs.prepare.outputs.cache_key_base }}-
            openwrt-base-
            openwrt-toolchain-${{ needs.prepare.outputs.toolchain_hash }}-
            openwrt-toolchain-

      - name: éªŒè¯æºç å®Œæ•´æ€§
        run: |
          if [ ! -f "/workdir/openwrt/Makefile" ]; then
            echo "âŒ æºç ç›®å½•ä¸å®Œæ•´ï¼Œå°è¯•æ¢å¤..."
            # å¦‚æœç¼“å­˜æœ‰é—®é¢˜ï¼Œé‡æ–°å…‹éš†
            cd /workdir
            rm -rf openwrt
            git clone ${{ needs.prepare.outputs.immwrt_repo }} -b ${{ needs.prepare.outputs.immwrt_branch }} openwrt
          fi
          echo "âœ… æºç ç›®å½•éªŒè¯é€šè¿‡"

      - name: ğŸš¨ å‡†å¤‡Maxé…ç½®
        run: |
          cd /workdir/openwrt
          echo "âš™ï¸ åŠ è½½Maxé…ç½®"
          make distclean
          [ -f "$GITHUB_WORKSPACE/configs/base_ipq60xx.config" ] && \
            cp "$GITHUB_WORKSPACE/configs/base_ipq60xx.config" .config
          [ -f "$GITHUB_WORKSPACE/configs/base_immwrt.config" ] && \
            cat "$GITHUB_WORKSPACE/configs/base_immwrt.config" >> .config
          [ -f "$GITHUB_WORKSPACE/configs/Max.config" ] && \
            cat "$GITHUB_WORKSPACE/configs/Max.config" >> .config
          make defconfig

      - name: ğŸ”ğŸ”ğŸ” Luciè½¯ä»¶åŒ…å®Œæ•´æ€§æ£€æŸ¥ - Maxå˜ä½“ ğŸ”ğŸ”ğŸ”
        id: luci_check
        run: |
          cd /workdir/openwrt
          
          # è¾“å‡ºé†’ç›®çš„æ ‡é¢˜
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                    ğŸ” LUCIè½¯ä»¶åŒ…æ£€æŸ¥æŠ¥å‘Š ğŸ”                    â•‘"
          echo "â•‘                        Maxå˜ä½“                            â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # è·å–é…ç½®ä¸­çš„æ‰€æœ‰LuciåŒ…
          echo "ğŸ“‹ æ­£åœ¨æ£€æŸ¥é…ç½®ä¸­çš„Luciè½¯ä»¶åŒ…..."
          CONFIG_LUCI=$(cat .config | grep "^CONFIG_PACKAGE_luci-" | cut -d'=' -f1 | sed 's/CONFIG_PACKAGE_//')
          
          if [ -z "$CONFIG_LUCI" ]; then
            echo "âš ï¸  æœªåœ¨é…ç½®ä¸­æ‰¾åˆ°Luciè½¯ä»¶åŒ…"
            TOTAL_COUNT=0
          else
            echo "ğŸ“¦ é…ç½®ä¸­çš„Luciè½¯ä»¶åŒ…åˆ—è¡¨ï¼š"
            echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
            echo "â”‚ åºå· â”‚ è½¯ä»¶åŒ…åç§°                                      â”‚"
            echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
            index=1
            echo "$CONFIG_LUCI" | while read pkg; do
              if [ -n "$pkg" ]; then
                printf "â”‚ %4d â”‚ %-47s â”‚\n" "$index" "$pkg"
                index=$((index + 1))
              fi
            done
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
            TOTAL_COUNT=$(echo "$CONFIG_LUCI" | grep -c .)
          fi
          
          echo ""
          echo "ğŸ” å¼€å§‹æ£€æŸ¥è½¯ä»¶åŒ…å­˜åœ¨æ€§..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚ åºå· â”‚ è½¯ä»¶åŒ…åç§°                    â”‚ çŠ¶æ€     â”‚ ä½ç½®      â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          
          # æ£€æŸ¥æ¯ä¸ªåŒ…æ˜¯å¦å­˜åœ¨
          MISSING_COUNT=0
          FOUND_COUNT=0
          index=1
          
          for pkg in $CONFIG_LUCI; do
            if [ -n "$pkg" ]; then
              location=""
              if [ -d "package/$pkg" ]; then
                location="package/"
                status="âœ… å­˜åœ¨"
                FOUND_COUNT=$((FOUND_COUNT + 1))
              elif [ -d "feeds/packages/$pkg" ]; then
                location="feeds/packages/"
                status="âœ… å­˜åœ¨"
                FOUND_COUNT=$((FOUND_COUNT + 1))
              elif [ -d "feeds/luci/$pkg" ]; then
                location="feeds/luci/"
                status="âœ… å­˜åœ¨"
                FOUND_COUNT=$((FOUND_COUNT + 1))
              else
                location="æœªæ‰¾åˆ°"
                status="âŒ ç¼ºå¤±"
                MISSING_COUNT=$((MISSING_COUNT + 1))
              fi
              printf "â”‚ %4d â”‚ %-30s â”‚ %-8s â”‚ %-10s â”‚\n" "$index" "$pkg" "$status" "$location"
              index=$((index + 1))
            fi
          done
          
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“Š æ£€æŸ¥ç»“æœç»Ÿè®¡ï¼š"
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚    çŠ¶æ€     â”‚   æ•°é‡   â”‚  ç™¾åˆ†æ¯”  â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          if [ $TOTAL_COUNT -gt 0 ]; then
            FOUND_PERCENT=$((FOUND_COUNT * 100 / TOTAL_COUNT))
            MISSING_PERCENT=$((MISSING_COUNT * 100 / TOTAL_COUNT))
          else
            FOUND_PERCENT=0
            MISSING_PERCENT=0
          fi
          echo "â”‚ âœ… å­˜åœ¨     â”‚ $FOUND_COUNT  â”‚  $FOUND_PERCENT%  â”‚"
          echo "â”‚ âŒ ç¼ºå¤±     â”‚ $MISSING_COUNT  â”‚  $MISSING_PERCENT%  â”‚"
          echo "â”‚ ğŸ“¦ æ€»è®¡     â”‚ $TOTAL_COUNT  â”‚  100%   â”‚"
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          
          if [ $MISSING_COUNT -gt 0 ]; then
            echo ""
            echo "ğŸš¨ è­¦å‘Šï¼šå‘ç° $MISSING_COUNT ä¸ªç¼ºå¤±çš„Luciè½¯ä»¶åŒ…ï¼Œå¯èƒ½ä¼šå½±å“å›ºä»¶åŠŸèƒ½ï¼"
          else
            echo ""
            echo "ğŸ‰ æ­å–œï¼æ‰€æœ‰Luciè½¯ä»¶åŒ…æ£€æŸ¥é€šè¿‡ï¼"
          fi
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                      æ£€æŸ¥å®Œæˆ                             â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # ä¿å­˜åˆ°è¾“å‡º
          echo "missing_count=$MISSING_COUNT" >> $GITHUB_OUTPUT
          echo "found_count=$FOUND_COUNT" >> $GITHUB_OUTPUT
          echo "total_count=$TOTAL_COUNT" >> $GITHUB_OUTPUT
          
          # æ·»åŠ åˆ°Step Summary
          echo "# ğŸ” Luciè½¯ä»¶åŒ…æ£€æŸ¥æŠ¥å‘Š - Maxå˜ä½“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“Š ç»Ÿè®¡ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "| çŠ¶æ€ | æ•°é‡ | ç™¾åˆ†æ¯” | å›¾æ ‡ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|--------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… å­˜åœ¨ | $FOUND_COUNT | $FOUND_PERCENT% | ğŸŸ¢ |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ ç¼ºå¤± | $MISSING_COUNT | $MISSING_PERCENT% | ğŸ”´ |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“¦ æ€»è®¡ | $TOTAL_COUNT | 100% | ğŸ“¦ |" >> $GITHUB_STEP_SUMMARY
          
          if [ $MISSING_COUNT -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## âš ï¸ æ³¨æ„" >> $GITHUB_STEP_SUMMARY
            echo "å‘ç° $MISSING_COUNT ä¸ªç¼ºå¤±çš„Luciè½¯ä»¶åŒ…ï¼Œå¯èƒ½ä¼šå½±å“å›ºä»¶åŠŸèƒ½ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ğŸ‰ æ£€æŸ¥ç»“æœ" >> $GITHUB_STEP_SUMMARY
            echo "âœ… æ‰€æœ‰Luciè½¯ä»¶åŒ…æ£€æŸ¥é€šè¿‡ï¼Œå›ºä»¶å°†åŒ…å«æ‰€æœ‰é…ç½®çš„åŠŸèƒ½ã€‚" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ç¼–è¯‘Maxå›ºä»¶
        run: |
          cd /workdir/openwrt
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘Maxå˜ä½“"
          echo "ä½¿ç”¨ $(nproc) ä¸ªçº¿ç¨‹å¹¶è¡Œç¼–è¯‘"
          
          # å¤šé‡ç¼–è¯‘ç­–ç•¥
          make -j$(nproc) || make -j1 || make -j1 V=s
          
          echo "âœ… Maxç¼–è¯‘å®Œæˆ"

      - name: æ•´ç†Maxå›ºä»¶
        run: |
          cd /workdir/openwrt/bin/targets/*/*
          echo "ğŸ“¦ æ•´ç†Maxå›ºä»¶"
          
          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p $GITHUB_WORKSPACE/firmware/Max
          
          # å¤åˆ¶å›ºä»¶æ–‡ä»¶
          find . -name "*immortalwrt*" -type f ! -name "*manifest*" | \
            xargs -I {} cp {} $GITHUB_WORKSPACE/firmware/Max/
          
          # é‡å‘½åå›ºä»¶
          cd $GITHUB_WORKSPACE/firmware/Max
          for file in *; do
            if [ -f "$file" ]; then
              mv "$file" "Max-${{ needs.prepare.outputs.build_date }}-${file}"
            fi
          done
          
          echo "âœ… Maxå›ºä»¶æ•´ç†å®Œæˆ"
          ls -la

  # Proå˜ä½“ç¼–è¯‘
  build-pro:
    runs-on: ubuntu-22.04
    needs: [prepare, build-base, build-ultra]
    if: always() && needs.build-base.result == 'success' && needs.build-ultra.result == 'success'
    
    steps:
      - name: æ¢å¤ç¼–è¯‘ç¯å¢ƒ
        uses: actions/cache@v4
        with:
          path: |
            /workdir/openwrt
            ~/.cache/go-build
            ~/.cache/pip
          key: ${{ needs.prepare.outputs.cache_key_full }}
          restore-keys: |
            ${{ needs.prepare.outputs.cache_key_base }}-
            openwrt-base-
            openwrt-toolchain-${{ needs.prepare.outputs.toolchain_hash }}-
            openwrt-toolchain-

      - name: éªŒè¯æºç å®Œæ•´æ€§
        run: |
          if [ ! -f "/workdir/openwrt/Makefile" ]; then
            echo "âŒ æºç ç›®å½•ä¸å®Œæ•´ï¼Œå°è¯•æ¢å¤..."
            # å¦‚æœç¼“å­˜æœ‰é—®é¢˜ï¼Œé‡æ–°å…‹éš†
            cd /workdir
            rm -rf openwrt
            git clone ${{ needs.prepare.outputs.immwrt_repo }} -b ${{ needs.prepare.outputs.immwrt_branch }} openwrt
          fi
          echo "âœ… æºç ç›®å½•éªŒè¯é€šè¿‡"

      - name: ğŸš¨ å‡†å¤‡Proé…ç½®
        run: |
          cd /workdir/openwrt
          echo "âš™ï¸ åŠ è½½Proé…ç½®"
          make distclean
          [ -f "$GITHUB_WORKSPACE/configs/base_ipq60xx.config" ] && \
            cp "$GITHUB_WORKSPACE/configs/base_ipq60xx.config" .config
          [ -f "$GITHUB_WORKSPACE/configs/base_immwrt.config" ] && \
            cat "$GITHUB_WORKSPACE/configs/base_immwrt.config" >> .config
          [ -f "$GITHUB_WORKSPACE/configs/Pro.config" ] && \
            cat "$GITHUB_WORKSPACE/configs/Pro.config" >> .config
          make defconfig

      - name: ğŸ”ğŸ”ğŸ” Luciè½¯ä»¶åŒ…å®Œæ•´æ€§æ£€æŸ¥ - Proå˜ä½“ ğŸ”ğŸ”ğŸ”
        id: luci_check
        run: |
          cd /workdir/openwrt
          
          # è¾“å‡ºé†’ç›®çš„æ ‡é¢˜
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                    ğŸ” LUCIè½¯ä»¶åŒ…æ£€æŸ¥æŠ¥å‘Š ğŸ”                    â•‘"
          echo "â•‘                        Proå˜ä½“                            â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # è·å–é…ç½®ä¸­çš„æ‰€æœ‰LuciåŒ…
          echo "ğŸ“‹ æ­£åœ¨æ£€æŸ¥é…ç½®ä¸­çš„Luciè½¯ä»¶åŒ…..."
          CONFIG_LUCI=$(cat .config | grep "^CONFIG_PACKAGE_luci-" | cut -d'=' -f1 | sed 's/CONFIG_PACKAGE_//')
          
          if [ -z "$CONFIG_LUCI" ]; then
            echo "âš ï¸  æœªåœ¨é…ç½®ä¸­æ‰¾åˆ°Luciè½¯ä»¶åŒ…"
            TOTAL_COUNT=0
          else
            echo "ğŸ“¦ é…ç½®ä¸­çš„Luciè½¯ä»¶åŒ…åˆ—è¡¨ï¼š"
            echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
            echo "â”‚ åºå· â”‚ è½¯ä»¶åŒ…åç§°                                      â”‚"
            echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
            index=1
            echo "$CONFIG_LUCI" | while read pkg; do
              if [ -n "$pkg" ]; then
                printf "â”‚ %4d â”‚ %-47s â”‚\n" "$index" "$pkg"
                index=$((index + 1))
              fi
            done
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
            TOTAL_COUNT=$(echo "$CONFIG_LUCI" | grep -c .)
          fi
          
          echo ""
          echo "ğŸ” å¼€å§‹æ£€æŸ¥è½¯ä»¶åŒ…å­˜åœ¨æ€§..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚ åºå· â”‚ è½¯ä»¶åŒ…åç§°                    â”‚ çŠ¶æ€     â”‚ ä½ç½®      â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          
          # æ£€æŸ¥æ¯ä¸ªåŒ…æ˜¯å¦å­˜åœ¨
          MISSING_COUNT=0
          FOUND_COUNT=0
          index=1
          
          for pkg in $CONFIG_LUCI; do
            if [ -n "$pkg" ]; then
              location=""
              if [ -d "package/$pkg" ]; then
                location="package/"
                status="âœ… å­˜åœ¨"
                FOUND_COUNT=$((FOUND_COUNT + 1))
              elif [ -d "feeds/packages/$pkg" ]; then
                location="feeds/packages/"
                status="âœ… å­˜åœ¨"
                FOUND_COUNT=$((FOUND_COUNT + 1))
              elif [ -d "feeds/luci/$pkg" ]; then
                location="feeds/luci/"
                status="âœ… å­˜åœ¨"
                FOUND_COUNT=$((FOUND_COUNT + 1))
              else
                location="æœªæ‰¾åˆ°"
                status="âŒ ç¼ºå¤±"
                MISSING_COUNT=$((MISSING_COUNT + 1))
              fi
              printf "â”‚ %4d â”‚ %-30s â”‚ %-8s â”‚ %-10s â”‚\n" "$index" "$pkg" "$status" "$location"
              index=$((index + 1))
            fi
          done
          
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“Š æ£€æŸ¥ç»“æœç»Ÿè®¡ï¼š"
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚    çŠ¶æ€     â”‚   æ•°é‡   â”‚  ç™¾åˆ†æ¯”  â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          if [ $TOTAL_COUNT -gt 0 ]; then
            FOUND_PERCENT=$((FOUND_COUNT * 100 / TOTAL_COUNT))
            MISSING_PERCENT=$((MISSING_COUNT * 100 / TOTAL_COUNT))
          else
            FOUND_PERCENT=0
            MISSING_PERCENT=0
          fi
          echo "â”‚ âœ… å­˜åœ¨     â”‚ $FOUND_COUNT  â”‚  $FOUND_PERCENT%  â”‚"
          echo "â”‚ âŒ ç¼ºå¤±     â”‚ $MISSING_COUNT  â”‚  $MISSING_PERCENT%  â”‚"
          echo "â”‚ ğŸ“¦ æ€»è®¡     â”‚ $TOTAL_COUNT  â”‚  100%   â”‚"
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          
          if [ $MISSING_COUNT -gt 0 ]; then
            echo ""
            echo "ğŸš¨ è­¦å‘Šï¼šå‘ç° $MISSING_COUNT ä¸ªç¼ºå¤±çš„Luciè½¯ä»¶åŒ…ï¼Œå¯èƒ½ä¼šå½±å“å›ºä»¶åŠŸèƒ½ï¼"
          else
            echo ""
            echo "ğŸ‰ æ­å–œï¼æ‰€æœ‰Luciè½¯ä»¶åŒ…æ£€æŸ¥é€šè¿‡ï¼"
          fi
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                      æ£€æŸ¥å®Œæˆ                             â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # ä¿å­˜åˆ°è¾“å‡º
          echo "missing_count=$MISSING_COUNT" >> $GITHUB_OUTPUT
          echo "found_count=$FOUND_COUNT" >> $GITHUB_OUTPUT
          echo "total_count=$TOTAL_COUNT" >> $GITHUB_OUTPUT
          
          # æ·»åŠ åˆ°Step Summary
          echo "# ğŸ” Luciè½¯ä»¶åŒ…æ£€æŸ¥æŠ¥å‘Š - Proå˜ä½“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“Š ç»Ÿè®¡ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "| çŠ¶æ€ | æ•°é‡ | ç™¾åˆ†æ¯” | å›¾æ ‡ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|--------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… å­˜åœ¨ | $FOUND_COUNT | $FOUND_PERCENT% | ğŸŸ¢ |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ ç¼ºå¤± | $MISSING_COUNT | $MISSING_PERCENT% | ğŸ”´ |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“¦ æ€»è®¡ | $TOTAL_COUNT | 100% | ğŸ“¦ |" >> $GITHUB_STEP_SUMMARY
          
          if [ $MISSING_COUNT -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## âš ï¸ æ³¨æ„" >> $GITHUB_STEP_SUMMARY
            echo "å‘ç° $MISSING_COUNT ä¸ªç¼ºå¤±çš„Luciè½¯ä»¶åŒ…ï¼Œå¯èƒ½ä¼šå½±å“å›ºä»¶åŠŸèƒ½ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ğŸ‰ æ£€æŸ¥ç»“æœ" >> $GITHUB_STEP_SUMMARY
            echo "âœ… æ‰€æœ‰Luciè½¯ä»¶åŒ…æ£€æŸ¥é€šè¿‡ï¼Œå›ºä»¶å°†åŒ…å«æ‰€æœ‰é…ç½®çš„åŠŸèƒ½ã€‚" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ç¼–è¯‘Proå›ºä»¶
        run: |
          cd /workdir/openwrt
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘Proå˜ä½“"
          echo "ä½¿ç”¨ $(nproc) ä¸ªçº¿ç¨‹å¹¶è¡Œç¼–è¯‘"
          
          # å¤šé‡ç¼–è¯‘ç­–ç•¥
          make -j$(nproc) || make -j1 || make -j1 V=s
          
          echo "âœ… Proç¼–è¯‘å®Œæˆ"

      - name: æ•´ç†Proå›ºä»¶
        run: |
          cd /workdir/openwrt/bin/targets/*/*
          echo "ğŸ“¦ æ•´ç†Proå›ºä»¶"
          
          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p $GITHUB_WORKSPACE/firmware/Pro
          
          # å¤åˆ¶å›ºä»¶æ–‡ä»¶
          find . -name "*immortalwrt*" -type f ! -name "*manifest*" | \
            xargs -I {} cp {} $GITHUB_WORKSPACE/firmware/Pro/
          
          # é‡å‘½åå›ºä»¶
          cd $GITHUB_WORKSPACE/firmware/Pro
          for file in *; do
            if [ -f "$file" ]; then
              mv "$file" "Pro-${{ needs.prepare.outputs.build_date }}-${file}"
            fi
          done
          
          echo "âœ… Proå›ºä»¶æ•´ç†å®Œæˆ"
          ls -la

  # å‘å¸ƒé˜¶æ®µ
  release:
    runs-on: ubuntu-22.04
    needs: [prepare, build-ultra, build-max, build-pro]
    if: always() && (needs.build-ultra.result == 'success' || needs.build-max.result == 'success' || needs.build-pro.result == 'success')
    
    steps:
      - name: æ•´ç†æ‰€æœ‰å›ºä»¶
        run: |
          mkdir -p $GITHUB_WORKSPACE/release
          
          # å¤åˆ¶æ‰€æœ‰å˜ä½“å›ºä»¶
          for variant in Ultra Max Pro; do
            if [ -d "firmware/$variant" ]; then
              echo "ğŸ“¦ å¤åˆ¶$variantå›ºä»¶"
              cp -r firmware/$variant/* release/
            fi
          done
          
          # ç”Ÿæˆå›ºä»¶ä¿¡æ¯æ–‡ä»¶
          cd $GITHUB_WORKSPACE/release
          cat > firmware_info.md << 'EOF'
          # OpenWrt IPQ60x2 å›ºä»¶å‘å¸ƒ
          
          ## ğŸ“‹ å›ºä»¶ä¿¡æ¯
          - **æ„å»ºæ—¶é—´**: ${BUILD_DATE}
          - **æºç åˆ†æ”¯**: ${REPO_BRANCH}
          - **æºç ä»“åº“**: ${IMMWRT_REPO}
          - **é…ç½®å“ˆå¸Œ**: ${CONFIG_HASH}
          - **ç¼“å­˜å‘½ä¸­**: ${CACHE_HIT}
          
          ## ğŸ”§ å›ºä»¶è®¾ç½®
          - **IPåœ°å€**: ${FIRMWARE_IP}
          - **æœºå™¨å**: ${FIRMWARE_NAME}
          - **å¯†ç **: ç©ºå¯†ç 
          - **ç™»å½•æ–¹å¼**: SSHæˆ–Webç•Œé¢
          
          ## ğŸ“¦ å˜ä½“è¯´æ˜
          - **Ultra**: å®Œæ•´åŠŸèƒ½ç‰ˆæœ¬ï¼ŒåŒ…å«æ‰€æœ‰å¯ç”¨æ’ä»¶å’ŒåŠŸèƒ½
          - **Max**: åŠŸèƒ½å¢å¼ºç‰ˆæœ¬ï¼Œå¹³è¡¡æ€§èƒ½å’ŒåŠŸèƒ½
          - **Pro**: ä¸“ä¸šä¼˜åŒ–ç‰ˆæœ¬ï¼Œç²¾ç®€ä¼˜åŒ–ï¼Œé€‚åˆé«˜çº§ç”¨æˆ·
          
          ## ğŸš€ ä½¿ç”¨è¯´æ˜
          1. ä¸‹è½½å¯¹åº”å˜ä½“çš„å›ºä»¶æ–‡ä»¶
          2. é€šè¿‡è·¯ç”±å™¨åå°æˆ–TFTPæ–¹å¼åˆ·å…¥
          3. åˆ·å…¥åè®¿é—® ${FIRMWARE_IP}
          4. ç”¨æˆ·å: rootï¼Œå¯†ç : ç©º
          
          ## âš ï¸ æ³¨æ„äº‹é¡¹
          - é¦–æ¬¡åˆ·æœºå»ºè®®ä½¿ç”¨U-Bootåˆ·æœº
          - å¤‡ä»½åŸå‚å›ºä»¶ä»¥é˜²ä¸‡ä¸€
          - åˆ·æœºå‰è¯·ç¡®è®¤è®¾å¤‡å‹å·
          
          ---
          æ„å»ºç³»ç»Ÿ: GitHub Actions
          æ„å»ºä»»åŠ¡: ${RUN_ID}
          EOF
          
          # æ›¿æ¢å˜é‡
          sed -i "s/\${BUILD_DATE}/${{ needs.prepare.outputs.build_date }}/g" firmware_info.md
          sed -i "s/\${REPO_BRANCH}/${{ needs.prepare.outputs.immwrt_branch }}/g" firmware_info.md
          sed -i "s#\${IMMWRT_REPO}#${{ needs.prepare.outputs.immwrt_repo }}#g" firmware_info.md
          sed -i "s/\${CONFIG_HASH}/${{ needs.prepare.outputs.config_hash }}/g" firmware_info.md
          sed -i "s/\${CACHE_HIT}/${{ needs.build-base.outputs.cache-hit }}/g" firmware_info.md
          sed -i "s/\${FIRMWARE_IP}/${{ env.FIRMWARE_IP }}/g" firmware_info.md
          sed -i "s/\${FIRMWARE_NAME}/${{ env.FIRMWARE_NAME }}/g" firmware_info.md
          sed -i "s/\${RUN_ID}/${{ github.run_id }}/g" firmware_info.md
          
          echo "âœ… å›ºä»¶æ•´ç†å®Œæˆ"
          ls -la

      - name: ç”Ÿæˆæ ¡éªŒå’Œ
        run: |
          cd $GITHUB_WORKSPACE/release
          echo "ğŸ” ç”Ÿæˆæ–‡ä»¶æ ¡éªŒå’Œ"
          sha256sum * > sha256sums.txt
          md5sum * > md5sums.txt
          echo "âœ… æ ¡éªŒå’Œç”Ÿæˆå®Œæˆ"

      - name: åˆ›å»ºRelease
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.release_tag }}
          name: "OpenWrt IPQ60x2 ${{ needs.prepare.outputs.build_date }}"
          body_path: release/firmware_info.md
          files: |
            release/*
            !release/firmware_info.md
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ä¸Šä¼ æ„å»ºæ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ needs.prepare.outputs.build_date }}
          path: |
            /workdir/openwrt/logs/
            /workdir/openwrt/.config
          retention-days: 30

      - name: æ„å»ºç»“æœæ±‡æ€»
        if: always()
        run: |
          echo "## ğŸ“Š æ„å»ºç»“æœæ±‡æ€»" >> $GITHUB_STEP_SUMMARY
          echo "| å˜ä½“ | çŠ¶æ€ | å›ºä»¶æ•°é‡ | ç¼“å­˜å‘½ä¸­ | Luciæ£€æŸ¥ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|----------|----------|----------|" >> $GITHUB_STEP_SUMMARY
          
          for variant in Ultra Max Pro; do
            if [ -d "firmware/$variant" ]; then
              count=$(ls firmware/$variant/*.bin 2>/dev/null | wc -l)
              status="âœ… æˆåŠŸ"
            else
              count=0
              status="âŒ å¤±è´¥"
            fi
            echo "| $variant | $status | $count | ${{ needs.build-base.outputs.cache-hit }} | âœ… å·²æ£€æŸ¥ |" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“ˆ æ„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **Releaseæ ‡ç­¾**: ${{ needs.prepare.outputs.release_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ„å»ºæ—¥æœŸ**: ${{ needs.prepare.outputs.build_date }}" >> $GITHUB_STEP_SUMMARY
          echo "- **é…ç½®å“ˆå¸Œ**: ${{ needs.prepare.outputs.config_hash }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å·¥å…·é“¾å“ˆå¸Œ**: ${{ needs.prepare.outputs.toolchain_hash }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç¼“å­˜å‘½ä¸­**: ${{ needs.build-base.outputs.cache-hit }}" >> $GITHUB_STEP_SUMMARY
          
          # ä¸‹è½½é“¾æ¥
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## â¬‡ï¸ ä¸‹è½½é“¾æ¥" >> $GITHUB_STEP_SUMMARY
          echo "[æŸ¥çœ‹æ‰€æœ‰å›ºä»¶](https://github.com/${{ github.repository }}/releases/tag/${{ needs.prepare.outputs.release_tag }})" >> $GITHUB_STEP_SUMMARY
