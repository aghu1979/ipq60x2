# .github/workflows/build.yml
# =============================================================================
# ImmortalWrt 自动编译工作流
# 版本: 1.0.7
# 更新日期: 2025-11-19
# =============================================================================

name: ImmortalWrt Build Workflow

on:
  workflow_dispatch:
    inputs:
      build_variant:
        description: '选择要编译的变体'
        required: true
        default: 'Ultra'
        type: choice
        options:
        - Ultra
        - Max
        - Pro
      firmware_version:
        description: '固件版本号 (例如: 2025.11.19)'
        required: true
        default: '2025.11.19'
        type: string
      release_tag:
        description: '发布标签 (例如: v2025.11.19)'
        required: true
        default: 'v2025.11.19'
        type: string

env:
  REPO_URL: https://github.com/laipeng668/immortalwrt.git
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  DIY_P1_SH: scripts/diy.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_COWTRANSFER: false
  UPLOAD_WETRANSFER: false
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai
  FIRMWARE_VERSION: ${{ github.event.inputs.firmware_version }}
  RELEASE_TAG: ${{ github.event.inputs.release_tag }}
  BUILD_VARIANT: ${{ github.event.inputs.build_variant }}
  DEVICE_INFO: devices.json
  LUCI_REPORT: luci_report.txt

jobs:
  setup:
    runs-on: ubuntu-24.04
    outputs:
      devices: ${{ steps.extract-devices.outputs.devices }}
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 初始化编译环境
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-2404)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: 下载配置文件
        run: |
          mkdir -p configs
          wget -O configs/base_ipq60xx.config https://github.com/aghu1979/ipq60x2/blob/main/configs/base_ipq60xx.config
          wget -O configs/base_immwrt.config https://github.com/aghu1979/ipq60x2/blob/main/configs/base_immwrt.config
          wget -O configs/Max.config https://github.com/aghu1979/ipq60x2/blob/main/configs/Max.config
          wget -O configs/Pro.config https://github.com/aghu1979/ipq60x2/blob/main/configs/Pro.config
          wget -O configs/Ultra.config https://github.com/aghu1979/ipq60x2/blob/main/configs/Ultra.config
          wget -O scripts/diy.sh https://github.com/aghu1979/ipq60x2/blob/main/scripts/diy.sh

      - name: 提取设备信息
        id: extract-devices
        run: |
          chmod +x scripts/extract-devices.sh
          devices_json=$(bash scripts/extract-devices.sh configs/base_ipq60xx.config)
          echo "devices=$devices_json" >> $GITHUB_OUTPUT
          echo "检测到的设备信息:"
          echo "$devices_json" | jq -C .
          echo "$devices_json" > $DEVICE_INFO

      - name: 生成缓存键
        id: cache-key
        run: |
          config_hash=$(cat configs/*.config | sha256sum | cut -d' ' -f1)
          key="immwrt-${{ env.FIRMWARE_VERSION }}-${config_hash}"
          echo "key=$key" >> $GITHUB_OUTPUT
          echo "生成的缓存键: $key"

  build:
    needs: setup
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        variant: [Ultra, Max, Pro]
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 扩展磁盘空间
        run: |
          chmod +x scripts/extend-disk.sh
          bash scripts/extend-disk.sh

      - name: 初始化编译环境
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-2404)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: 克隆源码
        working-directory: /workdir
        run: |
          df -hT $PWD
          git clone $REPO_URL -b $REPO_BRANCH immortalwrt
          ln -sf /workdir/immortalwrt $GITHUB_WORKSPACE/immortalwrt

      - name: 加载缓存
        uses: actions/cache@v4
        if: matrix.variant == 'Ultra'
        with:
          path: /workdir/immortalwrt
          key: ${{ needs.setup.outputs.cache-key }}-Ultra

      - name: 合并配置文件
        run: |
          chmod +x scripts/merge-configs.sh
          bash scripts/merge-configs.sh configs/base_ipq60xx.config configs/base_immwrt.config configs/${{ matrix.variant }}.config /workdir/immortalwrt/.config

      - name: 更新和安装Feeds
        run: |
          cd /workdir/immortalwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: 生成Luci软件包报告
        run: |
          chmod +x scripts/luci-report.sh
          bash scripts/luci-report.sh /workdir/immortalwrt ${{ matrix.variant }}

      - name: 上传Luci报告
        uses: actions/upload-artifact@v4
        with:
          name: luci-report-${{ matrix.variant }}
          path: ${{ env.LUCI_REPORT }}

      - name: 执行自定义DIY脚本
        run: |
          [ -e files ] && mv files /workdir/immortalwrt/files
          [ -e $DIY_P1_SH ] && cp $DIY_P1_SH /workdir/immortalwrt
          chmod +x /workdir/immortalwrt/$DIY_P1_SH
          cd /workdir/immortalwrt
          ./$DIY_P1_SH

      - name: 下载软件包
        id: package
        run: |
          cd /workdir/immortalwrt
          make defconfig
          make download -j$(nproc)
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: 编译固件
        id: compile
        run: |
          cd /workdir/immortalwrt
          echo -e "$(nproc) 线程编译"
          make -j$(nproc) || make -j1 || make -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT
          grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
          [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
          echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

      - name: 检查磁盘空间
        if: (!cancelled())
        run: df -hT

      - name: 上传固件工件
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-firmware-${{ matrix.variant }}${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: /workdir/immortalwrt/bin/targets/

      - name: 保存缓存
        uses: actions/cache@v4
        if: matrix.variant == 'Ultra' && steps.compile.outputs.status == 'success'
        with:
          path: /workdir/immortalwrt
          key: ${{ needs.setup.outputs.cache-key }}-Ultra

  release:
    needs: [setup, build]
    runs-on: ubuntu-24.04
    if: github.event.inputs.build_variant == 'Ultra' && github.event.inputs.release_tag != ''
    steps:
      - name: 下载所有固件工件
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: 整理发布文件
        run: |
          mkdir -p release
          find artifacts -name "*.img" -o -name "*.bin" -o -name "*.tar.gz" | xargs -I {} cp {} release/
          ls -la release/

      - name: 生成发布说明
        run: |
          cat > release_notes.md << EOF
          # ImmortalWrt 固件发布
          
          ## 版本信息
          - 固件版本: ${{ env.FIRMWARE_VERSION }}
          - 编译日期: $(date +"%Y-%m-%d %H:%M:%S")
          - 源码分支: ${{ env.REPO_BRANCH }}
          
          ## 变体配置
          - **Ultra**: 包含所有功能，适合高级用户
          - **Max**: 包含大部分常用功能
          - **Pro**: 精简版本，只包含基本功能
          
          ## 设备支持
          $(cat $DEVICE_INFO | jq -r '.[] | "- " + .name')
          
          ## Luci软件包报告
          \`\`\`
          $(cat $LUCI_REPORT)
          \`\`\`
          
          ## 使用说明
          1. 下载对应设备的固件文件
          2. 通过设备恢复界面或系统升级界面刷入固件
          3. 刷入后恢复出厂设置
          
          ## 注意事项
          - 刷机有风险，请谨慎操作
          - 建议刷机前备份原厂固件
          - 如遇问题，请到项目主页提交Issue
          EOF

      - name: 创建GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          body_path: release_notes.md
          files: release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
