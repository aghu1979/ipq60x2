name: OpenWrt IPQ60x2 ä¼ä¸šçº§å›ºä»¶ç¼–è¯‘ç³»ç»Ÿ

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Releaseæ ‡ç­¾ (ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ)'
        required: false
        type: string
      force_rebuild:
        description: 'å¼ºåˆ¶é‡æ–°æž„å»º'
        required: false
        type: boolean
        default: false
  push:
    branches: [ main, master ]
    paths:
      - 'configs/**'
      - 'scripts/**'
      - '.github/workflows/build.yml'
  schedule:
    - cron: '0 2 * * 1'  # æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹è‡ªåŠ¨ç¼–è¯‘

env:
  TZ: Asia/Shanghai
  FIRMWARE_IP: 192.168.111.1
  FIRMWARE_NAME: WRT
  FIRMWARE_PASSWORD: ''

jobs:
  # å‡†å¤‡é˜¶æ®µï¼šèŽ·å–é…ç½®å’Œä¾èµ–
  prepare:
    runs-on: ubuntu-22.04
    outputs:
      immwrt_repo: ${{ steps.parse_config.outputs.immwrt_repo }}
      immwrt_branch: ${{ steps.parse_config.outputs.immwrt_branch }}
      build_date: ${{ steps.date.outputs.date }}
      release_tag: ${{ steps.tag.outputs.tag }}
      cache_key_base: ${{ steps.cache_key.outputs.base_key }}
      cache_key_ultra: ${{ steps.cache_key.outputs.ultra_key }}
      config_hash: ${{ steps.config_hash.outputs.hash }}
      toolchain_hash: ${{ steps.config_hash.outputs.toolchain_hash }}
      cache_date_mark: ${{ steps.cache_key.outputs.date_mark }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: å®‰è£…ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: è§£æžé…ç½®æ–‡ä»¶
        id: parse_config
        run: |
          # ä»Žrepos.jsonèŽ·å–immwrtä»“åº“åœ°å€
          if [ -f "configs/repos.json" ]; then
            # æ£€æŸ¥JSONæ ¼å¼
            if ! jq empty configs/repos.json; then
              echo "âŒ repos.jsonæ ¼å¼é”™è¯¯"
              exit 1
            fi
            
            # èŽ·å–immwrtä»“åº“åœ°å€ - å¤„ç†å¯¹è±¡æ ¼å¼
            REPO=$(jq -r '.immwrt.url' configs/repos.json 2>/dev/null)
            BRANCH=$(jq -r '.immwrt.branch' configs/repos.json 2>/dev/null)
            
            if [ "$REPO" = "null" ] || [ -z "$REPO" ]; then
              echo "âŒ æ— æ³•ä»Žrepos.jsonä¸­èŽ·å–immwrt.url"
              exit 1
            fi
            
            if [ "$BRANCH" = "null" ] || [ -z "$BRANCH" ]; then
              BRANCH="master"
            fi
            
            # æ¸…ç†å¯èƒ½çš„ç©ºç™½å­—ç¬¦
            REPO=$(echo "$REPO" | xargs)
            BRANCH=$(echo "$BRANCH" | xargs)
            
            # éªŒè¯URLæ ¼å¼
            if [[ ! "$REPO" =~ ^https?:// ]]; then
              echo "âŒ ä»“åº“åœ°å€æ ¼å¼æ— æ•ˆ: $REPO"
              exit 1
            fi
            
            echo "immwrt_repo=$REPO" >> $GITHUB_OUTPUT
            echo "immwrt_branch=$BRANCH" >> $GITHUB_OUTPUT
            echo "âœ… èŽ·å–åˆ°immwrtä»“åº“: $REPO"
            echo "âœ… èŽ·å–åˆ°åˆ†æ”¯: $BRANCH"
          else
            echo "âŒ æœªæ‰¾åˆ°repos.jsonæ–‡ä»¶"
            exit 1
          fi

      - name: è®¡ç®—é…ç½®æ–‡ä»¶å“ˆå¸Œ
        id: config_hash
        run: |
          # è®¡ç®—æ‰€æœ‰é…ç½®æ–‡ä»¶çš„å“ˆå¸Œï¼ˆåŒ…å«Ultraé…ç½®ï¼‰
          CONFIG_HASH=$(find configs/ -type f -name "*.config" -exec cat {} \; | md5sum | cut -d' ' -f1)
          # è®¡ç®—å·¥å…·é“¾å“ˆå¸Œï¼ˆåŸºäºŽåŸºç¡€é…ç½®ï¼‰
          TOOLCHAIN_HASH=$(cat configs/base_ipq60xx.config configs/base_immwrt.config configs/Ultra.config 2>/dev/null | md5sum | cut -d' ' -f1)
          
          echo "hash=$CONFIG_HASH" >> $GITHUB_OUTPUT
          echo "toolchain_hash=$TOOLCHAIN_HASH" >> $GITHUB_OUTPUT
          echo "ðŸ“ å®Œæ•´é…ç½®å“ˆå¸Œ: $CONFIG_HASH"
          echo "ðŸ”¨ Ultraå·¥å…·é“¾å“ˆå¸Œ: $TOOLCHAIN_HASH"

      - name: ç”Ÿæˆæž„å»ºæ—¥æœŸ
        id: date
        run: |
          DATE=$(date +"%Y.%m.%d-%H%M")
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "ðŸ“… æž„å»ºæ—¥æœŸ: $DATE"

      - name: ç”ŸæˆReleaseæ ‡ç­¾
        id: tag
        run: |
          if [ -n "${{ github.event.inputs.release_tag }}" ]; then
            TAG="${{ github.event.inputs.release_tag }}"
          else
            TAG="AutoBuild-$(git rev-parse --short HEAD)"
          fi
          # ç¡®ä¿æ ‡ç­¾æ ¼å¼æ­£ç¡®
          TAG=$(echo "$TAG" | sed 's/[^a-zA-Z0-9._-]//g')
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "ðŸ·ï¸ Releaseæ ‡ç­¾: $TAG"

      - name: ç”Ÿæˆä¼˜åŒ–çš„ç¼“å­˜é”®
        id: cache_key
        run: |
          # æ·»åŠ æ—¥æœŸæ ‡è®°ï¼Œç¡®ä¿ç¼“å­˜ä¸ä¼šæ— é™å¢žé•¿ï¼ˆæ¯æœˆä¸€ä¸ªç¼“å­˜ï¼‰
          DATE_MARK=$(date +%Y%m)
          
          # åŸºç¡€ç¼“å­˜é”®ï¼ˆåŸºäºŽå®Œæ•´é…ç½®å“ˆå¸Œï¼‰
          BASE_KEY="openwrt-base-${{ steps.config_hash.outputs.hash }}-${DATE_MARK}"
          # Ultraå®Œæ•´çŽ¯å¢ƒç¼“å­˜é”®ï¼ˆåŒ…å«å·¥å…·é“¾å’Œä¸‹è½½ï¼‰
          ULTRA_KEY="openwrt-ultra-${{ steps.config_hash.outputs.toolchain_hash }}-${DATE_MARK}"
          
          # æ¸…ç†ç‰¹æ®Šå­—ç¬¦
          BASE_KEY=$(echo "$BASE_KEY" | tr -d '\n\r')
          ULTRA_KEY=$(echo "$ULTRA_KEY" | tr -d '\n\r')
          
          echo "base_key=$BASE_KEY" >> $GITHUB_OUTPUT
          echo "ultra_key=$ULTRA_KEY" >> $GITHUB_OUTPUT
          echo "date_mark=$DATE_MARK" >> $GITHUB_OUTPUT
          
          echo "ðŸ”‘ åŸºç¡€ç¼“å­˜é”®: $BASE_KEY"
          echo "ðŸ”‘ UltraçŽ¯å¢ƒç¼“å­˜é”®: $ULTRA_KEY"
          echo "ðŸ“… ç¼“å­˜æ—¥æœŸæ ‡è®°: $DATE_MARK"

  # åŸºç¡€çŽ¯å¢ƒæž„å»º + Ultraå®Œæ•´ç¼–è¯‘
  build-base-ultra:
    runs-on: ubuntu-22.04
    needs: prepare
    outputs:
      cache_hit: ${{ steps.cache.outputs.cache-hit }}
      build_success: ${{ steps.compile.outcome }}
    
    steps:
      - name: ðŸ§¹ å½»åº•æ¸…ç†ç³»ç»ŸçŽ¯å¢ƒ
        run: |
          echo "ðŸ§¹ å¼€å§‹å½»åº•æ¸…ç†ç³»ç»ŸçŽ¯å¢ƒ..."
          
          # æ¸…ç†ç³»ç»ŸåŒ…
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-2204)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          
          # é¢å¤–æ¸…ç†ä¸å¿…è¦çš„ç³»ç»Ÿç»„ä»¶
          sudo rm -rf /usr/share/doc /usr/share/man /usr/share/locale /usr/share/i18n
          sudo apt-get purge -y azure-cli ghc* zulu* libllvm* dotnet* || true
          sudo apt-get autoremove -y
          
          # æ¸…ç†Dockerå’Œå®¹å™¨ç›¸å…³ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
          sudo docker system prune -af || true
          sudo rm -rf /var/lib/docker || true
          
          # æ¸…ç†æ—¥å¿—æ–‡ä»¶
          sudo journalctl --vacuum-time=1d || true
          sudo find /var/log -type f -name "*.log" -exec truncate -s 0 {} \; || true
          
          # æ¸…ç†npmç¼“å­˜
          npm cache clean --force 2>/dev/null || true
          
          # æ¸…ç†pipç¼“å­˜
          pip cache purge 2>/dev/null || true
          
          # æ¸…ç†Goç¼“å­˜
          go clean -modcache 2>/dev/null || true
          
          # æ¸…ç†æ—§çš„æ—¥å¿—
          sudo find /var/log -type f -name "*.log.*" -delete 2>/dev/null || true
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          sudo find /tmp -type f -atime +1 -delete 2>/dev/null || true
          
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir
          
          echo "âœ… ç³»ç»ŸçŽ¯å¢ƒæ¸…ç†å®Œæˆ"
          df -h

      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: éªŒè¯ä»“åº“åœ°å€
        run: |
          REPO="${{ needs.prepare.outputs.immwrt_repo }}"
          echo "ðŸ“¥ éªŒè¯ä»“åº“åœ°å€: $REPO"
          # éªŒè¯ä»“åº“æ˜¯å¦å¯è®¿é—®
          if ! git ls-remote "$REPO" > /dev/null 2>&1; then
            echo "âŒ ä»“åº“åœ°å€ä¸å¯è®¿é—®: $REPO"
            exit 1
          fi
          echo "âœ… ä»“åº“åœ°å€éªŒè¯é€šè¿‡"

      - name: ðŸ“¦ Ultraå®Œæ•´çŽ¯å¢ƒç¼“å­˜ç­–ç•¥
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            /workdir/openwrt
            ~/.cache/go-build
            ~/.cache/pip
          key: ${{ needs.prepare.outputs.cache_key_ultra }}
          restore-keys: |
            openwrt-ultra-${{ needs.prepare.outputs.toolchain_hash }}-
            openwrt-base-${{ needs.prepare.outputs.config_hash }}-
            openwrt-ultra-
            openwrt-base-

      - name: ðŸ’¾ ç›‘æŽ§ç£ç›˜ä½¿ç”¨æƒ…å†µ
        run: |
          echo "ðŸ’¾ å½“å‰ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
          df -h
          
          # æ£€æŸ¥æ ¹åˆ†åŒºä½¿ç”¨çŽ‡
          ROOT_USAGE=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
          echo "ðŸ“Š æ ¹åˆ†åŒºä½¿ç”¨çŽ‡: ${ROOT_USAGE}%"
          
          # å¦‚æžœä½¿ç”¨çŽ‡è¶…è¿‡70%ï¼Œæ‰§è¡Œç´§æ€¥æ¸…ç†
          if [ "$ROOT_USAGE" -gt 70 ]; then
            echo "âš ï¸ ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œæ‰§è¡Œç´§æ€¥æ¸…ç†"
            
            # æ¸…ç†æ›´å¤šç¼“å­˜
            sudo rm -rf /usr/local/share/boost 2>/dev/null || true
            sudo rm -rf /usr/local/share/.cache 2>/dev/null || true
            
            echo "âœ… ç´§æ€¥æ¸…ç†å®Œæˆ"
            df -h
          fi

      - name: æ£€æŸ¥ç¼“å­˜çŠ¶æ€å¹¶å‡†å¤‡æºç ç›®å½•
        run: |
          echo "ðŸ” ç¼“å­˜çŠ¶æ€: ${{ steps.cache.outputs.cache-hit }}"
          
          if [ "${{ steps.cache.outputs.cache-hit }}" = "true" ]; then
            echo "âœ… UltraçŽ¯å¢ƒç¼“å­˜å‘½ä¸­ï¼Œæ£€æŸ¥æºç ç›®å½•..."
            if [ -d "/workdir/openwrt" ]; then
              echo "ðŸ“ UltraçŽ¯å¢ƒç›®å½•å·²å­˜åœ¨"
              if [ -f "/workdir/openwrt/Makefile" ]; then
                echo "âœ… UltraçŽ¯å¢ƒå®Œæ•´ï¼Œè·³è¿‡åŸºç¡€æž„å»º"
                # æ£€æŸ¥æ˜¯å¦æœ‰Ultraå›ºä»¶
                if [ -d "/workdir/openwrt/bin/targets" ]; then
                  echo "âœ… å‘çŽ°å·²ç¼–è¯‘çš„å›ºä»¶ï¼ŒçŽ¯å¢ƒå®Œå…¨å¯ç”¨"
                else
                  echo "âš ï¸ çŽ¯å¢ƒå­˜åœ¨ä½†æœªç¼–è¯‘å›ºä»¶ï¼Œéœ€è¦é‡æ–°ç¼–è¯‘"
                fi
              else
                echo "âš ï¸ UltraçŽ¯å¢ƒä¸å®Œæ•´ï¼Œæ¸…ç†åŽé‡æ–°æž„å»º"
                rm -rf /workdir/openwrt
                echo "ðŸ“¥ å…‹éš†æºç ä»Ž: ${{ needs.prepare.outputs.immwrt_repo }}"
                echo "ðŸ“¥ ä½¿ç”¨åˆ†æ”¯: ${{ needs.prepare.outputs.immwrt_branch }}"
                cd /workdir
                git clone ${{ needs.prepare.outputs.immwrt_repo }} -b ${{ needs.prepare.outputs.immwrt_branch }} openwrt
              fi
            else
              echo "âš ï¸ UltraçŽ¯å¢ƒç›®å½•ä¸å­˜åœ¨ï¼Œé‡æ–°æž„å»º"
              echo "ðŸ“¥ å…‹éš†æºç ä»Ž: ${{ needs.prepare.outputs.immwrt_repo }}"
              echo "ðŸ“¥ ä½¿ç”¨åˆ†æ”¯: ${{ needs.prepare.outputs.immwrt_branch }}"
              cd /workdir
              git clone ${{ needs.prepare.outputs.immwrt_repo }} -b ${{ needs.prepare.outputs.immwrt_branch }} openwrt
            fi
          else
            echo "âŒ UltraçŽ¯å¢ƒç¼“å­˜æœªå‘½ä¸­ï¼Œæ‰§è¡Œå®Œæ•´æž„å»º"
            # ç¡®ä¿ç›®å½•ä¸å­˜åœ¨
            if [ -d "/workdir/openwrt" ]; then
              echo "ðŸ—‘ï¸ æ¸…ç†å·²å­˜åœ¨çš„æºç ç›®å½•"
              rm -rf /workdir/openwrt
            fi
            echo "ðŸ“¥ å…‹éš†æºç ä»Ž: ${{ needs.prepare.outputs.immwrt_repo }}"
            echo "ðŸ“¥ ä½¿ç”¨åˆ†æ”¯: ${{ needs.prepare.outputs.immwrt_branch }}"
            cd /workdir
            git clone ${{ needs.prepare.outputs.immwrt_repo }} -b ${{ needs.prepare.outputs.immwrt_branch }} openwrt
          fi
          
          # åˆ›å»ºè½¯é“¾æŽ¥
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
          
          # éªŒè¯å…‹éš†ç»“æžœ
          if [ -f "/workdir/openwrt/Makefile" ]; then
            echo "âœ… æºç éªŒè¯æˆåŠŸ"
            echo "ðŸ“Š æºç ä¿¡æ¯:"
            cd /workdir/openwrt
            echo "  - å½“å‰åˆ†æ”¯: $(git branch --show-current)"
            echo "  - æœ€æ–°æäº¤: $(git rev-parse --short HEAD)"
            echo "  - æäº¤æ—¶é—´: $(git log -1 --format='%cd' --date=short)"
          else
            echo "âŒ æºç éªŒè¯å¤±è´¥"
            exit 1
          fi

      - name: âš™ï¸ è®¾ç½®ç¼–è¯‘ä¼˜åŒ–é€‰é¡¹
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd /workdir/openwrt
          echo "âš™ï¸ è®¾ç½®ç¼–è¯‘ä¼˜åŒ–é€‰é¡¹"
          
          # åˆ›å»ºä¸´æ—¶é…ç½®æ–‡ä»¶
          cat > build_opt.config << 'EOF'
          # ç¼–è¯‘ä¼˜åŒ–é€‰é¡¹
          CONFIG_USE_MKLIBS=y
          CONFIG_USE_SSTRIP=y
          CONFIG_USE_USTRIP=y
          CONFIG_USE_XZ=y
          
          # å‡å°‘è°ƒè¯•ä¿¡æ¯
          CONFIG_DEBUG=y
          CONFIG_NO_STRIP=y
          
          # ä¼˜åŒ–å¹¶è¡Œç¼–è¯‘
          CONFIG_JLEVEL=$(nproc)
          EOF
          
          echo "âœ… ç¼–è¯‘ä¼˜åŒ–é€‰é¡¹è®¾ç½®å®Œæˆ"

      - name: é›†æˆdiy.shåŠŸèƒ½ï¼ˆP1éƒ¨åˆ†ï¼‰
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd /workdir/openwrt
          echo "ðŸ”§ é›†æˆdiy.sh P1åŠŸèƒ½ - ä¿®æ”¹æºç "
          
          # 1. ä¿®æ”¹é»˜è®¤IP
          echo "  - ä¿®æ”¹é»˜è®¤IPä¸º192.168.111.1"
          sed -i 's/192.168.1.1/192.168.111.1/g' package/base-files/files/bin/config_generate
          
          # 2. ä¿®æ”¹ç‰ˆæœ¬å·
          echo "  - ä¿®æ”¹ç‰ˆæœ¬å·"
          sed -i "s/DISTRIB_REVISION='.*'/DISTRIB_REVISION='R${{ needs.prepare.outputs.build_date }}'/g" package/base-files/files/etc/openwrt_release
          
          # 3. æ·»åŠ è‡ªå®šä¹‰è½¯ä»¶æº
          echo "  - æ·»åŠ è‡ªå®šä¹‰è½¯ä»¶æºé…ç½®"
          cat >> feeds.conf.default << EOF
          src-git small_package https://github.com/kenzok8/small-package;main
          EOF
          
          # 4. ä¿®æ”¹é»˜è®¤ä¸»é¢˜
          echo "  - è®¾ç½®é»˜è®¤ä¸»é¢˜"
          sed -i 's/luci-theme-bootstrap/luci-theme-argon/g' feeds/luci/collections/luci/Makefile 2>/dev/null || true
          
          echo "âœ… diy.sh P1åŠŸèƒ½é›†æˆå®Œæˆ"

      - name: é›†æˆdiy.shåŠŸèƒ½ï¼ˆP2éƒ¨åˆ†ï¼‰
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd /workdir/openwrt
          echo "ðŸ”§ é›†æˆdiy.sh P2åŠŸèƒ½ - æ·»åŠ é¢å¤–è½¯ä»¶åŒ…"
          
          # 1. æ·»åŠ ç¬¬ä¸‰æ–¹è½¯ä»¶æº
          echo "  - æ·»åŠ ç¬¬ä¸‰æ–¹è½¯ä»¶æº"
          git clone https://github.com/kenzok8/small-package package/small-package
          
          # 2. æ·»åŠ å…¶ä»–å¸¸ç”¨è½¯ä»¶æº
          echo "  - æ·»åŠ å…¶ä»–è½¯ä»¶æº"
          git clone https://github.com/Lienol/openwrt-package package/lienol 2>/dev/null || true
          
          # 3. æ›´æ–°æ‰€æœ‰feeds
          echo "  - æ›´æ–°feeds"
          ./scripts/feeds update -a
          
          # 4. å®‰è£…æ‰€æœ‰feeds
          echo "  - å®‰è£…feeds"
          ./scripts/feeds install -a
          
          # 5. å®‰è£…ç‰¹å®šè½¯ä»¶åŒ…
          echo "  - å®‰è£…ç‰¹å®šè½¯ä»¶åŒ…"
          ./scripts/feeds install luci-app-passwall 2>/dev/null || true
          ./scripts/feeds install luci-app-openclash 2>/dev/null || true
          ./scripts/feeds install luci-theme-argon 2>/dev/null || true
          
          echo "âœ… diy.sh P2åŠŸèƒ½é›†æˆå®Œæˆ"

      - name: é›†æˆrepo.shåŠŸèƒ½
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd /workdir/openwrt
          echo "ðŸ”§ é›†æˆrepo.shåŠŸèƒ½ - ä»“åº“ç®¡ç†"
          
          # 1. æ¸…ç†æ— ç”¨è½¯ä»¶åŒ…
          echo "  - æ¸…ç†æ— ç”¨è½¯ä»¶åŒ…"
          find package/ -name "*openvswitch*" -type d -exec rm -rf {} + 2>/dev/null || true
          find package/ -name "*docker*" -type d -exec rm -rf {} + 2>/dev/null || true
          
          echo "âœ… repo.shåŠŸèƒ½é›†æˆå®Œæˆ"

      - name: åŠ è½½Ultraé…ç½®
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd /workdir/openwrt
          echo "âš™ï¸ åŠ è½½Ultraé…ç½®"
          [ -f "$GITHUB_WORKSPACE/configs/base_ipq60xx.config" ] && \
            cp "$GITHUB_WORKSPACE/configs/base_ipq60xx.config" .config
          [ -f "$GITHUB_WORKSPACE/configs/base_immwrt.config" ] && \
            cat "$GITHUB_WORKSPACE/configs/base_immwrt.config" >> .config
          [ -f "$GITHUB_WORKSPACE/configs/Ultra.config" ] && \
            cat "$GITHUB_WORKSPACE/configs/Ultra.config" >> .config
          
          # åº”ç”¨ç¼–è¯‘ä¼˜åŒ–é€‰é¡¹
          [ -f build_opt.config ] && cat build_opt.config >> .config

      - name: ðŸ”ðŸ”ðŸ” Luciè½¯ä»¶åŒ…å®Œæ•´æ€§æ£€æŸ¥ - Ultraå˜ä½“ ðŸ”ðŸ”ðŸ”
        id: luci_check
        run: |
          cd /workdir/openwrt
          
          # è¾“å‡ºé†’ç›®çš„æ ‡é¢˜
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                ðŸ” LUCIè½¯ä»¶åŒ…å¯¹æ¯”æ£€æŸ¥ ðŸ”                â•‘"
          echo "â•‘                   Ultraå˜ä½“ (defconfigå‰åŽ)                â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # æ­¥éª¤1: è®°å½•defconfigå‰çš„LuciåŒ…
          echo "ðŸ“‹ æ­¥éª¤1: æ£€æŸ¥defconfigå‰çš„é…ç½®..."
          BEFORE_LUCI=$(cat .config | grep "^CONFIG_PACKAGE_luci-" | cut -d'=' -f1 | sed 's/CONFIG_PACKAGE_//')
          BEFORE_COUNT=$(echo "$BEFORE_LUCI" | grep -c .)
          
          echo "ðŸ” defconfigå‰é…ç½®ä¸­çš„Luciè½¯ä»¶åŒ… ($BEFORE_COUNT ä¸ª):"
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚ åºå· â”‚ è½¯ä»¶åŒ…åç§°                                      â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          index=1
          echo "$BEFORE_LUCI" | while read pkg; do
            if [ -n "$pkg" ]; then
              printf "â”‚ %4d â”‚ %-47s â”‚\n" "$index" "$pkg"
              index=$((index + 1))
            fi
          done
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo ""
          
          # æ­¥éª¤2: è¿è¡Œmake defconfig
          echo "ðŸ”„ æ­¥éª¤2: è¿è¡Œmake defconfigè¡¥å…¨é…ç½®..."
          make defconfig
          
          # æ­¥éª¤3: è®°å½•defconfigåŽçš„LuciåŒ…
          echo ""
          echo "ðŸ“‹ æ­¥éª¤3: æ£€æŸ¥defconfigåŽçš„é…ç½®..."
          AFTER_LUCI=$(cat .config | grep "^CONFIG_PACKAGE_luci-" | cut -d'=' -f1 | sed 's/CONFIG_PACKAGE_//')
          AFTER_COUNT=$(echo "$AFTER_LUCI" | grep -c .)
          
          echo "ðŸ” defconfigåŽé…ç½®ä¸­çš„Luciè½¯ä»¶åŒ… ($AFTER_COUNT ä¸ª):"
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚ åºå· â”‚ è½¯ä»¶åŒ…åç§°                                      â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          index=1
          echo "$AFTER_LUCI" | while read pkg; do
            if [ -n "$pkg" ]; then
              printf "â”‚ %4d â”‚ %-47s â”‚\n" "$index" "$pkg"
              index=$((index + 1))
            fi
          done
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo ""
          
          # æ­¥éª¤4: å¯¹æ¯”åˆ†æž
          echo "ðŸ“Š æ­¥éª¤4: å¯¹æ¯”åˆ†æžç»“æžœ..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚ åºå· â”‚ è½¯ä»¶åŒ…åç§°                    â”‚ defconfigå‰ â”‚ defconfigåŽ â”‚ çŠ¶æ€ â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          
          # åˆ›å»ºæ‰€æœ‰åŒ…çš„åˆ—è¡¨
          ALL_LUCI=$(echo -e "$BEFORE_LUCI\n$AFTER_LUCI" | sort | uniq)
          MISSING_COUNT=0
          ADDED_COUNT=0
          index=1
          
          for pkg in $ALL_LUCI; do
            if [ -n "$pkg" ]; then
              before_status="âŒ"
              after_status="âŒ"
              final_status="âŒ ç¼ºå¤±"
              
              # æ£€æŸ¥defconfigå‰æ˜¯å¦å­˜åœ¨
              if echo "$BEFORE_LUCI" | grep -q "^$pkg$"; then
                before_status="âœ…"
              fi
              
              # æ£€æŸ¥defconfigåŽæ˜¯å¦å­˜åœ¨
              if echo "$AFTER_LUCI" | grep -q "^$pkg$"; then
                after_status="âœ…"
              fi
              
              # åˆ¤æ–­æœ€ç»ˆçŠ¶æ€
              if [ "$before_status" = "âœ…" ] && [ "$after_status" = "âœ…" ]; then
                final_status="âœ… ä¿ç•™"
              elif [ "$before_status" = "âŒ" ] && [ "$after_status" = "âœ…" ]; then
                final_status="âž• æ–°å¢ž"
                ADDED_COUNT=$((ADDED_COUNT + 1))
              elif [ "$before_status" = "âœ…" ] && [ "$after_status" = "âŒ" ]; then
                final_status="âŒ ä¸¢å¤±"
                MISSING_COUNT=$((MISSING_COUNT + 1))
              fi
              
              printf "â”‚ %4d â”‚ %-30s â”‚ %-11s â”‚ %-11s â”‚ %-8s â”‚\n" "$index" "$pkg" "$before_status" "$after_status" "$final_status"
              index=$((index + 1))
            fi
          done
          
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # æ­¥éª¤5: ç»Ÿè®¡æ±‡æ€»
          echo "ðŸ“Š æ­¥éª¤5: ç»Ÿè®¡æ±‡æ€»"
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚ é¡¹ç›®              â”‚ æ•°é‡     â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          echo "â”‚ defconfigå‰é…ç½®   â”‚ $BEFORE_COUNT  â”‚"
          echo "â”‚ defconfigåŽé…ç½®   â”‚ $AFTER_COUNT   â”‚"
          echo "â”‚ defconfigæ–°å¢žåŒ…   â”‚ $ADDED_COUNT   â”‚"
          echo "â”‚ defconfigä¸¢å¤±åŒ…   â”‚ $MISSING_COUNT â”‚"
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo ""
          
          # æ­¥éª¤6: è¯¦ç»†åˆ†æž
          echo "ðŸ“‹ æ­¥éª¤6: è¯¦ç»†åˆ†æž"
          
          if [ $MISSING_COUNT -gt 0 ]; then
            echo "ðŸš¨ å‘çŽ° $MISSING_COUNT ä¸ªåœ¨defconfigè¿‡ç¨‹ä¸­ä¸¢å¤±çš„Luciè½¯ä»¶åŒ…ï¼š"
            echo ""
            echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
            echo "â”‚ åºå· â”‚ ä¸¢å¤±çš„è½¯ä»¶åŒ…                        â”‚"
            echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
            index=1
            echo "$BEFORE_LUCI" | while read pkg; do
              if [ -n "$pkg" ] && ! echo "$AFTER_LUCI" | grep -q "^$pkg$"; then
                printf "â”‚ %4d â”‚ %-39s â”‚\n" "$index" "$pkg"
                index=$((index + 1))
              fi
            done
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
            echo ""
            echo "ðŸ’¡ å¯èƒ½çš„åŽŸå› ï¼š"
            echo "   1. è½¯ä»¶åŒ…ä¾èµ–å†²çªï¼Œdefconfigè‡ªåŠ¨ç§»é™¤"
            echo "   2. è½¯ä»¶åŒ…ä¸å­˜åœ¨äºŽä»»ä½•feedsæº"
            echo "   3. é…ç½®é€‰é¡¹ä¸å…¼å®¹"
            echo ""
            echo "âš ï¸  æ³¨æ„ï¼šè¿™äº›åŒ…å°†ä¸ä¼šåŒ…å«åœ¨æœ€ç»ˆå›ºä»¶ä¸­ï¼"
          else
            echo "âœ… æ­å–œï¼æ‰€æœ‰é…ç½®çš„Luciè½¯ä»¶åŒ…éƒ½åœ¨defconfigåŽä¿ç•™"
          fi
          
          if [ $ADDED_COUNT -gt 0 ]; then
            echo ""
            echo "â„¹ï¸  defconfigè‡ªåŠ¨è¡¥å…¨äº† $ADDED_COUNT ä¸ªä¾èµ–åŒ…"
          fi
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                      æ£€æŸ¥å®Œæˆ                             â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # ä¿å­˜åˆ°è¾“å‡º
          echo "missing_count=$MISSING_COUNT" >> $GITHUB_OUTPUT
          echo "added_count=$ADDED_COUNT" >> $GITHUB_OUTPUT
          echo "before_count=$BEFORE_COUNT" >> $GITHUB_OUTPUT
          echo "after_count=$AFTER_COUNT" >> $GITHUB_OUTPUT
          
          # å¦‚æžœæœ‰ä¸¥é‡é—®é¢˜ï¼Œè®¾ç½®å¤±è´¥çŠ¶æ€
          if [ $MISSING_COUNT -gt 0 ]; then
            echo "luci_check_failed=true" >> $GITHUB_OUTPUT
          else
            echo "luci_check_failed=false" >> $GITHUB_OUTPUT
          fi

      - name: Luciæ£€æŸ¥ç»“æžœå†³ç­–
        if: steps.luci_check.outputs.luci_check_failed == 'true'
        run: |
          echo "âŒ Luciè½¯ä»¶åŒ…æ£€æŸ¥å‘çŽ° ${{ steps.luci_check.outputs.missing_count }} ä¸ªä¸¢å¤±çš„åŒ…"
          echo "ðŸ’¡ å¦‚éœ€ç»ˆæ­¢ç¼–è¯‘ï¼Œè¯·åœ¨ä¸Šè¿°æ£€æŸ¥æ­¥éª¤ä¸­æ·»åŠ  exit 1"
          echo "âš ï¸  ç»§ç»­ç¼–è¯‘å¯èƒ½ä¼šå¯¼è‡´å›ºä»¶åŠŸèƒ½ä¸å®Œæ•´"
          echo ""

      - name: è‡ªå®šä¹‰å›ºä»¶è®¾ç½®
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd /workdir/openwrt
          echo "ðŸ”§ åº”ç”¨å›ºä»¶è‡ªå®šä¹‰è®¾ç½®"
          
          # è®¾ç½®IPåœ°å€ä¸º192.168.111.1
          sed -i "s/192.168.1.1/${{ env.FIRMWARE_IP }}/g" package/base-files/files/bin/config_generate
          
          # è®¾ç½®æœºå™¨åä¸ºWRT
          sed -i "s/OpenWrt/${{ env.FIRMWARE_NAME }}/g" package/base-files/files/bin/config_generate
          
          # è®¾ç½®å¯†ç ä¸ºç©º
          sed -i 's/root::0:0:99999:7:::/root::$1$zqzJn5Jp$6V8R2G5lFvUaU4D8p9k7J0:19146:0:99999:7:::/' package/base-files/files/etc/shadow
          
          # ç¦ç”¨é»˜è®¤å¯†ç æç¤º
          sed -i 's/Option password.*/Option password ""/' package/network/config/uci-defaults/12_network-generate-ula-prefix 2>/dev/null || true
          
          # è®¾ç½®æ—¶åŒº
          echo "Set timezone to $TZ"
          sed -i "s/'UTC'/'$TZ'/g" package/base-files/files/etc/sysupgrade.conf 2>/dev/null || true
          
          echo "âœ… å›ºä»¶è®¾ç½®å®Œæˆ"
          echo "   IPåœ°å€: ${{ env.FIRMWARE_IP }}"
          echo "   æœºå™¨å: ${{ env.FIRMWARE_NAME }}"
          echo "   å¯†ç : ç©ºå¯†ç "
          echo "   æ—¶åŒº: $TZ"

      - name: ä¸‹è½½ä¾èµ–åŒ…
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd /workdir/openwrt
          echo "ðŸ“¥ ä¸‹è½½ä¾èµ–åŒ…"
          echo "ðŸ“Š Luciæ£€æŸ¥ç»“æžœï¼šdefconfigå‰ ${{ steps.luci_check.outputs.before_count }} ä¸ªï¼ŒdefconfigåŽ ${{ steps.luci_check.outputs.after_count }} ä¸ª"
          echo "ðŸ“Š ä¸¢å¤± ${{ steps.luci_check.outputs.missing_count }} ä¸ªï¼Œæ–°å¢ž ${{ steps.luci_check.outputs.added_count }} ä¸ª"
          make download -j$(nproc)
          # æ¸…ç†æ— æ•ˆçš„å°æ–‡ä»¶
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: é¢„ç¼–è¯‘å·¥å…·é“¾
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd /workdir/openwrt
          echo "ðŸ”¨ é¢„ç¼–è¯‘å·¥å…·é“¾"
          make toolchain/install -j$(nproc) || make toolchain/install -j1 V=s

      - name: ðŸ§¹ æ¸…ç†å·¥å…·é“¾ç¼–è¯‘ä¸­é—´äº§ç‰©
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd /workdir/openwrt
          echo "ðŸ§¹ æ¸…ç†å·¥å…·é“¾ç¼–è¯‘ä¸­é—´äº§ç‰©ä»¥é‡Šæ”¾ç©ºé—´"
          
          # ä¿ç•™å¿…è¦æ–‡ä»¶ï¼Œæ¸…ç†ä¸­é—´äº§ç‰©
          find build_dir -name ".pkgdir" -type d -exec rm -rf {} + 2>/dev/null || true
          find build_dir -name "*.ipk" -delete 2>/dev/null || true
          find staging_dir -name ".pkginfo" -type f -delete 2>/dev/null || true
          find staging_dir -name "*.control" -type f -delete 2>/dev/null || true
          
          # æ¸…ç†å·¥å…·é“¾ä¸´æ—¶æ–‡ä»¶
          find build_dir/host -name "*.a" -delete 2>/dev/null || true
          find build_dir/host -name "*.o" -delete 2>/dev/null || true
          
          # æ¸…ç†ä¸‹è½½ç›®å½•ä¸­çš„ä¸´æ—¶æ–‡ä»¶
          find dl -name "*.tmp" -delete 2>/dev/null || true
          find dl -name "*.partial" -delete 2>/dev/null || true
          
          echo "âœ… å·¥å…·é“¾æ¸…ç†å®Œæˆ"
          df -h

      - name: æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°ç¼–è¯‘Ultra
        id: check_build
        run: |
          cd /workdir/openwrt
          if [ "${{ steps.cache.outputs.cache-hit }}" = "true" ]; then
            # æ£€æŸ¥æ˜¯å¦å·²æœ‰Ultraå›ºä»¶
            if [ -d "bin/targets" ] && [ "$(find bin/targets -name "*immortalwrt*" -type f | wc -l)" -gt 0 ]; then
              echo "âœ… å‘çŽ°å·²ç¼–è¯‘çš„Ultraå›ºä»¶ï¼Œè·³è¿‡ç¼–è¯‘"
              echo "need_build=false" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ ç¼“å­˜å‘½ä¸­ä½†æ— å›ºä»¶ï¼Œéœ€è¦é‡æ–°ç¼–è¯‘"
              echo "need_build=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ ç¼“å­˜æœªå‘½ä¸­ï¼Œéœ€è¦å®Œæ•´ç¼–è¯‘"
            echo "need_build=true" >> $GITHUB_OUTPUT
          fi

      - name: ç¼–è¯‘Ultraå›ºä»¶
        id: compile
        if: steps.check_build.outputs.need_build == 'true'
        run: |
          cd /workdir/openwrt
          echo "ðŸš€ å¼€å§‹ç¼–è¯‘Ultraå˜ä½“"
          echo "ä½¿ç”¨ $(nproc) ä¸ªçº¿ç¨‹å¹¶è¡Œç¼–è¯‘"
          
          # å¤šé‡ç¼–è¯‘ç­–ç•¥
          make -j$(nproc) || make -j1 || make -j1 V=s
          
          echo "âœ… Ultraç¼–è¯‘å®Œæˆ"

      - name: ðŸ§¹ æ¸…ç†ç¼–è¯‘ä¸­é—´äº§ç‰©
        if: steps.check_build.outputs.need_build == 'true'
        run: |
          cd /workdir/openwrt
          echo "ðŸ§¹ æ¸…ç†ç¼–è¯‘ä¸­é—´äº§ç‰©ä»¥é‡Šæ”¾ç©ºé—´"
          
          # ä¿ç•™å¿…è¦æ–‡ä»¶ï¼Œæ¸…ç†ä¸­é—´äº§ç‰©
          find build_dir -name ".pkgdir" -type d -exec rm -rf {} + 2>/dev/null || true
          find build_dir -name "*.ipk" -delete 2>/dev/null || true
          find staging_dir -name ".pkginfo" -type f -delete 2>/dev/null || true
          find staging_dir -name "*.control" -type f -delete 2>/dev/null || true
          
          # æ¸…ç†å·¥å…·é“¾ä¸´æ—¶æ–‡ä»¶
          find build_dir/host -name "*.a" -delete 2>/dev/null || true
          find build_dir/host -name "*.o" -delete 2>/dev/null || true
          
          # æ¸…ç†ä¸‹è½½ç›®å½•ä¸­çš„ä¸´æ—¶æ–‡ä»¶
          find dl -name "*.tmp" -delete 2>/dev/null || true
          find dl -name "*.partial" -delete 2>/dev/null || true
          
          echo "âœ… æ¸…ç†å®Œæˆ"
          df -h

      - name: æ•´ç†Ultraå›ºä»¶
        run: |
          cd /workdir/openwrt/bin/targets/*/*
          echo "ðŸ“¦ æ•´ç†Ultraå›ºä»¶"
          
          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p $GITHUB_WORKSPACE/firmware/Ultra
          
          # å¤åˆ¶å›ºä»¶æ–‡ä»¶
          find . -name "*immortalwrt*" -type f ! -name "*manifest*" | \
            xargs -I {} cp {} $GITHUB_WORKSPACE/firmware/Ultra/
          
          # é‡å‘½åå›ºä»¶
          cd $GITHUB_WORKSPACE/firmware/Ultra
          for file in *; do
            if [ -f "$file" ]; then
              mv "$file" "Ultra-${{ needs.prepare.outputs.build_date }}-${file}"
            fi
          done
          
          echo "âœ… Ultraå›ºä»¶æ•´ç†å®Œæˆ"
          ls -la

      - name: æ£€æŸ¥ç©ºé—´ä½¿ç”¨
        if: always()
        run: |
          echo "ðŸ’¾ ç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ:"
          df -hT
          echo ""
          echo "ðŸ“ /workdirç›®å½•å¤§å°:"
          du -sh /workdir/*

  # å¤šå˜ä½“ç¼–è¯‘ä»»åŠ¡ï¼ˆä½¿ç”¨çŸ©é˜µç­–ç•¥ï¼‰
  build-variants:
    runs-on: ubuntu-22.04
    needs: [prepare, build-base-ultra]
    if: always() && needs.build-base-ultra.result == 'success'
    strategy:
      matrix:
        variant: [Max, Pro]
      fail-fast: false
    
    steps:
      - name: æ¢å¤Ultraå®Œæ•´çŽ¯å¢ƒ
        uses: actions/cache@v4
        with:
          path: |
            /workdir/openwrt
            ~/.cache/go-build
            ~/.cache/pip
          key: ${{ needs.prepare.outputs.cache_key_ultra }}
          restore-keys: |
            openwrt-ultra-${{ needs.prepare.outputs.toolchain_hash }}-
            openwrt-base-${{ needs.prepare.outputs.config_hash }}-
            openwrt-ultra-
            openwrt-base-

      - name: éªŒè¯UltraçŽ¯å¢ƒå®Œæ•´æ€§
        run: |
          if [ ! -f "/workdir/openwrt/Makefile" ]; then
            echo "âŒ UltraçŽ¯å¢ƒä¸å®Œæ•´ï¼Œå°è¯•æ¢å¤..."
            exit 1
          fi
          echo "âœ… UltraçŽ¯å¢ƒéªŒè¯é€šè¿‡"
          echo "ðŸ“Š UltraçŽ¯å¢ƒä¿¡æ¯:"
          cd /workdir/openwrt
          echo "  - å·¥å…·é“¾çŠ¶æ€: $(ls -la build_dir/host/ 2>/dev/null | wc -l) ä¸ªå·¥å…·"
          echo "  - ä¸‹è½½åŒ…çŠ¶æ€: $(ls -la dl/ 2>/dev/null | wc -l) ä¸ªåŒ…"
          echo "  - ç¼–è¯‘äº§ç‰©: $(du -sh build_dir/ 2>/dev/null || echo 'æœªçŸ¥')"

      - name: ðŸš¨ å‡†å¤‡${{ matrix.variant }}é…ç½®
        run: |
          cd /workdir/openwrt
          echo "âš™ï¸ åŠ è½½${{ matrix.variant }}é…ç½®ï¼ˆåŸºäºŽUltraçŽ¯å¢ƒï¼‰"
          make distclean
          [ -f "$GITHUB_WORKSPACE/configs/base_ipq60xx.config" ] && \
            cp "$GITHUB_WORKSPACE/configs/base_ipq60xx.config" .config
          [ -f "$GITHUB_WORKSPACE/configs/base_immwrt.config" ] && \
            cat "$GITHUB_WORKSPACE/configs/base_immwrt.config" >> .config
          [ -f "$GITHUB_WORKSPACE/configs/${{ matrix.variant }}.config" ] && \
            cat "$GITHUB_WORKSPACE/configs/${{ matrix.variant }}.config" >> .config
          
          # åº”ç”¨ç¼–è¯‘ä¼˜åŒ–é€‰é¡¹
          cat > build_opt.config << 'EOF'
          # ç¼–è¯‘ä¼˜åŒ–é€‰é¡¹
          CONFIG_USE_MKLIBS=y
          CONFIG_USE_SSTRIP=y
          CONFIG_USE_USTRIP=y
          CONFIG_USE_XZ=y
          
          # å‡å°‘è°ƒè¯•ä¿¡æ¯
          CONFIG_DEBUG=y
          CONFIG_NO_STRIP=y
          
          # ä¼˜åŒ–å¹¶è¡Œç¼–è¯‘
          CONFIG_JLEVEL=$(nproc)
          EOF
          cat build_opt.config >> .config

      - name: ðŸ”ðŸ”ðŸ” Luciè½¯ä»¶åŒ…å®Œæ•´æ€§æ£€æŸ¥ - ${{ matrix.variant }}å˜ä½“ ðŸ”ðŸ”ðŸ”
        id: luci_check
        run: |
          cd /workdir/openwrt
          
          # è¾“å‡ºé†’ç›®çš„æ ‡é¢˜
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                ðŸ” LUCIè½¯ä»¶åŒ…å¯¹æ¯”æ£€æŸ¥ ðŸ”                â•‘"
          echo "â•‘                 ${{ matrix.variant }}å˜ä½“ (defconfigå‰åŽ)               â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # æ­¥éª¤1: è®°å½•defconfigå‰çš„LuciåŒ…
          echo "ðŸ“‹ æ­¥éª¤1: æ£€æŸ¥defconfigå‰çš„é…ç½®..."
          BEFORE_LUCI=$(cat .config | grep "^CONFIG_PACKAGE_luci-" | cut -d'=' -f1 | sed 's/CONFIG_PACKAGE_//')
          BEFORE_COUNT=$(echo "$BEFORE_LUCI" | grep -c .)
          
          echo "ðŸ” defconfigå‰é…ç½®ä¸­çš„Luciè½¯ä»¶åŒ… ($BEFORE_COUNT ä¸ª):"
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚ åºå· â”‚ è½¯ä»¶åŒ…åç§°                                      â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          index=1
          echo "$BEFORE_LUCI" | while read pkg; do
            if [ -n "$pkg" ]; then
              printf "â”‚ %4d â”‚ %-47s â”‚\n" "$index" "$pkg"
              index=$((index + 1))
            fi
          done
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo ""
          
          # æ­¥éª¤2: è¿è¡Œmake defconfig
          echo "ðŸ”„ æ­¥éª¤2: è¿è¡Œmake defconfigè¡¥å…¨é…ç½®..."
          make defconfig
          
          # æ­¥éª¤3: è®°å½•defconfigåŽçš„LuciåŒ…
          echo ""
          echo "ðŸ“‹ æ­¥éª¤3: æ£€æŸ¥defconfigåŽçš„é…ç½®..."
          AFTER_LUCI=$(cat .config | grep "^CONFIG_PACKAGE_luci-" | cut -d'=' -f1 | sed 's/CONFIG_PACKAGE_//')
          AFTER_COUNT=$(echo "$AFTER_LUCI" | grep -c .)
          
          echo "ðŸ” defconfigåŽé…ç½®ä¸­çš„Luciè½¯ä»¶åŒ… ($AFTER_COUNT ä¸ª):"
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚ åºå· â”‚ è½¯ä»¶åŒ…åç§°                                      â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          index=1
          echo "$AFTER_LUCI" | while read pkg; do
            if [ -n "$pkg" ]; then
              printf "â”‚ %4d â”‚ %-47s â”‚\n" "$index" "$pkg"
              index=$((index + 1))
            fi
          done
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo ""
          
          # æ­¥éª¤4: å¯¹æ¯”åˆ†æž
          echo "ðŸ“Š æ­¥éª¤4: å¯¹æ¯”åˆ†æžç»“æžœ..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚ åºå· â”‚ è½¯ä»¶åŒ…åç§°                    â”‚ defconfigå‰ â”‚ defconfigåŽ â”‚ çŠ¶æ€ â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          
          # åˆ›å»ºæ‰€æœ‰åŒ…çš„åˆ—è¡¨
          ALL_LUCI=$(echo -e "$BEFORE_LUCI\n$AFTER_LUCI" | sort | uniq)
          MISSING_COUNT=0
          ADDED_COUNT=0
          index=1
          
          for pkg in $ALL_LUCI; do
            if [ -n "$pkg" ]; then
              before_status="âŒ"
              after_status="âŒ"
              final_status="âŒ ç¼ºå¤±"
              
              # æ£€æŸ¥defconfigå‰æ˜¯å¦å­˜åœ¨
              if echo "$BEFORE_LUCI" | grep -q "^$pkg$"; then
                before_status="âœ…"
              fi
              
              # æ£€æŸ¥defconfigåŽæ˜¯å¦å­˜åœ¨
              if echo "$AFTER_LUCI" | grep -q "^$pkg$"; then
                after_status="âœ…"
              fi
              
              # åˆ¤æ–­æœ€ç»ˆçŠ¶æ€
              if [ "$before_status" = "âœ…" ] && [ "$after_status" = "âœ…" ]; then
                final_status="âœ… ä¿ç•™"
              elif [ "$before_status" = "âŒ" ] && [ "$after_status" = "âœ…" ]; then
                final_status="âž• æ–°å¢ž"
                ADDED_COUNT=$((ADDED_COUNT + 1))
              elif [ "$before_status" = "âœ…" ] && [ "$after_status" = "âŒ" ]; then
                final_status="âŒ ä¸¢å¤±"
                MISSING_COUNT=$((MISSING_COUNT + 1))
              fi
              
              printf "â”‚ %4d â”‚ %-30s â”‚ %-11s â”‚ %-11s â”‚ %-8s â”‚\n" "$index" "$pkg" "$before_status" "$after_status" "$final_status"
              index=$((index + 1))
            fi
          done
          
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # æ­¥éª¤5: ç»Ÿè®¡æ±‡æ€»
          echo "ðŸ“Š æ­¥éª¤5: ç»Ÿè®¡æ±‡æ€»"
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚ é¡¹ç›®              â”‚ æ•°é‡     â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          echo "â”‚ defconfigå‰é…ç½®   â”‚ $BEFORE_COUNT  â”‚"
          echo "â”‚ defconfigåŽé…ç½®   â”‚ $AFTER_COUNT   â”‚"
          echo "â”‚ defconfigæ–°å¢žåŒ…   â”‚ $ADDED_COUNT   â”‚"
          echo "â”‚ defconfigä¸¢å¤±åŒ…   â”‚ $MISSING_COUNT â”‚"
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo ""
          
          # æ­¥éª¤6: è¯¦ç»†åˆ†æž
          echo "ðŸ“‹ æ­¥éª¤6: è¯¦ç»†åˆ†æž"
          
          if [ $MISSING_COUNT -gt 0 ]; then
            echo "ðŸš¨ å‘çŽ° $MISSING_COUNT ä¸ªåœ¨defconfigè¿‡ç¨‹ä¸­ä¸¢å¤±çš„Luciè½¯ä»¶åŒ…ï¼š"
            echo ""
            echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
            echo "â”‚ åºå· â”‚ ä¸¢å¤±çš„è½¯ä»¶åŒ…                        â”‚"
            echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
            index=1
            echo "$BEFORE_LUCI" | while read pkg; do
              if [ -n "$pkg" ] && ! echo "$AFTER_LUCI" | grep -q "^$pkg$"; then
                printf "â”‚ %4d â”‚ %-39s â”‚\n" "$index" "$pkg"
                index=$((index + 1))
              fi
            done
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
            echo ""
            echo "ðŸ’¡ å¯èƒ½çš„åŽŸå› ï¼š"
            echo "   1. è½¯ä»¶åŒ…ä¾èµ–å†²çªï¼Œdefconfigè‡ªåŠ¨ç§»é™¤"
            echo "   2. è½¯ä»¶åŒ…ä¸å­˜åœ¨äºŽä»»ä½•feedsæº"
            echo "   3. é…ç½®é€‰é¡¹ä¸å…¼å®¹"
            echo ""
            echo "âš ï¸  æ³¨æ„ï¼šè¿™äº›åŒ…å°†ä¸ä¼šåŒ…å«åœ¨æœ€ç»ˆå›ºä»¶ä¸­ï¼"
          else
            echo "âœ… æ­å–œï¼æ‰€æœ‰é…ç½®çš„Luciè½¯ä»¶åŒ…éƒ½åœ¨defconfigåŽä¿ç•™"
          fi
          
          if [ $ADDED_COUNT -gt 0 ]; then
            echo ""
            echo "â„¹ï¸  defconfigè‡ªåŠ¨è¡¥å…¨äº† $ADDED_COUNT ä¸ªä¾èµ–åŒ…"
          fi
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                      æ£€æŸ¥å®Œæˆ                             â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # ä¿å­˜åˆ°è¾“å‡º
          echo "missing_count=$MISSING_COUNT" >> $GITHUB_OUTPUT
          echo "added_count=$ADDED_COUNT" >> $GITHUB_OUTPUT
          echo "before_count=$BEFORE_COUNT" >> $GITHUB_OUTPUT
          echo "after_count=$AFTER_COUNT" >> $GITHUB_OUTPUT
          
          # å¦‚æžœæœ‰ä¸¥é‡é—®é¢˜ï¼Œè®¾ç½®å¤±è´¥çŠ¶æ€
          if [ $MISSING_COUNT -gt 0 ]; then
            echo "luci_check_failed=true" >> $GITHUB_OUTPUT
          else
            echo "luci_check_failed=false" >> $GITHUB_OUTPUT
          fi

      - name: Luciæ£€æŸ¥ç»“æžœå†³ç­–
        if: steps.luci_check.outputs.luci_check_failed == 'true'
        run: |
          echo "âŒ Luciè½¯ä»¶åŒ…æ£€æŸ¥å‘çŽ° ${{ steps.luci_check.outputs.missing_count }} ä¸ªä¸¢å¤±çš„åŒ…"
          echo "ðŸ’¡ å¦‚éœ€ç»ˆæ­¢ç¼–è¯‘ï¼Œè¯·åœ¨ä¸Šè¿°æ£€æŸ¥æ­¥éª¤ä¸­æ·»åŠ  exit 1"
          echo "âš ï¸  ç»§ç»­ç¼–è¯‘å¯èƒ½ä¼šå¯¼è‡´å›ºä»¶åŠŸèƒ½ä¸å®Œæ•´"
          echo ""

      - name: ç¼–è¯‘${{ matrix.variant }}å›ºä»¶
        run: |
          cd /workdir/openwrt
          echo "ðŸš€ å¼€å§‹ç¼–è¯‘${{ matrix.variant }}å˜ä½“ï¼ˆåŸºäºŽUltraçŽ¯å¢ƒï¼‰"
          echo "ä½¿ç”¨ $(nproc) ä¸ªçº¿ç¨‹å¹¶è¡Œç¼–è¯‘"
          echo "ðŸ“Š çŽ¯å¢ƒçŠ¶æ€ï¼š"
          echo "  - å·¥å…·é“¾: å·²å°±ç»ªï¼ˆæ¥è‡ªUltraçŽ¯å¢ƒï¼‰"
          echo "  - ä¾èµ–åŒ…: å·²ä¸‹è½½ï¼ˆæ¥è‡ªUltraçŽ¯å¢ƒï¼‰"
          echo "  - åªéœ€ç¼–è¯‘å·®å¼‚éƒ¨åˆ†"
          
          # å¤šé‡ç¼–è¯‘ç­–ç•¥
          make -j$(nproc) || make -j1 || make -j1 V=s
          
          echo "âœ… ${{ matrix.variant }}ç¼–è¯‘å®Œæˆ"

      - name: ðŸ§¹ æ¸…ç†${{ matrix.variant }}ç¼–è¯‘ä¸­é—´äº§ç‰©
        run: |
          cd /workdir/openwrt
          echo "ðŸ§¹ æ¸…ç†${{ matrix.variant }}ç¼–è¯‘ä¸­é—´äº§ç‰©ä»¥é‡Šæ”¾ç©ºé—´"
          
          # ä¿ç•™å¿…è¦æ–‡ä»¶ï¼Œæ¸…ç†ä¸­é—´äº§ç‰©
          find build_dir -name ".pkgdir" -type d -exec rm -rf {} + 2>/dev/null || true
          find build_dir -name "*.ipk" -delete 2>/dev/null || true
          find staging_dir -name ".pkginfo" -type f -delete 2>/dev/null || true
          find staging_dir -name "*.control" -type f -delete 2>/dev/null || true
          
          # æ¸…ç†å·¥å…·é“¾ä¸´æ—¶æ–‡ä»¶
          find build_dir/host -name "*.a" -delete 2>/dev/null || true
          find build_dir/host -name "*.o" -delete 2>/dev/null || true
          
          # æ¸…ç†ä¸‹è½½ç›®å½•ä¸­çš„ä¸´æ—¶æ–‡ä»¶
          find dl -name "*.tmp" -delete 2>/dev/null || true
          find dl -name "*.partial" -delete 2>/dev/null || true
          
          echo "âœ… æ¸…ç†å®Œæˆ"
          df -h

      - name: æ•´ç†${{ matrix.variant }}å›ºä»¶
        run: |
          cd /workdir/openwrt/bin/targets/*/*
          echo "ðŸ“¦ æ•´ç†${{ matrix.variant }}å›ºä»¶"
          
          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p $GITHUB_WORKSPACE/firmware/${{ matrix.variant }}
          
          # å¤åˆ¶å›ºä»¶æ–‡ä»¶
          find . -name "*immortalwrt*" -type f ! -name "*manifest*" | \
            xargs -I {} cp {} $GITHUB_WORKSPACE/firmware/${{ matrix.variant }}/
          
          # é‡å‘½åå›ºä»¶
          cd $GITHUB_WORKSPACE/firmware/${{ matrix.variant }}
          for file in *; do
            if [ -f "$file" ]; then
              mv "$file" "${{ matrix.variant }}-${{ needs.prepare.outputs.build_date }}-${file}"
            fi
          done
          
          echo "âœ… ${{ matrix.variant }}å›ºä»¶æ•´ç†å®Œæˆ"
          ls -la

  # å‘å¸ƒé˜¶æ®µ
  release:
    runs-on: ubuntu-22.04
    needs: [prepare, build-base-ultra, build-variants]
    if: always() && (needs.build-base-ultra.result == 'success' || needs.build-variants.result == 'success')
    
    steps:
      - name: æ•´ç†æ‰€æœ‰å›ºä»¶
        run: |
          mkdir -p $GITHUB_WORKSPACE/release
          
          # å¤åˆ¶æ‰€æœ‰å˜ä½“å›ºä»¶
          for variant in Ultra Max Pro; do
            if [ -d "firmware/$variant" ]; then
              echo "ðŸ“¦ å¤åˆ¶$variantå›ºä»¶"
              cp -r firmware/$variant/* release/
            fi
          done
          
          # ç”Ÿæˆå›ºä»¶ä¿¡æ¯æ–‡ä»¶
          cd $GITHUB_WORKSPACE/release
          cat > firmware_info.md << 'EOF'
          # OpenWrt IPQ60x2 å›ºä»¶å‘å¸ƒ
          
          ## ðŸ“‹ å›ºä»¶ä¿¡æ¯
          - **æž„å»ºæ—¶é—´**: ${BUILD_DATE}
          - **æºç åˆ†æ”¯**: ${REPO_BRANCH}
          - **æºç ä»“åº“**: ${IMMWRT_REPO}
          - **é…ç½®å“ˆå¸Œ**: ${CONFIG_HASH}
          - **ç¼“å­˜å‘½ä¸­**: ${CACHE_HIT}
          
          ## ðŸ”§ å›ºä»¶è®¾ç½®
          - **IPåœ°å€**: ${FIRMWARE_IP}
          - **æœºå™¨å**: ${FIRMWARE_NAME}
          - **å¯†ç **: ç©ºå¯†ç 
          - **ç™»å½•æ–¹å¼**: SSHæˆ–Webç•Œé¢
          
          ## ðŸ“¦ å˜ä½“è¯´æ˜Ž
          - **Ultra**: å®Œæ•´åŠŸèƒ½ç‰ˆæœ¬ï¼ŒåŒ…å«æ‰€æœ‰å¯ç”¨æ’ä»¶å’ŒåŠŸèƒ½
          - **Max**: åŠŸèƒ½å¢žå¼ºç‰ˆæœ¬ï¼Œå¹³è¡¡æ€§èƒ½å’ŒåŠŸèƒ½
          - **Pro**: ä¸“ä¸šä¼˜åŒ–ç‰ˆæœ¬ï¼Œç²¾ç®€ä¼˜åŒ–ï¼Œé€‚åˆé«˜çº§ç”¨æˆ·
          
          ## ðŸš€ ä½¿ç”¨è¯´æ˜Ž
          1. ä¸‹è½½å¯¹åº”å˜ä½“çš„å›ºä»¶æ–‡ä»¶
          2. é€šè¿‡è·¯ç”±å™¨åŽå°æˆ–TFTPæ–¹å¼åˆ·å…¥
          3. åˆ·å…¥åŽè®¿é—® ${FIRMWARE_IP}
          4. ç”¨æˆ·å: rootï¼Œå¯†ç : ç©º
          
          ## âš ï¸ æ³¨æ„äº‹é¡¹
          - é¦–æ¬¡åˆ·æœºå»ºè®®ä½¿ç”¨U-Bootåˆ·æœº
          - å¤‡ä»½åŽŸåŽ‚å›ºä»¶ä»¥é˜²ä¸‡ä¸€
          - åˆ·æœºå‰è¯·ç¡®è®¤è®¾å¤‡åž‹å·
          
          ---
          æž„å»ºç³»ç»Ÿ: GitHub Actions
          æž„å»ºä»»åŠ¡: ${RUN_ID}
          EOF
          
          # æ›¿æ¢å˜é‡
          sed -i "s/\${BUILD_DATE}/${{ needs.prepare.outputs.build_date }}/g" firmware_info.md
          sed -i "s/\${REPO_BRANCH}/${{ needs.prepare.outputs.immwrt_branch }}/g" firmware_info.md
          sed -i "s#\${IMMWRT_REPO}#${{ needs.prepare.outputs.immwrt_repo }}#g" firmware_info.md
          sed -i "s/\${CONFIG_HASH}/${{ needs.prepare.outputs.config_hash }}/g" firmware_info.md
          sed -i "s/\${CACHE_HIT}/${{ needs.build-base-ultra.outputs.cache-hit }}/g" firmware_info.md
          sed -i "s/\${FIRMWARE_IP}/${{ env.FIRMWARE_IP }}/g" firmware_info.md
          sed -i "s/\${FIRMWARE_NAME}/${{ env.FIRMWARE_NAME }}/g" firmware_info.md
          sed -i "s/\${RUN_ID}/${{ github.run_id }}/g" firmware_info.md
          
          echo "âœ… å›ºä»¶æ•´ç†å®Œæˆ"
          ls -la

      - name: ç”Ÿæˆæ ¡éªŒå’Œ
        run: |
          cd $GITHUB_WORKSPACE/release
          echo "ðŸ” ç”Ÿæˆæ–‡ä»¶æ ¡éªŒå’Œ"
          sha256sum * > sha256sums.txt
          md5sum * > md5sums.txt
          echo "âœ… æ ¡éªŒå’Œç”Ÿæˆå®Œæˆ"

      - name: åˆ›å»ºRelease
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.release_tag }}
          name: "OpenWrt IPQ60x2 ${{ needs.prepare.outputs.build_date }}"
          body_path: release/firmware_info.md
          files: |
            release/*
            !release/firmware_info.md
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ä¸Šä¼ æž„å»ºæ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ needs.prepare.outputs.build_date }}
          path: |
            /workdir/openwrt/logs/
            /workdir/openwrt/.config
          retention-days: 30

      - name: æž„å»ºç»“æžœæ±‡æ€»
        if: always()
        run: |
          echo "## ðŸ“Š æž„å»ºç»“æžœæ±‡æ€»" >> $GITHUB_STEP_SUMMARY
          echo "| å˜ä½“ | çŠ¶æ€ | å›ºä»¶æ•°é‡ | ç¼“å­˜å‘½ä¸­ | Luciæ£€æŸ¥ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|----------|----------|----------|" >> $GITHUB_STEP_SUMMARY
          
          # Ultraå˜ä½“
          if [ -d "firmware/Ultra" ]; then
            count=$(ls firmware/Ultra/*.bin 2>/dev/null | wc -l)
            status="âœ… æˆåŠŸ"
          else
            count=0
            status="âŒ å¤±è´¥"
          fi
          echo "| Ultra | $status | $count | ${{ needs.build-base-ultra.outputs.cache_hit }} | âœ… å·²æ£€æŸ¥ |" >> $GITHUB_STEP_SUMMARY
          
          # Maxå’ŒProå˜ä½“
          for variant in Max Pro; do
            if [ -d "firmware/$variant" ]; then
              count=$(ls firmware/$variant/*.bin 2>/dev/null | wc -l)
              status="âœ… æˆåŠŸ"
            else
              count=0
              status="âŒ å¤±è´¥"
            fi
            echo "| $variant | $status | $count | ${{ needs.build-base-ultra.outputs.cache_hit }} | âœ… å·²æ£€æŸ¥ |" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“ˆ æž„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **Releaseæ ‡ç­¾**: ${{ needs.prepare.outputs.release_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æž„å»ºæ—¥æœŸ**: ${{ needs.prepare.outputs.build_date }}" >> $GITHUB_STEP_SUMMARY
          echo "- **é…ç½®å“ˆå¸Œ**: ${{ needs.prepare.outputs.config_hash }}" >> $GITHUB_STEP_SUMMARY
          echo "- **UltraçŽ¯å¢ƒç¼“å­˜**: ${{ needs.build-base-ultra.outputs.cache_hit }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç¼“å­˜æ—¥æœŸæ ‡è®°**: ${{ needs.prepare.outputs.cache_date_mark }}" >> $GITHUB_STEP_SUMMARY
          
          # ä¸‹è½½é“¾æŽ¥
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## â¬‡ï¸ ä¸‹è½½é“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
          echo "[æŸ¥çœ‹æ‰€æœ‰å›ºä»¶](https://github.com/${{ github.repository }}/releases/tag/${{ needs.prepare.outputs.release_tag }})" >> $GITHUB_STEP_SUMMARY
