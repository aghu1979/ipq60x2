# .github/workflows/build.yml
# =============================================================================
# ImmortalWrt 自动编译工作流 (优化版)
# 版本: 2.3.1
# 更新日期: 2025-11-19
# =============================================================================

name: ImmortalWrt Auto Build

on:
  workflow_dispatch:
  # schedule:
  #   - cron: '0 8 * * 1'

env:
  REPO_URL: https://github.com/laipeng668/immortalwrt.git
  REPO_BRANCH: master
  TZ: Asia/Shanghai

jobs:
  setup:
    runs-on: ubuntu-24.04
    outputs:
      devices: ${{ steps.extract-devices.outputs.devices }}
      cache-key: ${{ steps.cache-key.outputs.key }}
      release-tag: ${{ steps.vars.outputs.release-tag }}
      build-date: ${{ steps.vars.outputs.build-date }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 授权脚本
        run: chmod +x $GITHUB_WORKSPACE/scripts/*.sh

      - name: 初始化编译环境
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          # 清理运行器环境，但保留必要的软件源
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          # 更新包列表
          sudo -E apt-get -y update
          
          # 尝试使用原作者的依赖安装脚本
          echo ">>> 尝试使用原作者的依赖安装脚本..."
          if ! sudo -E apt-get -y install $(curl -fsSL ophub.org/ubuntu2404-make-openwrt-depends); then
            echo ">>> 原作者的脚本失败，回退到备用依赖列表..."
            # 备用依赖列表，适用于 Ubuntu 24.04
            sudo -E apt-get -y install \
              build-essential clang flex g++ gawk gcc-multilib gettext \
              git libncurses5-dev libssl-dev python3-distutils python3-pyelftools \
              python3-setuptools python3-venv rsync unzip zlib1g-dev wget file \
              ccache ecj fastjar java-propose-classpath libelf-dev \
              libgcrypt20-dev libgmp-dev libltdl-dev libmpc-dev libmpfr-dev \
              libncursesw5-dev libpython3-dev libreadline-dev libsqlite3-dev \
              libtool-bin m4 mkisofs ninja-build p7zip p7zip-full patch pkgconf \
              python3-debian python3-pip python3-pyelftools python3-yaml \
              qemu-user-static re2c sharutils subversion swig texinfo uglifyjs \
              upx-ucl xsltproc zip zlib1g-dev
          fi
          
          # 清理不需要的包
          sudo -E apt-get -y autoremove --purge
          sudo -E apt-get -y clean
          # 重载 systemd
          sudo -E systemctl daemon-reload
          # 设置时区
          sudo timedatectl set-timezone "$TZ"
          # 创建工作目录
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: 设置变量
        id: vars
        run: |
          build_date=$(date +'%Y.%m.%d')
          echo "build-date=$build_date" >> $GITHUB_OUTPUT
          release_tag="imm-$(date +'%Y%m%d')"
          echo "release-tag=$release_tag" >> $GITHUB_OUTPUT

      - name: 提取设备信息
        id: extract-devices
        run: |
          devices_json=$(bash $GITHUB_WORKSPACE/scripts/extract-devices.sh $GITHUB_WORKSPACE/configs/base_ipq60xx.config)
          echo "devices=$devices_json" >> $GITHUB_OUTPUT
          echo "$devices_json" > devices.json

      - name: 生成智能缓存键
        id: cache-key
        run: |
          config_hash=$(cat $GITHUB_WORKSPACE/configs/*.config $GITHUB_WORKSPACE/scripts/diy.sh | sha256sum | cut -d' ' -f1)
          key="immwrt-${{ github.sha }}-${config_hash}"
          echo "key=$key" >> $GITHUB_OUTPUT
          echo "生成的智能缓存键: $key"

      - name: 上传设备信息
        uses: actions/upload-artifact@v4
        with:
          name: build-metadata
          path: devices.json

  build-ultra:
    needs: setup
    runs-on: ubuntu-24.04
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 授权脚本
        run: chmod +x $GITHUB_WORKSPACE/scripts/*.sh

      - name: 初始化编译环境
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          # 清理运行器环境，但保留必要的软件源
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          # 更新包列表
          sudo -E apt-get -y update
          
          # 尝试使用原作者的依赖安装脚本
          echo ">>> 尝试使用原作者的依赖安装脚本..."
          if ! sudo -E apt-get -y install $(curl -fsSL ophub.org/ubuntu2404-make-openwrt-depends); then
            echo ">>> 原作者的脚本失败，回退到备用依赖列表..."
            # 备用依赖列表，适用于 Ubuntu 24.04
            sudo -E apt-get -y install \
              build-essential clang flex g++ gawk gcc-multilib gettext \
              git libncurses5-dev libssl-dev python3-distutils python3-pyelftools \
              python3-setuptools python3-venv rsync unzip zlib1g-dev wget file \
              ccache ecj fastjar java-propose-classpath libelf-dev \
              libgcrypt20-dev libgmp-dev libltdl-dev libmpc-dev libmpfr-dev \
              libncursesw5-dev libpython3-dev libreadline-dev libsqlite3-dev \
              libtool-bin m4 mkisofs ninja-build p7zip p7zip-full patch pkgconf \
              python3-debian python3-pip python3-pyelftools python3-yaml \
              qemu-user-static re2c sharutils subversion swig texinfo uglifyjs \
              upx-ucl xsltproc zip zlib1g-dev
          fi
          
          # 清理不需要的包
          sudo -E apt-get -y autoremove --purge
          sudo -E apt-get -y clean
          # 重载 systemd
          sudo -E systemctl daemon-reload
          # 设置时区
          sudo timedatectl set-timezone "$TZ"
          # 创建工作目录
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: 克隆源码
        working-directory: /workdir
        run: |
          df -hT $PWD
          git clone $REPO_URL -b $REPO_BRANCH immortalwrt
          ln -sf /workdir/immortalwrt $GITHUB_WORKSPACE/immortalwrt

      - name: 扩展磁盘空间
        run: |
          cd /workdir/immortalwrt
          echo ">>> 扩展磁盘空间，将大文件夹链接到 /mnt/g..."
          df -h

          # 在大容量磁盘 /mnt/g 上创建目录
          echo ">>> 在大容量磁盘 /mnt/g 上创建目录..."
          mkdir -p /mnt/g/openwrt-build/dl
          mkdir -p /mnt/g/openwrt-build/build_dir
          mkdir -p /mnt/g/openwrt-build/tmp

          # 删除源码目录中原有的目录并创建软链接
          echo ">>> 删除源码目录中的大文件夹并创建软链接..."
          rm -rf ./dl ./build_dir ./tmp
          ln -s /mnt/g/openwrt-build/dl ./dl
          ln -s /mnt/g/openwrt-build/build_dir ./build_dir
          ln -s /mnt/g/openwrt-build/tmp ./tmp

          echo ">>> 软链接创建完成:"
          ls -l . | grep '^l'
          
          echo ">>> 扩展后的磁盘使用情况:"
          df -h

      - name: 加载或回退缓存
        uses: actions/cache@v4
        with:
          path: /workdir/immortalwrt
          key: ${{ needs.setup.outputs.cache-key }}
          restore-keys: |
            immwrt-

      - name: 合并配置文件
        run: |
          bash $GITHUB_WORKSPACE/scripts/merge-configs.sh $GITHUB_WORKSPACE/configs/base_ipq60xx.config $GITHUB_WORKSPACE/configs/base_immwrt.config $GITHUB_WORKSPACE/configs/Ultra.config /workdir/immortalwrt/.config

      - name: 执行自定义DIY脚本
        run: |
          cp $GITHUB_WORKSPACE/scripts/diy.sh /workdir/immortalwrt/
          cd /workdir/immortalwrt
          ./diy.sh

      - name: 生成Luci软件包报告
        id: generate-report
        run: |
          # DIY脚本已执行，现在生成最终报告
          report_output=$(bash $GITHUB_WORKSPACE/scripts/luci-report.sh /workdir/immortalwrt Ultra $GITHUB_WORKSPACE/luci_report.txt)
          echo "$report_output"
          echo "has_list=$(echo "$report_output" | grep '^has_list=' | cut -d'=' -f2)" >> $GITHUB_OUTPUT

      - name: 上传Luci报告
        if: steps.generate-report.outputs.has_list != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: luci-report-ultra
          path: luci_report.txt

      - name: 下载软件包
        run: |
          cd /workdir/immortalwrt
          make defconfig
          make download -j$(nproc)

      - name: 编译固件
        run: |
          cd /workdir/immortalwrt
          echo -e "$(nproc) 线程编译 Ultra 变体"
          make -j$(nproc) || make -j1 || make -j1 V=s

      - name: 检查磁盘剩余空间
        if: (!cancelled())
        run: |
          echo ">>> 编译完成，最终磁盘使用情况:"
          df -hT

      - name: 上传固件工件
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-firmware-ultra
          path: /workdir/immortalwrt/bin/targets/

  build-others:
    needs: [setup, build-ultra]
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        variant: [Max, Pro]
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 授权脚本
        run: chmod +x $GITHUB_WORKSPACE/scripts/*.sh

      - name: 初始化编译环境
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          # 清理运行器环境，但保留必要的软件源
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          # 更新包列表
          sudo -E apt-get -y update
          
          # 尝试使用原作者的依赖安装脚本
          echo ">>> 尝试使用原作者的依赖安装脚本..."
          if ! sudo -E apt-get -y install $(curl -fsSL ophub.org/ubuntu2404-make-openwrt-depends); then
            echo ">>> 原作者的脚本失败，回退到备用依赖列表..."
            # 备用依赖列表，适用于 Ubuntu 24.04
            sudo -E apt-get -y install \
              build-essential clang flex g++ gawk gcc-multilib gettext \
              git libncurses5-dev libssl-dev python3-distutils python3-pyelftools \
              python3-setuptools python3-venv rsync unzip zlib1g-dev wget file \
              ccache ecj fastjar java-propose-classpath libelf-dev \
              libgcrypt20-dev libgmp-dev libltdl-dev libmpc-dev libmpfr-dev \
              libncursesw5-dev libpython3-dev libreadline-dev libsqlite3-dev \
              libtool-bin m4 mkisofs ninja-build p7zip p7zip-full patch pkgconf \
              python3-debian python3-pip python3-pyelftools python3-yaml \
              qemu-user-static re2c sharutils subversion swig texinfo uglifyjs \
              upx-ucl xsltproc zip zlib1g-dev
          fi
          
          # 清理不需要的包
          sudo -E apt-get -y autoremove --purge
          sudo -E apt-get -y clean
          # 重载 systemd
          sudo -E systemctl daemon-reload
          # 设置时区
          sudo timedatectl set-timezone "$TZ"
          # 创建工作目录
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: 克隆源码
        working-directory: /workdir
        run: |
          git clone $REPO_URL -b $REPO_BRANCH immortalwrt
          ln -sf /workdir/immortalwrt $GITHUB_WORKSPACE/immortalwrt

      - name: 扩展磁盘空间
        run: |
          cd /workdir/immortalwrt
          echo ">>> 扩展磁盘空间，将大文件夹链接到 /mnt/g..."
          df -h

          # 在大容量磁盘 /mnt/g 上创建目录
          echo ">>> 在大容量磁盘 /mnt/g 上创建目录..."
          mkdir -p /mnt/g/openwrt-build/dl
          mkdir -p /mnt/g/openwrt-build/build_dir
          mkdir -p /mnt/g/openwrt-build/tmp

          # 删除源码目录中原有的目录并创建软链接
          echo ">>> 删除源码目录中的大文件夹并创建软链接..."
          rm -rf ./dl ./build_dir ./tmp
          ln -s /mnt/g/openwrt-build/dl ./dl
          ln -s /mnt/g/openwrt-build/build_dir ./build_dir
          ln -s /mnt/g/openwrt-build/tmp ./tmp

          echo ">>> 软链接创建完成:"
          ls -l . | grep '^l'
          
          echo ">>> 扩展后的磁盘使用情况:"
          df -h

      - name: 加载Ultra缓存
        uses: actions/cache@v4
        with:
          path: /workdir/immortalwrt
          key: ${{ needs.setup.outputs.cache-key }}

      - name: 合并配置文件
        run: |
          bash $GITHUB_WORKSPACE/scripts/merge-configs.sh $GITHUB_WORKSPACE/configs/base_ipq60xx.config $GITHUB_WORKSPACE/configs/base_immwrt.config $GITHUB_WORKSPACE/configs/${{ matrix.variant }}.config /workdir/immortalwrt/.config

      - name: 执行自定义DIY脚本
        run: |
          cp $GITHUB_WORKSPACE/scripts/diy.sh /workdir/immortalwrt/
          cd /workdir/immortalwrt
          ./diy.sh

      - name: 生成Luci软件包报告
        id: generate-report
        run: |
          # DIY脚本已执行，现在生成最终报告
          report_output=$(bash $GITHUB_WORKSPACE/scripts/luci-report.sh /workdir/immortalwrt ${{ matrix.variant }} $GITHUB_WORKSPACE/luci_report.txt)
          echo "$report_output"
          echo "has_list=$(echo "$report_output" | grep '^has_list=' | cut -d'=' -f2)" >> $GITHUB_OUTPUT

      - name: 上传Luci报告
        if: steps.generate-report.outputs.has_list != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: luci-report-${{ matrix.variant }}
          path: luci_report.txt

      - name: 下载软件包
        run: |
          cd /workdir/immortalwrt
          make defconfig
          make download -j$(nproc)

      - name: 编译固件
        run: |
          cd /workdir/immortalwrt
          echo -e "$(nproc) 线程编译 ${{ matrix.variant }} 变体 (基于Ultra缓存)"
          make -j$(nproc) || make -j1 || make -j1 V=s

      - name: 检查磁盘剩余空间
        if: (!cancelled())
        run: |
          echo ">>> 编译完成，最终磁盘使用情况:"
          df -hT

      - name: 上传固件工件
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-firmware-${{ matrix.variant }}
          path: /workdir/immortalwrt/bin/targets/

  release:
    needs: [setup, build-ultra, build-others]
    runs-on: ubuntu-24.04
    if: needs.build-ultra.result == 'success' && needs.build-others.result == 'success'
    steps:
      - name: 下载所有固件工件
        uses: actions/download-artifact@v4
        with:
          pattern: immortalwrt-firmware-*
          merge-multiple: true
          path: artifacts/firmware

      - name: 下载所有Luci报告工件
        uses: actions/download-artifact@v4
        with:
          pattern: luci-report-*
          merge-multiple: true
          path: artifacts/reports

      - name: 下载元数据
        uses: actions/download-artifact@v4
        with:
          name: build-metadata
          path: artifacts/metadata

      - name: 整理发布文件
        run: |
          mkdir -p release
          find artifacts/firmware -name "*.img" -o -name "*.bin" -o -name "*.tar.gz" | xargs -I {} cp {} release/
          ls -la release/

      - name: 生成发布说明
        run: |
          cat > release_notes.md << EOF
          # ImmortalWrt 固件发布
          
          ## 版本信息
          - 构建日期: ${{ needs.setup.outputs.build-date }}
          - 发布标签: ${{ needs.setup.outputs.release-tag }}
          - 源码分支: ${{ env.REPO_BRANCH }}
          
          ## 变体配置
          - **Ultra**: 包含所有功能，适合高级用户
          - **Max**: 包含大部分常用功能
          - **Pro**: 精简版本，只包含基本功能
          
          ## 设备支持
          \`\`\`json
          $(cat artifacts/metadata/devices.json)
          \`\`\`
          
          ## Luci软件包报告
          EOF

          for report_file in artifacts/reports/*.txt; do
            if [ -f "$report_file" ]; then
              variant_name=$(basename "$report_file" .txt | sed 's/luci-report-//')
              echo "" >> release_notes.md
              echo "### $variant_name 变体" >> release_notes.md
              echo '```' >> release_notes.md
              cat "$report_file" >> release_notes.md
              echo '```' >> release_notes.md
            fi
          done
          
          cat >> release_notes.md << EOF
          
          ## 使用说明
          1. 下载对应设备的固件文件。
          2. 通过设备恢复界面或系统升级界面刷入固件。
          3. 刷入后恢复出厂设置。
          
          ## 注意事项
          - 刷机有风险，请谨慎操作。
          - 建议刷机前备份原厂固件。
          - 如遇问题，请到项目主页提交Issue。
          EOF

      - name: 创建GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.setup.outputs.release-tag }}
          body_path: release_notes.md
          files: release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
