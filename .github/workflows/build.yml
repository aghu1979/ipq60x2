# .github/workflows/build.yml
# =============================================================================
# ImmortalWrt å›ºä»¶ç¼–è¯‘ç³»ç»Ÿå·¥ä½œæµ
# ç‰ˆæœ¬: 1.0.7
# æ›´æ–°æ—¥æœŸ: 2025-11-18
# =============================================================================

name: ImmortalWrt å›ºä»¶ç¼–è¯‘ç³»ç»Ÿ

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  # ç‰ˆæœ¬æ§åˆ¶
  VERSION: "1.0.7"
  RELEASE_DATE: "2025-11-18"
  
  # ä»“åº“é…ç½®
  REPO_OWNER: laipeng668
  REPO_NAME: immortalwrt
  REPO_BRANCH: master
  
  # å›ºä»¶é…ç½®
  FIRMWARE_IP: "192.168.111.1"
  FIRMWARE_NAME: "WRT"
  AUTHOR_NAME: "Mary"
  
  # ç³»ç»Ÿé…ç½®
  TZ: "Asia/Shanghai"

jobs:
  prepare:
    runs-on: ubuntu-24.04
    outputs:
      device_list: ${{ steps.extract_devices.outputs.devices }}
      cache_key: ${{ steps.cache_key.outputs.key }}
      cache_version: ${{ steps.cache_key.outputs.version }}
    steps:
    - name: ğŸš€ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ“… è®¾ç½®ç¯å¢ƒå˜é‡
      run: |
        echo "BUILD_DATE=$(date +%Y-%m-%d)" >> $GITHUB_ENV
        echo "BUILD_TIME=$(date +%H:%M:%S)" >> $GITHUB_ENV
        echo "BUILD_TIMESTAMP=$(date +%s)" >> $GITHUB_ENV
        echo "TOOLCHAIN_VERSION=$(date +%Y%m%d)" >> $GITHUB_ENV

    - name: ğŸ“¦ å®‰è£…å¿…è¦çš„è½¯ä»¶åŒ…
      run: |
        sudo apt-get update
        
        # å®‰è£…åŸºç¡€ç¼–è¯‘å·¥å…·å’Œä¾èµ–
        sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk gettext git java-propose-classpath libelf-dev libncurses5-dev libncursesw5-dev libssl-dev python3 unzip python3-pyelftools python3-pip rsync subversion swig time wget vim python3-pyelftools python3-dev curl jq
        
        # å®‰è£…ç³»ç»Ÿåº“ä¾èµ–ï¼Œè§£å†³ç¼–è¯‘è­¦å‘Š
        sudo apt-get install -y \
          libpam0g-dev \
          libtirpc-dev \
          libev-dev \
          libsensors-dev \
          liblzma-dev \
          libsnmp-dev \
          libglib2.0-dev \
          libgpiod-dev
        
        echo -e "\033[1;32mâœ… è½¯ä»¶åŒ…å®‰è£…å®Œæˆ\033[0m"

    - name: ğŸ”‘ åˆ›å»ºç¼“å­˜é”®
      id: cache_key
      run: |
        # ä½¿ç”¨æºç åˆ†æ”¯ã€å·¥å…·é“¾ç‰ˆæœ¬å’Œæ—¥æœŸä½œä¸ºç¼“å­˜é”®
        echo "key=immwrt-${{ env.REPO_BRANCH }}-${{ env.TOOLCHAIN_VERSION }}" >> $GITHUB_OUTPUT
        echo "version=${{ env.VERSION }}-${{ env.RELEASE_DATE }}" >> $GITHUB_OUTPUT
        echo -e "\033[1;32mâœ… ç¼“å­˜é”®: immwrt-${{ env.REPO_BRANCH }}-${{ env.TOOLCHAIN_VERSION }}\033[0m"

    - name: ğŸ“± æå–è®¾å¤‡åç§°
      id: extract_devices
      run: |
        # åˆ›å»ºè®¾å¤‡æå–è„šæœ¬
        cat > extract_devices.sh << 'EOF'
        #!/bin/bash
        # =============================================================================
        # è®¾å¤‡åç§°æå–è„šæœ¬
        # ç‰ˆæœ¬: 1.0.7
        # æ›´æ–°æ—¥æœŸ: 2025-11-18
        # =============================================================================
        
        # é¢œè‰²å®šä¹‰
        RED='\033[0;31m'
        GREEN='\033[0;32m'
        YELLOW='\033[1;33m'
        BLUE='\033[0;34m'
        NC='\033[0m' # No Color
        
        # æ£€æŸ¥å‚æ•°
        if [ $# -lt 1 ]; then
            echo -e "${RED}âŒ ç”¨æ³•: $0 <é…ç½®æ–‡ä»¶è·¯å¾„>${NC}"
            exit 1
        fi
        
        CONFIG_FILE=$1
        
        # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "$CONFIG_FILE" ]; then
            echo -e "${RED}âŒ é”™è¯¯: é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $CONFIG_FILE${NC}"
            exit 1
        fi
        
        # æå–è®¾å¤‡åç§°
        echo -e "${BLUE}ğŸ“± æå–è®¾å¤‡åç§°...${NC}"
        
        # ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–è®¾å¤‡åç§°
        devices=$(grep -E 'CONFIG_TARGET_.*qualcommax_ipq60xx_DEVICE_[^=]+=y' "$CONFIG_FILE" | sed -E 's/CONFIG_TARGET_.*qualcommax_ipq60xx_DEVICE_([^=]+)=y/\1/' | sort -u)
        
        if [ -z "$devices" ]; then
            echo -e "${YELLOW}âš ï¸ è­¦å‘Š: æœªæ‰¾åˆ°è®¾å¤‡åç§°ï¼Œä½¿ç”¨é»˜è®¤è®¾å¤‡${NC}"
            devices="jdcloud_re-ss-01 jdcloud_re-cs-02 jdcloud_rz-caa-07"
        fi
        
        echo -e "${GREEN}âœ… æ‰¾åˆ°çš„è®¾å¤‡:${NC}"
        for device in $devices; do
            echo -e "  ğŸ“± $device"
        done
        
        # è¾“å‡ºè®¾å¤‡åˆ—è¡¨ï¼Œä¾›GitHub Actionsä½¿ç”¨ï¼ˆä¸åŒ…å«é¢œè‰²ä»£ç ï¼‰
        echo "$devices"
        EOF
        
        chmod +x extract_devices.sh
        
        # æå–è®¾å¤‡åç§°
        if [ -f "configs/base_ipq60xx.config" ]; then
          # ä½¿ç”¨è„šæœ¬æå–è®¾å¤‡ï¼Œå¹¶å°†ç»“æœä¿å­˜åˆ°å˜é‡
          devices_output=$(./extract_devices.sh configs/base_ipq60xx.config)
          # è·å–æœ€åä¸€è¡Œä½œä¸ºè®¾å¤‡åˆ—è¡¨
          devices=$(echo "$devices_output" | tail -1)
        else
          # å¦‚æœé…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤è®¾å¤‡
          devices="jdcloud_re-ss-01 jdcloud_re-cs-02 jdcloud_rz-caa-07"
        fi
        
        # è¾“å‡ºç»™GitHub Actionsï¼ˆä¸åŒ…å«é¢œè‰²ä»£ç ï¼‰
        echo "devices=$devices" >> $GITHUB_OUTPUT
        echo -e "\033[1;32mâœ… æ‰¾åˆ°çš„è®¾å¤‡: $devices\033[0m"

    - name: ğŸ“ åˆ›å»ºå·¥ä½œç›®å½•
      run: |
        mkdir -p build workspace

    - name: ğŸ’¾ æ‰©å±•ç£ç›˜ç©ºé—´
      run: |
        # åˆ›å»ºè½¯é“¾æ¥æ‰©å±•ç£ç›˜ç©ºé—´
        sudo mkdir -p /mnt/ramdisk
        sudo mount -t tmpfs -o size=10G tmpfs /mnt/ramdisk
        sudo mkdir -p /mnt/ramdisk/build
        sudo chown $USER:$USER /mnt/ramdisk/build
        ln -sf /mnt/ramdisk/build ./build
        echo -e "\033[1;32mâœ… ç£ç›˜ç©ºé—´æ‰©å±•æˆåŠŸ\033[0m"

  build-ultra:
    needs: prepare
    runs-on: ubuntu-24.04
    outputs:
      cache_hit: ${{ steps.cache.outputs.cache-hit }}
      luci_packages: ${{ steps.luci_report.outputs.packages }}
    steps:
    - name: ğŸš€ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ’¾ æ¢å¤å·¥ä½œç›®å½•
      run: |
        sudo mkdir -p /mnt/ramdisk
        sudo mount -t tmpfs -o size=10G tmpfs /mnt/ramdisk
        sudo mkdir -p /mnt/ramdisk/build
        sudo chown $USER:$USER /mnt/ramdisk/build
        ln -sf /mnt/ramdisk/build ./build

    - name: ğŸ’¾ æ¢å¤ç¼“å­˜
      uses: actions/cache@v4
      id: cache
      with:
        path: |
          ./build
          ~/.ccache
        key: ${{ needs.prepare.outputs.cache_key }}-ultra
        restore-keys: |
          immwrt-${{ env.REPO_BRANCH }}-

    - name: ğŸ“¥ å…‹éš†æºç ä»“åº“
      run: |
        echo -e "\033[1;34mğŸ“¥ å¼€å§‹å…‹éš†æºç ä»“åº“...\033[0m"
        git clone https://github.com/${{ env.REPO_OWNER }}/${{ env.REPO_NAME }}.git -b ${{ env.REPO_BRANCH }} build/source
        cd build/source
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶å’Œè„šæœ¬
        if [ -d "../../configs" ]; then
          cp ../../configs/* ../configs/
        fi
        if [ -d "../../scripts" ]; then
          cp ../../scripts/* ../scripts/
          chmod +x ../scripts/*.sh
        fi

    - name: ğŸ”§ åˆå¹¶é…ç½®æ–‡ä»¶
      run: |
        cd build/source
        echo -e "\033[1;34mğŸ”§ åˆå¹¶é…ç½®æ–‡ä»¶...\033[0m"
        
        # åˆ›å»ºé…ç½®ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        mkdir -p ../configs
        
        # ä¸‹è½½é…ç½®æ–‡ä»¶ï¼ˆå¦‚æœæœ¬åœ°ä¸å­˜åœ¨ï¼‰
        if [ ! -f "../configs/base_ipq60xx.config" ]; then
          curl -L https://raw.githubusercontent.com/aghu1979/ipq60x2/main/configs/base_ipq60xx.config -o ../configs/base_ipq60xx.config
        fi
        if [ ! -f "../configs/base_immwrt.config" ]; then
          curl -L https://raw.githubusercontent.com/aghu1979/ipq60x2/main/configs/base_immwrt.config -o ../configs/base_immwrt.config
        fi
        if [ ! -f "../configs/Ultra.config" ]; then
          curl -L https://raw.githubusercontent.com/aghu1979/ipq60x2/main/configs/Ultra.config -o ../configs/Ultra.config
        fi
        
        # åˆ›å»ºåˆå¹¶é…ç½®è„šæœ¬
        cat > merge_config.sh << 'EOF'
        #!/bin/bash
        # =============================================================================
        # é…ç½®æ–‡ä»¶åˆå¹¶è„šæœ¬
        # ç‰ˆæœ¬: 1.0.7
        # æ›´æ–°æ—¥æœŸ: 2025-11-18
        # =============================================================================
        
        # é¢œè‰²å®šä¹‰
        RED='\033[0;31m'
        GREEN='\033[0;32m'
        YELLOW='\033[1;33m'
        BLUE='\033[0;34m'
        NC='\033[0m' # No Color
        
        # è·å–å‚æ•°
        BASE_CONFIG=$1
        BRANCH_CONFIG=$2
        VARIANT_CONFIG=$3
        OUTPUT_CONFIG=$4
        
        echo -e "${BLUE}ğŸ”§ åˆå¹¶é…ç½®æ–‡ä»¶...${NC}"
        
        # æ£€æŸ¥å‚æ•°
        if [ $# -lt 4 ]; then
            echo -e "${RED}âŒ é”™è¯¯: å‚æ•°ä¸è¶³${NC}"
            echo -e "${YELLOW}ç”¨æ³•: $0 <åŸºç¡€é…ç½®> <åˆ†æ”¯é…ç½®> <å˜ä½“é…ç½®> <è¾“å‡ºé…ç½®>${NC}"
            exit 1
        fi
        
        # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        for config in "$BASE_CONFIG" "$BRANCH_CONFIG" "$VARIANT_CONFIG"; do
            if [ ! -f "$config" ]; then
                echo -e "${RED}âŒ é”™è¯¯: é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $config${NC}"
                exit 1
            fi
        done
        
        # è¿‡æ»¤æ‰æ³¨é‡Šè¡Œå’Œç©ºè¡Œï¼Œåˆå¹¶é…ç½®æ–‡ä»¶
        grep -v '^#' "$BASE_CONFIG" | grep -v '^$' | grep -v '^ #' > temp_base.config
        grep -v '^#' "$BRANCH_CONFIG" | grep -v '^$' | grep -v '^ #' > temp_branch.config
        grep -v '^#' "$VARIANT_CONFIG" | grep -v '^$' | grep -v '^ #' > temp_variant.config
        
        # åˆå¹¶é…ç½®
        cat temp_base.config temp_branch.config temp_variant.config > "$OUTPUT_CONFIG"
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -f temp_base.config temp_branch.config temp_variant_config
        
        echo -e "${GREEN}âœ… é…ç½®æ–‡ä»¶åˆå¹¶å®Œæˆ${NC}"
        EOF
        
        chmod +x merge_config.sh
        
        # æ‰§è¡Œåˆå¹¶é…ç½®è„šæœ¬
        ./merge_config.sh ../configs/base_ipq60xx.config ../configs/base_immwrt.config ../configs/Ultra.config .config
        
        # è¿è¡Œ defconfig è¡¥å…¨é…ç½®
        echo -e "\033[1;34mğŸ”§ è¿è¡Œ defconfig è¡¥å…¨é…ç½®...\033[0m"
        make defconfig || echo -e "\033[1;33mâš ï¸ defconfig æœ‰è­¦å‘Šï¼Œä½†ç»§ç»­æ‰§è¡Œ${NC}"

    - name: ğŸ¨ åº”ç”¨è‡ªå®šä¹‰è„šæœ¬
      run: |
        cd build/source
        echo -e "\033[1;34mğŸ¨ åº”ç”¨è‡ªå®šä¹‰è„šæœ¬...\033[0m"
        
        # åˆ›å»ºè„šæœ¬ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        mkdir -p ../scripts
        
        # ä¸‹è½½è„šæœ¬ï¼ˆå¦‚æœæœ¬åœ°ä¸å­˜åœ¨ï¼‰
        if [ ! -f "../scripts/diy.sh" ]; then
          curl -L https://raw.githubusercontent.com/aghu1979/ipq60x2/main/scripts/diy.sh -o ../scripts/diy.sh
        fi
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        export FIRMWARE_IP="${{ env.FIRMWARE_IP }}"
        export FIRMWARE_NAME="${{ env.FIRMWARE_NAME }}"
        export AUTHOR_NAME="${{ env.AUTHOR_NAME }}"
        
        # æ‰§è¡Œè„šæœ¬
        chmod +x ../scripts/diy.sh
        ../scripts/diy.sh || echo -e "\033[1;33mâš ï¸ diy.sh æ‰§è¡Œæœ‰è­¦å‘Šï¼Œä½†ç»§ç»­æ‰§è¡Œ${NC}"

    - name: ğŸ“¦ æ·»åŠ ç¬¬ä¸‰æ–¹è½¯ä»¶æº
      run: |
        cd build/source
        echo -e "\033[1;34mğŸ“¦ æ·»åŠ ç¬¬ä¸‰æ–¹è½¯ä»¶æº...\033[0m"
        
        # åˆ›å»ºè„šæœ¬ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        mkdir -p ../scripts
        
        # ä¸‹è½½è„šæœ¬ï¼ˆå¦‚æœæœ¬åœ°ä¸å­˜åœ¨ï¼‰
        if [ ! -f "../scripts/repo.sh" ]; then
          curl -L https://raw.githubusercontent.com/aghu1979/ipq60x2/main/scripts/repo.sh -o ../scripts/repo.sh
        fi
        
        # æ‰§è¡Œè„šæœ¬
        chmod +x ../scripts/repo.sh
        ../scripts/repo.sh || echo -e "\033[1;33mâš ï¸ repo.sh æ‰§è¡Œæœ‰è­¦å‘Šï¼Œä½†ç»§ç»­æ‰§è¡Œ${NC}"

    - name: ğŸ”„ æ›´æ–° feeds
      run: |
        cd build/source
        echo -e "\033[1;34mğŸ”„ æ›´æ–° feeds...\033[0m"
        ./scripts/feeds update -a || echo -e "\033[1;33mâš ï¸ feeds update æœ‰è­¦å‘Šï¼Œä½†ç»§ç»­æ‰§è¡Œ${NC}"
        echo -e "\033[1;34mğŸ“¦ å®‰è£… feeds...\033[0m"
        ./scripts/feeds install -a || echo -e "\033[1;33mâš ï¸ feeds install æœ‰è­¦å‘Šï¼Œä½†ç»§ç»­æ‰§è¡Œ${NC}"

    - name: ğŸ“‹ ç”ŸæˆLUCIè½¯ä»¶åŒ…æŠ¥å‘Š
      id: luci_report
      run: |
        cd build/source
        echo -e "\033[1;33mğŸ“‹ ç”ŸæˆLUCIè½¯ä»¶åŒ…æŠ¥å‘Š...\033[0m"
        
        # æå–æ‰€æœ‰luciè½¯ä»¶åŒ…
        grep -E '^CONFIG_PACKAGE_luci.*=y$' .config > ../luci-packages.txt || true
        
        # ç»Ÿè®¡æ•°é‡
        if [ -f "../luci-packages.txt" ]; then
          count=$(wc -l < ../luci-packages.txt)
          packages=$(cat ../luci-packages.txt | sed 's/CONFIG_PACKAGE_//g' | sed 's/=y//g' | tr '\n' ' ')
          echo "packages=$packages" >> $GITHUB_OUTPUT
          echo -e "\033[1;36mğŸ“¦ Ultraå˜ä½“åŒ…å«çš„LUCIè½¯ä»¶åŒ… ($countä¸ª):\033[0m"
          cat ../luci-packages.txt | while read line; do
            pkg=$(echo $line | sed 's/CONFIG_PACKAGE_//g' | sed 's/=y//g')
            echo -e "  âœ¨ $pkg"
          done
        else
          echo "packages=" >> $GITHUB_OUTPUT
          echo -e "\033[1;33mğŸ“­ æœªæ‰¾åˆ°LUCIè½¯ä»¶åŒ…\033[0m"
        fi

    - name: ğŸ”¨ ç¼–è¯‘å›ºä»¶
      run: |
        cd build/source
        echo -e "\033[1;34mğŸ”¨ å¼€å§‹ç¼–è¯‘å›ºä»¶...\033[0m"
        make -j$(nproc) || make -j1 || echo -e "\033[1;31mâŒ ç¼–è¯‘å¤±è´¥\033[0m"

    - name: ğŸ“¦ æ•´ç†ç¼–è¯‘äº§ç‰©
      run: |
        cd build/source
        mkdir -p ../output/ultra
        
        for device in ${{ needs.prepare.outputs.device_list }}; do
          if [ -f "bin/targets/qualcommax/ipq60xx/immortalwrt-*-qualcommax-ipq60xx-${device}-squashfs-sysupgrade.bin" ]; then
            cp "bin/targets/qualcommax/ipq60xx/immortalwrt-*-qualcommax-ipq60xx-${device}-squashfs-sysupgrade.bin" "../output/ultra/"
            mv "../output/ultra/immortalwrt-*-qualcommax-ipq60xx-${device}-squashfs-sysupgrade.bin" "../output/ultra/ImmortalWrt-${device}-Ultra-${{ env.BUILD_DATE }}.bin"
            echo -e "\033[1;32mâœ… é‡å‘½å: ImmortalWrt-${device}-Ultra-${{ env.BUILD_DATE }}.bin\033[0m"
          fi
        done

    - name: ğŸ“¤ ä¸Šä¼ ç¼–è¯‘äº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-ultra
        path: build/output/ultra/
        retention-days: 7

  build-max:
    needs: [prepare, build-ultra]
    runs-on: ubuntu-24.04
    steps:
    - name: ğŸš€ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ’¾ æ¢å¤å·¥ä½œç›®å½•
      run: |
        sudo mkdir -p /mnt/ramdisk
        sudo mount -t tmpfs -o size=10G tmpfs /mnt/ramdisk
        sudo mkdir -p /mnt/ramdisk/build
        sudo chown $USER:$USER /mnt/ramdisk/build
        ln -sf /mnt/ramdisk/build ./build

    - name: ğŸ’¾ æ¢å¤ç¼“å­˜
      uses: actions/cache@v4
      with:
        path: |
          ./build
          ~/.ccache
        key: ${{ needs.prepare.outputs.cache_key }}-ultra
        restore-keys: |
          immwrt-${{ env.REPO_BRANCH }}-

    - name: ğŸ”§ åˆå¹¶é…ç½®æ–‡ä»¶
      run: |
        cd build/source
        
        # åˆ›å»ºé…ç½®ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        mkdir -p ../configs
        
        # ä¸‹è½½é…ç½®æ–‡ä»¶ï¼ˆå¦‚æœæœ¬åœ°ä¸å­˜åœ¨ï¼‰
        if [ ! -f "../configs/Max.config" ]; then
          curl -L https://raw.githubusercontent.com/aghu1979/ipq60x2/main/configs/Max.config -o ../configs/Max.config
        fi
        
        # å¤‡ä»½å½“å‰é…ç½®
        cp .config ../configs/Ultra-backup.config
        
        # åˆ›å»ºåˆå¹¶é…ç½®è„šæœ¬ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if [ ! -f "merge_config.sh" ]; then
          cat > merge_config.sh << 'EOF'
          #!/bin/bash
          # =============================================================================
          # é…ç½®æ–‡ä»¶åˆå¹¶è„šæœ¬
          # ç‰ˆæœ¬: 1.0.7
          # æ›´æ–°æ—¥æœŸ: 2025-11-18
          # =============================================================================
          
          # é¢œè‰²å®šä¹‰
          RED='\033[0;31m'
          GREEN='\033[0;32m'
          YELLOW='\033[1;33m'
          BLUE='\033[0;34m'
          NC='\033[0m' # No Color
          
          # è·å–å‚æ•°
          BASE_CONFIG=$1
          BRANCH_CONFIG=$2
          VARIANT_CONFIG=$3
          OUTPUT_CONFIG=$4
          
          echo -e "${BLUE}ğŸ”§ åˆå¹¶é…ç½®æ–‡ä»¶...${NC}"
          
          # æ£€æŸ¥å‚æ•°
          if [ $# -lt 4 ]; then
              echo -e "${RED}âŒ é”™è¯¯: å‚æ•°ä¸è¶³${NC}"
              echo -e "${YELLOW}ç”¨æ³•: $0 <åŸºç¡€é…ç½®> <åˆ†æ”¯é…ç½®> <å˜ä½“é…ç½®> <è¾“å‡ºé…ç½®>${NC}"
              exit 1
          fi
          
          # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          for config in "$BASE_CONFIG" "$BRANCH_CONFIG" "$VARIANT_CONFIG"; do
              if [ ! -f "$config" ]; then
                  echo -e "${RED}âŒ é”™è¯¯: é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $config${NC}"
                  exit 1
              fi
          done
          
          # è¿‡æ»¤æ‰æ³¨é‡Šè¡Œå’Œç©ºè¡Œï¼Œåˆå¹¶é…ç½®æ–‡ä»¶
          grep -v '^#' "$BASE_CONFIG" | grep -v '^$' | grep -v '^ #' > temp_base.config
          grep -v '^#' "$BRANCH_CONFIG" | grep -v '^$' | grep -v '^ #' > temp_branch.config
          grep -v '^#' "$VARIANT_CONFIG" | grep -v '^$' | grep -v '^ #' > temp_variant.config
          
          # åˆå¹¶é…ç½®
          cat temp_base.config temp_branch.config temp_variant.config > "$OUTPUT_CONFIG"
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f temp_base.config temp_branch.config temp_variant_config
          
          echo -e "${GREEN}âœ… é…ç½®æ–‡ä»¶åˆå¹¶å®Œæˆ${NC}"
          EOF
          chmod +x merge_config.sh
        fi
        
        # æ‰§è¡Œåˆå¹¶é…ç½®è„šæœ¬
        ./merge_config.sh ../configs/base_ipq60xx.config ../configs/base_immwrt.config ../configs/Max.config .config
        
        # è¿è¡Œ defconfig è¡¥å…¨é…ç½®
        echo -e "\033[1;34mğŸ”§ è¿è¡Œ defconfig è¡¥å…¨é…ç½®...\033[0m"
        make defconfig || echo -e "\033[1;33mâš ï¸ defconfig æœ‰è­¦å‘Šï¼Œä½†ç»§ç»­æ‰§è¡Œ${NC}"
        
        # æå–å¹¶æ˜¾ç¤º luci è½¯ä»¶åŒ…å·®å¼‚
        echo -e "\033[1;33mğŸ“‹ LUCI è½¯ä»¶åŒ…å·®å¼‚æŠ¥å‘Š (Max vs Ultra)\033[0m"
        grep -E '^CONFIG_PACKAGE_luci.*=y$' .config > ../luci-max.txt || true
        grep -E '^CONFIG_PACKAGE_luci.*=y$' ../configs/Ultra-backup.config > ../luci-ultra.txt || true
        
        if [ -f "../luci-max.txt" ] && [ -f "../luci-ultra.txt" ]; then
          echo -e "\033[1;32mâ• æ–°å¢çš„ LUCI è½¯ä»¶åŒ…:\033[0m"
          comm -13 ../luci-ultra.txt ../luci-max.txt | while read line; do
            pkg=$(echo $line | sed 's/CONFIG_PACKAGE_//g' | sed 's/=y//g')
            echo -e "  âœ¨ $pkg"
          done || echo -e "  ğŸ“­ æ— æ–°å¢"
          
          echo -e "\033[1;31mâ– ç§»é™¤çš„ LUCI è½¯ä»¶åŒ…:\033[0m"
          comm -23 ../luci-ultra.txt ../luci-max.txt | while read line; do
            pkg=$(echo $line | sed 's/CONFIG_PACKAGE_//g' | sed 's/=y//g')
            echo -e "  ğŸ—‘ï¸ $pkg"
          done || echo -e "  ğŸ“­ æ— ç§»é™¤"
          
          # ç”Ÿæˆæ‘˜è¦
          ultra_count=$(wc -l < ../luci-ultra.txt)
          max_count=$(wc -l < ../luci-max.txt)
          added_count=$(comm -13 ../luci-ultra.txt ../luci-max.txt | wc -l)
          removed_count=$(comm -23 ../luci-ultra.txt ../luci-max.txt | wc -l)
          echo -e "\033[1;36mğŸ“Š æ‘˜è¦: Ultra($ultra_countä¸ª) -> Max($max_countä¸ª), æ–°å¢$added_countä¸ª, ç§»é™¤$removed_countä¸ª\033[0m"
        else
          echo -e "  ğŸ“­ æ— æ³•æ¯”è¾ƒ"
        fi

    - name: ğŸ”¨ ç¼–è¯‘å›ºä»¶
      run: |
        cd build/source
        echo -e "\033[1;34mğŸ”¨ å¼€å§‹ç¼–è¯‘ Max å›ºä»¶...\033[0m"
        make -j$(nproc) || make -j1 || echo -e "\033[1;31mâŒ ç¼–è¯‘å¤±è´¥\033[0m"

    - name: ğŸ“¦ æ•´ç†ç¼–è¯‘äº§ç‰©
      run: |
        cd build/source
        mkdir -p ../output/max
        
        for device in ${{ needs.prepare.outputs.device_list }}; do
          if [ -f "bin/targets/qualcommax/ipq60xx/immortalwrt-*-qualcommax-ipq60xx-${device}-squashfs-sysupgrade.bin" ]; then
            cp "bin/targets/qualcommax/ipq60xx/immortalwrt-*-qualcommax-ipq60xx-${device}-squashfs-sysupgrade.bin" "../output/max/"
            mv "../output/max/immortalwrt-*-qualcommax-ipq60xx-${device}-squashfs-sysupgrade.bin" "../output/max/ImmortalWrt-${device}-Max-${{ env.BUILD_DATE }}.bin"
            echo -e "\033[1;32mâœ… é‡å‘½å: ImmortalWrt-${device}-Max-${{ env.BUILD_DATE }}.bin\033[0m"
          fi
        done

    - name: ğŸ“¤ ä¸Šä¼ ç¼–è¯‘äº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-max
        path: build/output/max/
        retention-days: 7

  build-pro:
    needs: [prepare, build-ultra]
    runs-on: ubuntu-24.04
    steps:
    - name: ğŸš€ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ’¾ æ¢å¤å·¥ä½œç›®å½•
      run: |
        sudo mkdir -p /mnt/ramdisk
        sudo mount -t tmpfs -o size=10G tmpfs /mnt/ramdisk
        sudo mkdir -p /mnt/ramdisk/build
        sudo chown $USER:$USER /mnt/ramdisk/build
        ln -sf /mnt/ramdisk/build ./build

    - name: ğŸ’¾ æ¢å¤ç¼“å­˜
      uses: actions/cache@v4
      with:
        path: |
          ./build
          ~/.ccache
        key: ${{ needs.prepare.outputs.cache_key }}-ultra
        restore-keys: |
          immwrt-${{ env.REPO_BRANCH }}-

    - name: ğŸ”§ åˆå¹¶é…ç½®æ–‡ä»¶
      run: |
        cd build/source
        
        # åˆ›å»ºé…ç½®ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        mkdir -p ../configs
        
        # ä¸‹è½½é…ç½®æ–‡ä»¶ï¼ˆå¦‚æœæœ¬åœ°ä¸å­˜åœ¨ï¼‰
        if [ ! -f "../configs/Pro.config" ]; then
          curl -L https://raw.githubusercontent.com/aghu1979/ipq60x2/main/configs/Pro.config -o ../configs/Pro.config
        fi
        
        # å¤‡ä»½å½“å‰é…ç½®
        cp .config ../configs/Ultra-backup.config
        
        # åˆ›å»ºåˆå¹¶é…ç½®è„šæœ¬ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if [ ! -f "merge_config.sh" ]; then
          cat > merge_config.sh << 'EOF'
          #!/bin/bash
          # =============================================================================
          # é…ç½®æ–‡ä»¶åˆå¹¶è„šæœ¬
          # ç‰ˆæœ¬: 1.0.7
          # æ›´æ–°æ—¥æœŸ: 2025-11-18
          # =============================================================================
          
          # é¢œè‰²å®šä¹‰
          RED='\033[0;31m'
          GREEN='\033[0;32m'
          YELLOW='\033[1;33m'
          BLUE='\033[0;34m'
          NC='\033[0m' # No Color
          
          # è·å–å‚æ•°
          BASE_CONFIG=$1
          BRANCH_CONFIG=$2
          VARIANT_CONFIG=$3
          OUTPUT_CONFIG=$4
          
          echo -e "${BLUE}ğŸ”§ åˆå¹¶é…ç½®æ–‡ä»¶...${NC}"
          
          # æ£€æŸ¥å‚æ•°
          if [ $# -lt 4 ]; then
              echo -e "${RED}âŒ é”™è¯¯: å‚æ•°ä¸è¶³${NC}"
              echo -e "${YELLOW}ç”¨æ³•: $0 <åŸºç¡€é…ç½®> <åˆ†æ”¯é…ç½®> <å˜ä½“é…ç½®> <è¾“å‡ºé…ç½®>${NC}"
              exit 1
          fi
          
          # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          for config in "$BASE_CONFIG" "$BRANCH_CONFIG" "$VARIANT_CONFIG"; do
              if [ ! -f "$config" ]; then
                  echo -e "${RED}âŒ é”™è¯¯: é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $config${NC}"
                  exit 1
              fi
          done
          
          # è¿‡æ»¤æ‰æ³¨é‡Šè¡Œå’Œç©ºè¡Œï¼Œåˆå¹¶é…ç½®æ–‡ä»¶
          grep -v '^#' "$BASE_CONFIG" | grep -v '^$' | grep -v '^ #' > temp_base.config
          grep -v '^#' "$BRANCH_CONFIG" | grep -v '^$' | grep -v '^ #' > temp_branch.config
          grep -v '^#' "$VARIANT_CONFIG" | grep -v '^$' | grep -v '^ #' > temp_variant.config
          
          # åˆå¹¶é…ç½®
          cat temp_base.config temp_branch_config temp_variant_config > "$OUTPUT_CONFIG"
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f temp_base.config temp_branch_config temp_variant_config
          
          echo -e "${GREEN}âœ… é…ç½®æ–‡ä»¶åˆå¹¶å®Œæˆ${NC}"
          EOF
          chmod +x merge_config.sh
        fi
        
        # æ‰§è¡Œåˆå¹¶é…ç½®è„šæœ¬
        ./merge_config.sh ../configs/base_ipq60xx.config ../configs/base_immwrt.config ../configs/Pro.config .config
        
        # è¿è¡Œ defconfig è¡¥å…¨é…ç½®
        echo -e "\033[1;34mğŸ”§ è¿è¡Œ defconfig è¡¥å…¨é…ç½®...\033[0m"
        make defconfig || echo -e "\033[1;33mâš ï¸ defconfig æœ‰è­¦å‘Šï¼Œä½†ç»§ç»­æ‰§è¡Œ${NC}"
        
        # æå–å¹¶æ˜¾ç¤º luci è½¯ä»¶åŒ…å·®å¼‚
        echo -e "\033[1;33mğŸ“‹ LUCI è½¯ä»¶åŒ…å·®å¼‚æŠ¥å‘Š (Pro vs Ultra)\033[0m"
        grep -E '^CONFIG_PACKAGE_luci.*=y$' .config > ../luci-pro.txt || true
        grep -E '^CONFIG_PACKAGE_luci.*=y$' ../configs/Ultra-backup.config > ../luci-ultra.txt || true
        
        if [ -f "../luci-pro.txt" ] && [ -f "../luci-ultra.txt" ]; then
          echo -e "\033[1;32mâ• æ–°å¢çš„ LUCI è½¯ä»¶åŒ…:\033[0m"
          comm -13 ../luci-ultra.txt ../luci-pro.txt | while read line; do
            pkg=$(echo $line | sed 's/CONFIG_PACKAGE_//g' | sed 's/=y//g')
            echo -e "  âœ¨ $pkg"
          done || echo -e "  ğŸ“­ æ— æ–°å¢"
          
          echo -e "\033[1;31mâ– ç§»é™¤çš„ LUCI è½¯ä»¶åŒ…:\033[0m"
          comm -23 ../luci-ultra.txt ../luci-pro.txt | while read line; do
            pkg=$(echo $line | sed 's/CONFIG_PACKAGE_//g' | sed 's/=y//g')
            echo -e "  ğŸ—‘ï¸ $pkg"
          done || echo -e "  ğŸ“­ æ— ç§»é™¤"
          
          # ç”Ÿæˆæ‘˜è¦
          ultra_count=$(wc -l < ../luci-ultra.txt)
          pro_count=$(wc -l < ../luci-pro.txt)
          added_count=$(comm -13 ../luci-ultra.txt ../luci-pro.txt | wc -l)
          removed_count=$(comm -23 ../luci-ultra.txt ../luci-pro.txt | wc -l)
          echo -e "\033[1;36mğŸ“Š æ‘˜è¦: Ultra($ultra_countä¸ª) -> Pro($pro_countä¸ª), æ–°å¢$added_countä¸ª, ç§»é™¤$removed_countä¸ª\033[0m"
        else
          echo -e "  ğŸ“­ æ— æ³•æ¯”è¾ƒ"
        fi

    - name: ğŸ”¨ ç¼–è¯‘å›ºä»¶
      run: |
        cd build/source
        echo -e "\033[1;34mğŸ”¨ å¼€å§‹ç¼–è¯‘ Pro å›ºä»¶...\033[0m"
        make -j$(nproc) || make -j1 || echo -e "\033[1;31mâŒ ç¼–è¯‘å¤±è´¥\033[0m"

    - name: ğŸ“¦ æ•´ç†ç¼–è¯‘äº§ç‰©
      run: |
        cd build/source
        mkdir -p ../output/pro
        
        for device in ${{ needs.prepare.outputs.device_list }}; do
          if [ -f "bin/targets/qualcommax/ipq60xx/immortalwrt-*-qualcommax-ipq60xx-${device}-squashfs-sysupgrade.bin" ]; then
            cp "bin/targets/qualcommax/ipq60xx/immortalwrt-*-qualcommax-ipq60xx-${device}-squashfs-sysupgrade.bin" "../output/pro/"
            mv "../output/pro/immortalwrt-*-qualcommax-ipq60xx-${device}-squashfs-sysupgrade.bin" "../output/pro/ImmortalWrt-${device}-Pro-${{ env.BUILD_DATE }}.bin"
            echo -e "\033[1;32mâœ… é‡å‘½å: ImmortalWrt-${device}-Pro-${{ env.BUILD_DATE }}.bin\033[0m"
          fi
        done

    - name: ğŸ“¤ ä¸Šä¼ ç¼–è¯‘äº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-pro
        path: build/output/pro/
        retention-days: 7

  release:
    needs: [prepare, build-ultra, build-max, build-pro]
    runs-on: ubuntu-24.04
    if: success()
    steps:
    - name: ğŸ“ åˆ›å»ºå‘å¸ƒç›®å½•
      run: |
        mkdir -p release

    - name: ğŸ“¥ ä¸‹è½½æ‰€æœ‰ç¼–è¯‘äº§ç‰©
      uses: actions/download-artifact@v4
      with:
        path: release

    - name: ğŸ“ åˆ›å»ºå‘å¸ƒè¯´æ˜
      run: |
        cat > release/RELEASE_NOTES.md << EOF
        # ImmortalWrt å›ºä»¶å‘å¸ƒ ğŸš€
        
        ## ğŸ“… æ„å»ºä¿¡æ¯
        - ç‰ˆæœ¬: ${{ needs.prepare.outputs.cache_version }}
        - æ„å»ºæ—¥æœŸ: ${{ env.BUILD_DATE }}
        - æ„å»ºæ—¶é—´: ${{ env.BUILD_TIME }}
        - æºç ä»“åº“: ${{ env.REPO_OWNER }}/${{ env.REPO_NAME }}
        - æºç åˆ†æ”¯: ${{ env.REPO_BRANCH }}
        
        ## ğŸ¯ å›ºä»¶å˜ä½“
        - **Ultra**: åŒ…å«æ‰€æœ‰åŠŸèƒ½å’Œè½¯ä»¶åŒ… ğŸŒŸ
        - **Max**: åŒ…å«å¤§éƒ¨åˆ†åŠŸèƒ½å’Œè½¯ä»¶åŒ… â­
        - **Pro**: åŒ…å«å¸¸ç”¨åŠŸèƒ½å’Œè½¯ä»¶åŒ… âœ¨
        
        ## ğŸ“± æ”¯æŒçš„è®¾å¤‡
        ${{ needs.prepare.outputs.device_list }}
        
        ## ğŸ”§ å›ºä»¶ä¿¡æ¯
        - å›ºä»¶IPåœ°å€: ${{ env.FIRMWARE_IP }}
        - å›ºä»¶åç§°: ${{ env.FIRMWARE_NAME }}
        - ä½œè€…: ${{ env.AUTHOR_NAME }}
        - é»˜è®¤å¯†ç : ç©º
        
        ## ğŸ¨ ä¸»é¢˜
        - Argon ä¸»é¢˜
        - Aurora ä¸»é¢˜
        
        ## ğŸ“¦ ç¬¬ä¸‰æ–¹è½¯ä»¶åŒ…
        æœ¬å›ºä»¶åŒ…å«ä»¥ä¸‹ç¬¬ä¸‰æ–¹è½¯ä»¶åŒ…:
        - ğŸ® äº¬ä¸œäº‘é›…å…¸å¨œLEDæ§åˆ¶
        - ğŸš‡ Passwall / Passwall2
        - ğŸ›¡ï¸ AdGuardHome
        - ğŸŒ DDNS-GO
        - ğŸ“Š NetData
        - âš¡ ç½‘ç»œæµ‹é€Ÿ
        - ğŸ’¾ åˆ†åŒºç®¡ç†
        - â° ä»»åŠ¡è®¡åˆ’
        - ğŸ€ Lucky
        - ğŸ”— EasyTier
        - ğŸ  HomeProxy
        - ğŸ¹ Golang & OpenList2
        - ğŸŒŠ MosDNS
        - ğŸ“ QuickFile
        - ğŸ­ Momo / Nikki
        - ğŸ”’ OpenAppFilter
        - âš”ï¸ OpenClash
        - ğŸ¦Š Tailscale
        - ğŸŒ VNT
        
        ## âš ï¸ æ³¨æ„äº‹é¡¹
        1. é¦–æ¬¡åˆ·æœºåè¯·æ¢å¤å‡ºå‚è®¾ç½®
        2. å¦‚é‡é—®é¢˜ï¼Œè¯·å°è¯•æ¢å¤å‡ºå‚è®¾ç½®
        3. æ›´å¤šä¿¡æ¯è¯·è®¿é—®é¡¹ç›®ä¸»é¡µ
        
        ---
        æ„å»ºäº ${{ env.BUILD_DATE }} ${{ env.BUILD_TIME }}
        EOF

    - name: ğŸš€ å‘å¸ƒå›ºä»¶
      uses: softprops/action-gh-release@v2
      with:
        name: ImmortalWrt ${{ env.BUILD_DATE }}
        body_path: release/RELEASE_NOTES.md
        draft: false
        prerelease: false
        files: |
          release/**/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
