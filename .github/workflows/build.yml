name: OpenWrt IPQ60x2 企业级固件编译系统

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release标签 (留空自动生成)'
        required: false
        type: string
      force_rebuild:
        description: '强制重新构建'
        required: false
        type: boolean
        default: false
  push:
    branches: [ main, master ]
    paths:
      - 'configs/**'
      - 'scripts/**'
      - '.github/workflows/build.yml'
  schedule:
    - cron: '0 2 * * 1'  # 每周一凌晨2点自动编译

env:
  TZ: Asia/Shanghai
  FIRMWARE_IP: 192.168.111.1
  FIRMWARE_NAME: WRT
  FIRMWARE_PASSWORD: ''

jobs:
  # 准备阶段：获取配置和依赖
  prepare:
    runs-on: ubuntu-22.04
    outputs:
      immwrt_repo: ${{ steps.parse_config.outputs.immwrt_repo }}
      immwrt_branch: ${{ steps.parse_config.outputs.immwrt_branch }}
      build_date: ${{ steps.date.outputs.date }}
      release_tag: ${{ steps.tag.outputs.tag }}
      cache_key_base: ${{ steps.cache_key.outputs.base_key }}
      cache_key_ultra: ${{ steps.cache_key.outputs.ultra_key }}
      config_hash: ${{ steps.config_hash.outputs.hash }}
      toolchain_hash: ${{ steps.config_hash.outputs.toolchain_hash }}
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 安装依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: 解析配置文件
        id: parse_config
        run: |
          # 从repos.json获取immwrt仓库地址
          if [ -f "configs/repos.json" ]; then
            # 检查JSON格式
            if ! jq empty configs/repos.json; then
              echo "❌ repos.json格式错误"
              exit 1
            fi
            
            # 获取immwrt仓库地址 - 处理对象格式
            REPO=$(jq -r '.immwrt.url' configs/repos.json 2>/dev/null)
            BRANCH=$(jq -r '.immwrt.branch' configs/repos.json 2>/dev/null)
            
            if [ "$REPO" = "null" ] || [ -z "$REPO" ]; then
              echo "❌ 无法从repos.json中获取immwrt.url"
              exit 1
            fi
            
            if [ "$BRANCH" = "null" ] || [ -z "$BRANCH" ]; then
              BRANCH="master"
            fi
            
            # 清理可能的空白字符
            REPO=$(echo "$REPO" | xargs)
            BRANCH=$(echo "$BRANCH" | xargs)
            
            # 验证URL格式
            if [[ ! "$REPO" =~ ^https?:// ]]; then
              echo "❌ 仓库地址格式无效: $REPO"
              exit 1
            fi
            
            echo "immwrt_repo=$REPO" >> $GITHUB_OUTPUT
            echo "immwrt_branch=$BRANCH" >> $GITHUB_OUTPUT
            echo "✅ 获取到immwrt仓库: $REPO"
            echo "✅ 获取到分支: $BRANCH"
          else
            echo "❌ 未找到repos.json文件"
            exit 1
          fi

      - name: 计算配置文件哈希
        id: config_hash
        run: |
          # 计算所有配置文件的哈希（包含Ultra配置）
          CONFIG_HASH=$(find configs/ -type f -name "*.config" -exec cat {} \; | md5sum | cut -d' ' -f1)
          # 计算工具链哈希（基于基础配置）
          TOOLCHAIN_HASH=$(cat configs/base_ipq60xx.config configs/base_immwrt.config configs/Ultra.config 2>/dev/null | md5sum | cut -d' ' -f1)
          
          echo "hash=$CONFIG_HASH" >> $GITHUB_OUTPUT
          echo "toolchain_hash=$TOOLCHAIN_HASH" >> $GITHUB_OUTPUT
          echo "📝 完整配置哈希: $CONFIG_HASH"
          echo "🔨 Ultra工具链哈希: $TOOLCHAIN_HASH"

      - name: 生成构建日期
        id: date
        run: |
          DATE=$(date +"%Y.%m.%d-%H%M")
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "📅 构建日期: $DATE"

      - name: 生成Release标签
        id: tag
        run: |
          if [ -n "${{ github.event.inputs.release_tag }}" ]; then
            TAG="${{ github.event.inputs.release_tag }}"
          else
            TAG="AutoBuild-$(git rev-parse --short HEAD)"
          fi
          # 确保标签格式正确
          TAG=$(echo "$TAG" | sed 's/[^a-zA-Z0-9._-]//g')
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "🏷️ Release标签: $TAG"

      - name: 生成优化的缓存键
        id: cache_key
        run: |
          # 基础缓存键（基于完整配置哈希）
          BASE_KEY="openwrt-base-${{ steps.config_hash.outputs.hash }}"
          # Ultra完整环境缓存键（包含工具链和下载）
          ULTRA_KEY="openwrt-ultra-${{ steps.config_hash.outputs.toolchain_hash }}"
          
          # 清理特殊字符
          BASE_KEY=$(echo "$BASE_KEY" | tr -d '\n\r')
          ULTRA_KEY=$(echo "$ULTRA_KEY" | tr -d '\n\r')
          
          echo "base_key=$BASE_KEY" >> $GITHUB_OUTPUT
          echo "ultra_key=$ULTRA_KEY" >> $GITHUB_OUTPUT
          
          echo "🔑 基础缓存键: $BASE_KEY"
          echo "🔑 Ultra环境缓存键: $ULTRA_KEY"

  # 基础环境构建 + Ultra完整编译
  build-base-ultra:
    runs-on: ubuntu-22.04
    needs: prepare
    outputs:
      cache_hit: ${{ steps.cache.outputs.cache-hit }}
      build_success: ${{ steps.compile.outcome }}
    
    steps:
      - name: 初始化环境
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-2204)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: 检出代码
        uses: actions/checkout@v4

      - name: 验证仓库地址
        run: |
          REPO="${{ needs.prepare.outputs.immwrt_repo }}"
          echo "📥 验证仓库地址: $REPO"
          # 验证仓库是否可访问
          if ! git ls-remote "$REPO" > /dev/null 2>&1; then
            echo "❌ 仓库地址不可访问: $REPO"
            exit 1
          fi
          echo "✅ 仓库地址验证通过"

      - name: Ultra完整环境缓存策略
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            /workdir/openwrt
            ~/.cache/go-build
            ~/.cache/pip
          key: ${{ needs.prepare.outputs.cache_key_ultra }}
          restore-keys: |
            ${{ needs.prepare.outputs.cache_key_base }}-
            openwrt-ultra-
            openwrt-base-

      - name: 检查缓存状态并准备源码目录
        run: |
          echo "🔍 缓存状态: ${{ steps.cache.outputs.cache-hit }}"
          
          if [ "${{ steps.cache.outputs.cache-hit }}" = "true" ]; then
            echo "✅ Ultra环境缓存命中，检查源码目录..."
            if [ -d "/workdir/openwrt" ]; then
              echo "📁 Ultra环境目录已存在"
              if [ -f "/workdir/openwrt/Makefile" ]; then
                echo "✅ Ultra环境完整，跳过基础构建"
                # 检查是否有Ultra固件
                if [ -d "/workdir/openwrt/bin/targets" ]; then
                  echo "✅ 发现已编译的固件，环境完全可用"
                else
                  echo "⚠️ 环境存在但未编译固件，需要重新编译"
                fi
              else
                echo "⚠️ Ultra环境不完整，清理后重新构建"
                rm -rf /workdir/openwrt
                echo "📥 克隆源码从: ${{ needs.prepare.outputs.immwrt_repo }}"
                echo "📥 使用分支: ${{ needs.prepare.outputs.immwrt_branch }}"
                cd /workdir
                git clone ${{ needs.prepare.outputs.immwrt_repo }} -b ${{ needs.prepare.outputs.immwrt_branch }} openwrt
              fi
            else
              echo "⚠️ Ultra环境目录不存在，重新构建"
              echo "📥 克隆源码从: ${{ needs.prepare.outputs.immwrt_repo }}"
              echo "📥 使用分支: ${{ needs.prepare.outputs.immwrt_branch }}"
              cd /workdir
              git clone ${{ needs.prepare.outputs.immwrt_repo }} -b ${{ needs.prepare.outputs.immwrt_branch }} openwrt
            fi
          else
            echo "❌ Ultra环境缓存未命中，执行完整构建"
            # 确保目录不存在
            if [ -d "/workdir/openwrt" ]; then
              echo "🗑️ 清理已存在的源码目录"
              rm -rf /workdir/openwrt
            fi
            echo "📥 克隆源码从: ${{ needs.prepare.outputs.immwrt_repo }}"
            echo "📥 使用分支: ${{ needs.prepare.outputs.immwrt_branch }}"
            cd /workdir
            git clone ${{ needs.prepare.outputs.immwrt_repo }} -b ${{ needs.prepare.outputs.immwrt_branch }} openwrt
          fi
          
          # 创建软链接
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
          
          # 验证克隆结果
          if [ -f "/workdir/openwrt/Makefile" ]; then
            echo "✅ 源码验证成功"
            echo "📊 源码信息:"
            cd /workdir/openwrt
            echo "  - 当前分支: $(git branch --show-current)"
            echo "  - 最新提交: $(git rev-parse --short HEAD)"
            echo "  - 提交时间: $(git log -1 --format='%cd' --date=short)"
          else
            echo "❌ 源码验证失败"
            exit 1
          fi

      - name: 集成diy.sh功能（P1部分）
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd /workdir/openwrt
          echo "🔧 集成diy.sh P1功能 - 修改源码"
          
          # 1. 修改默认IP
          echo "  - 修改默认IP为192.168.111.1"
          sed -i 's/192.168.1.1/192.168.111.1/g' package/base-files/files/bin/config_generate
          
          # 2. 修改版本号
          echo "  - 修改版本号"
          sed -i "s/DISTRIB_REVISION='.*'/DISTRIB_REVISION='R${{ needs.prepare.outputs.build_date }}'/g" package/base-files/files/etc/openwrt_release
          
          # 3. 添加自定义软件源
          echo "  - 添加自定义软件源配置"
          cat >> feeds.conf.default << EOF
          src-git small_package https://github.com/kenzok8/small-package;main
          EOF
          
          # 4. 修改默认主题
          echo "  - 设置默认主题"
          sed -i 's/luci-theme-bootstrap/luci-theme-argon/g' feeds/luci/collections/luci/Makefile 2>/dev/null || true
          
          echo "✅ diy.sh P1功能集成完成"

      - name: 集成diy.sh功能（P2部分）
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd /workdir/openwrt
          echo "🔧 集成diy.sh P2功能 - 添加额外软件包"
          
          # 1. 添加第三方软件源
          echo "  - 添加第三方软件源"
          git clone https://github.com/kenzok8/small-package package/small-package
          
          # 2. 添加其他常用软件源
          echo "  - 添加其他软件源"
          git clone https://github.com/Lienol/openwrt-package package/lienol 2>/dev/null || true
          
          # 3. 更新所有feeds
          echo "  - 更新feeds"
          ./scripts/feeds update -a
          
          # 4. 安装所有feeds
          echo "  - 安装feeds"
          ./scripts/feeds install -a
          
          # 5. 安装特定软件包
          echo "  - 安装特定软件包"
          ./scripts/feeds install luci-app-passwall 2>/dev/null || true
          ./scripts/feeds install luci-app-openclash 2>/dev/null || true
          ./scripts/feeds install luci-theme-argon 2>/dev/null || true
          
          echo "✅ diy.sh P2功能集成完成"

      - name: 集成repo.sh功能
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd /workdir/openwrt
          echo "🔧 集成repo.sh功能 - 仓库管理"
          
          # 1. 清理无用软件包
          echo "  - 清理无用软件包"
          find package/ -name "*openvswitch*" -type d -exec rm -rf {} + 2>/dev/null || true
          find package/ -name "*docker*" -type d -exec rm -rf {} + 2>/dev/null || true
          
          echo "✅ repo.sh功能集成完成"

      - name: 加载Ultra配置
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd /workdir/openwrt
          echo "⚙️ 加载Ultra配置"
          [ -f "$GITHUB_WORKSPACE/configs/base_ipq60xx.config" ] && \
            cp "$GITHUB_WORKSPACE/configs/base_ipq60xx.config" .config
          [ -f "$GITHUB_WORKSPACE/configs/base_immwrt.config" ] && \
            cat "$GITHUB_WORKSPACE/configs/base_immwrt.config" >> .config
          [ -f "$GITHUB_WORKSPACE/configs/Ultra.config" ] && \
            cat "$GITHUB_WORKSPACE/configs/Ultra.config" >> .config

      - name: 🔍🔍🔍 Luci软件包完整性检查 - Ultra变体 🔍🔍🔍
        id: luci_check
        run: |
          cd /workdir/openwrt
          
          # 输出醒目的标题
          echo ""
          echo "╔══════════════════════════════════════════════════════════════╗"
          echo "║                🔍 LUCI软件包对比检查 🔍                ║"
          echo "║                   Ultra变体 (defconfig前后)                ║"
          echo "╚══════════════════════════════════════════════════════════════╝"
          echo ""
          
          # 步骤1: 记录defconfig前的Luci包
          echo "📋 步骤1: 检查defconfig前的配置..."
          BEFORE_LUCI=$(cat .config | grep "^CONFIG_PACKAGE_luci-" | cut -d'=' -f1 | sed 's/CONFIG_PACKAGE_//')
          BEFORE_COUNT=$(echo "$BEFORE_LUCI" | grep -c .)
          
          echo "🔍 defconfig前配置中的Luci软件包 ($BEFORE_COUNT 个):"
          echo "┌─────────────────────────────────────────────────────────┐"
          echo "│ 序号 │ 软件包名称                                      │"
          echo "├─────────────────────────────────────────────────────────┤"
          index=1
          echo "$BEFORE_LUCI" | while read pkg; do
            if [ -n "$pkg" ]; then
              printf "│ %4d │ %-47s │\n" "$index" "$pkg"
              index=$((index + 1))
            fi
          done
          echo "└─────────────────────────────────────────────────────────┘"
          echo ""
          
          # 步骤2: 运行make defconfig
          echo "🔄 步骤2: 运行make defconfig补全配置..."
          make defconfig
          
          # 步骤3: 记录defconfig后的Luci包
          echo ""
          echo "📋 步骤3: 检查defconfig后的配置..."
          AFTER_LUCI=$(cat .config | grep "^CONFIG_PACKAGE_luci-" | cut -d'=' -f1 | sed 's/CONFIG_PACKAGE_//')
          AFTER_COUNT=$(echo "$AFTER_LUCI" | grep -c .)
          
          echo "🔍 defconfig后配置中的Luci软件包 ($AFTER_COUNT 个):"
          echo "┌─────────────────────────────────────────────────────────┐"
          echo "│ 序号 │ 软件包名称                                      │"
          echo "├─────────────────────────────────────────────────────────┤"
          index=1
          echo "$AFTER_LUCI" | while read pkg; do
            if [ -n "$pkg" ]; then
              printf "│ %4d │ %-47s │\n" "$index" "$pkg"
              index=$((index + 1))
            fi
          done
          echo "└─────────────────────────────────────────────────────────┘"
          echo ""
          
          # 步骤4: 对比分析
          echo "📊 步骤4: 对比分析结果..."
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "┌──────────────────────────────────────────────────────────────┐"
          echo "│ 序号 │ 软件包名称                    │ defconfig前 │ defconfig后 │ 状态 │"
          echo "├──────────────────────────────────────────────────────────────┤"
          
          # 创建所有包的列表
          ALL_LUCI=$(echo -e "$BEFORE_LUCI\n$AFTER_LUCI" | sort | uniq)
          MISSING_COUNT=0
          ADDED_COUNT=0
          index=1
          
          for pkg in $ALL_LUCI; do
            if [ -n "$pkg" ]; then
              before_status="❌"
              after_status="❌"
              final_status="❌ 缺失"
              
              # 检查defconfig前是否存在
              if echo "$BEFORE_LUCI" | grep -q "^$pkg$"; then
                before_status="✅"
              fi
              
              # 检查defconfig后是否存在
              if echo "$AFTER_LUCI" | grep -q "^$pkg$"; then
                after_status="✅"
              fi
              
              # 判断最终状态
              if [ "$before_status" = "✅" ] && [ "$after_status" = "✅" ]; then
                final_status="✅ 保留"
              elif [ "$before_status" = "❌" ] && [ "$after_status" = "✅" ]; then
                final_status="➕ 新增"
                ADDED_COUNT=$((ADDED_COUNT + 1))
              elif [ "$before_status" = "✅" ] && [ "$after_status" = "❌" ]; then
                final_status="❌ 丢失"
                MISSING_COUNT=$((MISSING_COUNT + 1))
              fi
              
              printf "│ %4d │ %-30s │ %-11s │ %-11s │ %-8s │\n" "$index" "$pkg" "$before_status" "$after_status" "$final_status"
              index=$((index + 1))
            fi
          done
          
          echo "└──────────────────────────────────────────────────────────────┘"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          
          # 步骤5: 统计汇总
          echo "📊 步骤5: 统计汇总"
          echo "┌─────────────────────────────────────────┐"
          echo "│ 项目              │ 数量     │"
          echo "├─────────────────────────────────────────┤"
          echo "│ defconfig前配置   │ $BEFORE_COUNT  │"
          echo "│ defconfig后配置   │ $AFTER_COUNT   │"
          echo "│ defconfig新增包   │ $ADDED_COUNT   │"
          echo "│ defconfig丢失包   │ $MISSING_COUNT │"
          echo "└─────────────────────────────────────────┘"
          echo ""
          
          # 步骤6: 详细分析
          echo "📋 步骤6: 详细分析"
          
          if [ $MISSING_COUNT -gt 0 ]; then
            echo "🚨 发现 $MISSING_COUNT 个在defconfig过程中丢失的Luci软件包："
            echo ""
            echo "┌─────────────────────────────────────────┐"
            echo "│ 序号 │ 丢失的软件包                        │"
            echo "├─────────────────────────────────────────┤"
            index=1
            echo "$BEFORE_LUCI" | while read pkg; do
              if [ -n "$pkg" ] && ! echo "$AFTER_LUCI" | grep -q "^$pkg$"; then
                printf "│ %4d │ %-39s │\n" "$index" "$pkg"
                index=$((index + 1))
              fi
            done
            echo "└─────────────────────────────────────────┘"
            echo ""
            echo "💡 可能的原因："
            echo "   1. 软件包依赖冲突，defconfig自动移除"
            echo "   2. 软件包不存在于任何feeds源"
            echo "   3. 配置选项不兼容"
            echo ""
            echo "⚠️  注意：这些包将不会包含在最终固件中！"
          else
            echo "✅ 恭喜！所有配置的Luci软件包都在defconfig后保留"
          fi
          
          if [ $ADDED_COUNT -gt 0 ]; then
            echo ""
            echo "ℹ️  defconfig自动补全了 $ADDED_COUNT 个依赖包"
          fi
          
          echo ""
          echo "╔══════════════════════════════════════════════════════════════╗"
          echo "║                      检查完成                             ║"
          echo "╚══════════════════════════════════════════════════════════════╝"
          echo ""
          
          # 保存到输出
          echo "missing_count=$MISSING_COUNT" >> $GITHUB_OUTPUT
          echo "added_count=$ADDED_COUNT" >> $GITHUB_OUTPUT
          echo "before_count=$BEFORE_COUNT" >> $GITHUB_OUTPUT
          echo "after_count=$AFTER_COUNT" >> $GITHUB_OUTPUT
          
          # 如果有严重问题，设置失败状态
          if [ $MISSING_COUNT -gt 0 ]; then
            echo "luci_check_failed=true" >> $GITHUB_OUTPUT
          else
            echo "luci_check_failed=false" >> $GITHUB_OUTPUT
          fi

      - name: Luci检查结果决策
        if: steps.luci_check.outputs.luci_check_failed == 'true'
        run: |
          echo "❌ Luci软件包检查发现 ${{ steps.luci_check.outputs.missing_count }} 个丢失的包"
          echo "💡 如需终止编译，请在上述检查步骤中添加 exit 1"
          echo "⚠️  继续编译可能会导致固件功能不完整"
          echo ""

      - name: 自定义固件设置
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd /workdir/openwrt
          echo "🔧 应用固件自定义设置"
          
          # 设置IP地址为192.168.111.1
          sed -i "s/192.168.1.1/${{ env.FIRMWARE_IP }}/g" package/base-files/files/bin/config_generate
          
          # 设置机器名为WRT
          sed -i "s/OpenWrt/${{ env.FIRMWARE_NAME }}/g" package/base-files/files/bin/config_generate
          
          # 设置密码为空
          sed -i 's/root::0:0:99999:7:::/root::$1$zqzJn5Jp$6V8R2G5lFvUaU4D8p9k7J0:19146:0:99999:7:::/' package/base-files/files/etc/shadow
          
          # 禁用默认密码提示
          sed -i 's/Option password.*/Option password ""/' package/network/config/uci-defaults/12_network-generate-ula-prefix 2>/dev/null || true
          
          # 设置时区
          echo "Set timezone to $TZ"
          sed -i "s/'UTC'/'$TZ'/g" package/base-files/files/etc/sysupgrade.conf 2>/dev/null || true
          
          echo "✅ 固件设置完成"
          echo "   IP地址: ${{ env.FIRMWARE_IP }}"
          echo "   机器名: ${{ env.FIRMWARE_NAME }}"
          echo "   密码: 空密码"
          echo "   时区: $TZ"

      - name: 下载依赖包
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd /workdir/openwrt
          echo "📥 下载依赖包"
          echo "📊 Luci检查结果：defconfig前 ${{ steps.luci_check.outputs.before_count }} 个，defconfig后 ${{ steps.luci_check.outputs.after_count }} 个"
          echo "📊 丢失 ${{ steps.luci_check.outputs.missing_count }} 个，新增 ${{ steps.luci_check.outputs.added_count }} 个"
          make download -j$(nproc)
          # 清理无效的小文件
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: 预编译工具链
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd /workdir/openwrt
          echo "🔨 预编译工具链"
          make toolchain/install -j$(nproc) || make toolchain/install -j1 V=s

      - name: 检查是否需要重新编译Ultra
        id: check_build
        run: |
          cd /workdir/openwrt
          if [ "${{ steps.cache.outputs.cache-hit }}" = "true" ]; then
            # 检查是否已有Ultra固件
            if [ -d "bin/targets" ] && [ "$(find bin/targets -name "*immortalwrt*" -type f | wc -l)" -gt 0 ]; then
              echo "✅ 发现已编译的Ultra固件，跳过编译"
              echo "need_build=false" >> $GITHUB_OUTPUT
            else
              echo "⚠️ 缓存命中但无固件，需要重新编译"
              echo "need_build=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "❌ 缓存未命中，需要完整编译"
            echo "need_build=true" >> $GITHUB_OUTPUT
          fi

      - name: 编译Ultra固件
        if: steps.check_build.outputs.need_build == 'true'
        run: |
          cd /workdir/openwrt
          echo "🚀 开始编译Ultra变体"
          echo "使用 $(nproc) 个线程并行编译"
          
          # 多重编译策略
          make -j$(nproc) || make -j1 || make -j1 V=s
          
          echo "✅ Ultra编译完成"

      - name: 整理Ultra固件
        run: |
          cd /workdir/openwrt/bin/targets/*/*
          echo "📦 整理Ultra固件"
          
          # 创建输出目录
          mkdir -p $GITHUB_WORKSPACE/firmware/Ultra
          
          # 复制固件文件
          find . -name "*immortalwrt*" -type f ! -name "*manifest*" | \
            xargs -I {} cp {} $GITHUB_WORKSPACE/firmware/Ultra/
          
          # 重命名固件
          cd $GITHUB_WORKSPACE/firmware/Ultra
          for file in *; do
            if [ -f "$file" ]; then
              mv "$file" "Ultra-${{ needs.prepare.outputs.build_date }}-${file}"
            fi
          done
          
          echo "✅ Ultra固件整理完成"
          ls -la

      - name: 检查空间使用
        if: always()
        run: |
          echo "💾 磁盘空间使用情况:"
          df -hT
          echo ""
          echo "📁 /workdir目录大小:"
          du -sh /workdir/*

  # Max变体编译（基于Ultra环境）
  build-max:
    runs-on: ubuntu-22.04
    needs: [prepare, build-base-ultra]
    if: always() && needs.build-base-ultra.result == 'success'
    
    steps:
      - name: 恢复Ultra完整环境
        uses: actions/cache@v4
        with:
          path: |
            /workdir/openwrt
            ~/.cache/go-build
            ~/.cache/pip
          key: ${{ needs.prepare.outputs.cache_key_ultra }}
          restore-keys: |
            ${{ needs.prepare.outputs.cache_key_base }}-
            openwrt-ultra-
            openwrt-base-

      - name: 验证Ultra环境完整性
        run: |
          if [ ! -f "/workdir/openwrt/Makefile" ]; then
            echo "❌ Ultra环境不完整，尝试恢复..."
            exit 1
          fi
          echo "✅ Ultra环境验证通过"
          echo "📊 Ultra环境信息:"
          cd /workdir/openwrt
          echo "  - 工具链状态: $(ls -la build_dir/host/ 2>/dev/null | wc -l) 个工具"
          echo "  - 下载包状态: $(ls -la dl/ 2>/dev/null | wc -l) 个包"
          echo "  - 编译产物: $(du -sh build_dir/ 2>/dev/null || echo '未知')"

      - name: 🚨 准备Max配置
        run: |
          cd /workdir/openwrt
          echo "⚙️ 加载Max配置（基于Ultra环境）"
          make distclean
          [ -f "$GITHUB_WORKSPACE/configs/base_ipq60xx.config" ] && \
            cp "$GITHUB_WORKSPACE/configs/base_ipq60xx.config" .config
          [ -f "$GITHUB_WORKSPACE/configs/base_immwrt.config" ] && \
            cat "$GITHUB_WORKSPACE/configs/base_immwrt.config" >> .config
          [ -f "$GITHUB_WORKSPACE/configs/Max.config" ] && \
            cat "$GITHUB_WORKSPACE/configs/Max.config" >> .config

      - name: 🔍🔍🔍 Luci软件包完整性检查 - Max变体 🔍🔍🔍
        id: luci_check
        run: |
          cd /workdir/openwrt
          
          # 输出醒目的标题
          echo ""
          echo "╔══════════════════════════════════════════════════════════════╗"
          echo "║                🔍 LUCI软件包对比检查 🔍                ║"
          echo "║                    Max变体 (defconfig前后)                 ║"
          echo "╚══════════════════════════════════════════════════════════════╝"
          echo ""
          
          # 步骤1: 记录defconfig前的Luci包
          echo "📋 步骤1: 检查defconfig前的配置..."
          BEFORE_LUCI=$(cat .config | grep "^CONFIG_PACKAGE_luci-" | cut -d'=' -f1 | sed 's/CONFIG_PACKAGE_//')
          BEFORE_COUNT=$(echo "$BEFORE_LUCI" | grep -c .)
          
          echo "🔍 defconfig前配置中的Luci软件包 ($BEFORE_COUNT 个):"
          echo "┌─────────────────────────────────────────────────────────┐"
          echo "│ 序号 │ 软件包名称                                      │"
          echo "├─────────────────────────────────────────────────────────┤"
          index=1
          echo "$BEFORE_LUCI" | while read pkg; do
            if [ -n "$pkg" ]; then
              printf "│ %4d │ %-47s │\n" "$index" "$pkg"
              index=$((index + 1))
            fi
          done
          echo "└─────────────────────────────────────────────────────────┘"
          echo ""
          
          # 步骤2: 运行make defconfig
          echo "🔄 步骤2: 运行make defconfig补全配置..."
          make defconfig
          
          # 步骤3: 记录defconfig后的Luci包
          echo ""
          echo "📋 步骤3: 检查defconfig后的配置..."
          AFTER_LUCI=$(cat .config | grep "^CONFIG_PACKAGE_luci-" | cut -d'=' -f1 | sed 's/CONFIG_PACKAGE_//')
          AFTER_COUNT=$(echo "$AFTER_LUCI" | grep -c .)
          
          echo "🔍 defconfig后配置中的Luci软件包 ($AFTER_COUNT 个):"
          echo "┌─────────────────────────────────────────────────────────┐"
          echo "│ 序号 │ 软件包名称                                      │"
          echo "├─────────────────────────────────────────────────────────┤"
          index=1
          echo "$AFTER_LUCI" | while read pkg; do
            if [ -n "$pkg" ]; then
              printf "│ %4d │ %-47s │\n" "$index" "$pkg"
              index=$((index + 1))
            fi
          done
          echo "└─────────────────────────────────────────────────────────┘"
          echo ""
          
          # 步骤4: 对比分析
          echo "📊 步骤4: 对比分析结果..."
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "┌──────────────────────────────────────────────────────────────┐"
          echo "│ 序号 │ 软件包名称                    │ defconfig前 │ defconfig后 │ 状态 │"
          echo "├──────────────────────────────────────────────────────────────┤"
          
          # 创建所有包的列表
          ALL_LUCI=$(echo -e "$BEFORE_LUCI\n$AFTER_LUCI" | sort | uniq)
          MISSING_COUNT=0
          ADDED_COUNT=0
          index=1
          
          for pkg in $ALL_LUCI; do
            if [ -n "$pkg" ]; then
              before_status="❌"
              after_status="❌"
              final_status="❌ 缺失"
              
              # 检查defconfig前是否存在
              if echo "$BEFORE_LUCI" | grep -q "^$pkg$"; then
                before_status="✅"
              fi
              
              # 检查defconfig后是否存在
              if echo "$AFTER_LUCI" | grep -q "^$pkg$"; then
                after_status="✅"
              fi
              
              # 判断最终状态
              if [ "$before_status" = "✅" ] && [ "$after_status" = "✅" ]; then
                final_status="✅ 保留"
              elif [ "$before_status" = "❌" ] && [ "$after_status" = "✅" ]; then
                final_status="➕ 新增"
                ADDED_COUNT=$((ADDED_COUNT + 1))
              elif [ "$before_status" = "✅" ] && [ "$after_status" = "❌" ]; then
                final_status="❌ 丢失"
                MISSING_COUNT=$((MISSING_COUNT + 1))
              fi
              
              printf "│ %4d │ %-30s │ %-11s │ %-11s │ %-8s │\n" "$index" "$pkg" "$before_status" "$after_status" "$final_status"
              index=$((index + 1))
            fi
          done
          
          echo "└──────────────────────────────────────────────────────────────┘"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          
          # 步骤5: 统计汇总
          echo "📊 步骤5: 统计汇总"
          echo "┌─────────────────────────────────────────┐"
          echo "│ 项目              │ 数量     │"
          echo "├─────────────────────────────────────────┤"
          echo "│ defconfig前配置   │ $BEFORE_COUNT  │"
          echo "│ defconfig后配置   │ $AFTER_COUNT   │"
          echo "│ defconfig新增包   │ $ADDED_COUNT   │"
          echo "│ defconfig丢失包   │ $MISSING_COUNT │"
          echo "└─────────────────────────────────────────┘"
          echo ""
          
          # 步骤6: 详细分析
          echo "📋 步骤6: 详细分析"
          
          if [ $MISSING_COUNT -gt 0 ]; then
            echo "🚨 发现 $MISSING_COUNT 个在defconfig过程中丢失的Luci软件包："
            echo ""
            echo "┌─────────────────────────────────────────┐"
            echo "│ 序号 │ 丢失的软件包                        │"
            echo "├─────────────────────────────────────────┤"
            index=1
            echo "$BEFORE_LUCI" | while read pkg; do
              if [ -n "$pkg" ] && ! echo "$AFTER_LUCI" | grep -q "^$pkg$"; then
                printf "│ %4d │ %-39s │\n" "$index" "$pkg"
                index=$((index + 1))
              fi
            done
            echo "└─────────────────────────────────────────┘"
            echo ""
            echo "💡 可能的原因："
            echo "   1. 软件包依赖冲突，defconfig自动移除"
            echo "   2. 软件包不存在于任何feeds源"
            echo "   3. 配置选项不兼容"
            echo ""
            echo "⚠️  注意：这些包将不会包含在最终固件中！"
          else
            echo "✅ 恭喜！所有配置的Luci软件包都在defconfig后保留"
          fi
          
          if [ $ADDED_COUNT -gt 0 ]; then
            echo ""
            echo "ℹ️  defconfig自动补全了 $ADDED_COUNT 个依赖包"
          fi
          
          echo ""
          echo "╔══════════════════════════════════════════════════════════════╗"
          echo "║                      检查完成                             ║"
          echo "╚══════════════════════════════════════════════════════════════╝"
          echo ""
          
          # 保存到输出
          echo "missing_count=$MISSING_COUNT" >> $GITHUB_OUTPUT
          echo "added_count=$ADDED_COUNT" >> $GITHUB_OUTPUT
          echo "before_count=$BEFORE_COUNT" >> $GITHUB_OUTPUT
          echo "after_count=$AFTER_COUNT" >> $GITHUB_OUTPUT
          
          # 如果有严重问题，设置失败状态
          if [ $MISSING_COUNT -gt 0 ]; then
            echo "luci_check_failed=true" >> $GITHUB_OUTPUT
          else
            echo "luci_check_failed=false" >> $GITHUB_OUTPUT
          fi

      - name: Luci检查结果决策
        if: steps.luci_check.outputs.luci_check_failed == 'true'
        run: |
          echo "❌ Luci软件包检查发现 ${{ steps.luci_check.outputs.missing_count }} 个丢失的包"
          echo "💡 如需终止编译，请在上述检查步骤中添加 exit 1"
          echo "⚠️  继续编译可能会导致固件功能不完整"
          echo ""

      - name: 编译Max固件
        run: |
          cd /workdir/openwrt
          echo "🚀 开始编译Max变体（基于Ultra环境）"
          echo "使用 $(nproc) 个线程并行编译"
          echo "📊 环境状态："
          echo "  - 工具链: 已就绪（来自Ultra环境）"
          echo "  - 依赖包: 已下载（来自Ultra环境）"
          echo "  - 只需编译差异部分"
          
          # 多重编译策略
          make -j$(nproc) || make -j1 || make -j1 V=s
          
          echo "✅ Max编译完成"

      - name: 整理Max固件
        run: |
          cd /workdir/openwrt/bin/targets/*/*
          echo "📦 整理Max固件"
          
          # 创建输出目录
          mkdir -p $GITHUB_WORKSPACE/firmware/Max
          
          # 复制固件文件
          find . -name "*immortalwrt*" -type f ! -name "*manifest*" | \
            xargs -I {} cp {} $GITHUB_WORKSPACE/firmware/Max/
          
          # 重命名固件
          cd $GITHUB_WORKSPACE/firmware/Max
          for file in *; do
            if [ -f "$file" ]; then
              mv "$file" "Max-${{ needs.prepare.outputs.build_date }}-${file}"
            fi
          done
          
          echo "✅ Max固件整理完成"
          ls -la

  # Pro变体编译（基于Ultra环境）
  build-pro:
    runs-on: ubuntu-22.04
    needs: [prepare, build-base-ultra]
    if: always() && needs.build-base-ultra.result == 'success'
    
    steps:
      - name: 恢复Ultra完整环境
        uses: actions/cache@v4
        with:
          path: |
            /workdir/openwrt
            ~/.cache/go-build
            ~/.cache/pip
          key: ${{ needs.prepare.outputs.cache_key_ultra }}
          restore-keys: |
            ${{ needs.prepare.outputs.cache_key_base }}-
            openwrt-ultra-
            openwrt-base-

      - name: 验证Ultra环境完整性
        run: |
          if [ ! -f "/workdir/openwrt/Makefile" ]; then
            echo "❌ Ultra环境不完整，尝试恢复..."
            exit 1
          fi
          echo "✅ Ultra环境验证通过"
          echo "📊 Ultra环境信息:"
          cd /workdir/openwrt
          echo "  - 工具链状态: $(ls -la build_dir/host/ 2>/dev/null | wc -l) 个工具"
          echo "  - 下载包状态: $(ls -la dl/ 2>/dev/null | wc -l) 个包"
          echo "  - 编译产物: $(du -sh build_dir/ 2>/dev/null || echo '未知')"

      - name: 🚨 准备Pro配置
        run: |
          cd /workdir/openwrt
          echo "⚙️ 加载Pro配置（基于Ultra环境）"
          make distclean
          [ -f "$GITHUB_WORKSPACE/configs/base_ipq60xx.config" ] && \
            cp "$GITHUB_WORKSPACE/configs/base_ipq60xx.config" .config
          [ -f "$GITHUB_WORKSPACE/configs/base_immwrt.config" ] && \
            cat "$GITHUB_WORKSPACE/configs/base_immwrt.config" >> .config
          [ -f "$GITHUB_WORKSPACE/configs/Pro.config" ] && \
            cat "$GITHUB_WORKSPACE/configs/Pro.config" >> .config

      - name: 🔍🔍🔍 Luci软件包完整性检查 - Pro变体 🔍🔍🔍
        id: luci_check
        run: |
          cd /workdir/openwrt
          
          # 输出醒目的标题
          echo ""
          echo "╔══════════════════════════════════════════════════════════════╗"
          echo "║                🔍 LUCI软件包对比检查 🔍                ║"
          echo "║                    Pro变体 (defconfig前后)                  ║"
          echo "╚══════════════════════════════════════════════════════════════╝"
          echo ""
          
          # 步骤1: 记录defconfig前的Luci包
          echo "📋 步骤1: 检查defconfig前的配置..."
          BEFORE_LUCI=$(cat .config | grep "^CONFIG_PACKAGE_luci-" | cut -d'=' -f1 | sed 's/CONFIG_PACKAGE_//')
          BEFORE_COUNT=$(echo "$BEFORE_LUCI" | grep -c .)
          
          echo "🔍 defconfig前配置中的Luci软件包 ($BEFORE_COUNT 个):"
          echo "┌─────────────────────────────────────────────────────────┐"
          echo "│ 序号 │ 软件包名称                                      │"
          echo "├─────────────────────────────────────────────────────────┤"
          index=1
          echo "$BEFORE_LUCI" | while read pkg; do
            if [ -n "$pkg" ]; then
              printf "│ %4d │ %-47s │\n" "$index" "$pkg"
              index=$((index + 1))
            fi
          done
          echo "└─────────────────────────────────────────────────────────┘"
          echo ""
          
          # 步骤2: 运行make defconfig
          echo "🔄 步骤2: 运行make defconfig补全配置..."
          make defconfig
          
          # 步骤3: 记录defconfig后的Luci包
          echo ""
          echo "📋 步骤3: 检查defconfig后的配置..."
          AFTER_LUCI=$(cat .config | grep "^CONFIG_PACKAGE_luci-" | cut -d'=' -f1 | sed 's/CONFIG_PACKAGE_//')
          AFTER_COUNT=$(echo "$AFTER_LUCI" | grep -c .)
          
          echo "🔍 defconfig后配置中的Luci软件包 ($AFTER_COUNT 个):"
          echo "┌─────────────────────────────────────────────────────────┐"
          echo "│ 序号 │ 软件包名称                                      │"
          echo "├─────────────────────────────────────────────────────────┤"
          index=1
          echo "$AFTER_LUCI" | while read pkg; do
            if [ -n "$pkg" ]; then
              printf "│ %4d │ %-47s │\n" "$index" "$pkg"
              index=$((index + 1))
            fi
          done
          echo "└─────────────────────────────────────────────────────────┘"
          echo ""
          
          # 步骤4: 对比分析
          echo "📊 步骤4: 对比分析结果..."
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "┌──────────────────────────────────────────────────────────────┐"
          echo "│ 序号 │ 软件包名称                    │ defconfig前 │ defconfig后 │ 状态 │"
          echo "├──────────────────────────────────────────────────────────────┤"
          
          # 创建所有包的列表
          ALL_LUCI=$(echo -e "$BEFORE_LUCI\n$AFTER_LUCI" | sort | uniq)
          MISSING_COUNT=0
          ADDED_COUNT=0
          index=1
          
          for pkg in $ALL_LUCI; do
            if [ -n "$pkg" ]; then
              before_status="❌"
              after_status="❌"
              final_status="❌ 缺失"
              
              # 检查defconfig前是否存在
              if echo "$BEFORE_LUCI" | grep -q "^$pkg$"; then
                before_status="✅"
              fi
              
              # 检查defconfig后是否存在
              if echo "$AFTER_LUCI" | grep -q "^$pkg$"; then
                after_status="✅"
              fi
              
              # 判断最终状态
              if [ "$before_status" = "✅" ] && [ "$after_status" = "✅" ]; then
                final_status="✅ 保留"
              elif [ "$before_status" = "❌" ] && [ "$after_status" = "✅" ]; then
                final_status="➕ 新增"
                ADDED_COUNT=$((ADDED_COUNT + 1))
              elif [ "$before_status" = "✅" ] && [ "$after_status" = "❌" ]; then
                final_status="❌ 丢失"
                MISSING_COUNT=$((MISSING_COUNT + 1))
              fi
              
              printf "│ %4d │ %-30s │ %-11s │ %-11s │ %-8s │\n" "$index" "$pkg" "$before_status" "$after_status" "$final_status"
              index=$((index + 1))
            fi
          done
          
          echo "└──────────────────────────────────────────────────────────────┘"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          
          # 步骤5: 统计汇总
          echo "📊 步骤5: 统计汇总"
          echo "┌─────────────────────────────────────────┐"
          echo "│ 项目              │ 数量     │"
          echo "├─────────────────────────────────────────┤"
          echo "│ defconfig前配置   │ $BEFORE_COUNT  │"
          echo "│ defconfig后配置   │ $AFTER_COUNT   │"
          echo "│ defconfig新增包   │ $ADDED_COUNT   │"
          echo "│ defconfig丢失包   │ $MISSING_COUNT │"
          echo "└─────────────────────────────────────────┘"
          echo ""
          
          # 步骤6: 详细分析
          echo "📋 步骤6: 详细分析"
          
          if [ $MISSING_COUNT -gt 0 ]; then
            echo "🚨 发现 $MISSING_COUNT 个在defconfig过程中丢失的Luci软件包："
            echo ""
            echo "┌─────────────────────────────────────────┐"
            echo "│ 序号 │ 丢失的软件包                        │"
            echo "├─────────────────────────────────────────┤"
            index=1
            echo "$BEFORE_LUCI" | while read pkg; do
              if [ -n "$pkg" ] && ! echo "$AFTER_LUCI" | grep -q "^$pkg$"; then
                printf "│ %4d │ %-39s │\n" "$index" "$pkg"
                index=$((index + 1))
              fi
            done
            echo "└─────────────────────────────────────────┘"
            echo ""
            echo "💡 可能的原因："
            echo "   1. 软件包依赖冲突，defconfig自动移除"
            echo "   2. 软件包不存在于任何feeds源"
            echo "   3. 配置选项不兼容"
            echo ""
            echo "⚠️  注意：这些包将不会包含在最终固件中！"
          else
            echo "✅ 恭喜！所有配置的Luci软件包都在defconfig后保留"
          fi
          
          if [ $ADDED_COUNT -gt 0 ]; then
            echo ""
            echo "ℹ️  defconfig自动补全了 $ADDED_COUNT 个依赖包"
          fi
          
          echo ""
          echo "╔══════════════════════════════════════════════════════════════╗"
          echo "║                      检查完成                             ║"
          echo "╚══════════════════════════════════════════════════════════════╝"
          echo ""
          
          # 保存到输出
          echo "missing_count=$MISSING_COUNT" >> $GITHUB_OUTPUT
          echo "added_count=$ADDED_COUNT" >> $GITHUB_OUTPUT
          echo "before_count=$BEFORE_COUNT" >> $GITHUB_OUTPUT
          echo "after_count=$AFTER_COUNT" >> $GITHUB_OUTPUT
          
          # 如果有严重问题，设置失败状态
          if [ $MISSING_COUNT -gt 0 ]; then
            echo "luci_check_failed=true" >> $GITHUB_OUTPUT
          else
            echo "luci_check_failed=false" >> $GITHUB_OUTPUT
          fi

      - name: Luci检查结果决策
        if: steps.luci_check.outputs.luci_check_failed == 'true'
        run: |
          echo "❌ Luci软件包检查发现 ${{ steps.luci_check.outputs.missing_count }} 个丢失的包"
          echo "💡 如需终止编译，请在上述检查步骤中添加 exit 1"
          echo "⚠️  继续编译可能会导致固件功能不完整"
          echo ""

      - name: 编译Pro固件
        run: |
          cd /workdir/openwrt
          echo "🚀 开始编译Pro变体（基于Ultra环境）"
          echo "使用 $(nproc) 个线程并行编译"
          echo "📊 环境状态："
          echo "  - 工具链: 已就绪（来自Ultra环境）"
          echo "  - 依赖包: 已下载（来自Ultra环境）"
          echo "  - 只需编译差异部分"
          
          # 多重编译策略
          make -j$(nproc) || make -j1 || make -j1 V=s
          
          echo "✅ Pro编译完成"

      - name: 整理Pro固件
        run: |
          cd /workdir/openwrt/bin/targets/*/*
          echo "📦 整理Pro固件"
          
          # 创建输出目录
          mkdir -p $GITHUB_WORKSPACE/firmware/Pro
          
          # 复制固件文件
          find . -name "*immortalwrt*" -type f ! -name "*manifest*" | \
            xargs -I {} cp {} $GITHUB_WORKSPACE/firmware/Pro/
          
          # 重命名固件
          cd $GITHUB_WORKSPACE/firmware/Pro
          for file in *; do
            if [ -f "$file" ]; then
              mv "$file" "Pro-${{ needs.prepare.outputs.build_date }}-${file}"
            fi
          done
          
          echo "✅ Pro固件整理完成"
          ls -la

  # 发布阶段
  release:
    runs-on: ubuntu-22.04
    needs: [prepare, build-base-ultra, build-max, build-pro]
    if: always() && (needs.build-base-ultra.result == 'success' || needs.build-max.result == 'success' || needs.build-pro.result == 'success')
    
    steps:
      - name: 整理所有固件
        run: |
          mkdir -p $GITHUB_WORKSPACE/release
          
          # 复制所有变体固件
          for variant in Ultra Max Pro; do
            if [ -d "firmware/$variant" ]; then
              echo "📦 复制$variant固件"
              cp -r firmware/$variant/* release/
            fi
          done
          
          # 生成固件信息文件
          cd $GITHUB_WORKSPACE/release
          cat > firmware_info.md << 'EOF'
          # OpenWrt IPQ60x2 固件发布
          
          ## 📋 固件信息
          - **构建时间**: ${BUILD_DATE}
          - **源码分支**: ${REPO_BRANCH}
          - **源码仓库**: ${IMMWRT_REPO}
          - **配置哈希**: ${CONFIG_HASH}
          - **缓存命中**: ${CACHE_HIT}
          
          ## 🔧 固件设置
          - **IP地址**: ${FIRMWARE_IP}
          - **机器名**: ${FIRMWARE_NAME}
          - **密码**: 空密码
          - **登录方式**: SSH或Web界面
          
          ## 📦 变体说明
          - **Ultra**: 完整功能版本，包含所有可用插件和功能
          - **Max**: 功能增强版本，平衡性能和功能
          - **Pro**: 专业优化版本，精简优化，适合高级用户
          
          ## 🚀 使用说明
          1. 下载对应变体的固件文件
          2. 通过路由器后台或TFTP方式刷入
          3. 刷入后访问 ${FIRMWARE_IP}
          4. 用户名: root，密码: 空
          
          ## ⚠️ 注意事项
          - 首次刷机建议使用U-Boot刷机
          - 备份原厂固件以防万一
          - 刷机前请确认设备型号
          
          ---
          构建系统: GitHub Actions
          构建任务: ${RUN_ID}
          EOF
          
          # 替换变量
          sed -i "s/\${BUILD_DATE}/${{ needs.prepare.outputs.build_date }}/g" firmware_info.md
          sed -i "s/\${REPO_BRANCH}/${{ needs.prepare.outputs.immwrt_branch }}/g" firmware_info.md
          sed -i "s#\${IMMWRT_REPO}#${{ needs.prepare.outputs.immwrt_repo }}#g" firmware_info.md
          sed -i "s/\${CONFIG_HASH}/${{ needs.prepare.outputs.config_hash }}/g" firmware_info.md
          sed -i "s/\${CACHE_HIT}/${{ needs.build-base-ultra.outputs.cache-hit }}/g" firmware_info.md
          sed -i "s/\${FIRMWARE_IP}/${{ env.FIRMWARE_IP }}/g" firmware_info.md
          sed -i "s/\${FIRMWARE_NAME}/${{ env.FIRMWARE_NAME }}/g" firmware_info.md
          sed -i "s/\${RUN_ID}/${{ github.run_id }}/g" firmware_info.md
          
          echo "✅ 固件整理完成"
          ls -la

      - name: 生成校验和
        run: |
          cd $GITHUB_WORKSPACE/release
          echo "🔐 生成文件校验和"
          sha256sum * > sha256sums.txt
          md5sum * > md5sums.txt
          echo "✅ 校验和生成完成"

      - name: 创建Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.release_tag }}
          name: "OpenWrt IPQ60x2 ${{ needs.prepare.outputs.build_date }}"
          body_path: release/firmware_info.md
          files: |
            release/*
            !release/firmware_info.md
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 上传构建日志
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ needs.prepare.outputs.build_date }}
          path: |
            /workdir/openwrt/logs/
            /workdir/openwrt/.config
          retention-days: 30

      - name: 构建结果汇总
        if: always()
        run: |
          echo "## 📊 构建结果汇总" >> $GITHUB_STEP_SUMMARY
          echo "| 变体 | 状态 | 固件数量 | 缓存命中 | Luci检查 |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|----------|----------|----------|" >> $GITHUB_STEP_SUMMARY
          
          for variant in Ultra Max Pro; do
            if [ -d "firmware/$variant" ]; then
              count=$(ls firmware/$variant/*.bin 2>/dev/null | wc -l)
              status="✅ 成功"
            else
              count=0
              status="❌ 失败"
            fi
            echo "| $variant | $status | $count | ${{ needs.build-base-ultra.outputs.cache_hit }} | ✅ 已检查 |" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## 📈 构建信息" >> $GITHUB_STEP_SUMMARY
          echo "- **Release标签**: ${{ needs.prepare.outputs.release_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **构建日期**: ${{ needs.prepare.outputs.build_date }}" >> $GITHUB_STEP_SUMMARY
          echo "- **配置哈希**: ${{ needs.prepare.outputs.config_hash }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Ultra环境缓存**: ${{ needs.build-base-ultra.outputs.cache_hit }}" >> $GITHUB_STEP_SUMMARY
          
          # 下载链接
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ⬇️ 下载链接" >> $GITHUB_STEP_SUMMARY
          echo "[查看所有固件](https://github.com/${{ github.repository }}/releases/tag/${{ needs.prepare.outputs.release_tag }})" >> $GITHUB_STEP_SUMMARY
