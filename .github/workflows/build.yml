name: OpenWrt IPQ60x2 ä¼ä¸šçº§å›ºä»¶ç¼–è¯‘ç³»ç»Ÿ

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Releaseæ ‡ç­¾ (ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ)'
        required: false
        type: string
      force_rebuild:
        description: 'å¼ºåˆ¶é‡æ–°æž„å»º'
        required: false
        type: boolean
        default: false
  push:
    branches: [ main, master ]
    paths:
      - 'configs/**'
      - 'scripts/**'
      - '.github/workflows/build.yml'
  schedule:
    - cron: '0 2 * * 1'  # æ¯å‘¨ä¸€å‡Œæ™¨2ç‚¹è‡ªåŠ¨ç¼–è¯‘

env:
  TZ: Asia/Shanghai
  FIRMWARE_IP: 192.168.111.1
  FIRMWARE_NAME: WRT
  FIRMWARE_PASSWORD: ''

jobs:
  # å‡†å¤‡é˜¶æ®µï¼šèŽ·å–é…ç½®å’Œä¾èµ–
  prepare:
    runs-on: ubuntu-22.04
    outputs:
      immwrt_repo: ${{ steps.parse_config.outputs.immwrt_repo }}
      immwrt_branch: ${{ steps.parse_config.outputs.immwrt_branch }}
      build_date: ${{ steps.date.outputs.date }}
      release_tag: ${{ steps.tag.outputs.tag }}
      cache_key_base: ${{ steps.cache_key.outputs.base_key }}
      cache_key_full: ${{ steps.cache_key.outputs.full_key }}
      matrix_ultra: ${{ steps.matrix.outputs.ultra }}
      matrix_variants: ${{ steps.matrix.outputs.variants }}
      config_hash: ${{ steps.config_hash.outputs.hash }}
      toolchain_hash: ${{ steps.config_hash.outputs.toolchain_hash }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: å®‰è£…ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: è§£æžé…ç½®æ–‡ä»¶
        id: parse_config
        run: |
          # ä»Žrepos.jsonèŽ·å–immwrtä»“åº“åœ°å€
          if [ -f "configs/repos.json" ]; then
            # æ£€æŸ¥JSONæ ¼å¼
            if ! jq empty configs/repos.json; then
              echo "âŒ repos.jsonæ ¼å¼é”™è¯¯"
              exit 1
            fi
            
            # èŽ·å–immwrtä»“åº“åœ°å€ - å¤„ç†å¯¹è±¡æ ¼å¼
            REPO=$(jq -r '.immwrt.url' configs/repos.json 2>/dev/null)
            BRANCH=$(jq -r '.immwrt.branch' configs/repos.json 2>/dev/null)
            
            if [ "$REPO" = "null" ] || [ -z "$REPO" ]; then
              echo "âŒ æ— æ³•ä»Žrepos.jsonä¸­èŽ·å–immwrt.url"
              exit 1
            fi
            
            if [ "$BRANCH" = "null" ] || [ -z "$BRANCH" ]; then
              BRANCH="master"
            fi
            
            # æ¸…ç†å¯èƒ½çš„ç©ºç™½å­—ç¬¦
            REPO=$(echo "$REPO" | xargs)
            BRANCH=$(echo "$BRANCH" | xargs)
            
            # éªŒè¯URLæ ¼å¼
            if [[ ! "$REPO" =~ ^https?:// ]]; then
              echo "âŒ ä»“åº“åœ°å€æ ¼å¼æ— æ•ˆ: $REPO"
              exit 1
            fi
            
            echo "immwrt_repo=$REPO" >> $GITHUB_OUTPUT
            echo "immwrt_branch=$BRANCH" >> $GITHUB_OUTPUT
            echo "âœ… èŽ·å–åˆ°immwrtä»“åº“: $REPO"
            echo "âœ… èŽ·å–åˆ°åˆ†æ”¯: $BRANCH"
          else
            echo "âŒ æœªæ‰¾åˆ°repos.jsonæ–‡ä»¶"
            exit 1
          fi

      - name: è®¡ç®—é…ç½®æ–‡ä»¶å“ˆå¸Œ
        id: config_hash
        run: |
          # è®¡ç®—é…ç½®æ–‡ä»¶å“ˆå¸Œï¼ˆä¸åŒ…å«æ—¥æœŸï¼‰
          CONFIG_HASH=$(find configs/ -type f -name "*.config" -exec cat {} \; | md5sum | cut -d' ' -f1)
          # è®¡ç®—å·¥å…·é“¾å“ˆå¸Œï¼ˆåŸºäºŽåŸºç¡€é…ç½®ï¼‰
          TOOLCHAIN_HASH=$(cat configs/base_ipq60xx.config configs/base_immwrt.config 2>/dev/null | md5sum | cut -d' ' -f1)
          
          echo "hash=$CONFIG_HASH" >> $GITHUB_OUTPUT
          echo "toolchain_hash=$TOOLCHAIN_HASH" >> $GITHUB_OUTPUT
          echo "ðŸ“ é…ç½®æ–‡ä»¶å“ˆå¸Œ: $CONFIG_HASH"
          echo "ðŸ”¨ å·¥å…·é“¾å“ˆå¸Œ: $TOOLCHAIN_HASH"

      - name: ç”Ÿæˆæž„å»ºæ—¥æœŸ
        id: date
        run: |
          DATE=$(date +"%Y.%m.%d-%H%M")
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "ðŸ“… æž„å»ºæ—¥æœŸ: $DATE"

      - name: ç”ŸæˆReleaseæ ‡ç­¾
        id: tag
        run: |
          if [ -n "${{ github.event.inputs.release_tag }}" ]; then
            TAG="${{ github.event.inputs.release_tag }}"
          else
            TAG="AutoBuild-$(git rev-parse --short HEAD)"
          fi
          # ç¡®ä¿æ ‡ç­¾æ ¼å¼æ­£ç¡®
          TAG=$(echo "$TAG" | sed 's/[^a-zA-Z0-9._-]//g')
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "ðŸ·ï¸ Releaseæ ‡ç­¾: $TAG"

      - name: è®¾ç½®ç¼–è¯‘çŸ©é˜µ
        id: matrix
        run: |
          echo 'ultra=["Ultra"]' >> $GITHUB_OUTPUT
          echo 'variants=["Max","Pro"]' >> $GITHUB_OUTPUT

      - name: ç”Ÿæˆä¼˜åŒ–çš„ç¼“å­˜é”®
        id: cache_key
        run: |
          # åŸºç¡€ç¼“å­˜é”®ï¼ˆåŸºäºŽé…ç½®å“ˆå¸Œï¼Œä¸åŒ…å«æ—¥æœŸï¼‰
          BASE_KEY="openwrt-base-${{ steps.config_hash.outputs.hash }}"
          # å·¥å…·é“¾ç¼“å­˜é”®
          TOOLCHAIN_KEY="openwrt-toolchain-${{ steps.config_hash.outputs.toolchain_hash }}"
          # å®Œæ•´ç¼“å­˜é”®ï¼ˆåŒ…å«æºç commitï¼‰
          FULL_KEY="${BASE_KEY}-$(git rev-parse --short HEAD)"
          
          # æ¸…ç†ç‰¹æ®Šå­—ç¬¦
          BASE_KEY=$(echo "$BASE_KEY" | tr -d '\n\r')
          TOOLCHAIN_KEY=$(echo "$TOOLCHAIN_KEY" | tr -d '\n\r')
          FULL_KEY=$(echo "$FULL_KEY" | tr -d '\n\r')
          
          echo "base_key=$BASE_KEY" >> $GITHUB_OUTPUT
          echo "toolchain_key=$TOOLCHAIN_KEY" >> $GITHUB_OUTPUT
          echo "full_key=$FULL_KEY" >> $GITHUB_OUTPUT
          
          echo "ðŸ”‘ åŸºç¡€ç¼“å­˜é”®: $BASE_KEY"
          echo "ðŸ”‘ å·¥å…·é“¾ç¼“å­˜é”®: $TOOLCHAIN_KEY"
          echo "ðŸ”‘ å®Œæ•´ç¼“å­˜é”®: $FULL_KEY"

  # åŸºç¡€çŽ¯å¢ƒæž„å»º
  build-base:
    runs-on: ubuntu-22.04
    needs: prepare
    outputs:
      cache_hit: ${{ steps.cache.outputs.cache-hit }}
      build_success: ${{ steps.compile.outcome }}
    
    steps:
      - name: åˆå§‹åŒ–çŽ¯å¢ƒ
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-2204)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: éªŒè¯ä»“åº“åœ°å€
        run: |
          REPO="${{ needs.prepare.outputs.immwrt_repo }}"
          echo "ðŸ“¥ éªŒè¯ä»“åº“åœ°å€: $REPO"
          # éªŒè¯ä»“åº“æ˜¯å¦å¯è®¿é—®
          if ! git ls-remote "$REPO" > /dev/null 2>&1; then
            echo "âŒ ä»“åº“åœ°å€ä¸å¯è®¿é—®: $REPO"
            exit 1
          fi
          echo "âœ… ä»“åº“åœ°å€éªŒè¯é€šè¿‡"

      - name: ä¼ä¸šçº§å¤šå±‚ç¼“å­˜ç­–ç•¥
        id: cache
        uses: actions/cache@v4
        with:
          path: |
            /workdir/openwrt
            ~/.cache/go-build
            ~/.cache/pip
          key: ${{ needs.prepare.outputs.cache_key_full }}
          restore-keys: |
            ${{ needs.prepare.outputs.cache_key_base }}-
            openwrt-base-
            openwrt-toolchain-${{ needs.prepare.outputs.toolchain_hash }}-
            openwrt-toolchain-

      - name: å…‹éš†æºç 
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd /workdir
          echo "ðŸ“¥ å…‹éš†æºç ä»Ž: ${{ needs.prepare.outputs.immwrt_repo }}"
          echo "ðŸ“¥ ä½¿ç”¨åˆ†æ”¯: ${{ needs.prepare.outputs.immwrt_branch }}"
          git clone ${{ needs.prepare.outputs.immwrt_repo }} -b ${{ needs.prepare.outputs.immwrt_branch }} openwrt
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

      - name: é›†æˆdiy.shåŠŸèƒ½ï¼ˆP1éƒ¨åˆ†ï¼‰
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd /workdir/openwrt
          echo "ðŸ”§ é›†æˆdiy.sh P1åŠŸèƒ½ - ä¿®æ”¹æºç "
          
          # 1. ä¿®æ”¹é»˜è®¤IP
          echo "  - ä¿®æ”¹é»˜è®¤IPä¸º192.168.111.1"
          sed -i 's/192.168.1.1/192.168.111.1/g' package/base-files/files/bin/config_generate
          
          # 2. ä¿®æ”¹ç‰ˆæœ¬å·
          echo "  - ä¿®æ”¹ç‰ˆæœ¬å·"
          sed -i "s/DISTRIB_REVISION='.*'/DISTRIB_REVISION='R${{ needs.prepare.outputs.build_date }}'/g" package/base-files/files/etc/openwrt_release
          
          # 3. æ·»åŠ è‡ªå®šä¹‰è½¯ä»¶æº
          echo "  - æ·»åŠ è‡ªå®šä¹‰è½¯ä»¶æºé…ç½®"
          cat >> feeds.conf.default << EOF
          src-git small_package https://github.com/kenzok8/small-package;main
          EOF
          
          # 4. ä¿®æ”¹é»˜è®¤ä¸»é¢˜
          echo "  - è®¾ç½®é»˜è®¤ä¸»é¢˜"
          sed -i 's/luci-theme-bootstrap/luci-theme-argon/g' feeds/luci/collections/luci/Makefile 2>/dev/null || true
          
          echo "âœ… diy.sh P1åŠŸèƒ½é›†æˆå®Œæˆ"

      - name: é›†æˆdiy.shåŠŸèƒ½ï¼ˆP2éƒ¨åˆ†ï¼‰
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd /workdir/openwrt
          echo "ðŸ”§ é›†æˆdiy.sh P2åŠŸèƒ½ - æ·»åŠ é¢å¤–è½¯ä»¶åŒ…"
          
          # 1. æ·»åŠ ç¬¬ä¸‰æ–¹è½¯ä»¶æº
          echo "  - æ·»åŠ ç¬¬ä¸‰æ–¹è½¯ä»¶æº"
          git clone https://github.com/kenzok8/small-package package/small-package
          
          # 2. æ·»åŠ å…¶ä»–å¸¸ç”¨è½¯ä»¶æº
          echo "  - æ·»åŠ å…¶ä»–è½¯ä»¶æº"
          git clone https://github.com/Lienol/openwrt-package package/lienol 2>/dev/null || true
          
          # 3. æ›´æ–°æ‰€æœ‰feeds
          echo "  - æ›´æ–°feeds"
          ./scripts/feeds update -a
          
          # 4. å®‰è£…æ‰€æœ‰feeds
          echo "  - å®‰è£…feeds"
          ./scripts/feeds install -a
          
          # 5. å®‰è£…ç‰¹å®šè½¯ä»¶åŒ…
          echo "  - å®‰è£…ç‰¹å®šè½¯ä»¶åŒ…"
          ./scripts/feeds install luci-app-passwall 2>/dev/null || true
          ./scripts/feeds install luci-app-openclash 2>/dev/null || true
          ./scripts/feeds install luci-theme-argon 2>/dev/null || true
          
          echo "âœ… diy.sh P2åŠŸèƒ½é›†æˆå®Œæˆ"

      - name: é›†æˆrepo.shåŠŸèƒ½
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd /workdir/openwrt
          echo "ðŸ”§ é›†æˆrepo.shåŠŸèƒ½ - ä»“åº“ç®¡ç†"
          
          # 1. æ¸…ç†æ— ç”¨è½¯ä»¶åŒ…
          echo "  - æ¸…ç†æ— ç”¨è½¯ä»¶åŒ…"
          find package/ -name "*openvswitch*" -type d -exec rm -rf {} + 2>/dev/null || true
          find package/ -name "*docker*" -type d -exec rm -rf {} + 2>/dev/null || true
          
          echo "âœ… repo.shåŠŸèƒ½é›†æˆå®Œæˆ"

      - name: åŠ è½½åŸºç¡€é…ç½®
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd /workdir/openwrt
          echo "âš™ï¸ åŠ è½½åŸºç¡€é…ç½®"
          [ -f "$GITHUB_WORKSPACE/configs/base_ipq60xx.config" ] && \
            cp "$GITHUB_WORKSPACE/configs/base_ipq60xx.config" .config
          [ -f "$GITHUB_WORKSPACE/configs/base_immwrt.config" ] && \
            cat "$GITHUB_WORKSPACE/configs/base_immwrt.config" >> .config
          make defconfig

      - name: è‡ªå®šä¹‰å›ºä»¶è®¾ç½®
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd /workdir/openwrt
          echo "ðŸ”§ åº”ç”¨å›ºä»¶è‡ªå®šä¹‰è®¾ç½®"
          
          # è®¾ç½®IPåœ°å€ä¸º192.168.111.1
          sed -i "s/192.168.1.1/${{ env.FIRMWARE_IP }}/g" package/base-files/files/bin/config_generate
          
          # è®¾ç½®æœºå™¨åä¸ºWRT
          sed -i "s/OpenWrt/${{ env.FIRMWARE_NAME }}/g" package/base-files/files/bin/config_generate
          
          # è®¾ç½®å¯†ç ä¸ºç©º
          sed -i 's/root::0:0:99999:7:::/root::$1$zqzJn5Jp$6V8R2G5lFvUaU4D8p9k7J0:19146:0:99999:7:::/' package/base-files/files/etc/shadow
          
          # ç¦ç”¨é»˜è®¤å¯†ç æç¤º
          sed -i 's/Option password.*/Option password ""/' package/network/config/uci-defaults/12_network-generate-ula-prefix 2>/dev/null || true
          
          # è®¾ç½®æ—¶åŒº
          echo "Set timezone to $TZ"
          sed -i "s/'UTC'/'$TZ'/g" package/base-files/files/etc/sysupgrade.conf 2>/dev/null || true
          
          echo "âœ… å›ºä»¶è®¾ç½®å®Œæˆ"
          echo "   IPåœ°å€: ${{ env.FIRMWARE_IP }}"
          echo "   æœºå™¨å: ${{ env.FIRMWARE_NAME }}"
          echo "   å¯†ç : ç©ºå¯†ç "
          echo "   æ—¶åŒº: $TZ"

      - name: ä¸‹è½½ä¾èµ–åŒ…
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd /workdir/openwrt
          echo "ðŸ“¥ ä¸‹è½½ä¾èµ–åŒ…"
          make download -j$(nproc)
          # æ¸…ç†æ— æ•ˆçš„å°æ–‡ä»¶
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: é¢„ç¼–è¯‘å·¥å…·é“¾
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd /workdir/openwrt
          echo "ðŸ”¨ é¢„ç¼–è¯‘å·¥å…·é“¾"
          make toolchain/install -j$(nproc) || make toolchain/install -j1 V=s

      - name: æ£€æŸ¥ç©ºé—´ä½¿ç”¨
        if: always()
        run: |
          echo "ðŸ’¾ ç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ:"
          df -hT
          echo ""
          echo "ðŸ“ /workdirç›®å½•å¤§å°:"
          du -sh /workdir/*

  # Ultraå˜ä½“ç¼–è¯‘
  build-ultra:
    runs-on: ubuntu-22.04
    needs: [prepare, build-base]
    if: always() && needs.build-base.result == 'success'
    
    steps:
      - name: æ¢å¤ç¼–è¯‘çŽ¯å¢ƒ
        uses: actions/cache@v4
        with:
          path: |
            /workdir/openwrt
            ~/.cache/go-build
            ~/.cache/pip
          key: ${{ needs.prepare.outputs.cache_key_full }}
          restore-keys: |
            ${{ needs.prepare.outputs.cache_key_base }}-
            openwrt-base-
            openwrt-toolchain-${{ needs.prepare.outputs.toolchain_hash }}-
            openwrt-toolchain-

      - name: å‡†å¤‡Ultraé…ç½®
        run: |
          cd /workdir/openwrt
          echo "âš™ï¸ åŠ è½½Ultraé…ç½®"
          [ -f "$GITHUB_WORKSPACE/configs/Ultra.config" ] && \
            cat "$GITHUB_WORKSPACE/configs/Ultra.config" >> .config
          make defconfig

      - name: ç”ŸæˆLuciè½¯ä»¶åŒ…æ£€æŸ¥æŠ¥å‘Š
        id: luci_check
        run: |
          cd /workdir/openwrt
          echo "ðŸ” ç”ŸæˆLuciè½¯ä»¶åŒ…æ£€æŸ¥æŠ¥å‘Š"
          
          # åˆ›å»ºæŠ¥å‘Šæ–‡ä»¶
          REPORT_FILE="$GITHUB_WORKSPACE/luci_check_report.txt"
          echo "========================================" > $REPORT_FILE
          echo "Luciè½¯ä»¶åŒ…æ£€æŸ¥æŠ¥å‘Š - Ultraå˜ä½“" >> $REPORT_FILE
          echo "========================================" >> $REPORT_FILE
          echo "æž„å»ºæ—¶é—´: ${{ needs.prepare.outputs.build_date }}" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          
          # èŽ·å–é…ç½®ä¸­çš„æ‰€æœ‰LuciåŒ…
          echo "ã€é…ç½®ä¸­çš„Luciè½¯ä»¶åŒ…ã€‘" >> $REPORT_FILE
          CONFIG_LUCI=$(cat .config | grep "^CONFIG_PACKAGE_luci-" | cut -d'=' -f1 | sed 's/CONFIG_PACKAGE_//')
          echo "$CONFIG_LUCI" | while read pkg; do
            if [ -n "$pkg" ]; then
              echo "  - $pkg" >> $REPORT_FILE
            fi
          done
          echo "" >> $REPORT_FILE
          
          # æ£€æŸ¥æ¯ä¸ªåŒ…æ˜¯å¦å­˜åœ¨
          echo "ã€è½¯ä»¶åŒ…å­˜åœ¨æ€§æ£€æŸ¥ã€‘" >> $REPORT_FILE
          MISSING_COUNT=0
          FOUND_COUNT=0
          
          for pkg in $CONFIG_LUCI; do
            if [ -n "$pkg" ]; then
              if [ -d "package/$pkg" ] || [ -d "feeds/packages/$pkg" ] || [ -d "feeds/luci/$pkg" ]; then
                echo "  âœ… $pkg - å­˜åœ¨" >> $REPORT_FILE
                FOUND_COUNT=$((FOUND_COUNT + 1))
              else
                echo "  âŒ $pkg - ç¼ºå¤±" >> $REPORT_FILE
                MISSING_COUNT=$((MISSING_COUNT + 1))
              fi
            fi
          done
          
          echo "" >> $REPORT_FILE
          echo "ã€ç»Ÿè®¡ä¿¡æ¯ã€‘" >> $REPORT_FILE
          echo "  æ€»è®¡: $(echo "$CONFIG_LUCI" | grep -c .) ä¸ªåŒ…" >> $REPORT_FILE
          echo "  å­˜åœ¨: $FOUND_COUNT ä¸ªåŒ…" >> $REPORT_FILE
          echo "  ç¼ºå¤±: $MISSING_COUNT ä¸ªåŒ…" >> $REPORT_FILE
          
          # è¾“å‡ºåˆ°æŽ§åˆ¶å°
          echo ""
          echo "ðŸ” ========================================"
          echo "ðŸ” Luciè½¯ä»¶åŒ…æ£€æŸ¥æŠ¥å‘Š - Ultraå˜ä½“"
          echo "ðŸ” ========================================"
          cat $REPORT_FILE
          echo "ðŸ” ========================================"
          echo ""
          
          # ä¿å­˜åˆ°è¾“å‡º
          echo "missing_count=$MISSING_COUNT" >> $GITHUB_OUTPUT
          echo "found_count=$FOUND_COUNT" >> $GITHUB_OUTPUT
          
          # å¦‚æžœæœ‰ç¼ºå¤±åŒ…ï¼Œè®¾ç½®è­¦å‘Š
          if [ $MISSING_COUNT -gt 0 ]; then
            echo "âš ï¸ è­¦å‘Š: å‘çŽ° $MISSING_COUNT ä¸ªç¼ºå¤±çš„Luciè½¯ä»¶åŒ…"
            echo "ðŸ“„ è¯¦ç»†æŠ¥å‘Šå·²ä¿å­˜åˆ°: luci_check_report.txt"
          else
            echo "âœ… æ‰€æœ‰Luciè½¯ä»¶åŒ…æ£€æŸ¥é€šè¿‡"
          fi

      - name: ä¸Šä¼ Luciæ£€æŸ¥æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: luci-check-report-ultra
          path: luci_check_report.txt
          retention-days: 30

      - name: ç¼–è¯‘Ultraå›ºä»¶
        run: |
          cd /workdir/openwrt
          echo "ðŸš€ å¼€å§‹ç¼–è¯‘Ultraå˜ä½“"
          echo "ä½¿ç”¨ $(nproc) ä¸ªçº¿ç¨‹å¹¶è¡Œç¼–è¯‘"
          
          # å¤šé‡ç¼–è¯‘ç­–ç•¥
          make -j$(nproc) || make -j1 || make -j1 V=s
          
          echo "âœ… Ultraç¼–è¯‘å®Œæˆ"

      - name: æ•´ç†Ultraå›ºä»¶
        run: |
          cd /workdir/openwrt/bin/targets/*/*
          echo "ðŸ“¦ æ•´ç†Ultraå›ºä»¶"
          
          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p $GITHUB_WORKSPACE/firmware/Ultra
          
          # å¤åˆ¶å›ºä»¶æ–‡ä»¶
          find . -name "*immortalwrt*" -type f ! -name "*manifest*" | \
            xargs -I {} cp {} $GITHUB_WORKSPACE/firmware/Ultra/
          
          # é‡å‘½åå›ºä»¶
          cd $GITHUB_WORKSPACE/firmware/Ultra
          for file in *; do
            if [ -f "$file" ]; then
              mv "$file" "Ultra-${{ needs.prepare.outputs.build_date }}-${file}"
            fi
          done
          
          echo "âœ… Ultraå›ºä»¶æ•´ç†å®Œæˆ"
          ls -la

  # å˜ä½“å¹¶è¡Œç¼–è¯‘
  build-variants:
    runs-on: ubuntu-22.04
    needs: [prepare, build-base]
    if: always() && needs.build-base.result == 'success'
    strategy:
      matrix:
        variant: ${{ fromJson(needs.prepare.outputs.matrix_variants) }}
      fail-fast: false
    
    steps:
      - name: æ¢å¤ç¼–è¯‘çŽ¯å¢ƒ
        uses: actions/cache@v4
        with:
          path: |
            /workdir/openwrt
            ~/.cache/go-build
            ~/.cache/pip
          key: ${{ needs.prepare.outputs.cache_key_full }}
          restore-keys: |
            ${{ needs.prepare.outputs.cache_key_base }}-
            openwrt-base-
            openwrt-toolchain-${{ needs.prepare.outputs.toolchain_hash }}-
            openwrt-toolchain-

      - name: å‡†å¤‡${{ matrix.variant }}é…ç½®
        run: |
          cd /workdir/openwrt
          echo "âš™ï¸ åŠ è½½${{ matrix.variant }}é…ç½®"
          
          # æ¸…ç†ä¹‹å‰çš„é…ç½®
          make distclean
          
          # é‡æ–°åŠ è½½åŸºç¡€é…ç½®
          [ -f "$GITHUB_WORKSPACE/configs/base_ipq60xx.config" ] && \
            cp "$GITHUB_WORKSPACE/configs/base_ipq60xx.config" .config
          [ -f "$GITHUB_WORKSPACE/configs/base_immwrt.config" ] && \
            cat "$GITHUB_WORKSPACE/configs/base_immwrt.config" >> .config
          
          # åŠ è½½å˜ä½“é…ç½®
          [ -f "$GITHUB_WORKSPACE/configs/${{ matrix.variant }}.config" ] && \
            cat "$GITHUB_WORKSPACE/configs/${{ matrix.variant }}.config" >> .config
          
          make defconfig

      - name: ç”ŸæˆLuciè½¯ä»¶åŒ…æ£€æŸ¥æŠ¥å‘Š
        id: luci_check
        run: |
          cd /workdir/openwrt
          echo "ðŸ” ç”ŸæˆLuciè½¯ä»¶åŒ…æ£€æŸ¥æŠ¥å‘Š - ${{ matrix.variant }}å˜ä½“"
          
          # åˆ›å»ºæŠ¥å‘Šæ–‡ä»¶
          REPORT_FILE="$GITHUB_WORKSPACE/luci_check_report_${{ matrix.variant }}.txt"
          echo "========================================" > $REPORT_FILE
          echo "Luciè½¯ä»¶åŒ…æ£€æŸ¥æŠ¥å‘Š - ${{ matrix.variant }}å˜ä½“" >> $REPORT_FILE
          echo "========================================" >> $REPORT_FILE
          echo "æž„å»ºæ—¶é—´: ${{ needs.prepare.outputs.build_date }}" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          
          # èŽ·å–é…ç½®ä¸­çš„æ‰€æœ‰LuciåŒ…
          echo "ã€é…ç½®ä¸­çš„Luciè½¯ä»¶åŒ…ã€‘" >> $REPORT_FILE
          CONFIG_LUCI=$(cat .config | grep "^CONFIG_PACKAGE_luci-" | cut -d'=' -f1 | sed 's/CONFIG_PACKAGE_//')
          echo "$CONFIG_LUCI" | while read pkg; do
            if [ -n "$pkg" ]; then
              echo "  - $pkg" >> $REPORT_FILE
            fi
          done
          echo "" >> $REPORT_FILE
          
          # æ£€æŸ¥æ¯ä¸ªåŒ…æ˜¯å¦å­˜åœ¨
          echo "ã€è½¯ä»¶åŒ…å­˜åœ¨æ€§æ£€æŸ¥ã€‘" >> $REPORT_FILE
          MISSING_COUNT=0
          FOUND_COUNT=0
          
          for pkg in $CONFIG_LUCI; do
            if [ -n "$pkg" ]; then
              if [ -d "package/$pkg" ] || [ -d "feeds/packages/$pkg" ] || [ -d "feeds/luci/$pkg" ]; then
                echo "  âœ… $pkg - å­˜åœ¨" >> $REPORT_FILE
                FOUND_COUNT=$((FOUND_COUNT + 1))
              else
                echo "  âŒ $pkg - ç¼ºå¤±" >> $REPORT_FILE
                MISSING_COUNT=$((MISSING_COUNT + 1))
              fi
            fi
          done
          
          echo "" >> $REPORT_FILE
          echo "ã€ç»Ÿè®¡ä¿¡æ¯ã€‘" >> $REPORT_FILE
          echo "  æ€»è®¡: $(echo "$CONFIG_LUCI" | grep -c .) ä¸ªåŒ…" >> $REPORT_FILE
          echo "  å­˜åœ¨: $FOUND_COUNT ä¸ªåŒ…" >> $REPORT_FILE
          echo "  ç¼ºå¤±: $MISSING_COUNT ä¸ªåŒ…" >> $REPORT_FILE
          
          # è¾“å‡ºåˆ°æŽ§åˆ¶å°
          echo ""
          echo "ðŸ” ========================================"
          echo "ðŸ” Luciè½¯ä»¶åŒ…æ£€æŸ¥æŠ¥å‘Š - ${{ matrix.variant }}å˜ä½“"
          echo "ðŸ” ========================================"
          cat $REPORT_FILE
          echo "ðŸ” ========================================"
          echo ""
          
          # ä¿å­˜åˆ°è¾“å‡º
          echo "missing_count=$MISSING_COUNT" >> $GITHUB_OUTPUT
          echo "found_count=$FOUND_COUNT" >> $GITHUB_OUTPUT
          
          # å¦‚æžœæœ‰ç¼ºå¤±åŒ…ï¼Œè®¾ç½®è­¦å‘Š
          if [ $MISSING_COUNT -gt 0 ]; then
            echo "âš ï¸ è­¦å‘Š: ${{ matrix.variant }}å˜ä½“å‘çŽ° $MISSING_COUNT ä¸ªç¼ºå¤±çš„Luciè½¯ä»¶åŒ…"
          else
            echo "âœ… ${{ matrix.variant }}å˜ä½“æ‰€æœ‰Luciè½¯ä»¶åŒ…æ£€æŸ¥é€šè¿‡"
          fi

      - name: ä¸Šä¼ Luciæ£€æŸ¥æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: luci-check-report-${{ matrix.variant }}
          path: luci_check_report_${{ matrix.variant }}.txt
          retention-days: 30

      - name: ç¼–è¯‘${{ matrix.variant }}å›ºä»¶
        run: |
          cd /workdir/openwrt
          echo "ðŸš€ å¼€å§‹ç¼–è¯‘${{ matrix.variant }}å˜ä½“"
          echo "ä½¿ç”¨ $(nproc) ä¸ªçº¿ç¨‹å¹¶è¡Œç¼–è¯‘"
          
          # å¤šé‡ç¼–è¯‘ç­–ç•¥
          make -j$(nproc) || make -j1 || make -j1 V=s
          
          echo "âœ… ${{ matrix.variant }}ç¼–è¯‘å®Œæˆ"

      - name: æ•´ç†${{ matrix.variant }}å›ºä»¶
        run: |
          cd /workdir/openwrt/bin/targets/*/*
          echo "ðŸ“¦ æ•´ç†${{ matrix.variant }}å›ºä»¶"
          
          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p $GITHUB_WORKSPACE/firmware/${{ matrix.variant }}
          
          # å¤åˆ¶å›ºä»¶æ–‡ä»¶
          find . -name "*immortalwrt*" -type f ! -name "*manifest*" | \
            xargs -I {} cp {} $GITHUB_WORKSPACE/firmware/${{ matrix.variant }}/
          
          # é‡å‘½åå›ºä»¶
          cd $GITHUB_WORKSPACE/firmware/${{ matrix.variant }}
          for file in *; do
            if [ -f "$file" ]; then
              mv "$file" "${{ matrix.variant }}-${{ needs.prepare.outputs.build_date }}-${file}"
            fi
          done
          
          echo "âœ… ${{ matrix.variant }}å›ºä»¶æ•´ç†å®Œæˆ"
          ls -la

  # å‘å¸ƒé˜¶æ®µ
  release:
    runs-on: ubuntu-22.04
    needs: [prepare, build-ultra, build-variants]
    if: always() && (needs.build-ultra.result == 'success' || needs.build-variants.result == 'success')
    
    steps:
      - name: æ•´ç†æ‰€æœ‰å›ºä»¶
        run: |
          mkdir -p $GITHUB_WORKSPACE/release
          
          # å¤åˆ¶æ‰€æœ‰å˜ä½“å›ºä»¶
          for variant in Ultra Max Pro; do
            if [ -d "firmware/$variant" ]; then
              echo "ðŸ“¦ å¤åˆ¶$variantå›ºä»¶"
              cp -r firmware/$variant/* release/
            fi
          done
          
          # ç”Ÿæˆå›ºä»¶ä¿¡æ¯æ–‡ä»¶
          cd $GITHUB_WORKSPACE/release
          cat > firmware_info.md << 'EOF'
          # OpenWrt IPQ60x2 å›ºä»¶å‘å¸ƒ
          
          ## ðŸ“‹ å›ºä»¶ä¿¡æ¯
          - **æž„å»ºæ—¶é—´**: ${BUILD_DATE}
          - **æºç åˆ†æ”¯**: ${REPO_BRANCH}
          - **æºç ä»“åº“**: ${IMMWRT_REPO}
          - **é…ç½®å“ˆå¸Œ**: ${CONFIG_HASH}
          - **ç¼“å­˜å‘½ä¸­**: ${CACHE_HIT}
          
          ## ðŸ”§ å›ºä»¶è®¾ç½®
          - **IPåœ°å€**: ${FIRMWARE_IP}
          - **æœºå™¨å**: ${FIRMWARE_NAME}
          - **å¯†ç **: ç©ºå¯†ç 
          - **ç™»å½•æ–¹å¼**: SSHæˆ–Webç•Œé¢
          
          ## ðŸ“¦ å˜ä½“è¯´æ˜Ž
          - **Ultra**: å®Œæ•´åŠŸèƒ½ç‰ˆæœ¬ï¼ŒåŒ…å«æ‰€æœ‰å¯ç”¨æ’ä»¶å’ŒåŠŸèƒ½
          - **Max**: åŠŸèƒ½å¢žå¼ºç‰ˆæœ¬ï¼Œå¹³è¡¡æ€§èƒ½å’ŒåŠŸèƒ½
          - **Pro**: ä¸“ä¸šä¼˜åŒ–ç‰ˆæœ¬ï¼Œç²¾ç®€ä¼˜åŒ–ï¼Œé€‚åˆé«˜çº§ç”¨æˆ·
          
          ## ðŸš€ ä½¿ç”¨è¯´æ˜Ž
          1. ä¸‹è½½å¯¹åº”å˜ä½“çš„å›ºä»¶æ–‡ä»¶
          2. é€šè¿‡è·¯ç”±å™¨åŽå°æˆ–TFTPæ–¹å¼åˆ·å…¥
          3. åˆ·å…¥åŽè®¿é—® ${FIRMWARE_IP}
          4. ç”¨æˆ·å: rootï¼Œå¯†ç : ç©º
          
          ## âš ï¸ æ³¨æ„äº‹é¡¹
          - é¦–æ¬¡åˆ·æœºå»ºè®®ä½¿ç”¨U-Bootåˆ·æœº
          - å¤‡ä»½åŽŸåŽ‚å›ºä»¶ä»¥é˜²ä¸‡ä¸€
          - åˆ·æœºå‰è¯·ç¡®è®¤è®¾å¤‡åž‹å·
          
          ---
          æž„å»ºç³»ç»Ÿ: GitHub Actions
          æž„å»ºä»»åŠ¡: ${RUN_ID}
          EOF
          
          # æ›¿æ¢å˜é‡
          sed -i "s/\${BUILD_DATE}/${{ needs.prepare.outputs.build_date }}/g" firmware_info.md
          sed -i "s/\${REPO_BRANCH}/${{ needs.prepare.outputs.immwrt_branch }}/g" firmware_info.md
          sed -i "s#\${IMMWRT_REPO}#${{ needs.prepare.outputs.immwrt_repo }}#g" firmware_info.md
          sed -i "s/\${CONFIG_HASH}/${{ needs.prepare.outputs.config_hash }}/g" firmware_info.md
          sed -i "s/\${CACHE_HIT}/${{ needs.build-base.outputs.cache-hit }}/g" firmware_info.md
          sed -i "s/\${FIRMWARE_IP}/${{ env.FIRMWARE_IP }}/g" firmware_info.md
          sed -i "s/\${FIRMWARE_NAME}/${{ env.FIRMWARE_NAME }}/g" firmware_info.md
          sed -i "s/\${RUN_ID}/${{ github.run_id }}/g" firmware_info.md
          
          echo "âœ… å›ºä»¶æ•´ç†å®Œæˆ"
          ls -la

      - name: ç”Ÿæˆæ ¡éªŒå’Œ
        run: |
          cd $GITHUB_WORKSPACE/release
          echo "ðŸ” ç”Ÿæˆæ–‡ä»¶æ ¡éªŒå’Œ"
          sha256sum * > sha256sums.txt
          md5sum * > md5sums.txt
          echo "âœ… æ ¡éªŒå’Œç”Ÿæˆå®Œæˆ"

      - name: åˆ›å»ºRelease
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare.outputs.release_tag }}
          name: "OpenWrt IPQ60x2 ${{ needs.prepare.outputs.build_date }}"
          body_path: release/firmware_info.md
          files: |
            release/*
            !release/firmware_info.md
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ä¸Šä¼ æž„å»ºæ—¥å¿—
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ needs.prepare.outputs.build_date }}
          path: |
            /workdir/openwrt/logs/
            /workdir/openwrt/.config
          retention-days: 30

      - name: æž„å»ºç»“æžœæ±‡æ€»
        if: always()
        run: |
          echo "## ðŸ“Š æž„å»ºç»“æžœæ±‡æ€»" >> $GITHUB_STEP_SUMMARY
          echo "| å˜ä½“ | çŠ¶æ€ | å›ºä»¶æ•°é‡ | ç¼“å­˜å‘½ä¸­ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|----------|----------|" >> $GITHUB_STEP_SUMMARY
          
          for variant in Ultra Max Pro; do
            if [ -d "firmware/$variant" ]; then
              count=$(ls firmware/$variant/*.bin 2>/dev/null | wc -l)
              status="âœ… æˆåŠŸ"
            else
              count=0
              status="âŒ å¤±è´¥"
            fi
            echo "| $variant | $status | $count | ${{ needs.build-base.outputs.cache-hit }} |" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“ˆ æž„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **Releaseæ ‡ç­¾**: ${{ needs.prepare.outputs.release_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æž„å»ºæ—¥æœŸ**: ${{ needs.prepare.outputs.build_date }}" >> $GITHUB_STEP_SUMMARY
          echo "- **é…ç½®å“ˆå¸Œ**: ${{ needs.prepare.outputs.config_hash }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å·¥å…·é“¾å“ˆå¸Œ**: ${{ needs.prepare.outputs.toolchain_hash }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç¼“å­˜å‘½ä¸­**: ${{ needs.build-base.outputs.cache-hit }}" >> $GITHUB_STEP_SUMMARY
          
          # ä¸‹è½½é“¾æŽ¥
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## â¬‡ï¸ ä¸‹è½½é“¾æŽ¥" >> $GITHUB_STEP_SUMMARY
          echo "[æŸ¥çœ‹æ‰€æœ‰å›ºä»¶](https://github.com/${{ github.repository }}/releases/tag/${{ needs.prepare.outputs.release_tag }})" >> $GITHUB_STEP_SUMMARY
          
          # Luciæ£€æŸ¥æŠ¥å‘Šé“¾æŽ¥
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Luciæ£€æŸ¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "- [Ultraå˜ä½“æŠ¥å‘Š](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Maxå˜ä½“æŠ¥å‘Š](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Proå˜ä½“æŠ¥å‘Š](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
