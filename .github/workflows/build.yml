# .github/workflows/build.yml
# =============================================================================
# ImmortalWrt å›ºä»¶ç¼–è¯‘ç³»ç»Ÿå·¥ä½œæµ
# ç‰ˆæœ¬: 1.0.3
# æ›´æ–°æ—¥æœŸ: 2025-11-18
# =============================================================================

name: ImmortalWrt å›ºä»¶ç¼–è¯‘ç³»ç»Ÿ

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      variant:
        description: 'é€‰æ‹©è¦ç¼–è¯‘çš„å˜ä½“'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - ultra
        - max
        - pro
      device:
        description: 'é€‰æ‹©ç›®æ ‡è®¾å¤‡ (ç•™ç©ºåˆ™ç¼–è¯‘æ‰€æœ‰è®¾å¤‡)'
        required: false
        default: ''
        type: choice
        options:
        - ''
        - jdcloud_re-ss-01
        - jdcloud_re-cs-02
        - jdcloud_rz-caa-07
      compile_mode:
        description: 'ç¼–è¯‘æ¨¡å¼ (å¹¶è¡Œæˆ–é¡ºåº)'
        required: true
        default: 'parallel'
        type: choice
        options:
        - parallel
        - sequential

env:
  # ç‰ˆæœ¬æŽ§åˆ¶
  VERSION: "1.0.3"
  RELEASE_DATE: "2025-11-18"
  
  # ä»“åº“é…ç½®
  REPO_OWNER: laipeng668
  REPO_NAME: immortalwrt
  REPO_BRANCH: master
  
  # å›ºä»¶é…ç½®
  FIRMWARE_IP: "192.168.111.1"
  FIRMWARE_NAME: "WRT"
  AUTHOR_NAME: "Mary"
  
  # ç³»ç»Ÿé…ç½®
  TZ: "Asia/Shanghai"

jobs:
  prepare:
    runs-on: ubuntu-24.04
    outputs:
      device_list: ${{ steps.extract_devices.outputs.devices }}
      cache_key: ${{ steps.cache_key.outputs.key }}
      cache_version: ${{ steps.cache_key.outputs.version }}
      selected_device: ${{ steps.select_device.outputs.device }}
      compile_mode: ${{ steps.set_compile_mode.outputs.mode }}
    steps:
    - name: ðŸš€ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ðŸ“… è®¾ç½®çŽ¯å¢ƒå˜é‡
      run: |
        echo "BUILD_DATE=$(date +%Y-%m-%d)" >> $GITHUB_ENV
        echo "BUILD_TIME=$(date +%H:%M:%S)" >> $GITHUB_ENV
        echo "BUILD_TIMESTAMP=$(date +%s)" >> $GITHUB_ENV
        echo "TOOLCHAIN_VERSION=$(date +%Y%m%d)" >> $GITHUB_ENV

    - name: ðŸ“¦ å®‰è£…å¿…è¦çš„è½¯ä»¶åŒ…
      run: |
        sudo apt-get update
        
        # å®‰è£…åŸºç¡€ç¼–è¯‘å·¥å…·å’Œä¾èµ–
        sudo apt-get install -y build-essential ccache ecj fastjar file g++ gawk gettext git java-propose-classpath libelf-dev libncurses5-dev libncursesw5-dev libssl-dev python3 unzip python3-pyelftools python3-pip rsync subversion swig time wget vim python3-pyelftools python3-dev curl jq
        
        # å®‰è£…ç³»ç»Ÿåº“ä¾èµ–ï¼Œè§£å†³ç¼–è¯‘è­¦å‘Š
        # æ³¨æ„ï¼šOpenWrtç¼–è¯‘è¿‡ç¨‹ä¸­å‡ºçŽ°ä¾èµ–è­¦å‘Šæ˜¯æ­£å¸¸çŽ°è±¡ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†å¤§éƒ¨åˆ†ä¾èµ–
        # ä½†å…³é”®ä¾èµ–éœ€è¦æ‰‹åŠ¨å®‰è£…ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´ç¼–è¯‘å¤±è´¥
        sudo apt-get install -y \
          libpam0g-dev \
          libtirpc-dev \
          libev-dev \
          libsensors-dev \
          liblzma-dev \
          libsnmp-dev \
          libglib2.0-dev \
          libgpiod-dev
        
        echo -e "\033[1;32mâœ… è½¯ä»¶åŒ…å®‰è£…å®Œæˆ\033[0m"
        echo -e "\033[1;33mâš ï¸ æ³¨æ„ï¼šç¼–è¯‘è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå‡ºçŽ°ä¾èµ–è­¦å‘Šï¼Œè¿™æ˜¯æ­£å¸¸çŽ°è±¡\033[0m"
        echo -e "\033[1;33mâš ï¸ ç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†å¤§éƒ¨åˆ†ä¾èµ–ï¼Œå…³é”®ä¾èµ–å·²æ‰‹åŠ¨å®‰è£…\033[0m"
        echo -e "\033[1;33mâš ï¸ ä»¥ä¸‹OpenWrtç‰¹æœ‰åŒ…ä¼šåœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­è‡ªåŠ¨è§£å†³ï¼š\033[0m"
        echo -e "\033[1;33mâš ï¸ - luci, luci-i18n-base-zh-cn (LUCIç›¸å…³åŒ…)\033[0m"
        echo -e "\033[1;33mâš ï¸ - kmod-qca-nss-drv, kmod-qca-nss-drv-wifi-meshmgr (å†…æ ¸æ¨¡å—)\033[0m"

    - name: ðŸ”‘ åˆ›å»ºç¼“å­˜é”®
      id: cache_key
      run: |
        # ä½¿ç”¨æºç åˆ†æ”¯ã€å·¥å…·é“¾ç‰ˆæœ¬å’Œæ—¥æœŸä½œä¸ºç¼“å­˜é”®
        echo "key=immwrt-${{ env.REPO_BRANCH }}-${{ env.TOOLCHAIN_VERSION }}" >> $GITHUB_OUTPUT
        echo "version=${{ env.VERSION }}-${{ env.RELEASE_DATE }}" >> $GITHUB_OUTPUT
        echo -e "\033[1;32mâœ… ç¼“å­˜é”®: immwrt-${{ env.REPO_BRANCH }}-${{ env.TOOLCHAIN_VERSION }}\033[0m"

    - name: ðŸ“± æå–è®¾å¤‡åç§°
      id: extract_devices
      run: |
        # åˆ›å»ºè®¾å¤‡æå–è„šæœ¬
        cat > extract_devices.sh << 'EOF'
        #!/bin/bash
        # =============================================================================
        # è®¾å¤‡åç§°æå–è„šæœ¬
        # ç‰ˆæœ¬: 1.0.3
        # æ›´æ–°æ—¥æœŸ: 2025-11-18
        # =============================================================================
        
        # é¢œè‰²å®šä¹‰
        RED='\033[0;31m'
        GREEN='\033[0;32m'
        YELLOW='\033[1;33m'
        BLUE='\033[0;34m'
        NC='\033[0m' # No Color
        
        # æ£€æŸ¥å‚æ•°
        if [ $# -lt 1 ]; then
            echo -e "${RED}âŒ ç”¨æ³•: $0 <é…ç½®æ–‡ä»¶è·¯å¾„>${NC}"
            exit 1
        fi
        
        CONFIG_FILE=$1
        
        # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "$CONFIG_FILE" ]; then
            echo -e "${RED}âŒ é”™è¯¯: é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $CONFIG_FILE${NC}"
            exit 1
        fi
        
        # æå–è®¾å¤‡åç§°
        echo -e "${BLUE}ðŸ“± æå–è®¾å¤‡åç§°...${NC}"
        
        # ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–è®¾å¤‡åç§°ï¼Œä»Ž_DEVICE_åˆ°=yä¸­é—´çš„éƒ¨åˆ†
        devices=$(grep -oE 'CONFIG_TARGET_DEVICE_[^_]+_DEVICE_[^=]+=y' "$CONFIG_FILE" | sed -E 's/CONFIG_TARGET_DEVICE_[^_]+_DEVICE_([^=]+)=y/\1/' | sort -u)
        
        if [ -z "$devices" ]; then
            echo -e "${YELLOW}âš ï¸ è­¦å‘Š: æœªæ‰¾åˆ°è®¾å¤‡åç§°ï¼Œä½¿ç”¨é»˜è®¤è®¾å¤‡${NC}"
            devices="jdcloud_re-ss-01 jdcloud_re-cs-02 jdcloud_rz-caa-07"
        fi
        
        echo -e "${GREEN}âœ… æ‰¾åˆ°çš„è®¾å¤‡:${NC}"
        for device in $devices; do
            echo -e "  ðŸ“± $device"
        done
        
        # è¾“å‡ºè®¾å¤‡åˆ—è¡¨ï¼Œä¾›GitHub Actionsä½¿ç”¨
        echo "$devices"
        EOF
        
        chmod +x extract_devices.sh
        
        # æå–è®¾å¤‡åç§°
        if [ -f "configs/base_ipq60xx.config" ]; then
          devices=$(./extract_devices.sh configs/base_ipq60xx.config)
        else
          # å¦‚æžœé…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤è®¾å¤‡
          devices="jdcloud_re-ss-01 jdcloud_re-cs-02 jdcloud_rz-caa-07"
        fi
        
        echo "devices=$devices" >> $GITHUB_OUTPUT
        echo -e "\033[1;32mâœ… æ‰¾åˆ°çš„è®¾å¤‡: $devices\033[0m"

    - name: ðŸ“± é€‰æ‹©ç›®æ ‡è®¾å¤‡
      id: select_device
      run: |
        # å¦‚æžœç”¨æˆ·æŒ‡å®šäº†è®¾å¤‡ï¼Œä½¿ç”¨æŒ‡å®šçš„è®¾å¤‡ï¼›å¦åˆ™ä½¿ç”¨æ‰€æœ‰è®¾å¤‡
        if [ -n "${{ github.event.inputs.device }}" ]; then
          echo "device=${{ github.event.inputs.device }}" >> $GITHUB_OUTPUT
          echo -e "\033[1;32mâœ… é€‰æ‹©è®¾å¤‡: ${{ github.event.inputs.device }}\033[0m"
        else
          echo "device=" >> $GITHUB_OUTPUT
          echo -e "\033[1;32mâœ… ç¼–è¯‘æ‰€æœ‰è®¾å¤‡\033[0m"
        fi

    - name: âš™ï¸ è®¾ç½®ç¼–è¯‘æ¨¡å¼
      id: set_compile_mode
      run: |
        # è®¾ç½®ç¼–è¯‘æ¨¡å¼ï¼Œé»˜è®¤ä¸ºå¹¶è¡Œ
        mode="${{ github.event.inputs.compile_mode }}"
        if [ -z "$mode" ]; then
          mode="parallel"
        fi
        echo "mode=$mode" >> $GITHUB_OUTPUT
        echo -e "\033[1;32mâœ… ç¼–è¯‘æ¨¡å¼: $mode\033[0m"

    - name: ðŸ“ åˆ›å»ºå·¥ä½œç›®å½•
      run: |
        mkdir -p build workspace

    - name: ðŸ’¾ æ‰©å±•ç£ç›˜ç©ºé—´
      run: |
        # åˆ›å»ºè½¯é“¾æŽ¥æ‰©å±•ç£ç›˜ç©ºé—´
        sudo mkdir -p /mnt/ramdisk
        sudo mount -t tmpfs -o size=10G tmpfs /mnt/ramdisk
        sudo mkdir -p /mnt/ramdisk/build
        sudo chown $USER:$USER /mnt/ramdisk/build
        ln -sf /mnt/ramdisk/build ./build
        echo -e "\033[1;32mâœ… ç£ç›˜ç©ºé—´æ‰©å±•æˆåŠŸ\033[0m"

  build-ultra:
    needs: prepare
    runs-on: ubuntu-24.04
    if: github.event.inputs.variant == 'all' || github.event.inputs.variant == 'ultra' || github.event.inputs.variant == ''
    outputs:
      cache_hit: ${{ steps.cache.outputs.cache-hit }}
    steps:
    - name: ðŸš€ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ðŸ’¾ æ¢å¤å·¥ä½œç›®å½•
      run: |
        sudo mkdir -p /mnt/ramdisk
        sudo mount -t tmpfs -o size=10G tmpfs /mnt/ramdisk
        sudo mkdir -p /mnt/ramdisk/build
        sudo chown $USER:$USER /mnt/ramdisk/build
        ln -sf /mnt/ramdisk/build ./build

    - name: ðŸ’¾ æ¢å¤ç¼“å­˜
      uses: actions/cache@v4
      id: cache
      with:
        path: |
          ./build
          ~/.ccache
        key: ${{ needs.prepare.outputs.cache_key }}-ultra
        restore-keys: |
          immwrt-${{ env.REPO_BRANCH }}-

    - name: ðŸ“¥ å…‹éš†æºç ä»“åº“
      run: |
        echo -e "\033[1;34mðŸ“¥ å¼€å§‹å…‹éš†æºç ä»“åº“...\033[0m"
        git clone https://github.com/${{ env.REPO_OWNER }}/${{ env.REPO_NAME }}.git -b ${{ env.REPO_BRANCH }} build/source
        cd build/source
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶å’Œè„šæœ¬
        if [ -d "../../configs" ]; then
          cp ../../configs/* ../configs/
        fi
        if [ -d "../../scripts" ]; then
          cp ../../scripts/* ../scripts/
          chmod +x ../scripts/*.sh
        fi

    - name: ðŸ”§ åˆå¹¶é…ç½®æ–‡ä»¶
      run: |
        cd build/source
        echo -e "\033[1;34mðŸ”§ åˆå¹¶é…ç½®æ–‡ä»¶...\033[0m"
        
        # åˆ›å»ºé…ç½®ç›®å½•ï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
        mkdir -p ../configs
        
        # ä¸‹è½½é…ç½®æ–‡ä»¶ï¼ˆå¦‚æžœæœ¬åœ°ä¸å­˜åœ¨ï¼‰
        if [ ! -f "../configs/base_ipq60xx.config" ]; then
          curl -L https://raw.githubusercontent.com/aghu1979/ipq60x2/main/configs/base_ipq60xx.config -o ../configs/base_ipq60xx.config
        fi
        if [ ! -f "../configs/base_immwrt.config" ]; then
          curl -L https://raw.githubusercontent.com/aghu1979/ipq60x2/main/configs/base_immwrt.config -o ../configs/base_immwrt.config
        fi
        if [ ! -f "../configs/Ultra.config" ]; then
          curl -L https://raw.githubusercontent.com/aghu1979/ipq60x2/main/configs/Ultra.config -o ../configs/Ultra.config
        fi
        
        # åˆ›å»ºåˆå¹¶é…ç½®è„šæœ¬
        cat > ../scripts/merge_config.sh << 'EOF'
        #!/bin/bash
        # =============================================================================
        # é…ç½®æ–‡ä»¶åˆå¹¶è„šæœ¬
        # ç‰ˆæœ¬: 1.0.3
        # æ›´æ–°æ—¥æœŸ: 2025-11-18
        # =============================================================================
        
        # é¢œè‰²å®šä¹‰
        RED='\033[0;31m'
        GREEN='\033[0;32m'
        YELLOW='\033[1;33m'
        BLUE='\033[0;34m'
        NC='\033[0m' # No Color
        
        # èŽ·å–å‚æ•°
        BASE_CONFIG=$1
        BRANCH_CONFIG=$2
        VARIANT_CONFIG=$3
        OUTPUT_CONFIG=$4
        SELECTED_DEVICE=$5
        
        echo -e "${BLUE}ðŸ”§ åˆå¹¶é…ç½®æ–‡ä»¶...${NC}"
        
        # æ£€æŸ¥å‚æ•°
        if [ $# -lt 4 ]; then
            echo -e "${RED}âŒ é”™è¯¯: å‚æ•°ä¸è¶³${NC}"
            echo -e "${YELLOW}ç”¨æ³•: $0 <åŸºç¡€é…ç½®> <åˆ†æ”¯é…ç½®> <å˜ä½“é…ç½®> <è¾“å‡ºé…ç½®> [é€‰å®šè®¾å¤‡]${NC}"
            exit 1
        fi
        
        # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        for config in "$BASE_CONFIG" "$BRANCH_CONFIG" "$VARIANT_CONFIG"; do
            if [ ! -f "$config" ]; then
                echo -e "${RED}âŒ é”™è¯¯: é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $config${NC}"
                exit 1
            fi
        done
        
        # è¿‡æ»¤æŽ‰æ³¨é‡Šè¡Œå’Œç©ºè¡Œï¼Œåˆå¹¶é…ç½®æ–‡ä»¶
        grep -v '^#' "$BASE_CONFIG" | grep -v '^$' > temp_base.config
        grep -v '^#' "$BRANCH_CONFIG" | grep -v '^$' > temp_branch.config
        grep -v '^#' "$VARIANT_CONFIG" | grep -v '^$' > temp_variant.config
        
        # åˆå¹¶é…ç½®
        cat temp_base.config temp_branch.config temp_variant.config > "$OUTPUT_CONFIG"
        
        # å¦‚æžœæŒ‡å®šäº†è®¾å¤‡ï¼Œåªä¿ç•™æŒ‡å®šè®¾å¤‡çš„é…ç½®
        if [ -n "$SELECTED_DEVICE" ]; then
          echo -e "${YELLOW}ðŸ“± åªä¿ç•™è®¾å¤‡ $SELECTED_DEVICE çš„é…ç½®${NC}"
          
          # ç¦ç”¨æ‰€æœ‰è®¾å¤‡
          sed -i 's/CONFIG_TARGET_DEVICE_.*_DEVICE_.*=y/# CONFIG_TARGET_DEVICE_&/g' "$OUTPUT_CONFIG"
          
          # å¯ç”¨æŒ‡å®šè®¾å¤‡
          sed -i "s/# CONFIG_TARGET_DEVICE_.*_DEVICE_${SELECTED_DEVICE}=y/CONFIG_TARGET_DEVICE_qualcommax_ipq60xx_DEVICE_${SELECTED_DEVICE}=y/g" "$OUTPUT_CONFIG"
        fi
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -f temp_base.config temp_branch.config temp_variant.config
        
        echo -e "${GREEN}âœ… é…ç½®æ–‡ä»¶åˆå¹¶å®Œæˆ${NC}"
        EOF
        
        chmod +x ../scripts/merge_config.sh
        
        # æ‰§è¡Œåˆå¹¶é…ç½®è„šæœ¬
        ../scripts/merge_config.sh ../configs/base_ipq60xx.config ../configs/base_immwrt.config ../configs/Ultra.config .config "${{ needs.prepare.outputs.selected_device }}"
        
        # è¿è¡Œ defconfig è¡¥å…¨é…ç½®
        echo -e "\033[1;34mðŸ”§ è¿è¡Œ defconfig è¡¥å…¨é…ç½®...\033[0m"
        make defconfig || echo -e "\033[1;33mâš ï¸ defconfig æœ‰è­¦å‘Šï¼Œä½†ç»§ç»­æ‰§è¡Œ${NC}"
        
        # æå–å¹¶æ˜¾ç¤º luci è½¯ä»¶åŒ…å·®å¼‚
        echo -e "\033[1;33mðŸ“‹ LUCI è½¯ä»¶åŒ…æŠ¥å‘Š\033[0m"
        grep -E '^CONFIG_PACKAGE_luci.*=y$' .config > ../luci-after.txt || true
        
        echo -e "\033[1;36mðŸ“¦ å·²åŒ…å«çš„ LUCI è½¯ä»¶åŒ…:\033[0m"
        if [ -f "../luci-after.txt" ]; then
          cat ../luci-after.txt | while read line; do
            pkg=$(echo $line | sed 's/CONFIG_PACKAGE_//g' | sed 's/=y//g')
            echo -e "  âœ¨ $pkg"
          done
        else
          echo -e "  ðŸ“­ æœªæ‰¾åˆ° LUCI è½¯ä»¶åŒ…"
        fi

    - name: ðŸŽ¨ åº”ç”¨è‡ªå®šä¹‰è„šæœ¬
      run: |
        cd build/source
        echo -e "\033[1;34mðŸŽ¨ åº”ç”¨è‡ªå®šä¹‰è„šæœ¬...\033[0m"
        
        # åˆ›å»ºè„šæœ¬ç›®å½•ï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
        mkdir -p ../scripts
        
        # ä¸‹è½½è„šæœ¬ï¼ˆå¦‚æžœæœ¬åœ°ä¸å­˜åœ¨ï¼‰
        if [ ! -f "../scripts/diy.sh" ]; then
          curl -L https://raw.githubusercontent.com/aghu1979/ipq60x2/main/scripts/diy.sh -o ../scripts/diy.sh
        fi
        
        # è®¾ç½®çŽ¯å¢ƒå˜é‡
        export FIRMWARE_IP="${{ env.FIRMWARE_IP }}"
        export FIRMWARE_NAME="${{ env.FIRMWARE_NAME }}"
        export AUTHOR_NAME="${{ env.AUTHOR_NAME }}"
        
        # æ‰§è¡Œè„šæœ¬
        chmod +x ../scripts/diy.sh
        ../scripts/diy.sh || echo -e "\033[1;33mâš ï¸ diy.sh æ‰§è¡Œæœ‰è­¦å‘Šï¼Œä½†ç»§ç»­æ‰§è¡Œ${NC}"

    - name: ðŸ“¦ æ·»åŠ ç¬¬ä¸‰æ–¹è½¯ä»¶æº
      run: |
        cd build/source
        echo -e "\033[1;34mðŸ“¦ æ·»åŠ ç¬¬ä¸‰æ–¹è½¯ä»¶æº...\033[0m"
        
        # ä¸‹è½½è„šæœ¬ï¼ˆå¦‚æžœæœ¬åœ°ä¸å­˜åœ¨ï¼‰
        if [ ! -f "../scripts/repo.sh" ]; then
          curl -L https://raw.githubusercontent.com/aghu1979/ipq60x2/main/scripts/repo.sh -o ../scripts/repo.sh
        fi
        
        # æ‰§è¡Œè„šæœ¬
        chmod +x ../scripts/repo.sh
        ../scripts/repo.sh || echo -e "\033[1;33mâš ï¸ repo.sh æ‰§è¡Œæœ‰è­¦å‘Šï¼Œä½†ç»§ç»­æ‰§è¡Œ${NC}"

    - name: ðŸ”„ æ›´æ–° feeds
      run: |
        cd build/source
        echo -e "\033[1;34mðŸ”„ æ›´æ–° feeds...\033[0m"
        ./scripts/feeds update -a || echo -e "\033[1;33mâš ï¸ feeds update æœ‰è­¦å‘Šï¼Œä½†ç»§ç»­æ‰§è¡Œ${NC}"
        echo -e "\033[1;34mðŸ“¦ å®‰è£… feeds...\033[0m"
        ./scripts/feeds install -a || echo -e "\033[1;33mâš ï¸ feeds install æœ‰è­¦å‘Šï¼Œä½†ç»§ç»­æ‰§è¡Œ${NC}"

    - name: ðŸ”¨ ç¼–è¯‘å›ºä»¶
      run: |
        cd build/source
        echo -e "\033[1;34mðŸ”¨ å¼€å§‹ç¼–è¯‘å›ºä»¶...\033[0m"
        make -j$(nproc) || make -j1 || echo -e "\033[1;31mâŒ ç¼–è¯‘å¤±è´¥\033[0m"

    - name: ðŸ“¦ æ•´ç†ç¼–è¯‘äº§ç‰©
      run: |
        cd build/source
        mkdir -p ../output/ultra
        
        # å¦‚æžœæŒ‡å®šäº†è®¾å¤‡ï¼Œåªå¤„ç†æŒ‡å®šè®¾å¤‡
        if [ -n "${{ needs.prepare.outputs.selected_device }}" ]; then
          devices="${{ needs.prepare.outputs.selected_device }}"
        else
          devices="${{ needs.prepare.outputs.device_list }}"
        fi
        
        for device in $devices; do
          if [ -f "bin/targets/qualcommax/ipq60xx/immortalwrt-*-qualcommax-ipq60xx-${device}-squashfs-sysupgrade.bin" ]; then
            cp "bin/targets/qualcommax/ipq60xx/immortalwrt-*-qualcommax-ipq60xx-${device}-squashfs-sysupgrade.bin" "../output/ultra/"
            mv "../output/ultra/immortalwrt-*-qualcommax-ipq60xx-${device}-squashfs-sysupgrade.bin" "../output/ultra/ImmortalWrt-${device}-Ultra-${{ env.BUILD_DATE }}.bin"
            echo -e "\033[1;32mâœ… é‡å‘½å: ImmortalWrt-${device}-Ultra-${{ env.BUILD_DATE }}.bin\033[0m"
          fi
        done

    - name: ðŸ“¤ ä¸Šä¼ ç¼–è¯‘äº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-ultra
        path: build/output/ultra/
        retention-days: 7

  build-max:
    needs: [prepare, build-ultra]
    runs-on: ubuntu-24.04
    if: (github.event.inputs.variant == 'all' || github.event.inputs.variant == 'max' || github.event.inputs.variant == '') && (needs.prepare.outputs.compile_mode == 'parallel' || github.event.inputs.variant == 'max')
    steps:
    - name: ðŸš€ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ðŸ’¾ æ¢å¤å·¥ä½œç›®å½•
      run: |
        sudo mkdir -p /mnt/ramdisk
        sudo mount -t tmpfs -o size=10G tmpfs /mnt/ramdisk
        sudo mkdir -p /mnt/ramdisk/build
        sudo chown $USER:$USER /mnt/ramdisk/build
        ln -sf /mnt/ramdisk/build ./build

    - name: ðŸ’¾ æ¢å¤ç¼“å­˜
      uses: actions/cache@v4
      with:
        path: |
          ./build
          ~/.ccache
        key: ${{ needs.prepare.outputs.cache_key }}-ultra
        restore-keys: |
          immwrt-${{ env.REPO_BRANCH }}-

    - name: ðŸ”§ åˆå¹¶é…ç½®æ–‡ä»¶
      run: |
        cd build/source
        
        # åˆ›å»ºé…ç½®ç›®å½•ï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
        mkdir -p ../configs
        
        # ä¸‹è½½é…ç½®æ–‡ä»¶ï¼ˆå¦‚æžœæœ¬åœ°ä¸å­˜åœ¨ï¼‰
        if [ ! -f "../configs/Max.config" ]; then
          curl -L https://raw.githubusercontent.com/aghu1979/ipq60x2/main/configs/Max.config -o ../configs/Max.config
        fi
        
        # å¤‡ä»½å½“å‰é…ç½®
        cp .config ../configs/Ultra-backup.config
        
        # æ‰§è¡Œåˆå¹¶é…ç½®è„šæœ¬
        ../scripts/merge_config.sh ../configs/base_ipq60xx.config ../configs/base_immwrt.config ../configs/Max.config .config "${{ needs.prepare.outputs.selected_device }}"
        
        # è¿è¡Œ defconfig è¡¥å…¨é…ç½®
        echo -e "\033[1;34mðŸ”§ è¿è¡Œ defconfig è¡¥å…¨é…ç½®...\033[0m"
        make defconfig || echo -e "\033[1;33mâš ï¸ defconfig æœ‰è­¦å‘Šï¼Œä½†ç»§ç»­æ‰§è¡Œ${NC}"
        
        # æå–å¹¶æ˜¾ç¤º luci è½¯ä»¶åŒ…å·®å¼‚
        echo -e "\033[1;33mðŸ“‹ LUCI è½¯ä»¶åŒ…å·®å¼‚æŠ¥å‘Š (Max vs Ultra)\033[0m"
        grep -E '^CONFIG_PACKAGE_luci.*=y$' .config > ../luci-after.txt || true
        grep -E '^CONFIG_PACKAGE_luci.*=y$' ../configs/Ultra-backup.config > ../luci-before.txt || true
        
        echo -e "\033[1;32mâž• æ–°å¢žçš„ LUCI è½¯ä»¶åŒ…:\033[0m"
        if [ -f "../luci-after.txt" ] && [ -f "../luci-before.txt" ]; then
          comm -13 ../luci-before.txt ../luci-after.txt | while read line; do
            pkg=$(echo $line | sed 's/CONFIG_PACKAGE_//g' | sed 's/=y//g')
            echo -e "  âœ¨ $pkg"
          done || echo -e "  ðŸ“­ æ— æ–°å¢ž"
        else
          echo -e "  ðŸ“­ æ— æ³•æ¯”è¾ƒ"
        fi
        
        echo -e "\033[1;31mâž– ç§»é™¤çš„ LUCI è½¯ä»¶åŒ…:\033[0m"
        if [ -f "../luci-after.txt" ] && [ -f "../luci-before.txt" ]; then
          comm -23 ../luci-before.txt ../luci-after.txt | while read line; do
            pkg=$(echo $line | sed 's/CONFIG_PACKAGE_//g' | sed 's/=y//g')
            echo -e "  ðŸ—‘ï¸ $pkg"
          done || echo -e "  ðŸ“­ æ— ç§»é™¤"
        else
          echo -e "  ðŸ“­ æ— æ³•æ¯”è¾ƒ"
        fi

    - name: ðŸ”¨ ç¼–è¯‘å›ºä»¶
      run: |
        cd build/source
        echo -e "\033[1;34mðŸ”¨ å¼€å§‹ç¼–è¯‘ Max å›ºä»¶...\033[0m"
        make -j$(nproc) || make -j1 || echo -e "\033[1;31mâŒ ç¼–è¯‘å¤±è´¥\033[0m"

    - name: ðŸ“¦ æ•´ç†ç¼–è¯‘äº§ç‰©
      run: |
        cd build/source
        mkdir -p ../output/max
        
        # ä½¿ç”¨è®¾å¤‡æå–è„šæœ¬
        if [ ! -f "../scripts/extract_devices.sh" ]; then
          curl -L https://raw.githubusercontent.com/aghu1979/ipq60x2/main/scripts/extract_devices.sh -o ../scripts/extract_devices.sh
          chmod +x ../scripts/extract_devices.sh
        fi
        
        # æå–è®¾å¤‡åç§°
        if [ -f "../configs/base_ipq60xx.config" ]; then
          devices=$(../scripts/extract_devices.sh ../configs/base_ipq60xx.config | tail -1)
        else
          devices="${{ needs.prepare.outputs.device_list }}"
        fi
        
        # å¦‚æžœæŒ‡å®šäº†è®¾å¤‡ï¼Œåªå¤„ç†æŒ‡å®šè®¾å¤‡
        if [ -n "${{ needs.prepare.outputs.selected_device }}" ]; then
          devices="${{ needs.prepare.outputs.selected_device }}"
        fi
        
        for device in $devices; do
          if [ -f "bin/targets/qualcommax/ipq60xx/immortalwrt-*-qualcommax-ipq60xx-${device}-squashfs-sysupgrade.bin" ]; then
            cp "bin/targets/qualcommax/ipq60xx/immortalwrt-*-qualcommax-ipq60xx-${device}-squashfs-sysupgrade.bin" "../output/max/"
            mv "../output/max/immortalwrt-*-qualcommax-ipq60xx-${device}-squashfs-sysupgrade.bin" "../output/max/ImmortalWrt-${device}-Max-${{ env.BUILD_DATE }}.bin"
            echo -e "\033[1;32mâœ… é‡å‘½å: ImmortalWrt-${device}-Max-${{ env.BUILD_DATE }}.bin\033[0m"
          else
            echo -e "\033[1;33mâš ï¸ è­¦å‘Š: æ‰¾ä¸åˆ°è®¾å¤‡ $device çš„å›ºä»¶æ–‡ä»¶\033[0m"
          fi
        done

    - name: ðŸ“¤ ä¸Šä¼ ç¼–è¯‘äº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-max
        path: build/output/max/
        retention-days: 7

  build-pro:
    needs: [prepare, build-ultra]
    runs-on: ubuntu-24.04
    if: (github.event.inputs.variant == 'all' || github.event.inputs.variant == 'pro' || github.event.inputs.variant == '') && (needs.prepare.outputs.compile_mode == 'parallel' || github.event.inputs.variant == 'pro')
    steps:
    - name: ðŸš€ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ðŸ’¾ æ¢å¤å·¥ä½œç›®å½•
      run: |
        sudo mkdir -p /mnt/ramdisk
        sudo mount -t tmpfs -o size=10G tmpfs /mnt/ramdisk
        sudo mkdir -p /mnt/ramdisk/build
        sudo chown $USER:$USER /mnt/ramdisk/build
        ln -sf /mnt/ramdisk/build ./build

    - name: ðŸ’¾ æ¢å¤ç¼“å­˜
      uses: actions/cache@v4
      with:
        path: |
          ./build
          ~/.ccache
        key: ${{ needs.prepare.outputs.cache_key }}-ultra
        restore-keys: |
          immwrt-${{ env.REPO_BRANCH }}-

    - name: ðŸ”§ åˆå¹¶é…ç½®æ–‡ä»¶
      run: |
        cd build/source
        
        # åˆ›å»ºé…ç½®ç›®å½•ï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
        mkdir -p ../configs
        
        # ä¸‹è½½é…ç½®æ–‡ä»¶ï¼ˆå¦‚æžœæœ¬åœ°ä¸å­˜åœ¨ï¼‰
        if [ ! -f "../configs/Pro.config" ]; then
          curl -L https://raw.githubusercontent.com/aghu1979/ipq60x2/main/configs/Pro.config -o ../configs/Pro.config
        fi
        
        # å¤‡ä»½å½“å‰é…ç½®
        cp .config ../configs/Ultra-backup.config
        
        # æ‰§è¡Œåˆå¹¶é…ç½®è„šæœ¬
        ../scripts/merge_config.sh ../configs/base_ipq60xx.config ../configs/base_immwrt.config ../configs/Pro.config .config "${{ needs.prepare.outputs.selected_device }}"
        
        # è¿è¡Œ defconfig è¡¥å…¨é…ç½®
        echo -e "\033[1;34mðŸ”§ è¿è¡Œ defconfig è¡¥å…¨é…ç½®...\033[0m"
        make defconfig || echo -e "\033[1;33mâš ï¸ defconfig æœ‰è­¦å‘Šï¼Œä½†ç»§ç»­æ‰§è¡Œ${NC}"
        
        # æå–å¹¶æ˜¾ç¤º luci è½¯ä»¶åŒ…å·®å¼‚
        echo -e "\033[1;33mðŸ“‹ LUCI è½¯ä»¶åŒ…å·®å¼‚æŠ¥å‘Š (Pro vs Ultra)\033[0m"
        grep -E '^CONFIG_PACKAGE_luci.*=y$' .config > ../luci-after.txt || true
        grep -E '^CONFIG_PACKAGE_luci.*=y$' ../configs/Ultra-backup.config > ../luci-before.txt || true
        
        echo -e "\033[1;32mâž• æ–°å¢žçš„ LUCI è½¯ä»¶åŒ…:\033[0m"
        if [ -f "../luci-after.txt" ] && [ -f "../luci-before.txt" ]; then
          comm -13 ../luci-before.txt ../luci-after.txt | while read line; do
            pkg=$(echo $line | sed 's/CONFIG_PACKAGE_//g' | sed 's/=y//g')
            echo -e "  âœ¨ $pkg"
          done || echo -e "  ðŸ“­ æ— æ–°å¢ž"
        else
          echo -e "  ðŸ“­ æ— æ³•æ¯”è¾ƒ"
        fi
        
        echo -e "\033[1;31mâž– ç§»é™¤çš„ LUCI è½¯ä»¶åŒ…:\033[0m"
        if [ -f "../luci-after.txt" ] && [ -f "../luci-before.txt" ]; then
          comm -23 ../luci-before.txt ../luci-after.txt | while read line; do
            pkg=$(echo $line | sed 's/CONFIG_PACKAGE_//g' | sed 's/=y//g')
            echo -e "  ðŸ—‘ï¸ $pkg"
          done || echo -e "  ðŸ“­ æ— ç§»é™¤"
        else
          echo -e "  ðŸ“­ æ— æ³•æ¯”è¾ƒ"
        fi

    - name: ðŸ”¨ ç¼–è¯‘å›ºä»¶
      run: |
        cd build/source
        echo -e "\033[1;34mðŸ”¨ å¼€å§‹ç¼–è¯‘ Pro å›ºä»¶...\033[0m"
        make -j$(nproc) || make -j1 || echo -e "\033[1;31mâŒ ç¼–è¯‘å¤±è´¥\033[0m"

    - name: ðŸ“¦ æ•´ç†ç¼–è¯‘äº§ç‰©
      run: |
        cd build/source
        mkdir -p ../output/pro
        
        # ä½¿ç”¨è®¾å¤‡æå–è„šæœ¬
        if [ ! -f "../scripts/extract_devices.sh" ]; then
          curl -L https://raw.githubusercontent.com/aghu1979/ipq60x2/main/scripts/extract_devices.sh -o ../scripts/extract_devices.sh
          chmod +x ../scripts/extract_devices.sh
        fi
        
        # æå–è®¾å¤‡åç§°
        if [ -f "../configs/base_ipq60xx.config" ]; then
          devices=$(../scripts/extract_devices.sh ../configs/base_ipq60xx.config | tail -1)
        else
          devices="${{ needs.prepare.outputs.device_list }}"
        fi
        
        # å¦‚æžœæŒ‡å®šäº†è®¾å¤‡ï¼Œåªå¤„ç†æŒ‡å®šè®¾å¤‡
        if [ -n "${{ needs.prepare.outputs.selected_device }}" ]; then
          devices="${{ needs.prepare.outputs.selected_device }}"
        fi
        
        for device in $devices; do
          if [ -f "bin/targets/qualcommax/ipq60xx/immortalwrt-*-qualcommax-ipq60xx-${device}-squashfs-sysupgrade.bin" ]; then
            cp "bin/targets/qualcommax/ipq60xx/immortalwrt-*-qualcommax-ipq60xx-${device}-squashfs-sysupgrade.bin" "../output/pro/"
            mv "../output/pro/immortalwrt-*-qualcommax-ipq60xx-${device}-squashfs-sysupgrade.bin" "../output/pro/ImmortalWrt-${device}-Pro-${{ env.BUILD_DATE }}.bin"
            echo -e "\033[1;32mâœ… é‡å‘½å: ImmortalWrt-${device}-Pro-${{ env.BUILD_DATE }}.bin\033[0m"
          else
            echo -e "\033[1;33mâš ï¸ è­¦å‘Š: æ‰¾ä¸åˆ°è®¾å¤‡ $device çš„å›ºä»¶æ–‡ä»¶\033[0m"
          fi
        done

    - name: ðŸ“¤ ä¸Šä¼ ç¼–è¯‘äº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-pro
        path: build/output/pro/
        retention-days: 7

  build-pro-sequential:
    needs: [prepare, build-ultra, build-max]
    runs-on: ubuntu-24.04
    if: needs.prepare.outputs.compile_mode == 'sequential' && (github.event.inputs.variant == 'all' || github.event.inputs.variant == 'pro' || github.event.inputs.variant == '')
    steps:
    - name: ðŸš€ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ðŸ’¾ æ¢å¤å·¥ä½œç›®å½•
      run: |
        sudo mkdir -p /mnt/ramdisk
        sudo mount -t tmpfs -o size=10G tmpfs /mnt/ramdisk
        sudo mkdir -p /mnt/ramdisk/build
        sudo chown $USER:$USER /mnt/ramdisk/build
        ln -sf /mnt/ramdisk/build ./build

    - name: ðŸ’¾ æ¢å¤ç¼“å­˜
      uses: actions/cache@v4
      with:
        path: |
          ./build
          ~/.ccache
        key: ${{ needs.prepare.outputs.cache_key }}-ultra
        restore-keys: |
          immwrt-${{ env.REPO_BRANCH }}-

    - name: ðŸ”§ åˆå¹¶é…ç½®æ–‡ä»¶
      run: |
        cd build/source
        
        # åˆ›å»ºé…ç½®ç›®å½•ï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
        mkdir -p ../configs
        
        # ä¸‹è½½é…ç½®æ–‡ä»¶ï¼ˆå¦‚æžœæœ¬åœ°ä¸å­˜åœ¨ï¼‰
        if [ ! -f "../configs/Pro.config" ]; then
          curl -L https://raw.githubusercontent.com/aghu1979/ipq60x2/main/configs/Pro.config -o ../configs/Pro.config
        fi
        
        # å¤‡ä»½å½“å‰é…ç½®
        cp .config ../configs/Ultra-backup.config
        
        # æ‰§è¡Œåˆå¹¶é…ç½®è„šæœ¬
        ../scripts/merge_config.sh ../configs/base_ipq60xx.config ../configs/base_immwrt.config ../configs/Pro.config .config "${{ needs.prepare.outputs.selected_device }}"
        
        # è¿è¡Œ defconfig è¡¥å…¨é…ç½®
        echo -e "\033[1;34mðŸ”§ è¿è¡Œ defconfig è¡¥å…¨é…ç½®...\033[0m"
        make defconfig || echo -e "\033[1;33mâš ï¸ defconfig æœ‰è­¦å‘Šï¼Œä½†ç»§ç»­æ‰§è¡Œ${NC}"
        
        # æå–å¹¶æ˜¾ç¤º luci è½¯ä»¶åŒ…å·®å¼‚
        echo -e "\033[1;33mðŸ“‹ LUCI è½¯ä»¶åŒ…å·®å¼‚æŠ¥å‘Š (Pro vs Ultra)\033[0m"
        grep -E '^CONFIG_PACKAGE_luci.*=y$' .config > ../luci-after.txt || true
        grep -E '^CONFIG_PACKAGE_luci.*=y$' ../configs/Ultra-backup.config > ../luci-before.txt || true
        
        echo -e "\033[1;32mâž• æ–°å¢žçš„ LUCI è½¯ä»¶åŒ…:\033[0m"
        if [ -f "../luci-after.txt" ] && [ -f "../luci-before.txt" ]; then
          comm -13 ../luci-before.txt ../luci-after.txt | while read line; do
            pkg=$(echo $line | sed 's/CONFIG_PACKAGE_//g' | sed 's/=y//g')
            echo -e "  âœ¨ $pkg"
          done || echo -e "  ðŸ“­ æ— æ–°å¢ž"
        else
          echo -e "  ðŸ“­ æ— æ³•æ¯”è¾ƒ"
        fi
        
        echo -e "\033[1;31mâž– ç§»é™¤çš„ LUCI è½¯ä»¶åŒ…:\033[0m"
        if [ -f "../luci-after.txt" ] && [ -f "../luci-before.txt" ]; then
          comm -23 ../luci-before.txt ../luci-after.txt | while read line; do
            pkg=$(echo $line | sed 's/CONFIG_PACKAGE_//g' | sed 's/=y//g')
            echo -e "  ðŸ—‘ï¸ $pkg"
          done || echo -e "  ðŸ“­ æ— ç§»é™¤"
        else
          echo -e "  ðŸ“­ æ— æ³•æ¯”è¾ƒ"
        fi

    - name: ðŸ”¨ ç¼–è¯‘å›ºä»¶
      run: |
        cd build/source
        echo -e "\033[1;34mðŸ”¨ å¼€å§‹ç¼–è¯‘ Pro å›ºä»¶...\033[0m"
        make -j$(nproc) || make -j1 || echo -e "\033[1;31mâŒ ç¼–è¯‘å¤±è´¥\033[0m"

    - name: ðŸ“¦ æ•´ç†ç¼–è¯‘äº§ç‰©
      run: |
        cd build/source
        mkdir -p ../output/pro
        
        # ä½¿ç”¨è®¾å¤‡æå–è„šæœ¬
        if [ ! -f "../scripts/extract_devices.sh" ]; then
          curl -L https://raw.githubusercontent.com/aghu1979/ipq60x2/main/scripts/extract_devices.sh -o ../scripts/extract_devices.sh
          chmod +x ../scripts/extract_devices.sh
        fi
        
        # æå–è®¾å¤‡åç§°
        if [ -f "../configs/base_ipq60xx.config" ]; then
          devices=$(../scripts/extract_devices.sh ../configs/base_ipq60xx.config | tail -1)
        else
          devices="${{ needs.prepare.outputs.device_list }}"
        fi
        
        # å¦‚æžœæŒ‡å®šäº†è®¾å¤‡ï¼Œåªå¤„ç†æŒ‡å®šè®¾å¤‡
        if [ -n "${{ needs.prepare.outputs.selected_device }}" ]; then
          devices="${{ needs.prepare.outputs.selected_device }}"
        fi
        
        for device in $devices; do
          if [ -f "bin/targets/qualcommax/ipq60xx/immortalwrt-*-qualcommax-ipq60xx-${device}-squashfs-sysupgrade.bin" ]; then
            cp "bin/targets/qualcommax/ipq60xx/immortalwrt-*-qualcommax-ipq60xx-${device}-squashfs-sysupgrade.bin" "../output/pro/"
            mv "../output/pro/immortalwrt-*-qualcommax-ipq60xx-${device}-squashfs-sysupgrade.bin" "../output/pro/ImmortalWrt-${device}-Pro-${{ env.BUILD_DATE }}.bin"
            echo -e "\033[1;32mâœ… é‡å‘½å: ImmortalWrt-${device}-Pro-${{ env.BUILD_DATE }}.bin\033[0m"
          else
            echo -e "\033[1;33mâš ï¸ è­¦å‘Š: æ‰¾ä¸åˆ°è®¾å¤‡ $device çš„å›ºä»¶æ–‡ä»¶\033[0m"
          fi
        done

    - name: ðŸ“¤ ä¸Šä¼ ç¼–è¯‘äº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-pro
        path: build/output/pro/
        retention-days: 7

  release:
    needs: [prepare, build-ultra, build-max, build-pro]
    runs-on: ubuntu-24.04
    if: success() && (github.event.inputs.variant == 'all' || github.event.inputs.variant == '')
    steps:
    - name: ðŸ“ åˆ›å»ºå‘å¸ƒç›®å½•
      run: |
        mkdir -p release

    - name: ðŸ“¥ ä¸‹è½½æ‰€æœ‰ç¼–è¯‘äº§ç‰©
      uses: actions/download-artifact@v4
      with:
        path: release

    - name: ðŸ“ åˆ›å»ºå‘å¸ƒè¯´æ˜Ž
      run: |
        cat > release/RELEASE_NOTES.md << EOF
        # ImmortalWrt å›ºä»¶å‘å¸ƒ ðŸš€
        
        ## ðŸ“… æž„å»ºä¿¡æ¯
        - ç‰ˆæœ¬: ${{ needs.prepare.outputs.cache_version }}
        - æž„å»ºæ—¥æœŸ: ${{ env.BUILD_DATE }}
        - æž„å»ºæ—¶é—´: ${{ env.BUILD_TIME }}
        - æºç ä»“åº“: ${{ env.REPO_OWNER }}/${{ env.REPO_NAME }}
        - æºç åˆ†æ”¯: ${{ env.REPO_BRANCH }}
        
        ## ðŸŽ¯ å›ºä»¶å˜ä½“
        - **Ultra**: åŒ…å«æ‰€æœ‰åŠŸèƒ½å’Œè½¯ä»¶åŒ… ðŸŒŸ
        - **Max**: åŒ…å«å¤§éƒ¨åˆ†åŠŸèƒ½å’Œè½¯ä»¶åŒ… â­
        - **Pro**: åŒ…å«å¸¸ç”¨åŠŸèƒ½å’Œè½¯ä»¶åŒ… âœ¨
        
        ## ðŸ“± æ”¯æŒçš„è®¾å¤‡
        ${{ needs.prepare.outputs.device_list }}
        
        ## ðŸ”§ å›ºä»¶ä¿¡æ¯
        - å›ºä»¶IPåœ°å€: ${{ env.FIRMWARE_IP }}
        - å›ºä»¶åç§°: ${{ env.FIRMWARE_NAME }}
        - ä½œè€…: ${{ env.AUTHOR_NAME }}
        - é»˜è®¤å¯†ç : ç©º
        
        ## ðŸŽ¨ ä¸»é¢˜
        - Argon ä¸»é¢˜
        - Aurora ä¸»é¢˜
        
        ## ðŸ“¦ ç¬¬ä¸‰æ–¹è½¯ä»¶åŒ…
        æœ¬å›ºä»¶åŒ…å«ä»¥ä¸‹ç¬¬ä¸‰æ–¹è½¯ä»¶åŒ…:
        - ðŸ® äº¬ä¸œäº‘é›…å…¸å¨œLEDæŽ§åˆ¶
        - ðŸš‡ Passwall / Passwall2
        - ðŸ›¡ï¸ AdGuardHome
        - ðŸŒ DDNS-GO
        - ðŸ“Š NetData
        - âš¡ ç½‘ç»œæµ‹é€Ÿ
        - ðŸ’¾ åˆ†åŒºç®¡ç†
        - â° ä»»åŠ¡è®¡åˆ’
        - ðŸ€ Lucky
        - ðŸ”— EasyTier
        - ðŸ  HomeProxy
        - ðŸ¹ Golang & OpenList2
        - ðŸŒŠ MosDNS
        - ðŸ“ QuickFile
        - ðŸŽ­ Momo / Nikki
        - ðŸ”’ OpenAppFilter
        - âš”ï¸ OpenClash
        - ðŸ¦Š Tailscale
        - ðŸŒ VNT
        
        ## âš ï¸ æ³¨æ„äº‹é¡¹
        1. é¦–æ¬¡åˆ·æœºåŽè¯·æ¢å¤å‡ºåŽ‚è®¾ç½®
        2. å¦‚é‡é—®é¢˜ï¼Œè¯·å°è¯•æ¢å¤å‡ºåŽ‚è®¾ç½®
        3. æ›´å¤šä¿¡æ¯è¯·è®¿é—®é¡¹ç›®ä¸»é¡µ
        
        ---
        æž„å»ºäºŽ ${{ env.BUILD_DATE }} ${{ env.BUILD_TIME }}
        EOF

    - name: ðŸš€ å‘å¸ƒå›ºä»¶
      uses: softprops/action-gh-release@v2
      with:
        name: ImmortalWrt ${{ env.BUILD_DATE }}
        body_path: release/RELEASE_NOTES.md
        draft: false
        prerelease: false
        files: |
          release/**/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
