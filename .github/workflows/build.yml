# .github/workflows/build.yml
# =============================================================================
# ImmortalWrt 自动编译工作流
# 版本: 1.2.0
# 更新日期: 2025-11-19
# =============================================================================

name: ImmortalWrt Auto Build

on:
  # 允许手动触发工作流
  workflow_dispatch:
  # 每周一上午8点自动触发 (UTC时间)
  # schedule:
  #   - cron: '0 8 * * 1'

env:
  REPO_URL: https://github.com/laipeng668/immortalwrt.git
  REPO_BRANCH: master
  TZ: Asia/Shanghai

jobs:
  setup:
    runs-on: ubuntu-24.04
    outputs:
      # 将设备信息传递给后续作业
      devices: ${{ steps.extract-devices.outputs.devices }}
      # 将统一的缓存键传递给所有编译作业
      cache-key: ${{ steps.cache-key.outputs.key }}
      # 将发布标签传递给发布作业
      release-tag: ${{ steps.vars.outputs.release-tag }}
      # 将构建日期传递给发布作业
      build-date: ${{ steps.vars.outputs.build-date }}
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 初始化编译环境
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-2404)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: 设置变量
        id: vars
        run: |
          # 生成构建日期 YYYY.MM.DD，仅用于发布说明
          build_date=$(date +'%Y.%m.%d')
          echo "build-date=$build_date" >> $GITHUB_OUTPUT
          # 生成发布标签 imm-YYYYMMDD
          release_tag="imm-$(date +'%Y%m%d')"
          echo "release-tag=$release_tag" >> $GITHUB_OUTPUT
          echo "构建日期: $build_date"
          echo "发布标签: $release_tag"

      - name: 提取设备信息
        id: extract-devices
        run: |
          chmod +x scripts/extract-devices.sh
          # 捕获脚本的 标准输出，并将其设置为 GitHub Actions 的输出
          devices_json=$(bash scripts/extract-devices.sh configs/base_ipq60xx.config)
          echo "devices=$devices_json" >> $GITHUB_OUTPUT
          # 脚本已将日志输出到 stderr，并会显示在控制台
          # 脚本也已创建了 devices.json 文件，无需重复操作

      - name: 生成智能缓存键
        id: cache-key
        run: |
          # 计算配置文件和DIY脚本的哈希值，确保内容变更时缓存失效
          config_hash=$(cat configs/*.config scripts/diy.sh | sha256sum | cut -d' ' -f1)
          # 缓存键格式: immwrt-<commit-sha>-<config_hash>
          # 这确保了只有在源码或配置变更时，缓存才会失效
          key="immwrt-${{ github.sha }}-${config_hash}"
          echo "key=$key" >> $GITHUB_OUTPUT
          echo "生成的智能缓存键: $key"

      - name: 上传设备信息
        uses: actions/upload-artifact@v4
        with:
          name: build-metadata
          path: devices.json

  build:
    needs: setup
    runs-on: ubuntu-24.04
    strategy:
      # 并行编译所有变体
      matrix:
        variant: [Ultra, Max, Pro]
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 扩展磁盘空间
        run: |
          chmod +x scripts/extend-disk.sh
          bash scripts/extend-disk.sh

      - name: 初始化编译环境
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-2404)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: 克隆源码
        working-directory: /workdir
        run: |
          df -hT $PWD
          git clone $REPO_URL -b $REPO_BRANCH immortalwrt
          ln -sf /workdir/immortalwrt $GITHUB_WORKSPACE/immortalwrt

      - name: 加载或回退缓存
        uses: actions/cache@v4
        with:
          path: /workdir/immortalwrt
          # 主缓存键，精确匹配
          key: ${{ needs.setup.outputs.cache-key }}
          # 回退键，如果主键未命中，则尝试匹配最新的 immwrt- 缓存
          restore-keys: |
            immwrt-

      - name: 合并配置文件
        run: |
          chmod +x scripts/merge-configs.sh
          bash scripts/merge-configs.sh configs/base_ipq60xx.config configs/base_immwrt.config configs/${{ matrix.variant }}.config /workdir/immortalwrt/.config

      - name: 更新和安装Feeds
        run: |
          cd /workdir/immortalwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: 生成Luci软件包报告
        run: |
          chmod +x scripts/luci-report.sh
          bash scripts/luci-report.sh /workdir/immortalwrt ${{ matrix.variant }}

      - name: 上传Luci报告
        uses: actions/upload-artifact@v4
        with:
          name: luci-report-${{ matrix.variant }}
          path: luci_report.txt

      - name: 执行自定义DIY脚本
        run: |
          [ -e files ] && mv files /workdir/immortalwrt/files
          chmod +x scripts/diy.sh
          cp scripts/diy.sh /workdir/immortalwrt
          cd /workdir/immortalwrt
          ./scripts/diy.sh

      - name: 下载软件包
        id: package
        run: |
          cd /workdir/immortalwrt
          make defconfig
          make download -j$(nproc)
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: 编译固件
        id: compile
        run: |
          cd /workdir/immortalwrt
          echo -e "$(nproc) 线程编译"
          make -j$(nproc) || make -j1 || make -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT
          grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
          [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
          echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

      - name: 检查磁盘空间
        if: (!cancelled())
        run: df -hT

      - name: 上传固件工件
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-firmware-${{ matrix.variant }}${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
          path: /workdir/immortalwrt/bin/targets/

  release:
    needs: [setup, build]
    runs-on: ubuntu-24.04
    # 只有当所有编译作业都成功后才执行发布
    if: needs.build.result == 'success'
    steps:
      - name: 下载所有固件工件
        uses: actions/download-artifact@v4
        with:
          pattern: immortalwrt-firmware-*
          merge-multiple: true
          path: artifacts/firmware

      - name: 下载所有Luci报告工件
        uses: actions/download-artifact@v4
        with:
          pattern: luci-report-*
          merge-multiple: true
          path: artifacts/reports

      - name: 下载元数据
        uses: actions/download-artifact@v4
        with:
          name: build-metadata
          path: artifacts/metadata

      - name: 整理发布文件
        run: |
          mkdir -p release
          find artifacts/firmware -name "*.img" -o -name "*.bin" -o -name "*.tar.gz" | xargs -I {} cp {} release/
          ls -la release/

      - name: 生成发布说明
        run: |
          # 开始创建发布说明
          cat > release_notes.md << EOF
          # ImmortalWrt 固件发布
          
          ## 版本信息
          - 构建日期: ${{ needs.setup.outputs.build-date }}
          - 发布标签: ${{ needs.setup.outputs.release-tag }}
          - 源码分支: ${{ env.REPO_BRANCH }}
          
          ## 变体配置
          - **Ultra**: 包含所有功能，适合高级用户
          - **Max**: 包含大部分常用功能
          - **Pro**: 精简版本，只包含基本功能
          
          ## 设备支持
          \`\`\`json
          $(cat artifacts/metadata/devices.json)
          \`\`\`
          
          ## Luci软件包报告
          EOF

          # 将所有变体的Luci报告追加到发布说明中
          for report_file in artifacts/reports/*.txt; do
            if [ -f "$report_file" ]; then
              variant_name=$(basename "$report_file" .txt | sed 's/luci-report-//')
              echo "" >> release_notes.md
              echo "### $variant_name 变体" >> release_notes.md
              echo '```' >> release_notes.md
              cat "$report_file" >> release_notes.md
              echo '```' >> release_notes.md
            fi
          done
          
          # 添加使用说明
          cat >> release_notes.md << EOF
          
          ## 使用说明
          1. 下载对应设备的固件文件。
          2. 通过设备恢复界面或系统升级界面刷入固件。
          3. 刷入后恢复出厂设置。
          
          ## 注意事项
          - 刷机有风险，请谨慎操作。
          - 建议刷机前备份原厂固件。
          - 如遇问题，请到项目主页提交Issue。
          EOF

      - name: 创建GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.setup.outputs.release-tag }}
          body_path: release_notes.md
          files: release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
