name: OpenWrt Multi-Variant Build

on:
  workflow_dispatch:
    inputs:
      chip:
        required: true
        type: string
        default: 'ipq60xx'
        description: "ç›®æ ‡èŠ¯ç‰‡æž¶æž„"
      branch:
        required: true
        type: choice
        default: 'immwrt'
        description: "æºç åˆ†æ”¯"
        options:
          - 'openwrt'
          - 'immwrt'
          - 'libwrt'
          - 'all'
      release_tag:
        required: false
        type: string
        description: "å‘å¸ƒæ ‡ç­¾ (å¯é€‰ï¼Œç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ)"
      create_release:
        required: false
        type: boolean
        default: true
        description: "æ˜¯å¦åˆ›å»ºå‘å¸ƒ"
      debug_build:
        required: false
        type: boolean
        default: false
        description: "å¯ç”¨è°ƒè¯•æ¨¡å¼ (è¯¦ç»†æ—¥å¿—)"

env:
  CACHE_VERSION: "v2"
  LOG_LEVEL: "info"

jobs:
  # ç¡®å®šæž„å»ºç­–ç•¥
  determine-strategy:
    runs-on: ubuntu-22.04
    outputs:
      build-matrix: ${{ steps.set-matrix.outputs.matrix }}
      is-multiple-branches: ${{ steps.set-matrix.outputs.is-multiple }}
    steps:
      - name: ðŸ“‹ ç¡®å®šæž„å»ºç­–ç•¥
        id: set-matrix
        run: |
          if [ "${{ inputs.branch }}" == "all" ]; then
            echo "is-multiple=true" >> $GITHUB_OUTPUT
            echo 'matrix=["openwrt", "immwrt", "libwrt"]' >> $GITHUB_OUTPUT
            echo "ðŸ”§ å°†å¹¶è¡Œæž„å»ºæ‰€æœ‰åˆ†æ”¯: openwrt, immwrt, libwrt"
          else
            echo "is-multiple=false" >> $GITHUB_OUTPUT
            echo 'matrix=["${{ inputs.branch }}"]' >> $GITHUB_OUTPUT
            echo "ðŸ”§ å°†æž„å»ºå•ä¸ªåˆ†æ”¯: ${{ inputs.branch }}"
          fi

  # åŸºç¡€çŽ¯å¢ƒæž„å»º
  build-base:
    needs: determine-strategy
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        branch: ${{ fromJson(needs.determine-strategy.outputs.build-matrix) }}
      fail-fast: false
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
      build-path: ${{ steps.cache-key.outputs.path }}
      base-hash: ${{ steps.build-info.outputs.hash }}
    steps:
      - name: ðŸ› ï¸ åˆå§‹åŒ–çŽ¯å¢ƒ
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl build-essential libncurses5-dev gawk git libssl-dev gettext python3-distutils unzip

      - name: ðŸ’¾ æ£€æŸ¥ç£ç›˜ç©ºé—´
        run: |
          echo "ðŸ“Š åˆå§‹ç£ç›˜ç©ºé—´:"
          df -h

      - name: ðŸ§¹ æ¸…ç†ç³»ç»Ÿç©ºé—´
        run: |
          echo "ðŸ§¹ æ¸…ç†ä¸å¿…è¦çš„æ–‡ä»¶..."
          # æ¸…ç†aptç¼“å­˜
          sudo apt-get clean
          sudo apt-get autoremove -y
          
          # æ¸…ç†Dockeré•œåƒï¼ˆå¦‚æžœæœ‰ï¼‰
          sudo docker system prune -af --volumes || true
          
          # æ¸…ç†å¤§æ—¥å¿—æ–‡ä»¶
          sudo find /var/log -type f -name "*.log" -exec truncate -s 0 {} \;
          sudo journalctl --vacuum-time=1d || true
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          sudo rm -rf /tmp/* 2>/dev/null || true
          sudo rm -rf /var/tmp/* 2>/dev/null || true
          
          # æ¸…ç†ç”¨æˆ·ç¼“å­˜
          rm -rf ~/.cache/* 2>/dev/null || true
          
          echo "âœ… ç³»ç»Ÿæ¸…ç†å®Œæˆ"
          echo "ðŸ“Š æ¸…ç†åŽç£ç›˜ç©ºé—´:"
          df -h

      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” æ£€æŸ¥ç›®å½•ç»“æž„
        run: |
          echo "ðŸ“Œ å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "ðŸ“Œ æ ¹ç›®å½•å†…å®¹:"
          ls -la
          echo ""
          echo "ðŸ“Œ æ£€æŸ¥.githubç›®å½•:"
          ls -la .github/ 2>/dev/null || echo "âŒ .githubç›®å½•ä¸å­˜åœ¨"
          echo ""
          echo "ðŸ“Œ æŸ¥æ‰¾configsç›®å½•:"
          find . -name "configs" -type d 2>/dev/null
          echo ""
          echo "ðŸ“Œ æŸ¥æ‰¾scriptsç›®å½•:"
          find . -name "scripts" -type d 2>/dev/null
          echo ""
          echo "ðŸ“Œ æŸ¥æ‰¾baseé…ç½®æ–‡ä»¶:"
          find . -name "base_*.config" -type f 2>/dev/null
          echo ""
          echo "ðŸ“‹ è¾“å…¥å‚æ•°:"
          echo "  - chip: '${{ inputs.chip }}'"
          echo "  - branch: '${{ matrix.branch }}'"

      - name: ðŸ”‘ ç”Ÿæˆç¼“å­˜é”®
        id: cache-key
        run: |
          echo "ðŸ“‹ å¼€å§‹ç”Ÿæˆç¼“å­˜é”®..."
          echo "  - chip: '${{ inputs.chip }}'"
          echo "  - branch: '${{ matrix.branch }}'"
          
          # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          CHIP_CONFIG_FILE="base_${{ inputs.chip }}.config"
          BRANCH_CONFIG_FILE="base_${{ matrix.branch }}.config"
          
          echo "ðŸ“‹ æŸ¥æ‰¾é…ç½®æ–‡ä»¶:"
          echo "  - èŠ¯ç‰‡é…ç½®æ–‡ä»¶: $CHIP_CONFIG_FILE"
          echo "  - åˆ†æ”¯é…ç½®æ–‡ä»¶: $BRANCH_CONFIG_FILE"
          
          # æŸ¥æ‰¾èŠ¯ç‰‡é…ç½®æ–‡ä»¶
          if [ -f "configs/$CHIP_CONFIG_FILE" ]; then
            CHIP_CONFIG="configs/$CHIP_CONFIG_FILE"
            echo "  âœ… æ‰¾åˆ°èŠ¯ç‰‡é…ç½®: $CHIP_CONFIG"
          elif [ -f ".github/configs/$CHIP_CONFIG_FILE" ]; then
            CHIP_CONFIG=".github/configs/$CHIP_CONFIG_FILE"
            echo "  âœ… æ‰¾åˆ°èŠ¯ç‰‡é…ç½®: $CHIP_CONFIG"
          else
            echo "  âŒ æ‰¾ä¸åˆ°èŠ¯ç‰‡é…ç½®æ–‡ä»¶: $CHIP_CONFIG_FILE"
            echo "ðŸ“‹ å¯ç”¨çš„èŠ¯ç‰‡é…ç½®æ–‡ä»¶:"
            find . -name "base_*.config" -type f 2>/dev/null | sed 's/^/    /'
            exit 1
          fi
          
          # æŸ¥æ‰¾åˆ†æ”¯é…ç½®æ–‡ä»¶
          if [ -f "configs/$BRANCH_CONFIG_FILE" ]; then
            BRANCH_CONFIG="configs/$BRANCH_CONFIG_FILE"
            echo "  âœ… æ‰¾åˆ°åˆ†æ”¯é…ç½®: $BRANCH_CONFIG"
          elif [ -f ".github/configs/$BRANCH_CONFIG_FILE" ]; then
            BRANCH_CONFIG=".github/configs/$BRANCH_CONFIG_FILE"
            echo "  âœ… æ‰¾åˆ°åˆ†æ”¯é…ç½®: $BRANCH_CONFIG"
          else
            echo "  âŒ æ‰¾ä¸åˆ°åˆ†æ”¯é…ç½®æ–‡ä»¶: $BRANCH_CONFIG_FILE"
            echo "ðŸ“‹ å¯ç”¨çš„åˆ†æ”¯é…ç½®æ–‡ä»¶:"
            find . -name "base_*.config" -type f 2>/dev/null | grep "base_openwrt\|base_immwrt\|base_libwrt" | sed 's/^/    /'
            exit 1
          fi
          
          # ç”ŸæˆåŸºäºŽé…ç½®çš„ç¼“å­˜é”®
          CHIP_HASH=$(sha256sum "$CHIP_CONFIG" | cut -d' ' -f1)
          BRANCH_HASH=$(sha256sum "$BRANCH_CONFIG" | cut -d' ' -f1)
          CACHE_KEY="base-${{ inputs.chip }}-${{ matrix.branch }}-${CHIP_HASH:0:8}-${BRANCH_HASH:0:8}"
          BUILD_PATH="build-base-${{ inputs.chip }}-${{ matrix.branch }}"
          
          echo "key=$CACHE_KEY" >> $GITHUB_OUTPUT
          echo "path=$BUILD_PATH" >> $GITHUB_OUTPUT
          echo "chip-config=$CHIP_CONFIG" >> $GITHUB_OUTPUT
          echo "branch-config=$BRANCH_CONFIG" >> $GITHUB_OUTPUT
          echo "âœ… ç¼“å­˜é”®ç”Ÿæˆå®Œæˆ: $CACHE_KEY"

      - name: ðŸ“¦ æ¢å¤åŸºç¡€çŽ¯å¢ƒç¼“å­˜
        id: cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.cache-key.outputs.path }}
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            base-${{ inputs.chip }}-${{ matrix.branch }}-

      - name: ðŸŒ± å‡†å¤‡åŸºç¡€çŽ¯å¢ƒ
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          echo "ðŸ”§ å‡†å¤‡åŸºç¡€ç¼–è¯‘çŽ¯å¢ƒ..."
          echo "ðŸ“Œ å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "ðŸ“Œ èŠ¯ç‰‡: ${{ inputs.chip }}"
          echo "ðŸ“Œ åˆ†æ”¯: ${{ matrix.branch }}"
          echo "ðŸ“Œ èŠ¯ç‰‡é…ç½®æ–‡ä»¶: ${{ steps.cache-key.outputs.chip-config }}"
          echo "ðŸ“Œ åˆ†æ”¯é…ç½®æ–‡ä»¶: ${{ steps.cache-key.outputs.branch-config }}"
          
          # åˆ›å»ºæž„å»ºç›®å½•
          mkdir -p ${{ steps.cache-key.outputs.path }}
          
          # è®¾ç½®æºç ä»“åº“URLå’Œåˆ†æ”¯
          case "${{ matrix.branch }}" in
            "openwrt")
              REPO_URL="https://github.com/laipeng668/openwrt.git"
              REPO_BRANCH="master"
              ;;
            "immwrt")
              REPO_URL="https://github.com/laipeng668/immortalwrt.git"
              REPO_BRANCH="master"
              ;;
            "libwrt")
              REPO_URL="https://github.com/laipeng668/openwrt-6.x.git"
              REPO_BRANCH="k6.12-nss"
              ;;
            *)
              echo "âŒ ä¸æ”¯æŒçš„åˆ†æ”¯: ${{ matrix.branch }}"
              echo "ðŸ’¡ æ”¯æŒçš„åˆ†æ”¯: openwrt, immwrt, libwrt"
              exit 1
              ;;
          esac
          
          echo "ðŸ”½ å…‹éš†æºç : $REPO_URL"
          echo "ðŸ“‹ ä½¿ç”¨åˆ†æ”¯: $REPO_BRANCH"
          
          # å…‹éš†æŒ‡å®šåˆ†æ”¯
          git clone --depth=1 -b $REPO_BRANCH $REPO_URL openwrt-src
          
          # è¿›å…¥æºç ç›®å½•
          cd openwrt-src
          
          # åº”ç”¨é…ç½®
          cp "../${{ steps.cache-key.outputs.chip-config }}" .config.chip
          cp "../${{ steps.cache-key.outputs.branch-config }}" .config.branch
          
          cp .config.chip .config
          cat .config.branch >> .config
          
          # ç¬¬ä¸€æ¬¡ make defconfig
          make defconfig
          
          # å¤åˆ¶è„šæœ¬æ–‡ä»¶
          if [ -d "../scripts" ]; then
            SCRIPT_DIR="../scripts"
          elif [ -d "../.github/scripts" ]; then
            SCRIPT_DIR="../.github/scripts"
          else
            echo "âŒ æ‰¾ä¸åˆ°scriptsç›®å½•"
            exit 1
          fi
          
          cp "$SCRIPT_DIR/diy.sh" ./
          cp "$SCRIPT_DIR/repo.sh" ./
          chmod +x diy.sh repo.sh
          
          # æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬
          ./diy.sh
          ./repo.sh
          
          # æ›´æ–°feeds
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          # ç¬¬äºŒæ¬¡ make defconfig
          make defconfig
          
          # è¿”å›žä¸Šçº§ç›®å½•
          cd ..
          
          # æ‰“åŒ…åŸºç¡€çŽ¯å¢ƒ
          tar -czf ${{ steps.cache-key.outputs.path }}/base.tar.gz -C openwrt-src .
          echo "âœ… åŸºç¡€çŽ¯å¢ƒå‡†å¤‡å®Œæˆ"

      - name: ðŸ”‘ ä¿å­˜æž„å»ºä¿¡æ¯
        id: build-info
        run: |
          if [ -d "${{ steps.cache-key.outputs.path }}/openwrt-src" ]; then
            cd "${{ steps.cache-key.outputs.path }}/openwrt-src"
            echo "hash=$(sha256sum .config | cut -d' ' -f1)" >> $GITHUB_OUTPUT
            echo "version=$(grep 'CONFIG_VERSION_NUMBER=' .config | cut -d'=' -f2 | tr -d '"')" >> $GITHUB_OUTPUT
          else
            echo "hash=unknown" >> $GITHUB_OUTPUT
            echo "version=unknown" >> $GITHUB_OUTPUT
          fi

  # Ultraå˜ä½“æž„å»º
  build-ultra:
    needs: [determine-strategy, build-base]
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        branch: ${{ fromJson(needs.determine-strategy.outputs.build-matrix) }}
      fail-fast: false
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
      build-path: ${{ steps.cache-key.outputs.path }}
      ultra-hash: ${{ steps.build-info.outputs.hash }}
      ultra-version: ${{ steps.build-info.outputs.version }}
    steps:
      - name: ðŸ› ï¸ åˆå§‹åŒ–çŽ¯å¢ƒ
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl build-essential libncurses5-dev gawk git libssl-dev gettext python3-distutils unzip

      - name: ðŸ’¾ æ£€æŸ¥ç£ç›˜ç©ºé—´
        run: |
          echo "ðŸ“Š åˆå§‹ç£ç›˜ç©ºé—´:"
          df -h

      - name: ðŸ§¹ æ¸…ç†ç³»ç»Ÿç©ºé—´
        run: |
          echo "ðŸ§¹ æ¸…ç†ä¸å¿…è¦çš„æ–‡ä»¶..."
          # æ¸…ç†aptç¼“å­˜
          sudo apt-get clean
          sudo apt-get autoremove -y
          
          # æ¸…ç†Dockeré•œåƒï¼ˆå¦‚æžœæœ‰ï¼‰
          sudo docker system prune -af --volumes || true
          
          # æ¸…ç†å¤§æ—¥å¿—æ–‡ä»¶
          sudo find /var/log -type f -name "*.log" -exec truncate -s 0 {} \;
          sudo journalctl --vacuum-time=1d || true
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          sudo rm -rf /tmp/* 2>/dev/null || true
          sudo rm -rf /var/tmp/* 2>/dev/null || true
          
          # æ¸…ç†ç”¨æˆ·ç¼“å­˜
          rm -rf ~/.cache/* 2>/dev/null || true
          
          echo "âœ… ç³»ç»Ÿæ¸…ç†å®Œæˆ"
          echo "ðŸ“Š æ¸…ç†åŽç£ç›˜ç©ºé—´:"
          df -h

      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ æ¢å¤åŸºç¡€çŽ¯å¢ƒç¼“å­˜
        uses: actions/cache@v4
        with:
          path: ${{ needs.build-base.outputs.build-path }}
          key: ${{ needs.build-base.outputs.cache-key }}

      - name: ðŸ”‘ ç”ŸæˆUltraç¼“å­˜é”®
        id: cache-key
        run: |
          ULTRA_CONFIG="configs/Ultra.config"
          ULTRA_HASH=$(sha256sum "$ULTRA_CONFIG" | cut -d' ' -f1)
          CACHE_KEY="ultra-${{ inputs.chip }}-${{ matrix.branch }}-${ULTRA_HASH:0:8}-${{ needs.build-base.outputs.base-hash }}"
          BUILD_PATH="build-ultra-${{ inputs.chip }}-${{ matrix.branch }}"
          
          echo "key=$CACHE_KEY" >> $GITHUB_OUTPUT
          echo "path=$BUILD_PATH" >> $GITHUB_OUTPUT
          echo "ultra-config=$ULTRA_CONFIG" >> $GITHUB_OUTPUT

      - name: ðŸ“¦ æ£€æŸ¥Ultraç¼“å­˜
        id: cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.cache-key.outputs.path }}
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            ultra-${{ inputs.chip }}-${{ matrix.branch }}-

      - name: ðŸŒ± å‡†å¤‡UltraçŽ¯å¢ƒ
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          # åˆ›å»ºæž„å»ºç›®å½•
          mkdir -p ${{ steps.cache-key.outputs.path }}
          
          # è§£åŽ‹åŸºç¡€çŽ¯å¢ƒ
          tar -xzf ${{ needs.build-base.outputs.build-path }}/base.tar.gz -C ${{ steps.cache-key.outputs.path }}
          
          # è¿›å…¥æž„å»ºç›®å½•
          cd ${{ steps.cache-key.outputs.path }}
          
          # åº”ç”¨Ultraé…ç½®
          cp "../${{ steps.cache-key.outputs.ultra-config }}" .config.ultra
          cat .config.ultra >> .config
          
          # è¿è¡Œdefconfig
          make defconfig
          
          # ä¿å­˜é…ç½®ä¿¡æ¯
          echo "hash=$(sha256sum .config | cut -d' ' -f1)" >> $GITHUB_OUTPUT
          echo "version=$(grep 'CONFIG_VERSION_NUMBER=' .config | cut -d'=' -f2 | tr -d '"')" >> $GITHUB_OUTPUT

      - name: ðŸ”ðŸ”ðŸ” Luciè½¯ä»¶åŒ…å®Œæ•´æ€§æ£€æŸ¥ - Ultraå˜ä½“ ðŸ”ðŸ”ðŸ”
        id: luci_check
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd ${{ steps.cache-key.outputs.path }}
          
          # ä¿å­˜å½“å‰é…ç½®
          cp .config .config.before
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                ðŸ” LUCIè½¯ä»¶åŒ…å¯¹æ¯”æ£€æŸ¥ ðŸ”                â•‘"
          echo "â•‘                   Ultraå˜ä½“ (defconfigå‰åŽ)                â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # æ­¥éª¤1: è®°å½•defconfigå‰çš„LuciåŒ…
          echo "ðŸ“‹ æ­¥éª¤1: æ£€æŸ¥defconfigå‰çš„é…ç½®..."
          BEFORE_LUCI=$(cat .config | grep "^CONFIG_PACKAGE_luci-.*=y$" | cut -d'=' -f1 | sed 's/CONFIG_PACKAGE_//')
          BEFORE_COUNT=$(echo "$BEFORE_LUCI" | grep -c .)
          
          echo "ðŸ” defconfigå‰é…ç½®ä¸­çš„Luciè½¯ä»¶åŒ… ($BEFORE_COUNT ä¸ª):"
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚ åºå· â”‚ è½¯ä»¶åŒ…åç§°                                      â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          index=1
          echo "$BEFORE_LUCI" | while read pkg; do
            if [ -n "$pkg" ]; then
              printf "â”‚ %4d â”‚ %-47s â”‚\n" "$index" "$pkg"
              index=$((index + 1))
            fi
          done
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo ""
          
          # æ­¥éª¤2: è¿è¡Œmake defconfig
          echo "ðŸ”„ æ­¥éª¤2: è¿è¡Œmake defconfigè¡¥å…¨é…ç½®..."
          make defconfig
          
          # æ­¥éª¤3: è®°å½•defconfigåŽçš„LuciåŒ…
          echo ""
          echo "ðŸ“‹ æ­¥éª¤3: æ£€æŸ¥defconfigåŽçš„é…ç½®..."
          AFTER_LUCI=$(cat .config | grep "^CONFIG_PACKAGE_luci-.*=y$" | cut -d'=' -f1 | sed 's/CONFIG_PACKAGE_//')
          AFTER_COUNT=$(echo "$AFTER_LUCI" | grep -c .)
          
          echo "ðŸ” defconfigåŽé…ç½®ä¸­çš„Luciè½¯ä»¶åŒ… ($AFTER_COUNT ä¸ª):"
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚ åºå· â”‚ è½¯ä»¶åŒ…åç§°                                      â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          index=1
          echo "$AFTER_LUCI" | while read pkg; do
            if [ -n "$pkg" ]; then
              printf "â”‚ %4d â”‚ %-47s â”‚\n" "$index" "$pkg"
              index=$((index + 1))
            fi
          done
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo ""
          
          # æ­¥éª¤4: å¯¹æ¯”åˆ†æž
          echo "ðŸ“Š æ­¥éª¤4: å¯¹æ¯”åˆ†æžç»“æžœ..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚ åºå· â”‚ è½¯ä»¶åŒ…åç§°                    â”‚ defconfigå‰ â”‚ defconfigåŽ â”‚ çŠ¶æ€ â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          
          # åˆ›å»ºæ‰€æœ‰åŒ…çš„åˆ—è¡¨
          ALL_LUCI=$(echo -e "$BEFORE_LUCI\n$AFTER_LUCI" | sort | uniq)
          MISSING_COUNT=0
          ADDED_COUNT=0
          index=1
          
          for pkg in $ALL_LUCI; do
            if [ -n "$pkg" ]; then
              before_status="âŒ"
              after_status="âŒ"
              final_status="âŒ ç¼ºå¤±"
              
              # æ£€æŸ¥defconfigå‰æ˜¯å¦å­˜åœ¨
              if echo "$BEFORE_LUCI" | grep -q "^$pkg$"; then
                before_status="âœ…"
              fi
              
              # æ£€æŸ¥defconfigåŽæ˜¯å¦å­˜åœ¨
              if echo "$AFTER_LUCI" | grep -q "^$pkg$"; then
                after_status="âœ…"
              fi
              
              # åˆ¤æ–­æœ€ç»ˆçŠ¶æ€
              if [ "$before_status" = "âœ…" ] && [ "$after_status" = "âœ…" ]; then
                final_status="âœ… ä¿ç•™"
              elif [ "$before_status" = "âŒ" ] && [ "$after_status" = "âœ…" ]; then
                final_status="âž• æ–°å¢ž"
                ADDED_COUNT=$((ADDED_COUNT + 1))
              elif [ "$before_status" = "âœ…" ] && [ "$after_status" = "âŒ" ]; then
                final_status="âŒ ä¸¢å¤±"
                MISSING_COUNT=$((MISSING_COUNT + 1))
              fi
              
              printf "â”‚ %4d â”‚ %-30s â”‚ %-11s â”‚ %-11s â”‚ %-8s â”‚\n" "$index" "$pkg" "$before_status" "$after_status" "$final_status"
              index=$((index + 1))
            fi
          done
          
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # æ­¥éª¤5: ç»Ÿè®¡æ±‡æ€»
          echo "ðŸ“Š æ­¥éª¤5: ç»Ÿè®¡æ±‡æ€»"
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚ é¡¹ç›®              â”‚ æ•°é‡     â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          echo "â”‚ defconfigå‰é…ç½®   â”‚ $BEFORE_COUNT  â”‚"
          echo "â”‚ defconfigåŽé…ç½®   â”‚ $AFTER_COUNT   â”‚"
          echo "â”‚ defconfigæ–°å¢žåŒ…   â”‚ $ADDED_COUNT   â”‚"
          echo "â”‚ defconfigä¸¢å¤±åŒ…   â”‚ $MISSING_COUNT â”‚"
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo ""
          
          # æ­¥éª¤6: è¯¦ç»†åˆ†æž
          echo "ðŸ“‹ æ­¥éª¤6: è¯¦ç»†åˆ†æž"
          
          if [ $MISSING_COUNT -gt 0 ]; then
            echo "ðŸš¨ å‘çŽ° $MISSING_COUNT ä¸ªåœ¨defconfigè¿‡ç¨‹ä¸­ä¸¢å¤±çš„Luciè½¯ä»¶åŒ…ï¼š"
            echo ""
            echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
            echo "â”‚ åºå· â”‚ ä¸¢å¤±çš„è½¯ä»¶åŒ…                        â”‚"
            echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
            index=1
            echo "$BEFORE_LUCI" | while read pkg; do
              if [ -n "$pkg" ] && ! echo "$AFTER_LUCI" | grep -q "^$pkg$"; then
                printf "â”‚ %4d â”‚ %-39s â”‚\n" "$index" "$pkg"
                index=$((index + 1))
              fi
            done
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
            echo ""
            echo "ðŸ’¡ å¯èƒ½çš„åŽŸå› ï¼š"
            echo "   1. è½¯ä»¶åŒ…ä¾èµ–å†²çªï¼Œdefconfigè‡ªåŠ¨ç§»é™¤"
            echo "   2. è½¯ä»¶åŒ…ä¸å­˜åœ¨äºŽä»»ä½•feedsæº"
            echo "   3. é…ç½®é€‰é¡¹ä¸å…¼å®¹"
            echo ""
            echo "âš ï¸  æ³¨æ„ï¼šè¿™äº›åŒ…å°†ä¸ä¼šåŒ…å«åœ¨æœ€ç»ˆå›ºä»¶ä¸­ï¼"
          else
            echo "âœ… æ­å–œï¼æ‰€æœ‰é…ç½®çš„Luciè½¯ä»¶åŒ…éƒ½åœ¨defconfigåŽä¿ç•™"
          fi
          
          if [ $ADDED_COUNT -gt 0 ]; then
            echo ""
            echo "â„¹ï¸  defconfigè‡ªåŠ¨è¡¥å…¨äº† $ADDED_COUNT ä¸ªä¾èµ–åŒ…"
          fi
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                      æ£€æŸ¥å®Œæˆ                             â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # ä¿å­˜åˆ°è¾“å‡º
          echo "missing_count=$MISSING_COUNT" >> $GITHUB_OUTPUT
          echo "added_count=$ADDED_COUNT" >> $GITHUB_OUTPUT
          echo "before_count=$BEFORE_COUNT" >> $GITHUB_OUTPUT
          echo "after_count=$AFTER_COUNT" >> $GITHUB_OUTPUT
          
          # å¦‚æžœæœ‰ä¸¥é‡é—®é¢˜ï¼Œè®¾ç½®å¤±è´¥çŠ¶æ€
          if [ $MISSING_COUNT -gt 0 ]; then
            echo "luci_check_failed=true" >> $GITHUB_OUTPUT
          else
            echo "luci_check_failed=false" >> $GITHUB_OUTPUT
          fi
          
          # ç”ŸæˆæŠ¥å‘Šæ–‡ä»¶
          cat > luci-check-ultra-${{ matrix.branch }}.md << EOF
          # Ultraå˜ä½“ Luciè½¯ä»¶åŒ…æ£€æŸ¥æŠ¥å‘Š - ${{ matrix.branch }}
          
          ## æ£€æŸ¥æ—¶é—´
          $(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          ## ç»Ÿè®¡ä¿¡æ¯
          - defconfigå‰é…ç½®: $BEFORE_COUNT ä¸ª
          - defconfigåŽé…ç½®: $AFTER_COUNT ä¸ª
          - defconfigæ–°å¢žåŒ…: $ADDED_COUNT ä¸ª
          - defconfigä¸¢å¤±åŒ…: $MISSING_COUNT ä¸ª
          
          ## ä¸¢å¤±çš„è½¯ä»¶åŒ…
          EOF
          
          if [ $MISSING_COUNT -gt 0 ]; then
            echo "$BEFORE_LUCI" | while read pkg; do
              if [ -n "$pkg" ] && ! echo "$AFTER_LUCI" | grep -q "^$pkg$"; then
                echo "- $pkg" >> luci-check-ultra-${{ matrix.branch }}.md
              fi
            done
          else
            echo "æ— " >> luci-check-ultra-${{ matrix.branch }}.md
          fi

      - name: ðŸ’¾ æ£€æŸ¥ç£ç›˜ç©ºé—´ - ç¼–è¯‘å‰
        run: |
          echo "ðŸ“Š ç¼–è¯‘å‰ç£ç›˜ç©ºé—´:"
          df -h

      - name: ðŸ”¨ ç¼–è¯‘Ultraå›ºä»¶ - åˆ†é˜¶æ®µç¼–è¯‘
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd ${{ steps.cache-key.outputs.path }}
          
          # è®¾ç½®ç¼–è¯‘å‚æ•°
          JOBS=$(nproc)
          VERBOSE=${{ inputs.debug_build && 'V=sc' || 'V=s' }}
          
          echo "ðŸ”§ ç¼–è¯‘å‚æ•°:"
          echo "  - å¹¶è¡Œä»»åŠ¡æ•°: $JOBS"
          echo "  - è¯¦ç»†æ—¥å¿—: $VERBOSE"
          
          # 1. ä¸‹è½½è½¯ä»¶åŒ…
          echo "ðŸ“¥ æ­¥éª¤1: ä¸‹è½½è½¯ä»¶åŒ…..."
          make -j$JOBS IGNORE_ERRORS=1 download
          
          # æ£€æŸ¥ä¸‹è½½åŽç©ºé—´
          echo "ðŸ“Š ä¸‹è½½åŽç£ç›˜ç©ºé—´:"
          df -h
          
          # æ¸…ç†ä¸‹è½½ç¼“å­˜ä¸­çš„ä¸å¿…è¦æ–‡ä»¶
          echo "ðŸ§¹ æ¸…ç†ä¸‹è½½ç¼“å­˜..."
          find dl/ -name "*.tmp" -delete 2>/dev/null || true
          find dl/ -name "*.bak" -delete 2>/dev/null || true
          
          # 2. é¢„ç¼–è¯‘å·¥å…·é“¾
          echo "ðŸ”¨ æ­¥éª¤2: é¢„ç¼–è¯‘å·¥å…·é“¾..."
          make -j1 IGNORE_ERRORS=1 tools/prepare || true
          make -j1 IGNORE_ERRORS=1 toolchain/prepare || true
          
          # 3. ç¼–è¯‘å·¥å…·é“¾
          echo "ðŸ”¨ æ­¥éª¤3: ç¼–è¯‘å·¥å…·é“¾..."
          make -j$JOBS IGNORE_ERRORS=1 tools/compile
          
          # 4. ç¼–è¯‘æ ¸å¿ƒåº“
          echo "ðŸ”¨ æ­¥éª¤4: ç¼–è¯‘æ ¸å¿ƒåº“..."
          make -j$JOBS IGNORE_ERRORS=1 package/libs/compile
          
          # 5. å°è¯•ç¼–è¯‘å¤±è´¥çš„å…³é”®åŒ…
          echo "ðŸ”¨ æ­¥éª¤5: å°è¯•ç¼–è¯‘å¤±è´¥çš„å…³é”®åŒ…..."
          
          # GMPåº“
          echo "ðŸ”§ ç¼–è¯‘GMPåº“..."
          make -j1 IGNORE_ERRORS=1 package/libs/gmp/compile $VERBOSE || true
          
          # OpenSSLåº“
          echo "ðŸ”§ ç¼–è¯‘OpenSSLåº“..."
          make -j1 IGNORE_ERRORS=1 package/libs/openssl/compile $VERBOSE || true
          
          # 6. å°è¯•ç¼–è¯‘ä¸»æœºå·¥å…·
          echo "ðŸ”¨ æ­¥éª¤6: ç¼–è¯‘ä¸»æœºå·¥å…·..."
          
          # Golang
          echo "ðŸ”§ ç¼–è¯‘Golang..."
          make -j1 IGNORE_ERRORS=1 package/feeds/packages/golang/host-compile $VERBOSE || true
          
          # Rust
          echo "ðŸ”§ ç¼–è¯‘Rust..."
          make -j1 IGNORE_ERRORS=1 package/feeds/packages/rust/host-compile $VERBOSE || true
          
          # 7. æœ€ç»ˆç¼–è¯‘
          echo "ðŸ”¨ æ­¥éª¤7: æœ€ç»ˆç¼–è¯‘..."
          make -j$JOBS IGNORE_ERRORS=1 $VERBOSE || true

      - name: ðŸ’¾ æ£€æŸ¥ç£ç›˜ç©ºé—´ - ç¼–è¯‘åŽ
        run: |
          echo "ðŸ“Š ç¼–è¯‘åŽç£ç›˜ç©ºé—´:"
          df -h

      - name: ðŸ§¹ æ¸…ç†ç¼–è¯‘çŽ¯å¢ƒ
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd ${{ steps.cache-key.outputs.path }}
          
          echo "ðŸ§¹ æ¸…ç†ç¼–è¯‘çŽ¯å¢ƒä»¥èŠ‚çœç©ºé—´..."
          
          # ä¿å­˜é‡è¦æ–‡ä»¶
          mkdir -p ../temp-save
          find . -name "*.bin" -o -name "*.img" -o -name "*.manifest" | xargs -I {} cp {} ../temp-save/
          
          # æ¸…ç†å¤§ç›®å½•
          rm -rf build_dir/target-* 2>/dev/null || true
          rm -rf build_dir/host-* 2>/dev/null || true
          rm -rf staging_dir/target-* 2>/dev/null || true
          rm -rf staging_dir/host-* 2>/dev/null || true
          rm -rf logs/ 2>/dev/null || true
          rm -rf tmp/ 2>/dev/null || true
          
          # æ¸…ç†å·¥å…·é“¾ï¼ˆä¿ç•™ç¼–è¯‘ç»“æžœï¼‰
          find toolchain/ -name "*.a" -delete 2>/dev/null || true
          find toolchain/ -name "*.o" -delete 2>/dev/null || true
          
          # æ¸…ç†æºç ç›®å½•ä¸­çš„å¤§æ–‡ä»¶
          find . -name "*.git" -type d -exec rm -rf {} + 2>/dev/null || true
          find . -name ".svn" -type d -exec rm -rf {} + 2>/dev/null || true
          
          # æ¢å¤é‡è¦æ–‡ä»¶
          cp ../temp-save/* ./
          rm -rf ../temp-save
          
          echo "âœ… ç¼–è¯‘çŽ¯å¢ƒæ¸…ç†å®Œæˆ"
          echo "ðŸ“Š æ¸…ç†åŽç£ç›˜ç©ºé—´:"
          df -h

      - name: ðŸ“¦ ç¼“å­˜UltraçŽ¯å¢ƒ
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          cd ${{ steps.cache-key.outputs.path }}
          
          # æ‰“åŒ…çŽ¯å¢ƒï¼ˆå·²ç»æ¸…ç†è¿‡ï¼‰
          tar -czf ${{ steps.cache-key.outputs.path }}/ultra-env.tar.gz .
          echo "âœ… UltraçŽ¯å¢ƒç¼“å­˜å®Œæˆ"

      - name: ðŸ“¤ ä¸Šä¼ Ultraæž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ultra-build-${{ inputs.chip }}-${{ matrix.branch }}
          path: ${{ steps.cache-key.outputs.path }}
          retention-days: 7
          if-no-files-found: warn

  # Maxå’ŒProå˜ä½“å¹¶è¡Œæž„å»º
  build-variants:
    needs: [determine-strategy, build-base, build-ultra]
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        branch: ${{ fromJson(needs.determine-strategy.outputs.build-matrix) }}
        variant: [Max, Pro]
      fail-fast: false
    outputs:
      max-hash: ${{ steps.build-info.outputs.hash }}
      max-version: ${{ steps.build-info.outputs.version }}
      pro-hash: ${{ steps.build-info.outputs.hash }}
      pro-version: ${{ steps.build-info.outputs.version }}
    steps:
      - name: ðŸ› ï¸ åˆå§‹åŒ–çŽ¯å¢ƒ
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl build-essential libncurses5-dev gawk git libssl-dev gettext python3-distutils unzip

      - name: ðŸ’¾ æ£€æŸ¥ç£ç›˜ç©ºé—´
        run: |
          echo "ðŸ“Š åˆå§‹ç£ç›˜ç©ºé—´:"
          df -h

      - name: ðŸ§¹ æ¸…ç†ç³»ç»Ÿç©ºé—´
        run: |
          echo "ðŸ§¹ æ¸…ç†ä¸å¿…è¦çš„æ–‡ä»¶..."
          # æ¸…ç†aptç¼“å­˜
          sudo apt-get clean
          sudo apt-get autoremove -y
          
          # æ¸…ç†Dockeré•œåƒï¼ˆå¦‚æžœæœ‰ï¼‰
          sudo docker system prune -af --volumes || true
          
          # æ¸…ç†å¤§æ—¥å¿—æ–‡ä»¶
          sudo find /var/log -type f -name "*.log" -exec truncate -s 0 {} \;
          sudo journalctl --vacuum-time=1d || true
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          sudo rm -rf /tmp/* 2>/dev/null || true
          sudo rm -rf /var/tmp/* 2>/dev/null || true
          
          # æ¸…ç†ç”¨æˆ·ç¼“å­˜
          rm -rf ~/.cache/* 2>/dev/null || true
          
          echo "âœ… ç³»ç»Ÿæ¸…ç†å®Œæˆ"
          echo "ðŸ“Š æ¸…ç†åŽç£ç›˜ç©ºé—´:"
          df -h

      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ æ¢å¤UltraçŽ¯å¢ƒç¼“å­˜
        uses: actions/cache@v4
        with:
          path: build-${{ matrix.variant }}-${{ inputs.chip }}-${{ matrix.branch }}
          key: ${{ needs.build-ultra.outputs.cache-key }}
          restore-keys: |
            ultra-${{ inputs.chip }}-${{ matrix.branch }}-

      - name: ðŸŒ± å‡†å¤‡${{ matrix.variant }}çŽ¯å¢ƒ
        run: |
          # åˆ›å»ºæž„å»ºç›®å½•
          mkdir -p build-${{ matrix.variant }}-${{ inputs.chip }}-${{ matrix.branch }}
          
          # è§£åŽ‹UltraçŽ¯å¢ƒ
          if [ -f "build-ultra-${{ inputs.chip }}-${{ matrix.branch }}/ultra-env.tar.gz" ]; then
            tar -xzf "build-ultra-${{ inputs.chip }}-${{ matrix.branch }}/ultra-env.tar.gz" -C build-${{ matrix.variant }}-${{ inputs.chip }}-${{ matrix.branch }}
          else
            # å¦‚æžœUltraç¼“å­˜ä¸å¯ç”¨ï¼Œä½¿ç”¨åŸºç¡€çŽ¯å¢ƒ
            tar -xzf ${{ needs.build-base.outputs.build-path }}/base.tar.gz -C build-${{ matrix.variant }}-${{ inputs.chip }}-${{ matrix.branch }}
          fi
          
          # è¿›å…¥æž„å»ºç›®å½•
          cd build-${{ matrix.variant }}-${{ inputs.chip }}-${{ matrix.branch }}
          
          # åº”ç”¨å˜ä½“é…ç½®
          cp "../configs/${{ matrix.variant }}.config" .config.variant
          cat .config.variant >> .config
          
          # è¿è¡Œdefconfig
          make defconfig
          
          # ä¿å­˜é…ç½®ä¿¡æ¯
          echo "hash=$(sha256sum .config | cut -d' ' -f1)" >> $GITHUB_OUTPUT
          echo "version=$(grep 'CONFIG_VERSION_NUMBER=' .config | cut -d'=' -f2 | tr -d '"')" >> $GITHUB_OUTPUT

      - name: ðŸ”ðŸ”ðŸ” Luciè½¯ä»¶åŒ…å®Œæ•´æ€§æ£€æŸ¥ - ${{ matrix.variant }}å˜ä½“ ðŸ”ðŸ”ðŸ”
        id: luci_check
        run: |
          cd build-${{ matrix.variant }}-${{ inputs.chip }}-${{ matrix.branch }}
          
          # ä¿å­˜å½“å‰é…ç½®
          cp .config .config.before
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                ðŸ” LUCIè½¯ä»¶åŒ…å¯¹æ¯”æ£€æŸ¥ ðŸ”                â•‘"
          echo "â•‘                   ${{ matrix.variant }}å˜ä½“ (defconfigå‰åŽ)                â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # æ­¥éª¤1: è®°å½•defconfigå‰çš„LuciåŒ…
          echo "ðŸ“‹ æ­¥éª¤1: æ£€æŸ¥defconfigå‰çš„é…ç½®..."
          BEFORE_LUCI=$(cat .config | grep "^CONFIG_PACKAGE_luci-.*=y$" | cut -d'=' -f1 | sed 's/CONFIG_PACKAGE_//')
          BEFORE_COUNT=$(echo "$BEFORE_LUCI" | grep -c .)
          
          echo "ðŸ” defconfigå‰é…ç½®ä¸­çš„Luciè½¯ä»¶åŒ… ($BEFORE_COUNT ä¸ª):"
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚ åºå· â”‚ è½¯ä»¶åŒ…åç§°                                      â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          index=1
          echo "$BEFORE_LUCI" | while read pkg; do
            if [ -n "$pkg" ]; then
              printf "â”‚ %4d â”‚ %-47s â”‚\n" "$index" "$pkg"
              index=$((index + 1))
            fi
          done
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo ""
          
          # æ­¥éª¤2: è¿è¡Œmake defconfig
          echo "ðŸ”„ æ­¥éª¤2: è¿è¡Œmake defconfigè¡¥å…¨é…ç½®..."
          make defconfig
          
          # æ­¥éª¤3: è®°å½•defconfigåŽçš„LuciåŒ…
          echo ""
          echo "ðŸ“‹ æ­¥éª¤3: æ£€æŸ¥defconfigåŽçš„é…ç½®..."
          AFTER_LUCI=$(cat .config | grep "^CONFIG_PACKAGE_luci-.*=y$" | cut -d'=' -f1 | sed 's/CONFIG_PACKAGE_//')
          AFTER_COUNT=$(echo "$AFTER_LUCI" | grep -c .)
          
          echo "ðŸ” defconfigåŽé…ç½®ä¸­çš„Luciè½¯ä»¶åŒ… ($AFTER_COUNT ä¸ª):"
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚ åºå· â”‚ è½¯ä»¶åŒ…åç§°                                      â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          index=1
          echo "$AFTER_LUCI" | while read pkg; do
            if [ -n "$pkg" ]; then
              printf "â”‚ %4d â”‚ %-47s â”‚\n" "$index" "$pkg"
              index=$((index + 1))
            fi
          done
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo ""
          
          # æ­¥éª¤4: å¯¹æ¯”åˆ†æž
          echo "ðŸ“Š æ­¥éª¤4: å¯¹æ¯”åˆ†æžç»“æžœ..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚ åºå· â”‚ è½¯ä»¶åŒ…åç§°                    â”‚ defconfigå‰ â”‚ defconfigåŽ â”‚ çŠ¶æ€ â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          
          # åˆ›å»ºæ‰€æœ‰åŒ…çš„åˆ—è¡¨
          ALL_LUCI=$(echo -e "$BEFORE_LUCI\n$AFTER_LUCI" | sort | uniq)
          MISSING_COUNT=0
          ADDED_COUNT=0
          index=1
          
          for pkg in $ALL_LUCI; do
            if [ -n "$pkg" ]; then
              before_status="âŒ"
              after_status="âŒ"
              final_status="âŒ ç¼ºå¤±"
              
              # æ£€æŸ¥defconfigå‰æ˜¯å¦å­˜åœ¨
              if echo "$BEFORE_LUCI" | grep -q "^$pkg$"; then
                before_status="âœ…"
              fi
              
              # æ£€æŸ¥defconfigåŽæ˜¯å¦å­˜åœ¨
              if echo "$AFTER_LUCI" | grep -q "^$pkg$"; then
                after_status="âœ…"
              fi
              
              # åˆ¤æ–­æœ€ç»ˆçŠ¶æ€
              if [ "$before_status" = "âœ…" ] && [ "$after_status" = "âœ…" ]; then
                final_status="âœ… ä¿ç•™"
              elif [ "$before_status" = "âŒ" ] && [ "$after_status" = "âœ…" ]; then
                final_status="âž• æ–°å¢ž"
                ADDED_COUNT=$((ADDED_COUNT + 1))
              elif [ "$before_status" = "âœ…" ] && [ "$after_status" = "âŒ" ]; then
                final_status="âŒ ä¸¢å¤±"
                MISSING_COUNT=$((MISSING_COUNT + 1))
              fi
              
              printf "â”‚ %4d â”‚ %-30s â”‚ %-11s â”‚ %-11s â”‚ %-8s â”‚\n" "$index" "$pkg" "$before_status" "$after_status" "$final_status"
              index=$((index + 1))
            fi
          done
          
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # æ­¥éª¤5: ç»Ÿè®¡æ±‡æ€»
          echo "ðŸ“Š æ­¥éª¤5: ç»Ÿè®¡æ±‡æ€»"
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚ é¡¹ç›®              â”‚ æ•°é‡     â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          echo "â”‚ defconfigå‰é…ç½®   â”‚ $BEFORE_COUNT  â”‚"
          echo "â”‚ defconfigåŽé…ç½®   â”‚ $AFTER_COUNT   â”‚"
          echo "â”‚ defconfigæ–°å¢žåŒ…   â”‚ $ADDED_COUNT   â”‚"
          echo "â”‚ defconfigä¸¢å¤±åŒ…   â”‚ $MISSING_COUNT â”‚"
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo ""
          
          # æ­¥éª¤6: è¯¦ç»†åˆ†æž
          echo "ðŸ“‹ æ­¥éª¤6: è¯¦ç»†åˆ†æž"
          
          if [ $MISSING_COUNT -gt 0 ]; then
            echo "ðŸš¨ å‘çŽ° $MISSING_COUNT ä¸ªåœ¨defconfigè¿‡ç¨‹ä¸­ä¸¢å¤±çš„Luciè½¯ä»¶åŒ…ï¼š"
            echo ""
            echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
            echo "â”‚ åºå· â”‚ ä¸¢å¤±çš„è½¯ä»¶åŒ…                        â”‚"
            echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
            index=1
            echo "$BEFORE_LUCI" | while read pkg; do
              if [ -n "$pkg" ] && ! echo "$AFTER_LUCI" | grep -q "^$pkg$"; then
                printf "â”‚ %4d â”‚ %-39s â”‚\n" "$index" "$pkg"
                index=$((index + 1))
              fi
            done
            echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
            echo ""
            echo "ðŸ’¡ å¯èƒ½çš„åŽŸå› ï¼š"
            echo "   1. è½¯ä»¶åŒ…ä¾èµ–å†²çªï¼Œdefconfigè‡ªåŠ¨ç§»é™¤"
            echo "   2. è½¯ä»¶åŒ…ä¸å­˜åœ¨äºŽä»»ä½•feedsæº"
            echo "   3. é…ç½®é€‰é¡¹ä¸å…¼å®¹"
            echo ""
            echo "âš ï¸  æ³¨æ„ï¼šè¿™äº›åŒ…å°†ä¸ä¼šåŒ…å«åœ¨æœ€ç»ˆå›ºä»¶ä¸­ï¼"
          else
            echo "âœ… æ­å–œï¼æ‰€æœ‰é…ç½®çš„Luciè½¯ä»¶åŒ…éƒ½åœ¨defconfigåŽä¿ç•™"
          fi
          
          if [ $ADDED_COUNT -gt 0 ]; then
            echo ""
            echo "â„¹ï¸  defconfigè‡ªåŠ¨è¡¥å…¨äº† $ADDED_COUNT ä¸ªä¾èµ–åŒ…"
          fi
          
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                      æ£€æŸ¥å®Œæˆ                             â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # ä¿å­˜åˆ°è¾“å‡º
          echo "missing_count=$MISSING_COUNT" >> $GITHUB_OUTPUT
          echo "added_count=$ADDED_COUNT" >> $GITHUB_OUTPUT
          echo "before_count=$BEFORE_COUNT" >> $GITHUB_OUTPUT
          echo "after_count=$AFTER_COUNT" >> $GITHUB_OUTPUT
          
          # å¦‚æžœæœ‰ä¸¥é‡é—®é¢˜ï¼Œè®¾ç½®å¤±è´¥çŠ¶æ€
          if [ $MISSING_COUNT -gt 0 ]; then
            echo "luci_check_failed=true" >> $GITHUB_OUTPUT
          else
            echo "luci_check_failed=false" >> $GITHUB_OUTPUT
          fi
          
          # ç”ŸæˆæŠ¥å‘Šæ–‡ä»¶
          cat > luci-check-${{ matrix.variant }}-${{ matrix.branch }}.md << EOF
          # ${{ matrix.variant }}å˜ä½“ Luciè½¯ä»¶åŒ…æ£€æŸ¥æŠ¥å‘Š - ${{ matrix.branch }}
          
          ## æ£€æŸ¥æ—¶é—´
          $(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          ## ç»Ÿè®¡ä¿¡æ¯
          - defconfigå‰é…ç½®: $BEFORE_COUNT ä¸ª
          - defconfigåŽé…ç½®: $AFTER_COUNT ä¸ª
          - defconfigæ–°å¢žåŒ…: $ADDED_COUNT ä¸ª
          - defconfigä¸¢å¤±åŒ…: $MISSING_COUNT ä¸ª
          
          ## ä¸¢å¤±çš„è½¯ä»¶åŒ…
          EOF
          
          if [ $MISSING_COUNT -gt 0 ]; then
            echo "$BEFORE_LUCI" | while read pkg; do
              if [ -n "$pkg" ] && ! echo "$AFTER_LUCI" | grep -q "^$pkg$"; then
                echo "- $pkg" >> luci-check-${{ matrix.variant }}-${{ matrix.branch }}.md
              fi
            done
          else
            echo "æ— " >> luci-check-${{ matrix.variant }}-${{ matrix.branch }}.md
          fi

      - name: ðŸ’¾ æ£€æŸ¥ç£ç›˜ç©ºé—´ - ç¼–è¯‘å‰
        run: |
          echo "ðŸ“Š ç¼–è¯‘å‰ç£ç›˜ç©ºé—´:"
          df -h

      - name: ðŸ”¨ ç¼–è¯‘${{ matrix.variant }}å›ºä»¶ - åˆ†é˜¶æ®µç¼–è¯‘
        run: |
          cd build-${{ matrix.variant }}-${{ inputs.chip }}-${{ matrix.branch }}
          
          # è®¾ç½®ç¼–è¯‘å‚æ•°
          JOBS=$(nproc)
          VERBOSE=${{ inputs.debug_build && 'V=sc' || 'V=s' }}
          
          echo "ðŸ”§ ç¼–è¯‘å‚æ•°:"
          echo "  - å¹¶è¡Œä»»åŠ¡æ•°: $JOBS"
          echo "  - è¯¦ç»†æ—¥å¿—: $VERBOSE"
          
          # 1. ä¸‹è½½è½¯ä»¶åŒ…
          echo "ðŸ“¥ æ­¥éª¤1: ä¸‹è½½è½¯ä»¶åŒ…..."
          make -j$JOBS IGNORE_ERRORS=1 download
          
          # æ£€æŸ¥ä¸‹è½½åŽç©ºé—´
          echo "ðŸ“Š ä¸‹è½½åŽç£ç›˜ç©ºé—´:"
          df -h
          
          # æ¸…ç†ä¸‹è½½ç¼“å­˜ä¸­çš„ä¸å¿…è¦æ–‡ä»¶
          echo "ðŸ§¹ æ¸…ç†ä¸‹è½½ç¼“å­˜..."
          find dl/ -name "*.tmp" -delete 2>/dev/null || true
          find dl/ -name "*.bak" -delete 2>/dev/null || true
          
          # 2. é¢„ç¼–è¯‘å·¥å…·é“¾
          echo "ðŸ”¨ æ­¥éª¤2: é¢„ç¼–è¯‘å·¥å…·é“¾..."
          make -j1 IGNORE_ERRORS=1 tools/prepare || true
          make -j1 IGNORE_ERRORS=1 toolchain/prepare || true
          
          # 3. ç¼–è¯‘å·¥å…·é“¾
          echo "ðŸ”¨ æ­¥éª¤3: ç¼–è¯‘å·¥å…·é“¾..."
          make -j$JOBS IGNORE_ERRORS=1 tools/compile
          
          # 4. ç¼–è¯‘æ ¸å¿ƒåº“
          echo "ðŸ”¨ æ­¥éª¤4: ç¼–è¯‘æ ¸å¿ƒåº“..."
          make -j$JOBS IGNORE_ERRORS=1 package/libs/compile
          
          # 5. å°è¯•ç¼–è¯‘å¤±è´¥çš„å…³é”®åŒ…
          echo "ðŸ”¨ æ­¥éª¤5: å°è¯•ç¼–è¯‘å¤±è´¥çš„å…³é”®åŒ…..."
          
          # GMPåº“
          echo "ðŸ”§ ç¼–è¯‘GMPåº“..."
          make -j1 IGNORE_ERRORS=1 package/libs/gmp/compile $VERBOSE || true
          
          # OpenSSLåº“
          echo "ðŸ”§ ç¼–è¯‘OpenSSLåº“..."
          make -j1 IGNORE_ERRORS=1 package/libs/openssl/compile $VERBOSE || true
          
          # 6. å°è¯•ç¼–è¯‘ä¸»æœºå·¥å…·
          echo "ðŸ”¨ æ­¥éª¤6: ç¼–è¯‘ä¸»æœºå·¥å…·..."
          
          # Golang
          echo "ðŸ”§ ç¼–è¯‘Golang..."
          make -j1 IGNORE_ERRORS=1 package/feeds/packages/golang/host-compile $VERBOSE || true
          
          # Rust
          echo "ðŸ”§ ç¼–è¯‘Rust..."
          make -j1 IGNORE_ERRORS=1 package/feeds/packages/rust/host-compile $VERBOSE || true
          
          # 7. æœ€ç»ˆç¼–è¯‘
          echo "ðŸ”¨ æ­¥éª¤7: æœ€ç»ˆç¼–è¯‘..."
          make -j$JOBS IGNORE_ERRORS=1 $VERBOSE || true

      - name: ðŸ’¾ æ£€æŸ¥ç£ç›˜ç©ºé—´ - ç¼–è¯‘åŽ
        run: |
          echo "ðŸ“Š ç¼–è¯‘åŽç£ç›˜ç©ºé—´:"
          df -h

      - name: ðŸ§¹ æ¸…ç†ç¼–è¯‘çŽ¯å¢ƒ
        run: |
          cd build-${{ matrix.variant }}-${{ inputs.chip }}-${{ matrix.branch }}
          
          echo "ðŸ§¹ æ¸…ç†ç¼–è¯‘çŽ¯å¢ƒä»¥èŠ‚çœç©ºé—´..."
          
          # ä¿å­˜é‡è¦æ–‡ä»¶
          mkdir -p ../temp-save
          find . -name "*.bin" -o -name "*.img" -o -name "*.manifest" | xargs -I {} cp {} ../temp-save/
          
          # æ¸…ç†å¤§ç›®å½•
          rm -rf build_dir/target-* 2>/dev/null || true
          rm -rf build_dir/host-* 2>/dev/null || true
          rm -rf staging_dir/target-* 2>/dev/null || true
          rm -rf staging_dir/host-* 2>/dev/null || true
          rm -rf logs/ 2>/dev/null || true
          rm -rf tmp/ 2>/dev/null || true
          
          # æ¸…ç†å·¥å…·é“¾ï¼ˆä¿ç•™ç¼–è¯‘ç»“æžœï¼‰
          find toolchain/ -name "*.a" -delete 2>/dev/null || true
          find toolchain/ -name "*.o" -delete 2>/dev/null || true
          
          # æ¢å¤é‡è¦æ–‡ä»¶
          cp ../temp-save/* ./
          rm -rf ../temp-save
          
          echo "âœ… ç¼–è¯‘çŽ¯å¢ƒæ¸…ç†å®Œæˆ"
          echo "ðŸ“Š æ¸…ç†åŽç£ç›˜ç©ºé—´:"
          df -h

      - name: ðŸ“¤ ä¸Šä¼ ${{ matrix.variant }}æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.variant }}-build-${{ inputs.chip }}-${{ matrix.branch }}
          path: build-${{ matrix.variant }}-${{ inputs.chip }}-${{ matrix.branch }}
          retention-days: 7
          if-no-files-found: warn

  # å‘å¸ƒç®¡ç†
  release:
    needs: [determine-strategy, build-ultra, build-variants]
    if: inputs.create_release == 'true'
    runs-on: ubuntu-22.04
    steps:
      - name: ðŸ“¥ ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: ðŸ“‹ æ•´ç†æž„å»ºäº§ç‰©
        run: |
          mkdir -p release
          
          # åˆ›å»ºç›®å½•ç»“æž„
          if [ "${{ needs.determine-strategy.outputs.is-multiple-branches }}" == "true" ]; then
            # å¤šåˆ†æ”¯æž„å»º
            for branch in openwrt immwrt libwrt; do
              mkdir -p "release/${branch}/Ultra-${{ inputs.chip }}"
              mkdir -p "release/${branch}/Max-${{ inputs.chip }}"
              mkdir -p "release/${branch}/Pro-${{ inputs.chip }}"
              
              # å¤åˆ¶äº§ç‰©
              find artifacts/ultra-build-${{ inputs.chip }}-${branch} -name "*.bin" -o -name "*.img" -o -name "*.manifest" 2>/dev/null | xargs -I {} cp {} "release/${branch}/Ultra-${{ inputs.chip }}/" || true
              find artifacts/Max-build-${{ inputs.chip }}-${branch} -name "*.bin" -o -name "*.img" -o -name "*.manifest" 2>/dev/null | xargs -I {} cp {} "release/${branch}/Max-${{ inputs.chip }}/" || true
              find artifacts/Pro-build-${{ inputs.chip }}-${branch} -name "*.bin" -o -name "*.img" -o -name "*.manifest" 2>/dev/null | xargs -I {} cp {} "release/${branch}/Pro-${{ inputs.chip }}/" || true
            done
          else
            # å•åˆ†æ”¯æž„å»º
            mkdir -p "release/Ultra-${{ inputs.chip }}"
            mkdir -p "release/Max-${{ inputs.chip }}"
            mkdir -p "release/Pro-${{ inputs.chip }}"
            
            # å¤åˆ¶äº§ç‰©
            find artifacts/ultra-build-* -name "*.bin" -o -name "*.img" -o -name "*.manifest" | xargs -I {} cp {} "release/Ultra-${{ inputs.chip }}/"
            find artifacts/Max-build-* -name "*.bin" -o -name "*.img" -o -name "*.manifest" | xargs -I {} cp {} "release/Max-${{ inputs.chip }}/"
            find artifacts/Pro-build-* -name "*.bin" -o -name "*.img" -o -name "*.manifest" | xargs -I {} cp {} "release/Pro-${{ inputs.chip }}/"
          fi
          
          # å¤åˆ¶æ£€æŸ¥æŠ¥å‘Š
          find artifacts -name "luci-check-*.md" | xargs -I {} cp {} release/
          
          # ç”Ÿæˆæž„å»ºä¿¡æ¯
          cat > release/build-info.json << EOF
          {
            "chip": "${{ inputs.chip }}",
            "branch": "${{ inputs.branch }}",
            "build_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "is_multiple_branches": ${{ needs.determine-strategy.outputs.is-multiple-branches }},
            "variants": {
              "ultra": {
                "hash": "${{ needs.build-ultra.outputs.ultra-hash }}",
                "version": "${{ needs.build-ultra.outputs.ultra-version }}"
              },
              "max": {
                "hash": "${{ needs.build-variants.outputs.max-hash }}",
                "version": "${{ needs.build-variants.outputs.max-version }}"
              },
              "pro": {
                "hash": "${{ needs.build-variants.outputs.pro-hash }}",
                "version": "${{ needs.build-variants.outputs.pro-version }}"
              }
            }
          }
          EOF
          
          # ç”ŸæˆSHA256æ ¡éªŒå’Œ
          cd release
          find . -type f -not -name "sha256sums" -exec sha256sum {} \; > sha256sums
          cd ..

      - name: ðŸ“¤ åˆ›å»ºå‘å¸ƒ
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.release_tag || format('v{0}-{1}', inputs.chip, github.run_number) }}
          name: OpenWrt ${{ inputs.branch == 'all' && 'All Branches' || inputs.branch }} for ${{ inputs.chip }}
          body: |
            ## OpenWrt ${{ inputs.branch == 'all' && 'All Branches' || inputs.branch }} å¤šå˜ä½“æž„å»º
            
            ### æž„å»ºä¿¡æ¯
            - èŠ¯ç‰‡æž¶æž„: `${{ inputs.chip }}`
            - æºç åˆ†æ”¯: `${{ inputs.branch == 'all' && 'openwrt, immwrt, libwrt' || inputs.branch }}`
            - æž„å»ºæ—¥æœŸ: $(date -u +%Y-%m-%dT%H:%M:%SZ)
            
            ### å˜ä½“ç‰ˆæœ¬
            ${{ inputs.branch == 'all' && format('
            #### OpenWrt åˆ†æ”¯
            - Ultra: {0}
            - Max: {1}
            - Pro: {2}
            
            #### ImmortalWrt åˆ†æ”¯
            - Ultra: {3}
            - Max: {4}
            - Pro: {5}
            
            #### LibWrt åˆ†æ”¯
            - Ultra: {6}
            - Max: {7}
            - Pro: {8}', needs.build-ultra.outputs.ultra-version, needs.build-variants.outputs.max-version, needs.build-variants.outputs.pro-version, needs.build-ultra.outputs.ultra-version, needs.build-variants.outputs.max-version, needs.build-variants.outputs.pro-version, needs.build-ultra.outputs.ultra-version, needs.build-variants.outputs.max-version, needs.build-variants.outputs.pro-version) || format('
            - Ultra: {0}
            - Max: {1}
            - Pro: {2}', needs.build-ultra.outputs.ultra-version, needs.build-variants.outputs.max-version, needs.build-variants.outputs.pro-version) }}
            
            ### ä¸‹è½½è¯´æ˜Ž
            - Ultra: å®Œæ•´åŠŸèƒ½ç‰ˆæœ¬ï¼ŒåŒ…å«æ‰€æœ‰å¯ç”¨è½¯ä»¶åŒ…
            - Max: å¹³è¡¡ç‰ˆæœ¬ï¼ŒåŒ…å«å¸¸ç”¨è½¯ä»¶åŒ…
            - Pro: ç²¾ç®€ç‰ˆæœ¬ï¼Œä»…åŒ…å«æ ¸å¿ƒåŠŸèƒ½
            
            ${{ inputs.branch == 'all' && '### åˆ†æ”¯è¯´æ˜Ž
            - OpenWrt: å®˜æ–¹ç¨³å®šç‰ˆæœ¬
            - ImmortalWrt: å¢žå¼ºåŠŸèƒ½ç‰ˆæœ¬
            - LibWrt: å®žéªŒæ€§ç‰ˆæœ¬' || '' }}
            
            ### Luciè½¯ä»¶åŒ…æ£€æŸ¥æŠ¥å‘Š
            å„å˜ä½“çš„Luciè½¯ä»¶åŒ…å®Œæ•´æ€§æ£€æŸ¥æŠ¥å‘Šå·²åŒ…å«åœ¨å‘å¸ƒæ–‡ä»¶ä¸­ã€‚
            
            ### æ ¡éªŒå’Œ
            è¯·ä½¿ç”¨æä¾›çš„ `sha256sums` æ–‡ä»¶éªŒè¯ä¸‹è½½æ–‡ä»¶çš„å®Œæ•´æ€§ã€‚
          files: |
            release/**
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
