name: IPQ60XX-Full-Build

on:
  workflow_dispatch:
    inputs:
      repo_config:
        description: 'é€‰æ‹©è¦æž„å»ºçš„ä»“åº“'
        required: true
        default: 'immwrt'
        type: choice
        options:
          - immwrt
          - openwrt
          - libwrt
  workflow_call:
    inputs:
      repo_config:
        required: true
        type: string

env:
  TZ: Asia/Shanghai
  OPENWRT_PATH: /mnt/openwrt
  CONFIG_BASE_DIR: configs
  DIY_SCRIPT_DIR: scripts
  CACHE_VERSION: v2
  LOG_LEVEL: INFO
  LOG_FILE: build.log
  REPORT_FILE: build_report.json

jobs:
  # ==================== é˜¶æ®µä¸€ï¼šæž„å»ºåŸºç¡€çŽ¯å¢ƒ ====================
  Build-Base:
    runs-on: ubuntu-22.04
    outputs:
      SOURCE_REPO: ${{ steps.generate_vars.outputs.source_repo }}
      DEVICE_TARGET: ${{ steps.generate_vars.outputs.device_target }}
      DEVICE_SUBTARGET: ${{ steps.generate_vars.outputs.device_subtarget }}
      CHIP_FAMILY: ${{ steps.generate_vars.outputs.chip_family }}
      REPO_SHORT: ${{ steps.generate_vars.outputs.repo_short }}
      BUILD_ID_BASE: ${{ steps.generate_vars.outputs.build_id }}
    steps:
    - name: åˆå§‹åŒ–ä¼ä¸šçº§æ—¥å¿—ç³»ç»Ÿ
      id: init_logging
      run: |
        # ... (æ­¤è„šæœ¬å†…å®¹ä¸ŽåŽŸç‰ˆå®Œå…¨ç›¸åŒï¼Œä¸ºç®€æ´èµ·è§åœ¨æ­¤çœç•¥) ...
        cat > /tmp/logger.sh << 'EOF'
        #!/bin/bash
        declare -A LOG_LEVELS=([DEBUG]=0 [INFO]=1 [WARN]=2 [ERROR]=3)
        CURRENT_LEVEL=${LOG_LEVELS[$LOG_LEVEL]}
        LOG_FILE="$GITHUB_WORKSPACE/$LOG_FILE"
        REPORT_FILE="$GITHUB_WORKSPACE/$REPORT_FILE"
        echo "=== Build Log Started at $(date) ===" > "$LOG_FILE"
        echo '{"build_id":"base-'$(date +%s)'","start_time":"'$(date -Iseconds)'","steps":[],"errors":[],"warnings":[],"build_errors":[]}' > "$REPORT_FILE"
        log() { local level="$1" message="$2" step="${3:-$(caller | awk '{print $2}')}"; local timestamp=$(date '+%Y-%m-%d %H:%M:%S'); if [ ${LOG_LEVELS[$level]} -ge $CURRENT_LEVEL ]; then case $level in DEBUG) echo -e "\033[0;37m[$timestamp] [DEBUG] $message\033[0m" ;; INFO) echo -e "\033[0;34m[$timestamp] [INFO] $message\033[0m" ;; WARN) echo -e "\033[0;33m[$timestamp] [WARN] $message\033[0m" ;; ERROR) echo -e "\033[1;41;37m[$timestamp] [ERROR] $message\033[0m" ;; esac; echo "[$timestamp] [$level] [Step: $step] $message" >> "$LOG_FILE"; fi; }
        log_build_error() { local error_msg="$1" package="$2"; local timestamp=$(date -Iseconds); echo -e "\n\033[1;41;37mðŸ”¥ æž„å»ºé”™è¯¯ ðŸ”¥\033[0m\n\033[1;31mé”™è¯¯ä¿¡æ¯: $error_msg\033[0m\n\033[1;31mç›¸å…³åŒ…: $package\033[0m\n\033[1;41;37m================\033[0m\n"; log "ERROR" "æž„å»ºå¤±è´¥: $error_msg (åŒ…: $package)"; echo "::error ::æž„å»ºå¤±è´¥: $error_msg (åŒ…: $package)"; }
        step_start() { local step_name="$1" description="$2"; local timestamp=$(date -Iseconds); log "INFO" "â–¶ å¼€å§‹æ‰§è¡Œ: $description" "$step_name"; }
        step_complete() { local step_name="$1" status="$2"; local timestamp=$(date -Iseconds); if [ "$status" = "success" ]; then log "INFO" "âœ… æ­¥éª¤å®Œæˆ: $step_name" "$step_name"; elif [ "$status" = "failed" ]; then log "ERROR" "âŒ æ­¥éª¤å¤±è´¥: $step_name" "$step_name"; fi; }
        show_progress() { local current="$1" total="$2" description="$3"; local percent=$((current * 100 / total)); local filled=$((percent / 2)); local empty=$((50 - filled)); printf "\r\033[0;36m[%3d%%] [" "$percent"; printf "%*s" $filled | tr ' ' 'â–ˆ'; printf "%*s" $empty | tr ' ' 'â–‘'; printf "] %s\033[0m" "$description"; }
        export -f log log_build_error step_start step_complete show_progress
        EOF
        chmod +x /tmp/logger.sh
        echo "LOGGER_SCRIPT=/tmp/logger.sh" >> $GITHUB_ENV
        source /tmp/logger.sh
        step_start "INIT" "åˆå§‹åŒ–ä¼ä¸šçº§æ—¥å¿—ç³»ç»Ÿ"
        log "INFO" "æž„å»ºID: base-$(date +%s)"
        step_complete "INIT" "success"

    - name: åˆå§‹åŒ–çŽ¯å¢ƒ
      id: init_env
      run: |
        source "$LOGGER_SCRIPT"
        step_start "ENV_INIT" "åˆå§‹åŒ–æž„å»ºçŽ¯å¢ƒ"
        set -euo pipefail
        trap 'log "ERROR" "å‘½ä»¤æ‰§è¡Œå¤±è´¥: $BASH_COMMAND ($LINENO)"' ERR
        
        # ä¼˜åŒ–ï¼šåˆå¹¶ apt-get å‘½ä»¤
        log "INFO" "æ›´æ–°ç³»ç»ŸåŒ…å¹¶å®‰è£…ä¾èµ–..."
        sudo -E apt-get -y update
        # å»ºè®®ï¼šå°†ä¾èµ–åˆ—è¡¨æ”¾å…¥ä»“åº“çš„ scripts/depends.txt æ–‡ä»¶ä¸­ï¼Œæ›´å®‰å…¨å¯æŽ§
        sudo -E apt-get -y install $(curl -fsSL is.gd/depends_ubuntu_2204)
        
        # ä¼˜åŒ–ï¼šæ›´å®‰å…¨çš„ GitHub CLI å®‰è£…æ–¹å¼
        log "INFO" "å®‰è£…GitHub CLI..."
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
        && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
        && sudo apt update && sudo apt install gh -y

        log "INFO" "é…ç½®æ—¶åŒº..."
        sudo timedatectl set-timezone "$TZ" || log "WARN" "æ—¶åŒºè®¾ç½®å¤±è´¥"
        log "INFO" "CPUæ ¸å¿ƒæ•°: $(nproc), å†…å­˜: $(free -h | grep '^Mem:' | awk '{print $2}')"
        step_complete "ENV_INIT" "success"

    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@main

    - name: è¯»å–ä»“åº“é…ç½®
      id: read_repo_config
      run: |
        source "$LOGGER_SCRIPT"
        step_start "READ_CONFIG" "è¯»å–ä»“åº“é…ç½®"
        REPO_CONFIG="${{ github.event.inputs.repo_config || inputs.repo_config }}"
        REPO_CONFIG_FILE="${GITHUB_WORKSPACE}/${CONFIG_BASE_DIR}/repos.json"
        if [ ! -f "$REPO_CONFIG_FILE" ]; then log "ERROR" "ä»“åº“é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $REPO_CONFIG_FILE"; exit 1; fi
        REPO_INFO=$(jq -r --arg repo "$REPO_CONFIG" '.[$repo]' "$REPO_CONFIG_FILE")
        if [ "$REPO_INFO" = "null" ]; then log "ERROR" "æœªæ‰¾åˆ°ä»“åº“é…ç½®: $REPO_CONFIG"; exit 1; fi
        echo "REPO_URL=$(echo "$REPO_INFO" | jq -r '.url')" >> $GITHUB_ENV
        echo "REPO_BRANCH=$(echo "$REPO_INFO" | jq -r '.branch')" >> $GITHUB_ENV
        echo "REPO_SHORT=$(echo "$REPO_INFO" | jq -r '.short')" >> $GITHUB_ENV
        log "INFO" "é€‰å®šä»“åº“: $REPO_CONFIG ($REPO_URL)"
        step_complete "READ_CONFIG" "success"

    - name: å…‹éš†æºä»£ç 
      id: clone_source
      run: |
        source "$LOGGER_SCRIPT"
        step_start "CLONE_SOURCE" "å…‹éš†æºä»£ç "
        sudo mkdir -p "$OPENWRT_PATH" && sudo chown -R $(id -u):$(id -g) "$OPENWRT_PATH"
        if ! git clone --depth 1 -b "$REPO_BRANCH" --single-branch "$REPO_URL" "$OPENWRT_PATH"; then log "ERROR" "æºä»£ç å…‹éš†å¤±è´¥"; exit 1; fi
        log "INFO" "æºç å…‹éš†æˆåŠŸ"
        step_complete "CLONE_SOURCE" "success"

    - name: ç”Ÿæˆå˜é‡
      id: generate_vars
      run: |
        source "$LOGGER_SCRIPT"
        step_start "GEN_VARS" "ç”Ÿæˆæž„å»ºå˜é‡"
        # ... (æ­¤è„šæœ¬å†…å®¹ä¸ŽåŽŸç‰ˆåŸºæœ¬ç›¸åŒï¼Œä½†å¢žåŠ äº†è¾“å‡ºåˆ° GITHUB_OUTPUT) ...
        find_config_file() { local base_name="$1"; local config_dir="${GITHUB_WORKSPACE}/${CONFIG_BASE_DIR}"; for ext in ".config" ".config.txt"; do if [ -f "${config_dir}/${base_name}${ext}" ]; then echo "${config_dir}/${base_name}${ext}"; return 0; fi; done; local found_file=$(find "$config_dir" -iname "${base_name}.config*" -type f | head -n 1); if [ -n "$found_file" ]; then echo "$found_file"; return 0; fi; return 1; }
        CONFIG_BASE=$(find_config_file "base_ipq60xx") # å‡è®¾èŠ¯ç‰‡ç³»åˆ—å›ºå®šä¸ºipq60xx
        if [ $? -ne 0 ]; then log "ERROR" "åŸºç¡€é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: base_ipq60xx"; exit 1; fi
        CONFIG_BRANCH=$(find_config_file "base_${REPO_SHORT}")
        if [ $? -ne 0 ]; then log "ERROR" "åˆ†æ”¯é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: base_${REPO_SHORT}"; exit 1; fi
        log "INFO" "åŸºç¡€é…ç½®: $CONFIG_BASE"
        log "INFO" "åˆ†æ”¯é…ç½®: $CONFIG_BRANCH"
        
        cp "$CONFIG_BASE" "$OPENWRT_PATH/.config"
        cd "$OPENWRT_PATH"
        if ! make defconfig > /dev/null 2>&1; then log "ERROR" "è¿è¡Œdefconfigå¤±è´¥"; exit 1; fi
        
        SOURCE_REPO="$(echo "$REPO_URL" | awk -F '/' '{print $(NF)}')"
        DEVICE_TARGET=$(cat .config | grep CONFIG_TARGET_BOARD | awk -F '"' '{print $2}')
        DEVICE_SUBTARGET=$(cat .config | grep CONFIG_TARGET_SUBTARGET | awk -F '"' '{print $2}')
        CHIP_FAMILY="ipq60xx" # ä»Žé…ç½®ä¸­æå–æˆ–ç¡¬ç¼–ç 
        
        # è¾“å‡ºç»™ Job 2 ä½¿ç”¨
        echo "source_repo=${SOURCE_REPO}" >> $GITHUB_OUTPUT
        echo "device_target=${DEVICE_TARGET}" >> $GITHUB_OUTPUT
        echo "device_subtarget=${DEVICE_SUBTARGET}" >> $GITHUB_OUTPUT
        echo "chip_family=${CHIP_FAMILY}" >> $GITHUB_OUTPUT
        echo "repo_short=${REPO_SHORT}" >> $GITHUB_OUTPUT
        echo "build_id=base-$(date +%s)" >> $GITHUB_OUTPUT
        
        log "INFO" "è®¾å¤‡ä¿¡æ¯: $DEVICE_TARGET/$DEVICE_SUBTARGET"
        step_complete "GEN_VARS" "success"

    - name: ç¼“å­˜å·¥å…·é“¾
      uses: actions/cache@main
      with:
        key: ${{ env.CACHE_VERSION }}-toolchain-${{ steps.generate_vars.outputs.source_repo }}-${{ env.REPO_BRANCH }}-${{ steps.generate_vars.outputs.device_target }}-${{ steps.generate_vars.outputs.device_subtarget }}
        path: |
          ${{ env.OPENWRT_PATH }}/.ccache
          ${{ env.OPENWRT_PATH }}/staging_dir

    - name: ç¼“å­˜Feedså’ŒDL
      uses: actions/cache@main
      with:
        key: ${{ env.CACHE_VERSION }}-feeds-dl-${{ steps.generate_vars.outputs.source_repo }}-${{ env.REPO_BRANCH }}
        path: |
          ${{ env.OPENWRT_PATH }}/feeds
          ${{ env.OPENWRT_PATH }}/dl
          ${{ env.OPENWRT_PATH }}/package/feeds

    - name: å®‰è£…Feedså’ŒåŠ è½½è‡ªå®šä¹‰é…ç½®
      run: |
        source "$LOGGER_SCRIPT"
        step_start "PREP_BUILD" "å‡†å¤‡æž„å»ºçŽ¯å¢ƒ"
        cd "$OPENWRT_PATH"
        if [ "${{ steps.cache.outputs.cache-hit }}" != "true" ]; then ./scripts/feeds update -a; fi
        ./scripts/feeds install -a
        if [ -f "${{ env.DIY_SCRIPT_DIR }}/diy.sh" ]; then chmod +x "${{ env.DIY_SCRIPT_DIR }}/diy.sh" && "${{ env.DIY_SCRIPT_DIR }}/diy.sh"; fi
        if [ -f "${{ env.DIY_SCRIPT_DIR }}/repo.sh" ]; then chmod +x "${{ env.DIY_SCRIPT_DIR }}/repo.sh" && "${{ env.DIY_SCRIPT_DIR }}/repo.sh"; fi
        step_complete "PREP_BUILD" "success"

    - name: ç¼–è¯‘åŸºç¡€çŽ¯å¢ƒ
      id: compile_base
      run: |
        source "$LOGGER_SCRIPT"
        step_start "COMPILE_BASE" "ç¼–è¯‘åŸºç¡€çŽ¯å¢ƒ"
        cd "$OPENWRT_PATH"
        log "INFO" "å¼€å§‹ç¼–è¯‘å·¥å…·é“¾å’Œç³»ç»ŸåŒ…..."
        if make -j$(nproc) toolchain/kernel-headers compile; then
          log "INFO" "åŸºç¡€çŽ¯å¢ƒç¼–è¯‘æˆåŠŸ"
          echo "status=success" >> $GITHUB_OUTPUT
        else
          log "ERROR" "åŸºç¡€çŽ¯å¢ƒç¼–è¯‘å¤±è´¥"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi
        step_complete "COMPILE_BASE" "success"

    - name: ä¸Šä¼ åŸºç¡€çŽ¯å¢ƒåˆ°Artifact
      if: steps.compile_base.outputs.status == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: base-env-${{ steps.generate_vars.outputs.source_repo }}-${{ steps.generate_vars.outputs.repo_short }}
        path: ${{ env.OPENWRT_PATH }}
        retention-days: 7

  # ==================== é˜¶æ®µäºŒï¼šå¹¶è¡Œç¼–è¯‘å˜ä½“å›ºä»¶ ====================
  Build-Variants:
    needs: Build-Base
    if: needs.Build-Base.result == 'success'
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        variant_config: [Pro, Max, Ultra]
    
    env:
      # ä»Ž Job 1 çš„ outputs ä¸­èŽ·å–å˜é‡
      SOURCE_REPO: ${{ needs.Build-Base.outputs.SOURCE_REPO }}
      DEVICE_TARGET: ${{ needs.Build-Base.outputs.DEVICE_TARGET }}
      DEVICE_SUBTARGET: ${{ needs.Build-Base.outputs.DEVICE_SUBTARGET }}
      CHIP_FAMILY: ${{ needs.Build-Base.outputs.CHIP_FAMILY }}
      REPO_SHORT: ${{ needs.Build-Base.outputs.REPO_SHORT }}
      BUILD_ID: ${{ needs.Build-Base.outputs.BUILD_ID_BASE }}-${{ matrix.variant_config }}
      OPENWRT_PATH: /mnt/openwrt

    steps:
    - name: åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ
      run: |
        # ... (å¤ç”¨æ—¥å¿—è„šæœ¬) ...
        cat > /tmp/logger.sh << 'EOF'
        #!/bin/bash
        declare -A LOG_LEVELS=([DEBUG]=0 [INFO]=1 [WARN]=2 [ERROR]=3)
        CURRENT_LEVEL=${LOG_LEVELS[$LOG_LEVEL]}
        LOG_FILE="$GITHUB_WORKSPACE/$LOG_FILE"
        REPORT_FILE="$GITHUB_WORKSPACE/$REPORT_FILE"
        echo "=== Variant Build Log Started at $(date) ===" > "$LOG_FILE"
        echo '{"build_id":"'$BUILD_ID'","start_time":"'$(date -Iseconds)'","steps":[],"errors":[],"warnings":[],"build_errors":[]}' > "$REPORT_FILE"
        log() { local level="$1" message="$2" step="${3:-$(caller | awk '{print $2}')}"; local timestamp=$(date '+%Y-%m-%d %H:%M:%S'); if [ ${LOG_LEVELS[$level]} -ge $CURRENT_LEVEL ]; then case $level in DEBUG) echo -e "\033[0;37m[$timestamp] [DEBUG] $message\033[0m" ;; INFO) echo -e "\033[0;34m[$timestamp] [INFO] $message\033[0m" ;; WARN) echo -e "\033[0;33m[$timestamp] [WARN] $message\033[0m" ;; ERROR) echo -e "\033[1;41;37m[$timestamp] [ERROR] $message\033[0m" ;; esac; echo "[$timestamp] [$level] [Step: $step] $message" >> "$LOG_FILE"; fi; }
        step_start() { local step_name="$1" description="$2"; log "INFO" "â–¶ å¼€å§‹æ‰§è¡Œ: $description" "$step_name"; }
        step_complete() { local step_name="$1" status="$2"; if [ "$status" = "success" ]; then log "INFO" "âœ… æ­¥éª¤å®Œæˆ: $step_name" "$step_name"; elif [ "$status" = "failed" ]; then log "ERROR" "âŒ æ­¥éª¤å¤±è´¥: $step_name" "$step_name"; fi; }
        export -f log step_start step_complete
        EOF
        chmod +x /tmp/logger.sh
        echo "LOGGER_SCRIPT=/tmp/logger.sh" >> $GITHUB_ENV
        source /tmp/logger.sh
        step_start "INIT" "åˆå§‹åŒ–å˜ä½“æž„å»ºæ—¥å¿—"
        log "INFO" "æž„å»ºID: $BUILD_ID"
        step_complete "INIT" "success"

    - name: ä¸‹è½½åŸºç¡€çŽ¯å¢ƒ
      id: download_base
      uses: actions/download-artifact@v4
      with:
        name: base-env-${{ env.SOURCE_REPO }}-${{ env.REPO_SHORT }}
        path: ${{ env.OPENWRT_PATH }}

    - name: å‡†å¤‡å˜ä½“é…ç½®
      id: prepare_variant_config
      run: |
        source "$LOGGER_SCRIPT"
        step_start "PREP_VARIANT_CONFIG" "å‡†å¤‡å˜ä½“é…ç½®"
        cd "$OPENWRT_PATH"
        
        # æŸ¥æ‰¾å¹¶åˆå¹¶å˜ä½“é…ç½®
        VARIANT_CONFIG_FILE="${{ env.CONFIG_BASE_DIR }}/${{ matrix.variant_config }}.config"
        if [ ! -f "$VARIANT_CONFIG_FILE" ]; then
          log "ERROR" "å˜ä½“é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $VARIANT_CONFIG_FILE"
          exit 1
        fi
        
        log "INFO" "åˆå¹¶åŸºç¡€é…ç½®ä¸Žå˜ä½“é…ç½®: $VARIANT_CONFIG_FILE"
        cat .config "$VARIANT_CONFIG_FILE" > .config.tmp && mv .config.tmp .config
        
        log "INFO" "è¿è¡Œ defconfig..."
        make defconfig
        
        log "INFO" "å˜ä½“é…ç½®å‡†å¤‡å®Œæˆ"
        step_complete "PREP_VARIANT_CONFIG" "success"

    - name: ç¼–è¯‘å˜ä½“å›ºä»¶
      id: compile_variant
      run: |
        source "$LOGGER_SCRIPT"
        step_start "COMPILE_VARIANT" "ç¼–è¯‘å˜ä½“å›ºä»¶ (${{ matrix.variant_config }})"
        cd "$OPENWRT_PATH"
        
        log "INFO" "å¼€å§‹ç¼–è¯‘å›ºä»¶ï¼Œè¿™å°†åªç¼–è¯‘å·®å¼‚éƒ¨åˆ†å’Œç”Ÿæˆé•œåƒ..."
        if make -j$(nproc); then
          log "INFO" "å˜ä½“ ${{ matrix.variant_config }} ç¼–è¯‘æˆåŠŸ"
          echo "status=success" >> $GITHUB_OUTPUT
        else
          log "ERROR" "å˜ä½“ ${{ matrix.variant_config }} ç¼–è¯‘å¤±è´¥"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi
        step_complete "COMPILE_VARIANT" "success"

    - name: ä¸Šä¼ å›ºä»¶Artifact
      if: steps.compile_variant.outputs.status == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ env.SOURCE_REPO }}-${{ matrix.variant_config }}-${{ env.FILE_DATE }}
        path: ${{ env.OPENWRT_PATH }}/bin/targets/
        retention-days: 30

    - name: ä¸Šä¼ æž„å»ºæ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: logs-${{ env.SOURCE_REPO }}-${{ matrix.variant_config }}-${{ env.FILE_DATE }}
        path: |
          ${{ github.workspace }}/$LOG_FILE
          ${{ github.workspace }}/$REPORT_FILE
        retention-days: 7
